
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>剛好學：課堂互動so easy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/d3-cloud@1.2.7/build/d3.layout.cloud.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* Animations from 剛好測分享版 */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fadeInUp 0.3s ease-out forwards; }
        
        /* Scrollbar customization */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Landing Page Card Styles */
        .landing-card {
            background-color: white;
            padding: 2rem;
            border-radius: 1.5rem; /* rounded-3xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-xl */
            transition: all 0.3s ease;
            cursor: pointer; /* Cards are clickable in 剛好學最新版 */
            border: 1px solid #f1f5f9; /* border-slate-100 */
            position: relative;
            overflow: hidden;
            display: flex; /* Make cards use flex for internal alignment */
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .landing-card:hover {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); /* shadow-2xl */
        }

        /* 自訂樣式 */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8; /* 柔和的背景色 */
        }
        /* 隱藏元素的通用 class */
        .hidden {
            display: none !important;
        }
        /* 按鈕樣式 (直接在 HTML 中使用 Tailwind class，不使用 @apply) */
        .btn {
            display: inline-block;
            width: 100%;
            padding: 1rem 1.5rem;
            font-size: 1.25rem;
            line-height: 1.75rem;
            font-weight: 700;
            color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.2s ease-in-out;
        }
        .btn:hover {
            transform: scale(1.05);
        }
        .btn-primary { background-color: #2563eb; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-green { background-color: #16a34a; }
        .btn-green:hover { background-color: #15803d; }
        .btn-orange { background-color: #ea580c; }
        .btn-orange:hover { background-color: #c2410c; }
        .btn-purple { background-color: #9333ea; }
        .btn-purple:hover { background-color: #7e22ce; }
        .btn-red { background-color: #dc2626; }
        .btn-red:hover { background-color: #b91c1c; }
        .btn-teal { background-color: #0d9488; } /* New Teal color */
        .btn-teal:hover { background-color: #0f766e; }
        .btn-gray { background-color: #9ca3af; cursor: not-allowed; }


        /* 搶答按鈕樣式 */
        .quick-answer-btn {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            font-size: 24px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        .quick-answer-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.4);
        }
        .quick-answer-btn:active {
            transform: scale(0.95);
        }
        .quick-answer-btn.locked {
            background: #9ca3af;
            cursor: not-allowed;
            animation: none;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* 繪圖板 Canvas 樣式 */
        #drawing-canvas {
            border: 2px solid #cbd5e1;
            border-radius: 0.5rem;
            cursor: crosshair;
            touch-action: none; /* 防止在 canvas 上繪圖時觸發頁面滾動 */
            display: block; /* Ensures it takes up its own line and respects margins */
            margin: 0 auto; /* Center the canvas */
            background-color: white; /* 繪圖畫布背景色 */
            flex-grow: 1; /* Allow canvas to take available vertical space */
            width: 100%; /* Ensure canvas takes full width within its container */
        }
        /* 學生作答結果卡片 */
        .student-card {
            background-color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            margin-bottom: 0.75rem;
            word-break: break-all;
        }

        /* 新增：用於學生作答列表的卡片樣式 */
        .student-response-item {
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* 將內容向左對齊 */
            justify-content: flex-start; /* 將內容向上對齊 */
            text-align: left; /* 將文本向左對齊 */
            transition: border 0.3s ease-in-out, box-shadow 0.3s ease-in-out; /* Add transition for smooth border change */
        }
        .student-response-item .name-box {
            background-color: #d1e7dd; /* Light green for name */
            color: #0f5132; /* Dark green text */
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            width: 100%; /* Take full width within its grid column */
            max-width: 150px; /* Max width for name box */
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            text-align: center; /* 讓姓名在框內置中 */
        }
        .student-response-item .answer-box {
            background-color: white; /* Changed to white */
            color: #0e7490; /* Dark blue text */
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            width: 100%; /* Take full width within its grid column */
            word-break: break-word;
            flex-grow: 1; /* Allow answer box to take available space */
            min-height: 48px; /* Ensure a consistent height regardless of content */
            display: flex; /* To vertically center content */
            align-items: center;
            justify-content: center;
        }
        .student-response-item .answer-box img {
            max-width: 100%; /* Make images responsive within the answer box */
            height: auto;
            max-height: 120px; /* Limit image height to prevent large images */
            object-fit: contain; /* Ensure image fits without cropping */
            display: block; /* Remove extra space below image */
            margin: 0 auto; /* Center image if it's smaller than max-width */
        }
        .student-response-item .answer-box audio {
            width: 100%;
            max-width: 200px; /* Limit audio player width */
        }
        /* New: Styles for custom multiple choice answers in teacher monitor */
        .student-response-item .mc-question-answer {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
            color: #334155;
        }
        .student-response-item .mc-question-answer .icon {
            font-size: 1.1rem;
        }
        .student-response-item .mc-question-answer .correct-icon {
            color: #16a34a; /* Green */
        }
        .student-response-item .mc-question-answer .incorrect-icon {
            color: #dc2626; /* Red */
        }
        .student-response-item .mc-question-answer .question-text {
            font-weight: 500;
        }
        .student-response-item .mc-question-answer .student-choice {
            font-weight: bold;
            color: #2563eb; /* Blue */
        }

        /* 互評投票相關樣式 */
        .peer-review-work-item {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid transparent;
        }
        
        .peer-review-work-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        .peer-review-work-item .work-author {
            background-color: #e0f2fe;
            color: #0369a1;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            font-weight: bold;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }
        
        .peer-review-work-item .work-content {
            flex-grow: 1;
            margin-bottom: 0.75rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .peer-review-work-item .work-content img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .peer-review-work-item .work-content p {
            padding: 0.5rem;
            background-color: #f8fafc;
            border-radius: 0.5rem;
            color: #374151;
            line-height: 1.5;
        }
        
        .peer-review-work-item .vote-section {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .peer-review-work-item .vote-btn {
            background: none;
            border: 2px solid transparent;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 3rem;
            height: 3rem;
            position: relative;
        }
        
        .peer-review-work-item .vote-btn:hover {
            background-color: #fef7f7;
            transform: scale(1.1);
            border-color: #fca5a5;
        }
        
        .peer-review-work-item .vote-btn.voted {
            color: #dc2626;
            background-color: #fef2f2;
            border-color: #dc2626;
            animation: pulse 2s infinite;
        }
        
        .peer-review-work-item .vote-btn:not(.voted) {
            color: #9ca3af;
            border-color: #e5e7eb;
        }
        
        .peer-review-work-item .vote-btn:not(.voted):hover {
            color: #dc2626;
            background-color: #fef7f7;
        }
        
        /* Pulse animation for voted buttons */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        /* Tooltip for vote buttons */
        .peer-review-work-item .vote-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: -2rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #374151;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
            z-index: 10;
        }
        
        .peer-review-work-item .vote-btn:hover::after {
            opacity: 1;
            visibility: visible;
        }
        
        .peer-review-work-item .vote-count {
            font-weight: bold;
            color: #dc2626;
            font-size: 1.1rem;
        }
        
        .peer-review-work-item .vote-count.zero {
            color: #9ca3af;
        }

        /* 教師端投票統計樣式 */
        .vote-stats-item {
            background-color: #f8fafc;
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            border: 1px solid #e2e8f0;
            position: relative;
        }
        
        .vote-stats-item .stats-author {
            background-color: #dbeafe;
            color: #1e40af;
            padding: 0.375rem 0.75rem;
            border-radius: 0.75rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        
        .vote-stats-item .stats-content {
            flex-grow: 1;
            margin-bottom: 0.5rem;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .vote-stats-item .stats-content img {
            max-width: 100%;
            height: auto;
            border-radius: 0.375rem;
            max-height: 120px;
            object-fit: contain;
        }
        
        .vote-stats-item .stats-content p {
            padding: 0.375rem;
            background-color: white;
            border-radius: 0.375rem;
            color: #374151;
            font-size: 0.875rem;
            line-height: 1.4;
        }
        
        .vote-stats-item .stats-votes {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem;
            background-color: #fef2f2;
            border-radius: 0.5rem;
            border: 1px solid #fecaca;
        }
        
        .vote-stats-item .stats-votes .vote-icon {
            color: #dc2626;
            font-size: 1.2rem;
        }
        
        .vote-stats-item .stats-votes .vote-count {
            font-weight: bold;
            color: #dc2626;
            font-size: 1.1rem;
        }
        
        .vote-stats-item .stats-votes .vote-count.zero {
            color: #9ca3af;
        }


        /* 放大繪圖 Modal 樣式 */
        .magnified-image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        /* API Error Modal - highest z-index to always show on top */
        #api-error-modal {
            z-index: 10000 !important;
        }
        .magnified-image-modal-content {
            position: relative;
            background-color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto; /* Allow scrolling for large content */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }

        /* 排序題和配對題的模態框樣式 */
        #sequencing-settings-modal-content,
        #matching-settings-modal-content {
            max-width: 95%;
            max-height: 95vh;
            width: 1200px;
            justify-content: flex-start;
            align-items: stretch;
        }

        /* 專注力遊戲設定模態框樣式 */
        #focus-game-settings-modal-content {
            max-width: 600px;
            width: 90%;
        }

        /* 專注力遊戲數字選項的選中狀態 */
        .focus-game-number-option.selected {
            background-color: #06b6d4 !important;
            border-color: #0891b2 !important;
        }

        .focus-game-number-option.selected .text-cyan-700 {
            color: white !important;
        }

        .focus-game-number-option.selected .text-gray-600 {
            color: #e0f2fe !important;
        }

        /* 查看題目模態框樣式 */
        #view-questions-modal-content {
            max-width: 60% !important;
            width: 60%;
        }
        .magnified-image-modal-content img {
            max-width: 100%;
            max-height: 80vh; /* Limit image height within modal */
            object-fit: contain;
        }
        .magnified-image-modal-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 2rem;
            color: #333;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        .magnified-image-modal-close:hover {
            background-color: #eee;
        }

        /* Dropdown styles for drawing tools */
        .drawing-tool-select {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            background-color: white;
            font-size: 1rem;
            height: 44px; /* Match button height for alignment */
            cursor: pointer;
            min-width: 100px; /* Ensure dropdown has minimum width */
            appearance: none; /* Remove default dropdown arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25em 1.25em;
        }

        /* Styles for color swatch in dropdown */
        .color-option-text {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .color-swatch {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1px solid #ccc;
            flex-shrink: 0; /* Prevent shrinking when text is long */
        }
        /* Hidden select for visual color swatch */
        #current-color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #2563eb; /* Highlight selected color */
            margin-right: 8px;
            display: inline-block;
            vertical-align: middle;
            flex-shrink: 0;
        }

        /* Made by link styling */
        .made-by-text {
            background-color: #e0f7fa; /* Light blue background */
            color: #007bff; /* Blue text */
            padding: 8px 15px;
            border-radius: 12px; /* Rounded corners */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-decoration: none; /* Remove underline */
            transition: background-color 0.3s ease;
        }
        .made-by-text:hover {
            background-color: #cceeff; /* Lighter blue on hover */
            color: #0056b3;
        }

        /* Modal for student list */
        #student-list-modal-content {
            padding: 1rem;
            max-width: 700px; /* Adjusted max-width for 5 columns */
            width: 100%;
        }
        /* Applying grid to modal-student-names */
        #modal-student-names {
            display: grid;
            /* Changed to fixed 5 columns on larger screens, responsive down to 100px min width */
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem; /* Gap between grid items */
            padding: 0.5rem; /* Padding for the grid container */
            max-height: 64vh; /* Adjusted to fit more height */
            overflow-y: auto;
            background-color: #f8fafc; /* Light background */
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
        }
        @media (min-width: 768px) { /* md breakpoint */
            #modal-student-names {
                grid-template-columns: repeat(5, 1fr); /* Fixed 5 columns for md and larger */
            }
        }
        #modal-student-names p {
            background-color: #e0f2f7; /* Light blue background for each name */
            padding: 0.5rem;
            border-radius: 0.375rem;
            text-align: center;
            font-size: 0.9rem;
            color: #0e7490;
            font-weight: 500;
            overflow: hidden; /* Hide overflow text */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
            white-space: nowrap; /* Prevent text wrapping */
            border-bottom: none; /* Remove individual border-bottom, handled by grid gap */
            margin: 0; /* Remove default paragraph margin */
            transition: all 0.2s ease-in-out; /* Add transition for smooth highlight */
        }
        /* No specific styling for the last-child within the grid items, as gap handles spacing */

        /* NEW: Styles for Unsubmitted Students Modal */
        #modal-unsubmitted-student-names {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem;
            padding: 0.5rem;
            max-height: 64vh;
            overflow-y: auto;
            background-color: #fef2f2; /* Light red background */
            border-radius: 0.5rem;
            border: 1px solid #fca5a5; /* Red border */
        }
        #modal-unsubmitted-student-names p {
            background-color: #fee2e2; /* Lighter red background for each name */
            padding: 0.5rem;
            border-radius: 0.375rem;
            text-align: center;
            font-size: 0.9rem;
            color: #b91c1c; /* Darker red text */
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin: 0;
        }
        @media (min-width: 768px) { /* md breakpoint */
            #modal-unsubmitted-student-names {
                grid-template-columns: repeat(5, 1fr);
            }
        }


        /* Styles for Chart Modal */
        #statistics-modal-content { /* Changed ID to match HTML */
            padding: 1rem;
            max-width: 600px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        #chart-svg {
            display: block;
            margin: 0 auto;
            background-color: #fff; /* Ensure chart background is white */
            border-radius: 0.5rem;
            flex-shrink: 0; /* Prevent shrinking */
        }
        #students-by-answer-list-container {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            background-color: #f8fafc;
        }
        #students-by-answer-list-container h5 {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #334155;
        }
        /* New style for the paragraph containing names */
        #students-by-answer-names {
            word-wrap: break-word; /* Allow long names to wrap */
            color: #475569;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* New CSS for selected student border */
        .selected-student-border {
            border: 4px solid #ef4444; /* Tailwind red-500 */
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.6); /* Optional: add a glow effect */
        }

        /* NEW CSS for selected student border in the modal */
        .modal-selected-student-border {
            border: 2px solid #ef4444; /* Red border */
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.4); /* Optional: add a glow effect */
            background-color: #fef2f2; /* Light red background */
        }


        /* AI Text Summary Modal Styles */
        #ai-summary-modal-content {
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            position: relative; /* Needed for close button positioning */
        }
        #ai-summary-modal-content h4 {
            font-size: 1.75rem;
            font-weight: bold;
            color: #334155;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        #ai-summary-result-list {
            list-style-type: none; /* Removed decimal numbering */
            padding-left: 0; /* Removed default padding for list */
            font-size: 1rem;
        }
        /* Default style for list items (successful results) */
        #ai-summary-result-list li {
            margin-bottom: 0.4rem;
            padding: 0.2rem 0;
            border-bottom: 1px dashed #e2e8f0;
            color: black; /* Changed to black */
            font-weight: bold; /* Added bold */
        }
        #ai-summary-result-list li:last-child {
            border-bottom: none;
        }
        /* Style for error messages within the list */
        #ai-summary-result-list li.error-message {
            color: white; /* White color for error messages */
            background-color: #dc2626; /* A red background for visual emphasis (optional, but good for error) */
            padding: 0.5rem;
            border-radius: 0.25rem;
            text-align: center;
        }
        #ai-loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100px; /* Ensure some height for spinner */
            color: #2563eb;
            font-size: 1.1rem;
        }

        /* AI Settings Modal Styles */
        #ai-settings-modal-content {
            padding: 1.5rem;
            max-width: 400px;
            width: 90%;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            position: relative;
        }
        #ai-settings-modal-content h4 {
            font-size: 1.75rem;
            font-weight: bold;
            color: #334155;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        #ai-settings-modal-content label {
            font-weight: 500;
            color: #475569;
            margin-bottom: 0.25rem;
            display: block;
        }
        #ai-settings-modal-content select,
        #ai-settings-modal-content input[type="password"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            background-color: white;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25em 1.25em;
        }
        #ai-settings-modal-content input[type="password"] {
            background-image: none; /* Remove dropdown arrow for password field */
        }
        .settings-button-group {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .settings-button-group .btn {
            width: auto;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
        }

        /* New: URL Dispatch Modal Styles */
        #url-dispatch-settings-modal-content {
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
        }
        #url-dispatch-settings-modal-content h4 {
            font-size: 1.75rem;
            font-weight: bold;
            color: #334155;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        #url-dispatch-settings-modal-content label {
            font-weight: 500;
            color: #475569;
            margin-bottom: 0.25rem;
            display: block;
        }
        #url-dispatch-settings-modal-content input[type="text"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-top: 1rem;
            gap: 0.5rem;
        }
        .checkbox-container input[type="checkbox"] {
            height: 1.25rem;
            width: 1.25rem;
            border-radius: 0.25rem;
            border-color: #d1d5db;
            color: #2563eb;
        }

        /* New: Student-side URL Dispatch Styles */
        #interaction-url-dispatch {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            padding: 1rem;
        }
        .url-card {
            background-color: #ffffff;
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
            color: inherit;
        }
        .url-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        .url-card-icon {
            font-size: 4rem;
            color: #2563eb;
        }
        .url-card-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e3a8a;
        }
        .url-card-link {
            font-size: 1rem;
            color: #6b7280;
            word-break: break-all;
        }
        .youtube-embed-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            background-color: #000; /* 添加黑色背景，如果影片載入失敗會看到 */
        }
        .youtube-embed-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        /* NEW: Pause Overlay for Student */
        .pause-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9); /* Semi-transparent white */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999; /* Below modals */
            border-radius: 0.5rem; /* Match container border-radius */
            text-align: center;
            padding: 1rem;
        }
        .pause-overlay p {
            font-size: 2rem;
            font-weight: bold;
            color: #dc2626; /* Red text */
            margin-bottom: 1rem;
        }
        .pause-overlay i {
            font-size: 4rem;
            color: #ef4444; /* Lighter red icon */
        }

        /* NEW: HTML Dispatch Styles */
        /* This ID is now reused for the combined dispatch, but the content will be in the iframe */
        #interaction-html-dispatch {
            position: fixed; /* Use fixed positioning to cover entire screen */
            top: 0;
            left: 0;
            width: 100vw; /* Full viewport width */
            height: 100vh; /* Full viewport height */
            margin: 0;
            padding: 0;
            border: none;
            overflow: hidden; /* Prevent scrolling at container level */
            background-color: white;
            z-index: 1000; /* Ensure it's above other content */
        }
        #html-content-iframe {
            width: 100vw; /* Full viewport width */
            height: 100vh; /* Full viewport height */
            margin: 0;
            padding: 0;
            border: none;
            background-color: white;
            display: block; /* Ensure no inline spacing */
        }

        /* HTML Dispatch Status Indicator */
        .html-dispatch-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: rgba(239, 68, 68, 0.9); /* Red background with transparency */
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1001; /* Above the HTML content */
            animation: blink-glow 1.5s ease-in-out infinite alternate;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        @keyframes blink-glow {
            0% {
                opacity: 0.7;
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
            }
            100% {
                opacity: 1;
                transform: scale(1.05);
                box-shadow: 0 4px 16px rgba(239, 68, 68, 0.6);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        .animate-fade-in-up {
            animation: fade-in-up 0.6s ease-out forwards;
        }

        /* NEW: Styles for enlarged default multiple-choice buttons */
        #interaction-multiple-choice.enlarged-buttons #default-mc-options .answer-btn {
            width: 12rem; /* Double the original 6rem (h-24) */
            height: 12rem; /* Double the original 6rem (h-24) */
            font-size: 8rem; /* Double the original 4rem (text-7xl) */
        }
        
        /* MODIFIED: MC Settings Modal for AI Question Generation */
        #multiple-choice-settings-modal {
            align-items: center; /* Center modal vertically */
        }

        #multiple-choice-settings-modal-content {
            max-width: 800px; /* Wider modal for two columns */
            max-height: 95vh; /* Increase max height */
            height: auto; /* Allow dynamic height */
            justify-content: flex-start; /* Align content to top */
            align-items: stretch; /* Stretch to full width */
            padding: 1.5rem; /* Increase padding */
            margin-top: 0; /* Remove top margin */
        }

        /* Sequencing Question Styles */
        .sequencing-item {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: grab;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.125rem;
            font-weight: 500;
        }
        .sequencing-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        .sequencing-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .sequencing-item.drag-over {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .sequencing-item-number {
            background-color: #3b82f6;
            color: white;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }
        .sequencing-container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* Matching Question Styles */
        .matching-container {
            max-width: 900px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            position: relative;
        }
        .matching-column {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .matching-item {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 3px solid transparent;
            font-size: 1.125rem;
            font-weight: 500;
            min-height: 4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .matching-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        .matching-item.selected {
            border-color: #ec4899;
            background-color: #fdf2f8;
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.2);
        }
        .matching-item.matched {
            border-color: #10b981;
            background-color: #ecfdf5;
            cursor: default;
        }
        .matching-item.matched:hover {
            transform: none;
        }
        #matching-svg-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        .matching-line {
            stroke: #ec4899;
            stroke-width: 3;
            fill: none;
            stroke-linecap: round;
        }
        .matching-line.correct {
            stroke: #10b981;
        }
        .matching-line.incorrect {
            stroke: #ef4444;
        }

        /* Reading Comprehension - Highlighter Styles */
        .highlighter-btn {
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .highlighter-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
        }
        .highlighter-btn.active {
            border-color: #374151 !important;
            border-width: 3px;
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.5);
        }
        .highlighter-btn.active::after {
            content: '✓';
            position: absolute;
            bottom: -2px;
            right: -2px;
            background-color: #374151;
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        #eraser-btn:hover, #reading-eraser-btn:hover, #reading-mouse-btn:hover {
            background-color: #f3f4f6;
            transform: scale(1.1);
        }
        #eraser-btn.active, #reading-eraser-btn.active, #reading-mouse-btn.active {
            background-color: #374151;
            border-color: #374151;
            border-width: 3px;
            position: relative;
        }
        #eraser-btn.active i, #reading-eraser-btn.active i, #reading-mouse-btn.active i {
            color: white;
        }
        #eraser-btn.active::after, #reading-eraser-btn.active::after, #reading-mouse-btn.active::after {
            content: '✓';
            position: absolute;
            bottom: -2px;
            right: -2px;
            background-color: #374151;
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            font-size: 10px;
            line-height: 16px;
            text-align: center;
        }

        /* Highlighted text spans */
        .highlight {
            padding: 2px 4px;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            border: 1px solid #000;
            display: inline;
        }
        .highlight:hover {
            opacity: 0.8;
        }
        .highlight.yellow {
            background-color: rgba(254, 240, 138, 0.8);
        }
        .highlight.green {
            background-color: rgba(134, 239, 172, 0.8);
        }
        .highlight.pink {
            background-color: rgba(253, 164, 175, 0.8);
        }
        .highlight.blue {
            background-color: rgba(147, 197, 253, 0.8);
        }

        /* Eraser mode cursor and hover effect */
        #reading-text-display.eraser-mode {
            cursor: pointer;
        }
        #reading-text-display.eraser-mode .highlight {
            cursor: pointer;
        }
        #reading-text-display.eraser-mode .highlight:hover {
            opacity: 0.5;
            text-decoration: line-through;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
        }

        /* Reading comprehension question cards */
        #reading-questions-container .question-card {
            background: linear-gradient(to right, #f0fdf4, #ecfdf5);
            border-left: 4px solid #10b981;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        #reading-questions-container .question-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateX(4px);
        }

        /* Touch device optimizations */
        #reading-text-display {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            -webkit-touch-callout: default;
        }

        /* Larger touch targets for highlighter buttons on mobile */
        @media (hover: none) and (pointer: coarse) {
            .highlighter-btn, #reading-eraser-btn, #reading-mouse-btn {
                min-width: 44px;
                min-height: 44px;
                touch-action: manipulation;
            }

            /* Improve touch feedback */
            .highlighter-btn:active, #reading-eraser-btn:active, #reading-mouse-btn:active {
                transform: scale(0.95);
                transition: transform 0.1s;
            }

            /* Make highlights easier to tap on touch devices */
            .highlight {
                padding: 4px 2px;
                min-height: 24px;
                display: inline-block;
            }
        }

        /* Disable pull-to-refresh on iOS/iPadOS */
        body {
            overscroll-behavior-y: none;
        }

        #interaction-reading-comprehension {
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="bg-indigo-50 text-slate-800">

    <div id="app-container" class="relative min-h-screen flex flex-col">

        <div id="entry-view" class="relative w-full h-screen flex flex-col items-center justify-around p-4 overflow-y-auto">
            
            <!-- 右上角按鈕區 -->
            <div class="absolute top-4 right-4 z-10 flex gap-2">
                <button id="firebase-settings-btn" class="inline-flex items-center px-4 py-2 bg-white/80 backdrop-blur-md hover:bg-white text-slate-600 text-sm font-medium rounded-xl shadow-sm border border-slate-200 transition-all duration-200" title="Firebase 設定">
                    <i class="fas fa-cog mr-2 text-slate-400"></i>
                    Firebase 設定
                </button>
                <a href="https://filedn.com/laMtL9jmKf7JrDEQG0A6OPy/html/%E5%89%9B%E5%A5%BD%E5%AD%B8%E6%9C%80%E6%96%B0%E7%89%88-%E5%BB%BA%E7%BD%AE%E6%89%8B%E5%86%8A/%E5%89%9B%E5%A5%BD%E5%AD%B8%E6%95%99%E5%B8%AB%E4%BD%BF%E7%94%A8%E5%BB%BA%E7%BD%AE%E6%89%8B%E5%86%8ANew.html" target="_blank" rel="noopener noreferrer"
                   class="inline-flex items-center px-4 py-2 bg-amber-100 hover:bg-amber-200 text-amber-700 text-sm font-medium rounded-xl shadow-sm border border-amber-200 transition-all duration-200">
                    <i class="fas fa-book-open mr-2"></i>
                    建置操作手冊
                </a>
            </div>

            <!-- Main Content wrapper -->
            <div class="w-full max-w-6xl mx-auto p-4 sm:p-6 flex flex-col items-center animate-fade-in-up">
                
                <div class="text-center mb-8">
                    <div class="flex items-center justify-center gap-3 mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center text-white text-2xl shadow-lg shadow-indigo-200">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <h1 class="text-4xl md:text-5xl font-bold text-slate-800">剛好學：課堂互動so easy</h1>
                    </div>
                    <p class="text-lg text-slate-500">一個專為現代課堂設計的即時互動工具</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full md:max-w-5xl">
                    
                    <!-- Teacher Section -->
                    <div class="landing-card group relative">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-pink-100 rounded-full -mr-16 -mt-16 group-hover:scale-110 transition duration-500"></div>
                        <div class="relative z-10 flex flex-col h-full">
                            <div class="w-16 h-16 bg-pink-100 text-pink-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:bg-pink-600 group-hover:text-white transition shadow-sm">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-slate-800 mb-2">我是教師</h2>
                            <p class="text-slate-500 mb-6">建立教室，發起互動，即時查看學生反饋。</p>
                            
                            <div class="mt-auto">
                                <button id="teacher-entry-btn" class="w-full py-3 bg-pink-500 text-white rounded-xl font-bold hover:bg-pink-600 transition shadow-lg shadow-pink-200">
                                    建立或進入教室 <i class="fas fa-arrow-right ml-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Student Section -->
                    <div class="landing-card group relative">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-sky-100 rounded-full -mr-16 -mt-16 group-hover:scale-110 transition duration-500"></div>
                        <div class="relative z-10 flex flex-col h-full">
                            <div class="w-16 h-16 bg-sky-100 text-sky-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:bg-sky-600 group-hover:text-white transition shadow-sm">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-slate-800 mb-2">我是學生</h2>
                            <p class="text-slate-500 mb-6">輸入教室代碼，參與課堂問答與互動。</p>
                            
                            <div class="mt-auto">
                                <button id="student-entry-btn" class="w-full py-3 bg-sky-500 text-white rounded-xl font-bold hover:bg-sky-600 transition shadow-lg shadow-sky-200">
                                    加入課堂 <i class="fas fa-sign-in-alt ml-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-8">
                    <p class="text-xs text-slate-400">
                        App ID: <span id="app-id-display"></span> &nbsp;&bull;&nbsp;
                        User ID: <span id="user-id-display"></span>
                        <span id="firebase-project-id-display-wrapper" class="hidden">
                            &nbsp;&bull;&nbsp; Firebase Project: <span id="firebase-project-id-display" class="font-semibold text-green-600"></span>
                        </span>
                    </p>
                    <div class="mt-2 text-slate-400 text-sm">
                        Made with <i class="fas fa-heart text-pink-400 mx-1"></i> by <a href="https://kentxchang.blogspot.tw" target="_blank" rel="noopener noreferrer" class="text-indigo-500 hover:text-indigo-600 font-bold hover:underline">阿剛老師 V4.8</a>
                    </div>
                    <div class="mt-4 text-slate-500 text-xs max-w-2xl mx-auto px-4">
                        <p class="mb-2">
                            本作品採用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener noreferrer" class="text-indigo-500 hover:text-indigo-600 font-semibold hover:underline">CC BY-NC-SA 4.0 創用CC授權</a>。
                        </p>
                        <p class="text-slate-400">
                            歡迎非商業用途轉載、引用或改編，請保留「阿剛老師」署名，並附上本作品原始連結。
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div id="teacher-classroom-code-view" class="hidden text-center w-full max-w-md mx-auto mt-10">
            <div class="landing-card p-8">
                <div class="mb-6 inline-block p-4 bg-blue-100 text-blue-600 rounded-full text-3xl">
                    <i class="fas fa-chalkboard-user"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 mb-6">教師登入：請輸入教室代碼</h2>
                <div class="space-y-4">
                    <!-- 已開啟教室代碼選單 -->
                    <div id="teacher-recent-classrooms-container" class="hidden mb-4 text-left">
                        <label class="block text-sm font-bold text-slate-500 mb-2 uppercase tracking-wider">選擇已開啟的教室</label>
                        <select id="teacher-recent-classrooms-select" class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50 focus:bg-white transition">
                            <option value="">-- 選擇教室代碼 --</option>
                        </select>
                    </div>

                    <div class="relative flex items-center py-2">
                        <div class="flex-grow border-t border-slate-200"></div>
                        <span class="flex-shrink-0 mx-4 text-slate-400 text-xs">或手動輸入</span>
                        <div class="flex-grow border-t border-slate-200"></div>
                    </div>

                    <input type="text" id="teacher-classroom-code-input" placeholder="請輸入自訂教室代碼" class="w-full p-3 border border-slate-200 rounded-xl text-lg focus:ring-2 focus:ring-blue-500 outline-none transition bg-slate-50 focus:bg-white text-center font-bold text-slate-700">
                    
                    <button id="teacher-classroom-code-submit-btn" class="w-full py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl font-bold hover:shadow-lg hover:from-blue-600 hover:to-indigo-700 transition transform hover:-translate-y-0.5 shadow-blue-200">
                        進入教師面板 <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                    <button id="teacher-classroom-code-back-btn" class="w-full py-2 text-slate-400 text-sm hover:text-slate-600 font-medium transition">
                        <i class="fas fa-arrow-left mr-1"></i> 返回
                    </button>
                </div>
            </div>
        </div>

        <div id="teacher-menu-view" class="hidden text-center relative w-full max-w-6xl mx-auto p-4">
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                    <i class="fas fa-layer-group text-indigo-500"></i> 教師面板：請選擇互動模式
                </h2>
                
                <div class="flex items-center gap-3 mt-4 md:mt-0">
                    <button id="end-class-session-menu-btn" class="px-4 py-2 bg-red-50 text-red-600 rounded-lg text-sm font-bold hover:bg-red-100 transition border border-red-100 flex items-center">
                        <i class="fas fa-door-open mr-2"></i> <span id="end-class-button-text">下課 🔚</span>
                    </button>
                    
                    <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-50 border border-slate-200">
                        <div id="student-status-area" class="text-slate-600 text-sm font-medium cursor-pointer flex items-center justify-center hover:text-indigo-600 transition-colors">
                            <span>在線人數: <span id="active-student-count" class="font-bold text-indigo-600 text-lg">0</span></span>
                        </div>
                        <button id="refresh-student-count-btn" class="text-slate-400 hover:text-indigo-600 transition-colors" title="更新統計">
                            <i class="fas fa-rotate"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mx-auto w-full">
                <button data-mode="true_false" class="landing-card hover:scale-105 transition transform duration-200 !p-6 flex flex-col items-center justify-center gap-3 group">
                    <div class="w-14 h-14 rounded-2xl bg-blue-100 text-blue-600 flex items-center justify-center text-2xl group-hover:bg-blue-600 group-hover:text-white transition">
                        <i class="fas fa-check"></i>
                    </div>
                    <span class="font-bold text-slate-700 text-lg">是非題</span>
                </button>
                <button id="choice-sequencing-matching-menu-btn" class="landing-card hover:scale-105 transition transform duration-200 !p-6 flex flex-col items-center justify-center gap-3 group">
                    <div class="w-14 h-14 rounded-2xl bg-green-100 text-green-600 flex items-center justify-center text-2xl group-hover:bg-green-600 group-hover:text-white transition">
                        <i class="fas fa-list-ol"></i>
                    </div>
                    <span class="font-bold text-slate-700 text-lg">選擇/排序/配對</span>
                </button>
                <button data-mode="text_input" class="landing-card hover:scale-105 transition transform duration-200 !p-6 flex flex-col items-center justify-center gap-3 group">
                    <div class="w-14 h-14 rounded-2xl bg-orange-100 text-orange-600 flex items-center justify-center text-2xl group-hover:bg-orange-600 group-hover:text-white transition">
                        <i class="fas fa-comment-dots"></i>
                    </div>
                    <span class="font-bold text-slate-700 text-lg">文字題</span>
                </button>
                <button data-mode="word_cloud" class="landing-card hover:scale-105 transition transform duration-200 !p-6 flex flex-col items-center justify-center gap-3 group">
                    <div class="w-14 h-14 rounded-2xl bg-pink-100 text-pink-600 flex items-center justify-center text-2xl group-hover:bg-pink-600 group-hover:text-white transition">
                        <i class="fas fa-cloud"></i>
                    </div>
                    <span class="font-bold text-slate-700 text-lg">即時文字雲</span>
                </button>
                <button data-mode="drawing" class="landing-card hover:scale-105 transition transform duration-200 !p-6 flex flex-col items-center justify-center gap-3 group">
                    <div class="w-14 h-14 rounded-2xl bg-purple-100 text-purple-600 flex items-center justify-center text-2xl group-hover:bg-purple-600 group-hover:text-white transition">
                        <i class="fas fa-palette"></i>
                    </div>
                    <span class="font-bold text-slate-700 text-lg">繪圖題</span>
                </button>
                <button data-mode="url_dispatch" class="landing-card hover:scale-105 transition transform duration-200 !p-6 flex flex-col items-center justify-center gap-3 group">
                    <div class="w-14 h-14 rounded-2xl bg-teal-100 text-teal-600 flex items-center justify-center text-2xl group-hover:bg-teal-600 group-hover:text-white transition">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                    <span class="font-bold text-slate-700 text-lg">派送網址/HTML</span>
                </button>
                <button data-mode="recording" class="landing-card hover:scale-105 transition transform duration-200 !p-6 flex flex-col items-center justify-center gap-3 group">
                    <div class="w-14 h-14 rounded-2xl bg-indigo-100 text-indigo-600 flex items-center justify-center text-2xl group-hover:bg-indigo-600 group-hover:text-white transition">
                        <i class="fas fa-microphone"></i>
                    </div>
                    <span class="font-bold text-slate-700 text-lg">錄音題</span>
                </button>
                <button id="reading-comprehension-settings-btn" class="landing-card hover:scale-105 transition transform duration-200 !p-6 flex flex-col items-center justify-center gap-3 group">
                    <div class="w-14 h-14 rounded-2xl bg-rose-100 text-rose-600 flex items-center justify-center text-2xl group-hover:bg-rose-600 group-hover:text-white transition">
                        <i class="fas fa-book-open-reader"></i>
                    </div>
                    <span class="font-bold text-slate-700 text-lg">閱讀測驗</span>
                </button>
                <button data-mode="sticky_note" class="landing-card hover:scale-105 transition transform duration-200 !p-6 flex flex-col items-center justify-center gap-3 group">
                    <div class="w-14 h-14 rounded-2xl bg-amber-100 text-amber-600 flex items-center justify-center text-2xl group-hover:bg-amber-600 group-hover:text-white transition">
                        <i class="fas fa-note-sticky"></i>
                    </div>
                    <span class="font-bold text-slate-700 text-lg">便利貼牆</span>
                </button>
                <button id="focus-game-settings-btn" class="landing-card hover:scale-105 transition transform duration-200 !p-6 flex flex-col items-center justify-center gap-3 group">
                    <div class="w-14 h-14 rounded-2xl bg-cyan-100 text-cyan-600 flex items-center justify-center text-2xl group-hover:bg-cyan-600 group-hover:text-white transition">
                        <i class="fas fa-brain"></i>
                    </div>
                    <span class="font-bold text-slate-700 text-lg">專注力遊戲</span>
                </button>
                <button data-mode="quick_answer" class="landing-card hover:scale-105 transition transform duration-200 !p-6 flex flex-col items-center justify-center gap-3 group">
                    <div class="w-14 h-14 rounded-2xl bg-amber-100 text-amber-600 flex items-center justify-center text-2xl group-hover:bg-amber-600 group-hover:text-white transition">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <span class="font-bold text-slate-700 text-lg">搶答</span>
                </button>
                <button id="quick-poll-settings-btn" class="landing-card hover:scale-105 transition transform duration-200 !p-6 flex flex-col items-center justify-center gap-3 group">
                    <div class="w-14 h-14 rounded-2xl bg-lime-100 text-lime-600 flex items-center justify-center text-2xl group-hover:bg-lime-600 group-hover:text-white transition">
                        <i class="fas fa-square-poll-vertical"></i>
                    </div>
                    <span class="font-bold text-slate-700 text-lg">快速投票</span>
                </button>
            </div>

            <div class="mt-8 flex flex-col items-center bg-white p-6 rounded-2xl shadow-sm border border-slate-100 max-w-2xl mx-auto">
                <h3 class="text-lg font-bold text-slate-700 mb-4 flex items-center"><i class="fas fa-image mr-2 text-purple-500"></i> 背景圖片設定 (繪圖題用)</h3>
                <div class="flex flex-wrap justify-center gap-4 mb-4 w-full">
                    <label for="teacher-image-upload-input" class="flex-1 min-w-[160px] py-3 px-4 bg-purple-50 text-purple-700 rounded-xl font-bold hover:bg-purple-100 transition border border-purple-200 flex items-center justify-center cursor-pointer">
                        <i class="fas fa-cloud-arrow-up mr-2"></i> 上傳圖片
                    </label>
                    <input type="file" id="teacher-image-upload-input" accept="image/*" class="hidden">
                    <button id="clear-teacher-background-btn" class="flex-1 min-w-[160px] py-3 px-4 bg-red-50 text-red-600 rounded-xl font-bold hover:bg-red-100 transition border border-red-200 flex items-center justify-center">
                        <i class="fas fa-trash-can mr-2"></i> 清除背景
                    </button>
                </div>
                <p id="teacher-image-status" class="text-slate-400 text-sm">目前沒有背景圖片。可選擇檔案或直接貼上(Ctrl+V)。</p>
                <div id="teacher-image-preview-container" class="mt-4 hidden border border-slate-200 rounded-xl p-2 max-w-xs bg-slate-50">
                    <img id="teacher-image-preview" src="" alt="背景圖片預覽" class="w-full h-auto rounded-lg object-contain shadow-sm">
                </div>
            </div>

            <div class="flex justify-between items-center mt-8 px-4">
                <button id="leave-classroom-btn" class="px-4 py-2 text-slate-500 hover:text-slate-700 font-medium transition flex items-center" title="暫離教室（保留資料）">
                    <i class="fas fa-arrow-right-from-bracket mr-2"></i>暫離教室
                </button>
                <div class="flex gap-4">
                    <button id="ai-settings-btn" class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 hover:bg-blue-100 hover:text-blue-600 transition flex items-center justify-center text-lg shadow-sm" title="AI 設定">
                        <i class="fas fa-robot"></i>
                    </button>
                    <button id="url-dispatch-settings-btn" class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 hover:bg-teal-100 hover:text-teal-600 transition flex items-center justify-center text-lg shadow-sm" title="設定派送網址/HTML">
                        <i class="fas fa-link"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="teacher-monitor-view" class="hidden w-full max-w-[95%] mx-auto p-4">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 mb-6 flex flex-col lg:flex-row justify-between items-center gap-4 sticky top-4 z-20 backdrop-blur-sm bg-white/90">
                <div class="flex items-center gap-4"> 
                    <button id="end-class-session-monitor-btn" class="px-4 py-2 bg-red-500 text-white rounded-xl text-sm font-bold hover:bg-red-600 transition shadow-md shadow-red-200 flex items-center" title="下課並清空資料">
                        <i class="fas fa-door-open mr-2"></i> <span id="end-class-monitor-button-text">下課</span>
                    </button>
                    <h2 class="text-2xl font-bold text-slate-800 tracking-tight"></h2>
                </div>
                <div class="flex flex-wrap justify-center gap-2">
                     <button id="toggle-pause-btn" class="monitor-btn bg-slate-700 text-white hover:bg-slate-800">
                        <i class="fas fa-pause mr-1.5"></i> <span id="toggle-pause-btn-text">暫停</span>
                     </button>
                     <button id="draw-lottery-btn" class="monitor-btn bg-orange-500 text-white hover:bg-orange-600 shadow-orange-200">抽籤 🎲</button> 
                     <button id="show-unsubmitted-students-btn" class="monitor-btn bg-amber-500 text-white hover:bg-amber-600 shadow-amber-200 hidden">未作答 📝</button>
                     <button id="ai-text-summary-btn" class="monitor-btn bg-violet-600 text-white hover:bg-violet-700 shadow-violet-200 hidden">AI 分析 🤖</button> 
                     <button id="download-media-btn" class="monitor-btn bg-purple-500 text-white hover:bg-purple-600 shadow-purple-200 hidden">下載媒體 💾</button> 
                     <button id="show-statistics-btn" class="monitor-btn bg-blue-500 text-white hover:bg-blue-600 shadow-blue-200 hidden">統計 📊</button>
                     <button id="start-peer-review-btn" class="monitor-btn bg-teal-500 text-white hover:bg-teal-600 shadow-teal-200 hidden">互評 ❤️</button>
                     <button id="view-questions-btn" class="monitor-btn bg-indigo-500 text-white hover:bg-indigo-600 shadow-indigo-200 hidden">題目 📝</button>
                     <button id="view-reading-questions-btn" class="monitor-btn bg-rose-500 text-white hover:bg-rose-600 shadow-rose-200 hidden">題目 📖</button>
                     <button id="download-responses-btn" class="monitor-btn bg-emerald-500 text-white hover:bg-emerald-600 shadow-emerald-200 hidden">下載 📥</button>
                     <button id="end-interaction-btn" class="monitor-btn bg-slate-200 text-slate-600 hover:bg-slate-300 font-bold border border-slate-300">結束 🛑</button>
                 </div>
            </div>

            <!-- Word Cloud Display Area (Teacher) -->
            <div id="word-cloud-display" class="hidden bg-white p-6 rounded-2xl border border-slate-200 h-[calc(100vh-180px)] overflow-hidden flex flex-col items-center justify-center">
                <div class="w-full h-full flex items-center justify-center">
                    <svg id="word-cloud-svg" class="w-full h-full"></svg>
                </div>
                <p class="text-sm text-slate-500 mt-4">即時文字雲 - 學生輸入的關鍵字將即時顯示</p>
            </div>

            <!-- Sticky Note Wall Display Area (Teacher) -->
            <div id="sticky-note-wall" class="hidden bg-gradient-to-br from-slate-50 to-slate-100 rounded-2xl border border-slate-200 h-[calc(100vh-180px)] overflow-hidden relative">
                <!-- Toolbar -->
                <div class="absolute top-0 left-0 right-0 bg-white/90 backdrop-blur-sm border-b border-slate-200 p-3 flex items-center gap-4 z-[2000]">
                    <!-- Scale Controls -->
                    <div class="flex items-center gap-2 border-r border-slate-300 pr-4">
                        <span class="text-sm font-medium text-slate-600">縮放：</span>
                        <button id="sticky-zoom-out" class="w-8 h-8 rounded bg-slate-200 hover:bg-slate-300 flex items-center justify-center text-slate-700" title="縮小">
                            <i class="fas fa-minus text-xs"></i>
                        </button>
                        <span id="sticky-zoom-level" class="text-sm font-bold text-slate-700 w-12 text-center">100%</span>
                        <button id="sticky-zoom-in" class="w-8 h-8 rounded bg-slate-200 hover:bg-slate-300 flex items-center justify-center text-slate-700" title="放大">
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                        <button id="sticky-zoom-reset" class="px-3 h-8 rounded bg-slate-200 hover:bg-slate-300 text-xs font-medium text-slate-700" title="重置">
                            重置
                        </button>
                    </div>

                    <!-- Mode Toggle -->
                    <div class="flex items-center gap-2 border-r border-slate-300 pr-4">
                        <span class="text-sm font-medium text-slate-600">模式：</span>
                        <button id="mouse-mode" class="w-8 h-8 rounded bg-blue-500 text-white flex items-center justify-center" title="滑鼠模式">
                            <i class="fas fa-mouse-pointer text-xs"></i>
                        </button>
                        <button id="draw-mode" class="w-8 h-8 rounded bg-slate-200 hover:bg-slate-300 flex items-center justify-center text-slate-700" title="繪圖模式">
                            <i class="fas fa-pencil-alt text-xs"></i>
                        </button>
                    </div>

                    <!-- Drawing Tools -->
                    <div class="flex items-center gap-2 opacity-50" id="drawing-tools">
                        <span class="text-sm font-medium text-slate-600">畫筆：</span>
                        <button id="pen-tool" class="w-8 h-8 rounded bg-slate-200 hover:bg-slate-300 flex items-center justify-center text-slate-700" title="畫筆">
                            <i class="fas fa-pen text-xs"></i>
                        </button>
                        <button id="eraser-tool" class="w-8 h-8 rounded bg-slate-200 hover:bg-slate-300 flex items-center justify-center text-slate-700" title="橡皮擦">
                            <i class="fas fa-eraser text-xs"></i>
                        </button>

                        <!-- Color Picker -->
                        <div class="flex gap-1">
                            <button class="pen-color w-6 h-6 rounded border-2 border-slate-400" style="background: #000000" data-color="#000000" title="黑色"></button>
                            <button class="pen-color w-6 h-6 rounded border border-slate-300" style="background: #ef4444" data-color="#ef4444" title="紅色"></button>
                            <button class="pen-color w-6 h-6 rounded border border-slate-300" style="background: #3b82f6" data-color="#3b82f6" title="藍色"></button>
                            <button class="pen-color w-6 h-6 rounded border border-slate-300" style="background: #10b981" data-color="#10b981" title="綠色"></button>
                            <button class="pen-color w-6 h-6 rounded border border-slate-300" style="background: #f59e0b" data-color="#f59e0b" title="橙色"></button>
                        </div>

                        <!-- Line Width -->
                        <select id="pen-width" class="h-8 px-2 rounded border border-slate-300 text-xs">
                            <option value="2">細</option>
                            <option value="4" selected>中</option>
                            <option value="8">粗</option>
                        </select>

                        <button id="clear-canvas" class="px-3 h-8 rounded bg-red-100 hover:bg-red-200 text-red-700 text-xs font-medium" title="清除畫記">
                            清除畫記
                        </button>
                    </div>
                </div>

                <!-- Content Area -->
                <div id="sticky-wall-scroll" class="absolute top-16 left-0 right-0 bottom-0 overflow-hidden">
                    <!-- Drawing Canvas Layer (Top) -->
                    <canvas id="sticky-drawing-canvas" class="absolute top-0 left-0 pointer-events-none w-full h-full" style="z-index: 1000;"></canvas>

                    <!-- Sticky Notes Container (Bottom) -->
                    <div id="sticky-notes-container" class="absolute top-0 left-0 w-full h-full" style="z-index: 1;">
                        <div class="text-center py-10 text-slate-400 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2" id="sticky-note-placeholder">
                            <i class="fas fa-note-sticky text-4xl mb-4"></i>
                            <p class="text-lg font-medium">等待學生送出便利貼...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Focus Game Results Display (Teacher) -->
            <div id="focus-game-results" class="hidden bg-gradient-to-br from-cyan-50 to-blue-50 p-6 rounded-2xl border-2 border-cyan-200 h-[calc(100vh-180px)] overflow-y-auto">
                <div class="mb-6 text-center">
                    <h3 class="text-2xl font-bold text-cyan-700 flex items-center justify-center gap-2">
                        <i class="fas fa-trophy"></i> 專注力遊戲 - 完成時間
                    </h3>
                    <p class="text-sm text-slate-600 mt-2">學生按時間分組顯示</p>
                </div>

                <!-- Time Groups Container -->
                <div id="focus-time-groups" class="space-y-4">
                    <div class="text-center py-20 text-slate-400">
                        <i class="fas fa-hourglass-start text-4xl mb-4"></i>
                        <p class="text-lg font-medium">等待學生完成遊戲...</p>
                    </div>
                </div>
            </div>

            <div id="student-responses-container" class="bg-slate-100 p-6 rounded-2xl border border-slate-200 h-[calc(100vh-180px)] overflow-y-auto grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 content-start">
                <div class="col-span-full flex flex-col items-center justify-center py-20 text-slate-400">
                    <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                    <p class="text-lg font-medium">正在等待學生作答...</p>
                </div>
            </div>
            
            <div id="peer-review-stats-container" class="hidden mt-6">
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <h3 class="text-xl font-bold text-slate-800 mb-4 text-center flex items-center justify-center gap-2">
                        <span class="w-8 h-8 rounded-full bg-teal-100 text-teal-600 flex items-center justify-center text-sm"><i class="fas fa-chart-simple"></i></span>
                        即時投票統計
                    </h3>
                    <div id="peer-review-stats-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                        <p class="text-slate-400 text-center col-span-full py-8">尚未開始互評...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="student-name-view" class="hidden text-center w-full max-w-md mx-auto mt-10">
            <div class="landing-card p-8">
                <div class="mb-6 inline-block p-4 bg-green-100 text-green-600 rounded-full text-3xl">
                    <i class="fas fa-user-tag"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 mb-6">請輸入教室代碼與您的姓名</h2>
                <div class="space-y-4">
                    <input type="text" id="student-classroom-code-input" placeholder="請輸入教室代碼" class="w-full p-3 border border-slate-200 rounded-xl text-lg focus:ring-2 focus:ring-green-500 outline-none transition bg-slate-50 focus:bg-white text-center font-bold text-slate-700">
                    <input type="text" id="student-name-input" placeholder="例如：王小明" class="w-full p-3 border border-slate-200 rounded-xl text-lg focus:ring-2 focus:ring-green-500 outline-none transition bg-slate-50 focus:bg-white text-center font-bold text-slate-700">
                    <button id="submit-name-btn" class="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-bold hover:shadow-lg hover:from-green-600 hover:to-emerald-700 transition transform hover:-translate-y-0.5 shadow-green-200">
                        進入教室 <i class="fas fa-door-open ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="student-waiting-view" class="hidden text-center w-full max-w-md mx-auto mt-20">
             <div class="landing-card p-10">
                 <div class="mb-6 inline-block p-4 bg-indigo-50 text-indigo-500 rounded-full text-4xl animate-bounce">
                    <i class="fas fa-child-reaching"></i>
                 </div>
                 <h2 id="student-welcome-msg" class="text-2xl font-bold text-slate-800 mb-4"></h2>
                 <div class="flex items-center justify-center space-x-3 text-lg text-slate-500 bg-slate-50 py-3 px-6 rounded-full inline-flex">
                    <i class="fas fa-spinner fa-spin text-indigo-500"></i>
                    <p>請等待老師開始互動...</p>
                </div>
            </div>
        </div>
        
        <div id="student-interaction-view" class="hidden relative w-full h-full min-h-screen">
            <div id="student-pause-overlay" class="pause-overlay hidden backdrop-blur-sm bg-white/80">
                <div class="bg-white p-8 rounded-3xl shadow-2xl border-4 border-red-100 text-center animate-bounce">
                    <i class="fas fa-hand text-6xl text-red-500 mb-4 block"></i>
                    <p class="text-2xl font-bold text-red-600">老師已暫停回覆</p>
                </div>
            </div>

            <div id="interaction-true-false" class="hidden w-full max-w-4xl mx-auto pt-10 text-center">
                <h3 class="text-3xl font-bold text-slate-800 mb-10 flex items-center justify-center gap-3">
                    <span class="bg-blue-100 text-blue-600 p-2 rounded-lg"><i class="fas fa-check"></i></span> 是非題
                </h3>
                <div class="flex justify-center gap-8">
                    <button data-answer="O" class="answer-btn text-8xl w-40 h-40 rounded-3xl bg-green-500 text-white flex items-center justify-center shadow-xl shadow-green-200 transform hover:scale-110 hover:rotate-3 transition duration-200 border-b-8 border-green-700 active:border-b-0 active:translate-y-2">O</button>
                    <button data-answer="X" class="answer-btn text-8xl w-40 h-40 rounded-3xl bg-red-500 text-white flex items-center justify-center shadow-xl shadow-red-200 transform hover:scale-110 hover:-rotate-3 transition duration-200 border-b-8 border-red-700 active:border-b-0 active:translate-y-2">X</button>
                </div>
            </div>
            <div id="interaction-multiple-choice" class="hidden flex flex-col items-center w-full max-w-4xl mx-auto pt-10">
                <h3 class="text-3xl font-bold text-slate-800 mb-10 flex items-center justify-center gap-3">
                    <span class="bg-green-100 text-green-600 p-2 rounded-lg"><i class="fas fa-list-ul"></i></span> 選擇題
                </h3>
                <div id="default-mc-options" class="grid grid-cols-2 gap-6 w-full max-w-2xl px-4">
                     <button data-answer="1" class="answer-btn btn bg-blue-500 hover:bg-blue-600 h-32 text-7xl rounded-2xl shadow-lg shadow-blue-200 border-b-8 border-blue-700 active:border-b-0 active:translate-y-2 transition-all">1</button>
                     <button data-answer="2" class="answer-btn btn bg-yellow-500 hover:bg-yellow-600 h-32 text-7xl rounded-2xl shadow-lg shadow-yellow-200 border-b-8 border-yellow-700 active:border-b-0 active:translate-y-2 transition-all">2</button>
                     <button data-answer="3" class="answer-btn btn bg-green-500 hover:bg-green-600 h-32 text-7xl rounded-2xl shadow-lg shadow-green-200 border-b-8 border-green-700 active:border-b-0 active:translate-y-2 transition-all">3</button>
                     <button data-answer="4" class="answer-btn btn bg-red-500 hover:bg-red-600 h-32 text-7xl rounded-2xl shadow-lg shadow-red-200 border-b-8 border-red-700 active:border-b-0 active:translate-y-2 transition-all">4</button>
                </div>
                <div id="custom-mc-questions-container" class="hidden w-full max-w-3xl space-y-6 text-left px-4">
                    </div>
                <button id="submit-custom-mc-btn" class="btn bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 mt-8 hidden max-w-sm mx-auto rounded-xl shadow-lg">送出全部答案 <i class="fas fa-paper-plane ml-2"></i></button>
            </div>
            <div id="interaction-text-input" class="hidden text-center w-full max-w-3xl mx-auto pt-10 px-4">
                 <h3 class="text-3xl font-bold text-slate-800 mb-8 flex items-center justify-center gap-3">
                    <span class="bg-orange-100 text-orange-600 p-2 rounded-lg"><i class="fas fa-comment-dots"></i></span> 文字題
                 </h3>
                 <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
                    <textarea id="text-input-area" rows="6" class="w-full p-4 border border-slate-200 rounded-xl text-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-slate-50 focus:bg-white transition resize-none" placeholder="請在此輸入您的回答..."></textarea>
                 </div>
                 <button id="submit-text-btn" class="btn bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 mt-6 max-w-xs mx-auto rounded-xl shadow-lg shadow-orange-200 text-lg py-3">送出回答 <i class="fas fa-paper-plane ml-2"></i></button>
            </div>

            <!-- Word Cloud Interaction (Student) -->
            <div id="interaction-word-cloud" class="hidden text-center w-full max-w-3xl mx-auto pt-10 px-4">
                 <h3 class="text-3xl font-bold text-slate-800 mb-8 flex items-center justify-center gap-3">
                    <span class="bg-pink-100 text-pink-600 p-2 rounded-lg"><i class="fas fa-cloud"></i></span> 即時文字雲
                 </h3>
                 <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
                    <p class="text-slate-600 mb-4 text-sm">請輸入關鍵字或短語（限制10字以內）</p>
                    <input type="text" id="word-cloud-input" maxlength="10" class="w-full p-4 border border-slate-200 rounded-xl text-lg focus:outline-none focus:ring-2 focus:ring-pink-500 bg-slate-50 focus:bg-white transition text-center font-bold" placeholder="例如：創意、快樂、學習..." />
                    <p class="text-xs text-slate-400 mt-2">已輸入：<span id="word-cloud-char-count">0</span>/10 字</p>
                 </div>
                 <button id="submit-word-cloud-btn" class="btn bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 mt-6 max-w-xs mx-auto rounded-xl shadow-lg shadow-pink-200 text-lg py-3">送出 <i class="fas fa-paper-plane ml-2"></i></button>
            </div>

            <!-- Sticky Note Interaction (Student) -->
            <div id="interaction-sticky-note" class="hidden text-center w-full max-w-3xl mx-auto pt-10 px-4">
                 <h3 class="text-3xl font-bold text-slate-800 mb-8 flex items-center justify-center gap-3">
                    <span class="bg-amber-100 text-amber-600 p-2 rounded-lg"><i class="fas fa-note-sticky"></i></span> 便利貼牆
                 </h3>

                 <!-- Tab selection -->
                 <div class="flex gap-2 mb-6 justify-center">
                    <button id="sticky-text-tab" class="px-6 py-3 rounded-xl font-bold bg-amber-500 text-white transition">
                        <i class="fas fa-font mr-2"></i>文字
                    </button>
                    <button id="sticky-image-tab" class="px-6 py-3 rounded-xl font-bold bg-slate-200 text-slate-600 transition hover:bg-slate-300">
                        <i class="fas fa-image mr-2"></i>圖片
                    </button>
                 </div>

                 <!-- Text input section -->
                 <div id="sticky-text-section" class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
                    <p class="text-slate-600 mb-4 text-sm">請輸入您的想法或意見（單行文字）</p>
                    <input type="text" id="sticky-note-text" class="w-full p-4 border border-slate-200 rounded-xl text-lg focus:outline-none focus:ring-2 focus:ring-amber-500 bg-slate-50 focus:bg-white transition" placeholder="在此輸入文字...">
                    <p class="text-xs text-slate-400 mt-2">已輸入：<span id="sticky-text-char-count">0</span> 字</p>
                 </div>

                 <!-- Image upload section -->
                 <div id="sticky-image-section" class="hidden bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
                    <p class="text-slate-600 mb-4 text-sm">請選擇或拍攝圖片</p>
                    <div class="flex flex-col gap-3">
                        <input type="file" id="sticky-image-input" accept="image/*" class="hidden">
                        <button id="sticky-select-image-btn" class="btn bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 rounded-xl shadow-lg">
                            <i class="fas fa-folder-open mr-2"></i>選擇圖片
                        </button>
                        <button id="sticky-capture-image-btn" class="btn bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 rounded-xl shadow-lg">
                            <i class="fas fa-camera mr-2"></i>拍攝照片
                        </button>
                    </div>
                    <div id="sticky-image-preview" class="hidden mt-4">
                        <img id="sticky-preview-img" class="max-w-full max-h-64 mx-auto rounded-xl border-2 border-amber-300">
                    </div>
                 </div>

                 <button id="submit-sticky-note-btn" class="btn bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 mt-6 max-w-xs mx-auto rounded-xl shadow-lg shadow-amber-200 text-lg py-3">送出便利貼 <i class="fas fa-paper-plane ml-2"></i></button>
            </div>

            <!-- Focus Game Interaction (Student) -->
            <div id="interaction-focus-game" class="hidden text-center w-full max-w-4xl mx-auto pt-10 px-4">
                <h3 class="text-3xl font-bold text-slate-800 mb-6 flex items-center justify-center gap-3">
                    <span class="bg-cyan-100 text-cyan-600 p-2 rounded-lg"><i class="fas fa-brain"></i></span> 專注力遊戲
                </h3>

                <!-- Game Instructions -->
                <div id="focus-game-instructions" class="bg-gradient-to-br from-cyan-50 to-blue-50 p-6 rounded-2xl shadow-lg border-2 border-cyan-200 mb-6">
                    <h4 class="text-xl font-bold text-cyan-700 mb-4 flex items-center justify-center gap-2">
                        <i class="fas fa-info-circle"></i> 遊戲說明
                    </h4>
                    <div class="text-left text-slate-700 space-y-2 max-w-2xl mx-auto">
                        <p class="flex items-start gap-2">
                            <i class="fas fa-circle-check text-cyan-500 mt-1 flex-shrink-0"></i>
                            <span>在 6×6 的方格中，找到數字 1 並點擊開始</span>
                        </p>
                        <p class="flex items-start gap-2">
                            <i class="fas fa-circle-check text-cyan-500 mt-1 flex-shrink-0"></i>
                            <span>依序點擊 1 到 36，點對就會消失</span>
                        </p>
                        <p class="flex items-start gap-2">
                            <i class="fas fa-circle-check text-cyan-500 mt-1 flex-shrink-0"></i>
                            <span>盡快完成所有數字，系統會記錄你的時間</span>
                        </p>
                        <p class="flex items-start gap-2">
                            <i class="fas fa-trophy text-amber-500 mt-1 flex-shrink-0"></i>
                            <span class="font-bold text-cyan-600">越快完成代表專注力越好！加油！</span>
                        </p>
                    </div>
                </div>

                <!-- Timer Display -->
                <div id="focus-game-timer" class="hidden mb-4">
                    <div class="inline-block bg-white px-6 py-3 rounded-full shadow-lg border-2 border-cyan-300">
                        <span class="text-2xl font-bold text-cyan-600">
                            <i class="fas fa-stopwatch mr-2"></i>
                            <span id="focus-timer-display">0.00</span> 秒
                        </span>
                    </div>
                    <p class="text-sm text-slate-500 mt-2">下一個數字：<span id="focus-next-number" class="font-bold text-cyan-600">1</span></p>
                </div>

                <!-- Game Grid (6x6) -->
                <div id="focus-game-grid" class="grid grid-cols-6 gap-2 max-w-2xl mx-auto mb-6">
                    <!-- Grid cells will be generated by JavaScript -->
                </div>

                <!-- Completion Message -->
                <div id="focus-game-complete" class="hidden">
                    <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-8 rounded-2xl shadow-xl border-2 border-green-300 max-w-lg mx-auto animate-fade-in-up">
                        <div class="text-6xl mb-4">🎉</div>
                        <h4 class="text-3xl font-bold text-green-700 mb-4">恭喜完成！</h4>
                        <div class="bg-white p-4 rounded-xl mb-4 shadow-inner">
                            <p class="text-4xl font-bold text-cyan-600">
                                <i class="fas fa-clock"></i> <span id="focus-final-time">0.00</span> 秒
                            </p>
                        </div>
                        <p id="focus-encouragement" class="text-lg text-slate-700 font-medium italic">太棒了！你的專注力很好！</p>
                    </div>
                </div>
            </div>

            <div id="interaction-drawing" class="hidden text-center flex flex-col h-full min-h-screen bg-slate-100">
                <div class="bg-white shadow-sm p-3 flex flex-wrap justify-between items-center gap-3 z-10 sticky top-0">
                    <div class="flex items-center gap-2">
                        <h3 class="text-xl font-bold text-slate-800 mr-2 hidden md:block">繪圖題</h3>
                        <button id="pen-tool-btn" class="w-10 h-10 rounded-lg border-2 border-purple-500 text-purple-600 bg-purple-50 flex items-center justify-center hover:bg-purple-100 transition" title="畫筆">
                            <i class="fas fa-pencil"></i>
                        </button>
                        <div class="flex items-center gap-1 bg-slate-100 p-1 rounded-lg">
                            <span id="current-color-swatch" class="w-6 h-6 rounded-full bg-black border border-slate-300 ml-1"></span>
                            <select id="color-select" class="bg-transparent border-none text-sm focus:ring-0 cursor-pointer w-20">
                                <option value="black">黑色</option>
                                <option value="red">紅色</option>
                                <option value="blue">藍色</option>
                                <option value="green">綠色</option>
                                <option value="yellow">黃色</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-1 bg-slate-100 p-1 rounded-lg">
                            <i class="fas fa-circle text-xs text-slate-400 ml-2"></i>
                            <select id="size-select" class="bg-transparent border-none text-sm focus:ring-0 cursor-pointer w-16">
                                <option value="2">細</option>
                                <option value="5">中</option>
                                <option value="10">粗</option>
                            </select>
                        </div>
                        <button id="eraser-btn" class="w-10 h-10 rounded-lg border border-slate-200 text-slate-500 hover:bg-slate-100 flex items-center justify-center transition" title="橡皮擦">
                            <i class="fas fa-eraser"></i>
                        </button>
                        <button id="clear-canvas-btn" class="w-10 h-10 rounded-lg border border-slate-200 text-red-500 hover:bg-red-50 flex items-center justify-center transition" title="清除畫布">
                            <i class="fas fa-trash-can"></i>
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="student-image-upload-input" class="w-10 h-10 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center cursor-pointer hover:bg-purple-200 transition" title="上傳圖片">
                            <i class="fas fa-image"></i>
                        </label>
                        <input type="file" id="student-image-upload-input" accept="image/*" class="hidden">
                        <button id="clear-student-image-btn" class="w-10 h-10 rounded-lg bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200 transition" title="移除圖片">
                            <i class="fas fa-image-portrait"></i><i class="fas fa-slash absolute text-xs"></i>
                        </button>
                        <div class="w-px h-8 bg-slate-200 mx-1"></div>
                        <button id="submit-drawing-btn" class="px-6 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg font-bold hover:shadow-lg transition flex items-center">
                            送出 <i class="fas fa-paper-plane ml-2"></i>
                        </button>
                    </div>
                </div>
                <div class="flex-grow bg-slate-200 p-4 overflow-hidden flex items-center justify-center">
                    <canvas id="drawing-canvas" class="shadow-lg bg-white rounded-lg"></canvas>
                </div>
            </div>
            <div id="interaction-url-dispatch" class="hidden p-4">
                </div>
            <div id="interaction-recording" class="hidden text-center flex flex-col items-center justify-center h-full min-h-screen p-4">
                <h3 class="text-3xl font-bold text-slate-800 mb-8 flex items-center justify-center gap-3">
                    <span class="bg-indigo-100 text-indigo-600 p-2 rounded-lg"><i class="fas fa-microphone-lines"></i></span> 錄音題
                </h3>
                <div class="bg-white p-10 rounded-3xl shadow-xl border border-slate-100 max-w-lg w-full">
                    <div class="flex items-center justify-center space-x-3 text-xl text-slate-500 mb-8">
                        <i id="recording-status-icon" class="fas fa-microphone-alt text-4xl text-slate-300"></i>
                        <p id="recording-status-text" class="font-medium">準備錄音...</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <button id="start-recording-btn" class="col-span-2 py-4 bg-red-500 text-white rounded-2xl text-xl font-bold hover:bg-red-600 shadow-lg shadow-red-200 transition flex items-center justify-center gap-2">
                            <i class="fas fa-circle"></i> 開始錄音
                        </button>
                        <button id="stop-recording-btn" class="py-4 bg-slate-700 text-white rounded-2xl text-lg font-bold hover:bg-slate-800 transition flex items-center justify-center gap-2" disabled>
                            <i class="fas fa-square"></i> 停止
                        </button>
                        <button id="play-recording-btn" class="py-4 bg-blue-500 text-white rounded-2xl text-lg font-bold hover:bg-blue-600 transition flex items-center justify-center gap-2" disabled>
                            <i class="fas fa-play"></i> 試聽
                        </button>
                    </div>
                    <button id="reset-recording-btn" class="w-full py-2 text-slate-400 hover:text-slate-600 font-medium mb-4 transition" disabled>
                        <i class="fas fa-rotate-left mr-1"></i> 重新錄製
                    </button>
                    <audio id="audio-preview" controls class="w-full mb-6 hidden"></audio>
                    <button id="submit-recording-btn" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-paper-plane mr-2"></i> 送出錄音
                    </button>
                </div>
            </div>
            <div id="interaction-reading-comprehension" class="hidden flex flex-col" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: #f8fafc; overflow: hidden; z-index: 50; padding: 1.5rem 0;">
                <!-- 標題與送出按鈕 -->
                <div class="flex items-center justify-center mb-4 relative flex-shrink-0 px-6">
                    <h3 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                        <span class="bg-rose-100 text-rose-600 p-1.5 rounded-lg text-xl"><i class="fas fa-book-open"></i></span> 閱讀測驗
                    </h3>
                    <button id="submit-reading-btn" class="absolute right-6 px-6 py-2 bg-gradient-to-r from-rose-500 to-pink-600 text-white rounded-xl font-bold hover:shadow-lg transition flex items-center">
                        送出 <i class="fas fa-paper-plane ml-2"></i>
                    </button>
                </div>

                <!-- 左右二欄佈局 -->
                <div class="flex flex-col lg:flex-row gap-6 mx-auto flex-1 w-[96%] min-h-0 pb-4">
                    <!-- 左欄：閱讀文本 -->
                    <div class="w-full lg:w-1/2 flex flex-col min-h-0">
                        <div class="bg-white rounded-2xl shadow-md border border-slate-200 p-6 flex flex-col h-full">
                            <div class="flex items-center justify-between mb-4 flex-shrink-0">
                                <h4 class="text-lg font-bold text-slate-700">
                                    <i class="fas fa-align-left text-slate-400 mr-2"></i>文章內容
                                </h4>
                                <!-- 螢光筆工具列 -->
                                <div class="flex gap-2 items-center bg-slate-50 p-1.5 rounded-xl border border-slate-100">
                                    <button class="highlighter-btn w-8 h-8 rounded-lg border border-slate-200" data-color="yellow" style="background-color: #fef08a;" title="黃色螢光筆"></button>
                                    <button class="highlighter-btn w-8 h-8 rounded-lg border border-slate-200" data-color="green" style="background-color: #86efac;" title="綠色螢光筆"></button>
                                    <button class="highlighter-btn w-8 h-8 rounded-lg border border-slate-200" data-color="pink" style="background-color: #fda4af;" title="粉色螢光筆"></button>
                                    <button class="highlighter-btn w-8 h-8 rounded-lg border border-slate-200" data-color="blue" style="background-color: #93c5fd;" title="藍色螢光筆"></button>
                                    <div class="w-px h-6 bg-slate-300 mx-1"></div>
                                    <button id="reading-eraser-btn" class="w-8 h-8 rounded-lg border border-slate-200 bg-white flex items-center justify-center text-slate-500 hover:bg-slate-100" title="橡皮擦">
                                        <i class="fas fa-eraser"></i>
                                    </button>
                                    <button id="reading-mouse-btn" class="w-8 h-8 rounded-lg border border-slate-200 bg-white flex items-center justify-center text-slate-500 hover:bg-slate-100" title="滑鼠模式">
                                        <i class="fas fa-mouse-pointer"></i>
                                    </button>
                                </div>
                            </div>
                            <div style="position: relative; flex: 1; min-height: 0; overflow-x: hidden;" class="bg-orange-50/50 rounded-xl border border-orange-100">
                                <div id="reading-text-display" class="p-6 text-left text-base leading-loose whitespace-pre-wrap overflow-y-auto h-full text-slate-800" style="overflow-x: hidden; width: 100%;"></div>
                                <canvas id="reading-highlight-canvas" style="position: absolute; top: 0; left: 0; pointer-events: none; border-radius: 0.75rem; display: none;"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- 右欄：題目 -->
                    <div class="w-full lg:w-1/2 flex flex-col min-h-0">
                        <div class="bg-white rounded-2xl shadow-md border border-slate-200 p-6 flex flex-col h-full">
                            <h4 class="text-lg font-bold text-slate-700 mb-4 flex-shrink-0 border-b border-slate-100 pb-3">
                                <i class="fas fa-clipboard-question text-slate-400 mr-2"></i>作答區
                            </h4>
                            <div id="reading-questions-container" class="space-y-6 overflow-y-auto flex-1 pr-2" style="min-height: 0; overflow-x: hidden; width: 100%;">
                                <!-- 題目將動態生成在這裡 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="interaction-quick-answer" class="hidden text-center flex flex-col items-center justify-center h-full min-h-screen p-4 relative">
                <h3 class="text-3xl font-bold text-slate-800 mb-8 flex items-center gap-3">
                    <span class="bg-amber-100 text-amber-600 p-2 rounded-lg"><i class="fas fa-bolt"></i></span> 搶答題
                </h3>
                <p id="quick-answer-status-text" class="text-xl text-slate-500 mb-8 font-medium bg-white px-6 py-2 rounded-full shadow-sm">等待搶答開始...</p>
                <div id="quick-answer-button-container" class="absolute inset-0 pointer-events-none">
                    <!-- 搶答按鈕將會動態生成在這裡 -->
                </div>
                <div id="quick-answer-result" class="hidden animate-fade-in-up">
                    <div class="bg-green-100 text-green-700 p-10 rounded-full w-80 h-80 flex flex-col items-center justify-center shadow-2xl border-8 border-green-200 mx-auto">
                        <i class="fas fa-trophy text-6xl mb-4"></i>
                        <h2 class="text-3xl font-bold mb-2">搶答成功！</h2>
                        <p class="text-lg opacity-90">你是第一名！</p>
                    </div>
                </div>
                <div id="quick-answer-locked" class="hidden animate-fade-in-up">
                    <div class="bg-slate-100 text-slate-500 p-10 rounded-full w-64 h-64 flex flex-col items-center justify-center border-8 border-slate-200 mx-auto">
                        <i class="fas fa-lock text-5xl mb-4"></i>
                        <h2 class="text-2xl font-bold mb-2">搶答結束</h2>
                        <p class="text-sm opacity-80">下次再加油！</p>
                    </div>
                </div>
            </div>
            <div id="interaction-sequencing" class="hidden text-center w-full max-w-3xl mx-auto pt-10 px-4">
                <h3 class="text-3xl font-bold text-slate-800 mb-4 flex items-center justify-center gap-3">
                    <span class="bg-cyan-100 text-cyan-600 p-2 rounded-lg"><i class="fas fa-sort-numeric-down"></i></span> 排序題
                </h3>
                <p id="sequencing-question-text" class="text-lg text-slate-600 mb-8 bg-white p-4 rounded-xl shadow-sm border border-slate-100 inline-block"></p>
                <div class="sequencing-container space-y-2">
                    <div id="sequencing-items-container" class="mb-8">
                        <!-- 排序項目將動態生成在這裡 -->
                    </div>
                    <button id="submit-sequencing-btn" class="btn bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 text-white rounded-xl font-bold shadow-lg shadow-cyan-200 py-3 max-w-xs mx-auto block">送出答案 <i class="fas fa-check ml-2"></i></button>
                </div>
            </div>
            <div id="interaction-matching" class="hidden text-center w-full max-w-5xl mx-auto pt-10 px-4">
                <h3 class="text-3xl font-bold text-slate-800 mb-4 flex items-center justify-center gap-3">
                    <span class="bg-fuchsia-100 text-fuchsia-600 p-2 rounded-lg"><i class="fas fa-right-left"></i></span> 配對題
                </h3>
                <p id="matching-question-text" class="text-lg text-slate-600 mb-8 bg-white p-4 rounded-xl shadow-sm border border-slate-100 inline-block"></p>
                <div class="matching-container bg-white p-6 rounded-3xl shadow-lg border border-slate-100">
                    <svg id="matching-svg-canvas"></svg>
                    <div class="matching-column" id="matching-column-a" style="z-index: 2;">
                        <!-- A項目列表 -->
                    </div>
                    <div class="matching-column" id="matching-column-b" style="z-index: 2;">
                        <!-- B項目列表 -->
                    </div>
                </div>
                <button id="submit-matching-btn" class="btn bg-gradient-to-r from-fuchsia-500 to-purple-600 hover:from-fuchsia-600 hover:to-purple-700 text-white rounded-xl font-bold shadow-lg shadow-fuchsia-200 py-3 max-w-xs mx-auto mt-8 block">送出答案 <i class="fas fa-check ml-2"></i></button>
            </div>

            <div id="interaction-quick-poll" class="hidden text-center flex flex-col items-center justify-center h-full min-h-screen p-4">
                <h3 class="text-3xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                    <span class="bg-lime-100 text-lime-600 p-2 rounded-lg"><i class="fas fa-square-poll-vertical"></i></span> 快速投票
                </h3>
                <p id="quick-poll-question-display" class="text-xl text-slate-600 mb-10 font-medium px-6 py-4 bg-white rounded-2xl shadow-sm border border-slate-100 max-w-3xl"></p>

                <!-- 投票選項容器 -->
                <div id="quick-poll-options-container" class="w-full max-w-2xl grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- 選項按鈕將會動態生成在這裡 -->
                </div>

                <!-- 已投票狀態 -->
                <div id="quick-poll-voted-status" class="hidden mt-10 animate-fade-in-up">
                    <div class="bg-white border-2 border-green-100 rounded-3xl p-8 shadow-xl text-center max-w-sm">
                        <div class="w-20 h-20 bg-green-100 text-green-500 rounded-full flex items-center justify-center text-4xl mx-auto mb-4">
                            <i class="fas fa-check"></i>
                        </div>
                        <h4 class="text-2xl font-bold text-slate-800 mb-2">投票成功！</h4>
                        <p class="text-slate-500">感謝您的參與</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="student-peer-review-view" class="hidden w-full h-full min-h-screen flex flex-col">
            <div class="flex-shrink-0 mb-6 pt-10 px-6">
                <h2 class="text-3xl font-bold text-slate-800 text-center mb-4 flex items-center justify-center gap-3">
                    <span class="bg-teal-100 text-teal-600 p-2 rounded-lg"><i class="fas fa-heart"></i></span> 作品觀摩與投票
                </h2>
                <p class="text-lg text-slate-500 text-center mb-6">點擊愛心投票，再點擊可取消！</p>
                <div class="text-center mb-4">
                    <span class="inline-flex items-center gap-2 bg-white border border-slate-200 text-slate-700 px-5 py-2 rounded-full text-base font-bold shadow-sm">
                        已投票：<span id="current-vote-count" class="text-rose-500 text-xl">0</span> <span class="text-slate-400">/</span> 3
                    </span>
                </div>
            </div>
            
            <div id="peer-review-works-container" class="flex-1 bg-slate-100 p-6 rounded-t-3xl overflow-y-auto shadow-inner">
                <div id="peer-review-works-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 max-w-7xl mx-auto pb-20">
                    <p class="text-slate-400 text-center col-span-full py-20">載入作品中...</p>
                </div>
            </div>
            
            <div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-30">
                <button id="exit-peer-review-btn" class="px-8 py-3 bg-slate-800 text-white rounded-full font-bold hover:bg-slate-900 shadow-lg hover:shadow-xl transition flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i> 返回等待
                </button>
            </div>
        </div>

    </div>

    <div id="message-box" class="fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg hidden z-50 transition-all duration-300 transform" role="alert">
        <p id="message-content"></p>
        <button id="close-message-btn" class="absolute top-1 right-2 text-white text-xl leading-none">×</button>
    </div>

    <!-- Firebase 設定 Modal -->
    <div id="firebase-settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[110] flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 max-w-lg w-full my-auto max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">貼上 Firebase 設定</h2>
                <button id="firebase-settings-modal-close-btn" class="text-gray-400 hover:text-gray-700 text-3xl font-bold">&times;</button>
            </div>
            <p class="text-sm text-gray-600 mb-3">
                請從您的 Firebase 專案中，複製 <code>firebaseConfig</code> 物件 <code>{</code> 和 <code>}</code> <strong>之間</strong>的六行內容，貼到下方：
            </p>
            <textarea id="firebase-config-textarea" rows="7" class="w-full p-3 border rounded-md font-mono text-sm bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="apiKey: &quot;...&quot;,
authDomain: &quot;...&quot;,
projectId: &quot;...&quot;,
storageBucket: &quot;...&quot;,
messagingSenderId: &quot;...&quot;,
appId: &quot;...&quot;"></textarea>

            <button id="apply-firebase-settings-btn" class="w-full px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition duration-300 mt-4">
                套用設定
            </button>
            <button id="generate-firebase-url-btn" class="w-full px-6 py-3 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition duration-300 mt-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                生成異機專用網址(可免再設定firebase)
            </button>
            <button id="clear-firebase-config-btn" class="w-full px-6 py-3 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-300 mt-2">
                <i class="fas fa-trash-alt mr-2"></i>清除本地設定值
            </button>
            <p id="firebase-copy-success-msg" class="text-center mt-3 text-sm font-medium hidden"></p>

            <!-- 網址資訊顯示區域 -->
            <div id="firebase-url-info" class="hidden mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <div class="mb-3">
                    <label class="block text-sm font-semibold text-gray-700 mb-1">短網址 (已複製)</label>
                    <div class="flex items-center gap-2">
                        <input type="text" id="firebase-short-url-display" readonly class="flex-1 px-3 py-2 text-sm bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="copy-short-url-btn" class="px-3 py-2 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600 transition" title="複製短網址">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">原始網址</label>
                    <div class="flex items-center gap-2">
                        <input type="text" id="firebase-original-url-display" readonly class="flex-1 px-3 py-2 text-sm bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="copy-original-url-btn" class="px-3 py-2 bg-gray-500 text-white text-sm rounded-md hover:bg-gray-600 transition" title="複製原始網址">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- QR Code 顯示區域 -->
            <div id="firebase-qrcode-container" class="hidden mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800 mb-3 text-center">掃描 QR Code 或下載圖片</h3>
                <div id="firebase-qrcode" class="flex justify-center mb-3"></div>
                <button id="download-qrcode-btn" class="w-full px-4 py-2 bg-purple-500 text-white font-semibold rounded-lg hover:bg-purple-600 transition duration-300">
                    <i class="fas fa-download mr-2"></i>下載 QR Code
                </button>
            </div>
        </div>
    </div>

    <div id="magnified-image-modal" class="magnified-image-modal hidden">
        <div class="magnified-image-modal-content">
            <button id="magnified-image-modal-close-btn" class="magnified-image-modal-close">×</button>
            <img id="magnified-image" src="" alt="放大繪圖">
        </div>
    </div>

    <div id="student-list-modal" class="magnified-image-modal hidden">
        <div id="student-list-modal-content" class="magnified-image-modal-content">
            <button id="student-list-modal-close-btn" class="magnified-image-modal-close">×</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">目前在線學生</h4>
            <button id="modal-draw-lottery-btn" class="btn btn-orange !w-auto text-sm mb-4">抽籤 🎲</button> <div id="modal-student-names">
                <p class="text-gray-500 text-sm">沒有學生在線</p>
            </div>
        </div>
    </div>

    <div id="statistics-modal" class="magnified-image-modal hidden">
        <div id="statistics-modal-content" class="magnified-image-modal-content">
            <button id="chart-modal-close-btn" class="magnified-image-modal-close">×</button>
            <h4 id="chart-title" class="text-2xl font-bold mb-4 text-gray-800">作答統計</h4>
            <svg id="chart-svg" width="550" height="400"></svg>
            <div id="students-by-answer-list-container" class="hidden">
                <h5 id="students-by-answer-list-title"></h5>
                <p id="students-by-answer-names" class="text-gray-700"></p> 
            </div>
        </div>
    </div>

    <div id="ai-summary-modal" class="magnified-image-modal hidden">
        <div id="ai-summary-modal-content">
            <button id="ai-summary-modal-close-btn" class="magnified-image-modal-close">×</button>
            <h4>AI 文字分析 - 熱門詞彙</h4>
            <div id="ai-loading-spinner" class="hidden">
                <p>文字分析中....</p>
            </div>
            <ul id="ai-summary-result-list">
                </ul>
        </div>
    </div>

    <div id="ai-settings-modal" class="magnified-image-modal hidden">
        <div id="ai-settings-modal-content" class="magnified-image-modal-content">
            <button id="ai-settings-modal-close-btn" class="magnified-image-modal-close">×</button>
            <h4>AI 設定</h4>
            <div class="space-y-4">
                <div>
                    <label for="ai-source-select">AI 模型來源:</label>
                    <select id="ai-source-select" class="drawing-tool-select">
                        <option value="gemini-default">使用目前 Gemini (不可使用)</option>
                        <option value="gemini-custom" selected>自訂 Gemini API Key</option>
                    </select>
                </div>
                <div id="gemini-api-key-group" class="hidden">
                    <label for="gemini-api-key-input">Gemini API Key:</label>
                    <input type="password" id="gemini-api-key-input" placeholder="請貼上您的 Gemini API Key" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">

                    <div style="margin-top: 15px;">
                        <label for="ai-model-select">選擇 AI 模型:</label>
                        <select id="ai-model-select" class="drawing-tool-select">
                            <option value="gemini-2.5-flash" selected>Gemini 2.5 Flash (目前使用)</option>
                            <option value="gemma-3-27b-it">Gemma 3 27B IT</option>
                        </select>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">
                            <i class="fas fa-info-circle"></i> 不同模型有不同的特性和效能，可依需求切換
                        </p>
                    </div>
                </div>
            </div>
            <div class="settings-button-group">
                <button id="save-ai-settings-btn" class="btn btn-primary">儲存設定 💾</button>
            </div>
        </div>
    </div>

    <!-- API Error Modal -->
    <div id="api-error-modal" class="magnified-image-modal hidden">
        <div class="magnified-image-modal-content" style="max-width: 600px;">
            <button id="api-error-modal-close-btn" class="magnified-image-modal-close">×</button>
            <h4 class="text-2xl font-bold mb-4 text-red-600">⚠️ API 錯誤</h4>
            <div class="space-y-4">
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <h5 class="font-bold text-lg mb-2 text-gray-800">錯誤原因：</h5>
                    <p id="api-error-message" class="text-gray-700 leading-relaxed"></p>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h5 class="font-bold text-lg mb-2 text-gray-800">💡 解決方法：</h5>
                    <ul id="api-error-solutions" class="list-disc list-inside text-gray-700 space-y-1">
                    </ul>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="api-error-modal-ok-btn" class="btn btn-primary px-6 py-2">我知道了</button>
            </div>
        </div>
    </div>

    <div id="url-dispatch-settings-modal" class="magnified-image-modal hidden">
        <div id="url-dispatch-settings-modal-content" class="magnified-image-modal-content">
            <button id="url-dispatch-settings-modal-close-btn" class="magnified-image-modal-close">×</button>
            <h4>設定派送網址/HTML</h4>
            <div class="w-full space-y-4">
                <div class="flex items-center justify-center gap-6 mb-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="dispatchType" value="url" class="form-radio text-blue-600 h-5 w-5" checked>
                        <span class="ml-2 text-gray-700 font-medium">派送網址</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="dispatchType" value="html" class="form-radio text-blue-600 h-5 w-5">
                        <span class="ml-2 text-gray-700 font-medium">派送 HTML</span>
                    </label>
                </div>

                <div id="url-dispatch-section">
                    <div>
                        <label for="dispatch-url-input">網址:</label>
                        <input type="text" id="dispatch-url-input" placeholder="請貼上要派送的網址" class="w-full">
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" id="is-youtube-checkbox">
                        <label for="is-youtube-checkbox">此連結為 YouTube 影片</label>
                    </div>
                </div>

                <div id="html-dispatch-section" class="hidden">
                    <div class="flex flex-col items-center">
                        <div class="flex gap-4 mb-4">
                            <label for="dispatch-html-upload-input" class="btn bg-yellow-600 !w-auto text-base h-11 px-4 py-2 flex items-center justify-center cursor-pointer">
                                <i class="fas fa-file-upload mr-2"></i> 上傳 HTML 檔案 ⬆️
                            </label>
                            <input type="file" id="dispatch-html-upload-input" accept=".html" class="hidden">
                            <button id="clear-dispatch-html-btn" class="btn btn-red !w-auto text-base h-11 px-4 py-2 flex items-center justify-center">
                                <i class="fas fa-trash mr-2"></i> 清除 HTML 🗑️
                            </button>
                        </div>
                        <p id="dispatch-html-status" class="text-gray-600 text-sm mt-2">目前沒有 HTML 檔案。</p>
                    </div>
                </div>
            </div>
            <div class="settings-button-group mt-6 w-full">
                <button id="clear-dispatch-settings-btn" class="btn btn-red">清除設定 🧹</button>
                <button id="save-dispatch-settings-btn" class="btn btn-primary">儲存設定 💾</button>
            </div>
        </div>
    </div>

    <div id="unsubmitted-students-modal" class="magnified-image-modal hidden">
        <div id="unsubmitted-students-modal-content" class="magnified-image-modal-content">
            <button id="unsubmitted-students-modal-close-btn" class="magnified-image-modal-close">×</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">未作答學生名單</h4>
            <div id="modal-unsubmitted-student-names">
                <p class="text-gray-500 text-sm">所有學生皆已作答或無學生在線</p>
            </div>
        </div>
    </div>

    <!-- 查看題目模態框 -->
    <div id="view-questions-modal" class="magnified-image-modal hidden">
        <div id="view-questions-modal-content" class="magnified-image-modal-content">
            <button id="view-questions-modal-close-btn" class="magnified-image-modal-close">×</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">查看題目與正確答案</h4>
            <div id="questions-display-container" class="w-full space-y-4 max-h-96 overflow-y-auto">
                <!-- 題目內容將動態填入 -->
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="save-correct-answers-btn" class="btn btn-green !w-auto px-6">儲存修改</button>
                <button id="cancel-questions-view-btn" class="btn bg-gray-500 hover:bg-gray-600 !w-auto px-6">取消</button>
            </div>
        </div>
    </div>

    <!-- 查看閱讀測驗題目模態框 -->
    <div id="view-reading-questions-modal" class="magnified-image-modal hidden">
        <div id="view-reading-questions-modal-content" class="magnified-image-modal-content" style="max-width: 900px;">
            <button id="view-reading-questions-modal-close-btn" class="magnified-image-modal-close">×</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">📖 閱讀測驗題目</h4>

            <!-- 閱讀文本顯示 -->
            <div class="mb-6">
                <h5 class="text-lg font-bold text-gray-700 mb-2">閱讀文本：</h5>
                <div id="view-reading-text-display" class="bg-gray-50 p-4 rounded-lg border text-base leading-relaxed whitespace-pre-wrap max-h-64 overflow-y-auto"></div>
            </div>

            <!-- 題目顯示 -->
            <div>
                <h5 class="text-lg font-bold text-gray-700 mb-2">題目：</h5>
                <div id="view-reading-questions-display" class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- 題目內容將動態填入 -->
                </div>
            </div>

            <div class="flex justify-end gap-4 mt-6">
                <button id="close-reading-questions-view-btn" class="btn btn-primary !w-auto px-6">關閉</button>
            </div>
        </div>
    </div>

    <div id="multiple-choice-settings-modal" class="magnified-image-modal hidden">
        <div id="multiple-choice-settings-modal-content" class="magnified-image-modal-content">
            <button id="multiple-choice-settings-modal-close-btn" class="magnified-image-modal-close">×</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">選擇題設定</h4>
            <div class="w-full space-y-4">
                <div class="flex items-center justify-center gap-6 mb-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="mcQuestionType" value="none" class="form-radio text-blue-600 h-5 w-5" checked>
                        <span class="ml-2 text-gray-700 font-medium">無題目出題 (預設 1-4 選項)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="mcQuestionType" value="custom" class="form-radio text-blue-600 h-5 w-5">
                        <span class="ml-2 text-gray-700 font-medium">自訂題目出題</span>
                    </label>
                </div>

                <div id="custom-mc-questions-section" class="hidden w-full">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                        <div class="flex flex-col space-y-2">
                            <label for="custom-mc-questions-textarea" class="block text-gray-700 text-sm font-bold">
                                請輸入題目 (或由 AI 生成)
                            </label>
                            <p class="text-gray-600 text-xs">格式: 題目,正確答案(1-4或A-D),選項1,選項2,選項3,選項4 (每行一題)</p>
                            <textarea id="custom-mc-questions-textarea" rows="6" class="w-full p-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-blue-500 flex-grow" placeholder="例如：
台灣的首都在哪裡?,1,台北,台中,台南,高雄
2+2=?,B,3,4,5,6"></textarea>
                            <p id="custom-mc-questions-status" class="text-red-500 text-sm mt-2 hidden">格式錯誤或題目為空，請檢查輸入。</p>
                        </div>

                        <div class="flex flex-col space-y-4 bg-gray-50 p-4 rounded-lg border">
                            <h5 class="text-lg font-bold text-gray-800 text-center">🤖 AI 智能出題</h5>
                            <div>
                                <label for="ai-mc-topic-textarea" class="block text-gray-700 text-sm font-bold mb-2">出題主題、範圍或要求:</label>
                                <textarea id="ai-mc-topic-textarea" rows="3" class="w-full p-2 border rounded-md text-base focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="例如：
- 關於台灣歷史的選擇題
- 關於光合作用的國中程度是非題
- 請出有關聖誕節的英文單字選擇題"></textarea>
                            </div>
                            <div>
                                <label for="ai-mc-count-input" class="block text-gray-700 text-sm font-bold mb-2">出題數量 (1-10):</label>
                                <input type="number" id="ai-mc-count-input" min="1" max="10" value="5" class="w-full p-2 border rounded-md text-base focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div class="text-center">
                                <button id="ai-generate-mc-btn" class="btn btn-purple !w-auto text-base h-11 px-4 py-2 flex items-center justify-center mx-auto">
                                    <i id="ai-mc-btn-icon" class="fas fa-magic mr-2"></i>
                                    <span id="ai-mc-btn-text">AI 開始出題</span>
                                </button>
                                <div class="mt-2 flex items-center justify-center">
                                    <span class="inline-flex items-center px-3 py-1 bg-purple-50 rounded-full text-xs font-medium text-purple-700">
                                        <i class="fas fa-robot mr-1.5"></i>
                                        <span id="ai-mc-model-name">使用模型: Gemini 2.5 Flash</span>
                                    </span>
                                </div>
                            </div>
                            <div id="ai-mc-loading-spinner" class="hidden flex items-center justify-center text-purple-600 pt-2">
                                <i class="fas fa-spinner fa-spin mr-2"></i>
                                <span>AI 思考中，請稍候...</span>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- 題庫管理區塊 -->
                <div id="question-bank-management-section" class="hidden w-full mt-6 bg-blue-50 p-4 rounded-lg border">
                    <h5 class="text-lg font-bold text-gray-800 text-center mb-4">📚 題庫管理</h5>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- 題庫載入區 -->
                        <div class="flex flex-col space-y-2">
                            <label class="block text-gray-700 text-sm font-bold">從檔案載入題庫</label>
                            <input type="file" id="question-bank-file-input" accept=".txt" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="load-question-bank-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white text-sm h-8 px-3 py-1">載入題庫</button>
                        </div>

                        <!-- 題庫儲存區 -->
                        <div class="flex flex-col space-y-2">
                            <label class="block text-gray-700 text-sm font-bold">儲存目前題目為題庫</label>
                            <input type="text" id="question-bank-name-input" placeholder="輸入題庫名稱" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="save-question-bank-btn" class="btn bg-green-600 hover:bg-green-700 text-white text-sm h-8 px-3 py-1">儲存題庫</button>
                        </div>
                    </div>

                    <!-- 題庫列表 -->
                    <div class="mt-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">已儲存的題庫</label>
                        <div id="question-bank-list" class="space-y-2 max-h-32 overflow-y-auto border rounded-md p-2 bg-white">
                            <div class="text-gray-500 text-sm italic text-center">目前沒有儲存的題庫</div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="settings-button-group mt-6 w-full">
                <button id="start-mc-interaction-btn" class="btn btn-primary">確認並開始互動 🚀</button>
                <button id="cancel-mc-settings-btn" class="btn btn-gray">取消 ↩️</button>
            </div>
        </div>
    </div>

    <!-- B. 選擇/排序/配對題選單模態框 -->
    <div id="choice-sequencing-matching-menu-modal" class="magnified-image-modal hidden">
        <div class="magnified-image-modal-content" style="max-width: 400px;">
            <button id="choice-sequencing-matching-menu-close-btn" class="magnified-image-modal-close">×</button>
            <h4 class="text-2xl font-bold mb-6 text-gray-800 text-center">B. 請選擇題型</h4>
            <div class="space-y-4">
                <button id="open-multiple-choice-settings-btn" class="btn btn-green w-full text-xl py-4">✓ 選擇題</button>
                <button id="open-sequencing-settings-btn" class="btn bg-cyan-500 hover:bg-cyan-600 w-full text-xl py-4">📋 排序題</button>
                <button id="open-matching-settings-btn" class="btn bg-pink-500 hover:bg-pink-600 w-full text-xl py-4">🔗 配對題</button>
            </div>
        </div>
    </div>

    <!-- 排序/配對題選單模態框 -->
    <div id="sequencing-matching-menu-modal" class="magnified-image-modal hidden">
        <div class="magnified-image-modal-content" style="max-width: 400px;">
            <button id="sequencing-matching-menu-close-btn" class="magnified-image-modal-close">×</button>
            <h4 class="text-2xl font-bold mb-6 text-gray-800 text-center">請選擇題型</h4>
            <div class="space-y-4">
                <button id="sequencing-settings-btn" class="btn bg-cyan-500 hover:bg-cyan-600 w-full text-xl py-4">📋 排序題</button>
                <button id="matching-settings-btn" class="btn bg-pink-500 hover:bg-pink-600 w-full text-xl py-4">🔗 配對題</button>
            </div>
        </div>
    </div>

    <!-- 排序題設定模態框 -->
    <div id="sequencing-settings-modal" class="magnified-image-modal hidden">
        <div id="sequencing-settings-modal-content" class="magnified-image-modal-content">
            <button id="sequencing-settings-modal-close-btn" class="magnified-image-modal-close">×</button>
            <div class="w-full">
                <!-- 題型切換按鈕 -->
                <div class="flex justify-center mb-4 gap-2">
                    <button id="switch-to-matching-btn" class="btn bg-pink-500 hover:bg-pink-600 text-white px-6 py-2 text-sm">
                        🔗 切換到配對題
                    </button>
                </div>
                <h4 class="text-2xl font-bold mb-4 text-gray-800">排序題設定</h4>

                <!-- 上方：左右兩欄布局 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                <!-- 左欄：題目輸入 -->
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <label for="sequencing-items-textarea" class="block text-gray-700 text-sm font-bold mb-2">📝 排序項目（每行一個，按正確順序輸入）</label>
                    <textarea id="sequencing-items-textarea" rows="6" class="w-full p-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="例如：
打開檔案
編輯內容
儲存檔案
關閉檔案"></textarea>
                    <p class="text-gray-600 text-xs mt-1">💡 提示：請依照正確順序輸入項目，系統會自動打亂給學生作答</p>
                </div>

                <!-- 右欄：AI智能出題 -->
                <div class="bg-purple-50 p-4 rounded-lg border">
                    <h5 class="text-lg font-bold text-gray-800 mb-3">🤖 AI 智能出題</h5>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">出題主題或要求：</label>
                            <textarea id="ai-seq-topic-textarea" rows="2" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="例如：請生成光合作用的步驟排序"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">項目數量 (3-10):</label>
                            <input type="number" id="ai-seq-count-input" min="3" max="10" value="5" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div class="text-center">
                            <button id="ai-generate-seq-btn" class="btn btn-purple w-full text-base h-11 px-4 py-2 flex items-center justify-center">
                                <i id="ai-seq-btn-icon" class="fas fa-magic mr-2"></i>
                                <span id="ai-seq-btn-text">AI 開始出題</span>
                            </button>
                            <div class="mt-2 flex items-center justify-center">
                                <span class="inline-flex items-center px-3 py-1 bg-purple-50 rounded-full text-xs font-medium text-purple-700">
                                    <i class="fas fa-robot mr-1.5"></i>
                                    <span id="ai-seq-model-name">使用模型: Gemini 2.5 Flash</span>
                                </span>
                            </div>
                        </div>
                        <div id="ai-seq-loading-spinner" class="hidden flex items-center justify-center text-purple-600 pt-2">
                            <i class="fas fa-spinner fa-spin mr-2"></i>
                            <span>AI 思考中，請稍候...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 下方：題庫管理區塊（全寬） -->
            <div class="w-full bg-blue-50 p-4 rounded-lg border">
                <h5 class="text-lg font-bold text-gray-800 mb-3">📚 題庫管理</h5>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col space-y-2">
                        <label class="block text-gray-700 text-sm font-bold">從檔案載入題庫</label>
                        <input type="file" id="seq-bank-file-input" accept=".txt" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="load-seq-bank-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white text-sm h-8 px-3 py-1">載入題庫</button>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <label class="block text-gray-700 text-sm font-bold">儲存目前題目為題庫</label>
                        <input type="text" id="seq-bank-name-input" placeholder="輸入題庫名稱" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="save-seq-bank-btn" class="btn bg-green-600 hover:bg-green-700 text-white text-sm h-8 px-3 py-1">儲存題庫</button>
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">已儲存的題庫</label>
                    <div id="seq-bank-list" class="space-y-2 max-h-20 overflow-y-auto border rounded-md p-2 bg-white">
                        <div class="text-gray-500 text-sm italic text-center">目前沒有儲存的題庫</div>
                    </div>
                </div>
            </div>

                <div class="settings-button-group mt-4">
                    <button id="start-sequencing-interaction-btn" class="btn bg-cyan-500 hover:bg-cyan-600">確認並開始互動 🚀</button>
                    <button id="cancel-sequencing-settings-btn" class="btn btn-gray">取消 ↩️</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 配對題設定模態框 -->
    <div id="matching-settings-modal" class="magnified-image-modal hidden">
        <div id="matching-settings-modal-content" class="magnified-image-modal-content">
            <button id="matching-settings-modal-close-btn" class="magnified-image-modal-close">×</button>
            <div class="w-full">
                <!-- 題型切換按鈕 -->
                <div class="flex justify-center mb-4 gap-2">
                    <button id="switch-to-sequencing-btn" class="btn bg-cyan-500 hover:bg-cyan-600 text-white px-6 py-2 text-sm">
                        📋 切換到排序題
                    </button>
                </div>
                <h4 class="text-2xl font-bold mb-4 text-gray-800">配對題設定</h4>

                <!-- 上方：左右兩欄布局 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                <!-- 左欄：題目輸入 -->
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <label for="matching-pairs-textarea" class="block text-gray-700 text-sm font-bold mb-2">📝 配對項目（每行一對，用逗號或Tab分隔）</label>
                    <textarea id="matching-pairs-textarea" rows="6" class="w-full p-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="例如：
台北,台灣首都
東京,日本首都
首爾,韓國首都
北京,中國首都"></textarea>
                    <p class="text-gray-600 text-xs mt-1">💡 提示：每行一對配對項目，用逗號（,）或Tab鍵分隔左右兩側</p>
                </div>

                <!-- 右欄：AI智能出題 -->
                <div class="bg-purple-50 p-4 rounded-lg border">
                    <h5 class="text-lg font-bold text-gray-800 mb-3">🤖 AI 智能出題</h5>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">出題主題或要求：</label>
                            <textarea id="ai-match-topic-textarea" rows="2" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="例如：國家與首都的配對"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">配對數量 (3-10):</label>
                            <input type="number" id="ai-match-count-input" min="3" max="10" value="5" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div class="text-center">
                            <button id="ai-generate-match-btn" class="btn btn-purple w-full text-base h-11 px-4 py-2 flex items-center justify-center">
                                <i id="ai-match-btn-icon" class="fas fa-magic mr-2"></i>
                                <span id="ai-match-btn-text">AI 開始出題</span>
                            </button>
                            <div class="mt-2 flex items-center justify-center">
                                <span class="inline-flex items-center px-3 py-1 bg-purple-50 rounded-full text-xs font-medium text-purple-700">
                                    <i class="fas fa-robot mr-1.5"></i>
                                    <span id="ai-match-model-name">使用模型: Gemini 2.5 Flash</span>
                                </span>
                            </div>
                        </div>
                        <div id="ai-match-loading-spinner" class="hidden flex items-center justify-center text-purple-600 pt-2">
                            <i class="fas fa-spinner fa-spin mr-2"></i>
                            <span>AI 思考中，請稍候...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 下方：題庫管理區塊（全寬） -->
            <div class="w-full bg-blue-50 p-4 rounded-lg border">
                <h5 class="text-lg font-bold text-gray-800 mb-3">📚 題庫管理</h5>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col space-y-2">
                        <label class="block text-gray-700 text-sm font-bold">從檔案載入題庫</label>
                        <input type="file" id="match-bank-file-input" accept=".txt" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="load-match-bank-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white text-sm h-8 px-3 py-1">載入題庫</button>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <label class="block text-gray-700 text-sm font-bold">儲存目前題目為題庫</label>
                        <input type="text" id="match-bank-name-input" placeholder="輸入題庫名稱" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="save-match-bank-btn" class="btn bg-green-600 hover:bg-green-700 text-white text-sm h-8 px-3 py-1">儲存題庫</button>
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">已儲存的題庫</label>
                    <div id="match-bank-list" class="space-y-2 max-h-20 overflow-y-auto border rounded-md p-2 bg-white">
                        <div class="text-gray-500 text-sm italic text-center">目前沒有儲存的題庫</div>
                    </div>
                </div>
            </div>

                <div class="settings-button-group mt-4">
                    <button id="start-matching-interaction-btn" class="btn bg-pink-500 hover:bg-pink-600">確認並開始互動 🚀</button>
                    <button id="cancel-matching-settings-btn" class="btn btn-gray">取消 ↩️</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 專注力遊戲設定模態框 -->
    <div id="focus-game-settings-modal" class="magnified-image-modal hidden">
        <div id="focus-game-settings-modal-content" class="magnified-image-modal-content">
            <button id="focus-game-settings-modal-close-btn" class="magnified-image-modal-close">×</button>
            <div class="w-full">
                <h4 class="text-2xl font-bold mb-4 text-cyan-800 flex items-center justify-center gap-2">
                    <i class="fas fa-brain"></i> 專注力遊戲設定
                </h4>

                <div class="bg-gradient-to-br from-cyan-50 to-blue-50 p-6 rounded-lg border-2 border-cyan-200">
                    <label class="block text-gray-700 text-lg font-bold mb-4">選擇數字數量：</label>
                    <div class="grid grid-cols-2 gap-4">
                        <button class="focus-game-number-option bg-white hover:bg-cyan-100 border-2 border-cyan-300 hover:border-cyan-500 rounded-xl p-6 text-center transition transform hover:scale-105 active:scale-95" data-number="9">
                            <div class="text-4xl font-bold text-cyan-700 mb-2">9</div>
                            <div class="text-sm text-gray-600">3×3 格子</div>
                        </button>
                        <button class="focus-game-number-option bg-white hover:bg-cyan-100 border-2 border-cyan-300 hover:border-cyan-500 rounded-xl p-6 text-center transition transform hover:scale-105 active:scale-95" data-number="16">
                            <div class="text-4xl font-bold text-cyan-700 mb-2">16</div>
                            <div class="text-sm text-gray-600">4×4 格子</div>
                        </button>
                        <button class="focus-game-number-option bg-white hover:bg-cyan-100 border-2 border-cyan-300 hover:border-cyan-500 rounded-xl p-6 text-center transition transform hover:scale-105 active:scale-95" data-number="25">
                            <div class="text-4xl font-bold text-cyan-700 mb-2">25</div>
                            <div class="text-sm text-gray-600">5×5 格子</div>
                        </button>
                        <button class="focus-game-number-option bg-white hover:bg-cyan-100 border-2 border-cyan-300 hover:border-cyan-500 rounded-xl p-6 text-center transition transform hover:scale-105 active:scale-95 selected" data-number="36">
                            <div class="text-4xl font-bold text-cyan-700 mb-2">36</div>
                            <div class="text-sm text-gray-600">6×6 格子（預設）</div>
                        </button>
                    </div>
                </div>

                <div class="settings-button-group mt-6">
                    <button id="start-focus-game-interaction-btn" class="btn bg-cyan-500 hover:bg-cyan-600">確認並開始互動 🚀</button>
                    <button id="cancel-focus-game-settings-btn" class="btn btn-gray">取消 ↩️</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 教師密碼驗證模態框 -->
    <div id="teacher-password-modal" class="magnified-image-modal hidden">
        <div id="teacher-password-modal-content" class="magnified-image-modal-content">
            <button id="teacher-password-modal-close-btn" class="magnified-image-modal-close">×</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">教師登入驗證</h4>
            <div class="w-full space-y-4">
                <input type="password" id="teacher-password-input" placeholder="請輸入密碼" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="flex justify-center gap-4">
                    <button id="teacher-password-submit-btn" class="btn btn-primary px-8">確認</button>
                    <button id="teacher-password-cancel-btn" class="btn btn-gray px-8">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 閱讀測驗設定模態框 -->
    <div id="reading-comprehension-settings-modal" class="magnified-image-modal hidden">
        <div id="reading-comprehension-settings-modal-content" class="magnified-image-modal-content" style="max-width: 900px;">
            <button id="reading-comprehension-settings-modal-close-btn" class="magnified-image-modal-close">×</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">閱讀測驗設定</h4>
            <div class="w-full space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                    <!-- 左側：文本與題目輸入 -->
                    <div class="flex flex-col space-y-4">
                        <!-- 文本輸入框 -->
                        <div>
                            <label for="reading-text-textarea" class="block text-gray-700 text-sm font-bold mb-2">
                                閱讀文本：
                            </label>
                            <textarea id="reading-text-textarea" rows="8" class="w-full p-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="請輸入閱讀文本內容..."></textarea>
                        </div>

                        <!-- 題目輸入框 -->
                        <div>
                            <label for="reading-questions-textarea" class="block text-gray-700 text-sm font-bold mb-2">
                                題目設定：
                            </label>
                            <p class="text-gray-600 text-xs mb-2">格式: 題目,正確答案(1-4或A-D),選項1,選項2,選項3,選項4<span class="text-gray-500">,[層次(1-4)選填]</span><br>
                            <span class="text-gray-500">支援逗號(,)或Tab分隔，每行一題</span></p>
                            <textarea id="reading-questions-textarea" rows="8" class="w-full p-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="例如：
主角的名字是什麼?,2,小明,小華,小美,小強,1
本文的主旨是?,A,友誼的重要,競爭的意義,學習的價值,家庭的溫暖
故事發生的地點在哪裡?,3,學校,公園,圖書館,家裡"></textarea>
                            <p id="reading-questions-status" class="text-red-500 text-sm mt-2 hidden">格式錯誤或題目為空，請檢查輸入。</p>
                        </div>

                        <!-- 下載題庫按鈕 -->
                        <div>
                            <button id="download-reading-zip-btn" class="btn bg-teal-600 hover:bg-teal-700 text-white text-sm h-10 px-4 py-2 w-full flex items-center justify-center gap-2">
                                <i class="fas fa-download"></i>
                                <span>下載文本及題目 (ZIP)</span>
                            </button>
                        </div>
                    </div>

                    <!-- 右側：AI生成與題庫管理 -->
                    <div class="flex flex-col space-y-4">
                        <!-- AI 生成區塊 -->
                        <div class="bg-purple-50 p-4 rounded-lg border flex-1">
                            <h5 class="text-lg font-bold text-gray-800 text-center mb-4">🤖 PIRLS AI 出題</h5>
                            <div class="space-y-3">
                                <div>
                                    <label for="ai-reading-topic-textarea" class="block text-gray-700 text-sm font-bold mb-2">出題要求：</label>
                                    <textarea id="ai-reading-topic-textarea" rows="3" class="w-full p-2 border rounded-md text-base focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="例如：
- 根據左方文本生成 PIRLS 閱讀理解題
- 或直接描述主題，AI 會生成文本+題目"></textarea>
                                </div>
                                <div class="text-sm text-gray-600 bg-white p-2 rounded border">
                                    <p class="font-bold mb-1">PIRLS 四層次配置：</p>
                                    <ul class="list-disc list-inside text-xs space-y-1">
                                        <li>層次1 (直接提取)：3題</li>
                                        <li>層次2 (直接推論)：3題</li>
                                        <li>層次3 (詮釋整合)：2題</li>
                                        <li>層次4 (比較評估)：2題</li>
                                    </ul>
                                </div>
                                <button id="ai-generate-reading-btn" class="btn btn-purple !w-full text-base h-11 px-4 py-2 flex items-center justify-center">
                                    <i id="ai-reading-btn-icon" class="fas fa-magic mr-2"></i>
                                    <span id="ai-reading-btn-text">AI 開始出題</span>
                                </button>
                                <div id="ai-reading-loading-spinner" class="hidden flex items-center justify-center text-purple-600 pt-2">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>
                                    <span>AI 思考中，請稍候...</span>
                                </div>
                            </div>
                        </div>

                        <!-- 題庫管理區塊 -->
                        <div class="bg-blue-50 p-4 rounded-lg border">
                            <h5 class="text-lg font-bold text-gray-800 text-center mb-4">📚 題庫管理</h5>
                            <div class="space-y-3">
                                <!-- 載入題庫 -->
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2">從檔案載入題庫</label>
                                    <div class="space-y-2">
                                        <div>
                                            <label class="block text-gray-600 text-xs mb-1">上傳文本 (.txt)</label>
                                            <input type="file" id="reading-text-file-input" accept=".txt" class="w-full p-1 border rounded-md text-xs focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                        <div>
                                            <label class="block text-gray-600 text-xs mb-1">上傳題目 (.txt)</label>
                                            <input type="file" id="reading-questions-file-input" accept=".txt" class="w-full p-1 border rounded-md text-xs focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                        <button id="load-reading-files-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white text-sm h-8 px-3 py-1 w-full">載入檔案</button>
                                    </div>
                                </div>

                                <!-- 儲存題庫 -->
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2">儲存目前題目為題庫</label>
                                    <input type="text" id="reading-question-bank-name-input" placeholder="輸入題庫名稱" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
                                    <button id="save-reading-question-bank-btn" class="btn bg-green-600 hover:bg-green-700 text-white text-sm h-8 px-3 py-1 w-full">儲存題庫</button>
                                </div>

                                <!-- 題庫列表 -->
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2">已儲存的題庫</label>
                                    <div id="reading-question-bank-list" class="space-y-2 max-h-32 overflow-y-auto border rounded-md p-2 bg-white">
                                        <div class="text-gray-500 text-sm italic text-center">目前沒有儲存的題庫</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <div class="settings-button-group mt-6 w-full">
                <button id="start-reading-interaction-btn" class="btn btn-primary">確認並開始互動 🚀</button>
                <button id="cancel-reading-settings-btn" class="btn btn-gray">取消 ↩️</button>
            </div>
        </div>
    </div>

    <!-- 快速投票設定模態框 -->
    <div id="quick-poll-settings-modal" class="magnified-image-modal hidden">
        <div id="quick-poll-settings-modal-content" class="magnified-image-modal-content" style="max-width: 600px;">
            <button id="quick-poll-settings-modal-close-btn" class="magnified-image-modal-close">×</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">快速投票設定</h4>
            <div class="w-full space-y-4">
                <!-- 投票類型選擇 -->
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">投票類型：</label>
                    <div class="space-y-2">
                        <label class="inline-flex items-center w-full p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="pollType" value="emoji" class="form-radio text-lime-600 h-5 w-5" checked>
                            <span class="ml-3 text-gray-700">心情符號（😊 😐 😕）</span>
                        </label>
                        <label class="inline-flex items-center w-full p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="pollType" value="simple" class="form-radio text-lime-600 h-5 w-5">
                            <span class="ml-3 text-gray-700">簡單選項（同意 / 不同意 / 不確定）</span>
                        </label>
                        <label class="inline-flex items-center w-full p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="pollType" value="rating5" class="form-radio text-lime-600 h-5 w-5">
                            <span class="ml-3 text-gray-700">數字等級（1-5 分）</span>
                        </label>
                        <label class="inline-flex items-center w-full p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="pollType" value="rating10" class="form-radio text-lime-600 h-5 w-5">
                            <span class="ml-3 text-gray-700">數字等級（1-10 分）</span>
                        </label>
                        <label class="inline-flex items-center w-full p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="pollType" value="custom" class="form-radio text-lime-600 h-5 w-5">
                            <span class="ml-3 text-gray-700">自訂選項</span>
                        </label>
                    </div>
                </div>

                <!-- 自訂選項輸入區 -->
                <div id="custom-poll-options-section" class="hidden">
                    <label for="custom-poll-options-input" class="block text-gray-700 text-sm font-bold mb-2">自訂選項（每行一個）：</label>
                    <textarea id="custom-poll-options-input" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-lime-500" placeholder="例如：
選項 A
選項 B
選項 C"></textarea>
                </div>

                <!-- 匿名設定 -->
                <div class="flex items-center">
                    <input type="checkbox" id="quick-poll-anonymous-checkbox" checked class="form-checkbox h-5 w-5 text-lime-600 rounded">
                    <label for="quick-poll-anonymous-checkbox" class="ml-2 text-gray-700 font-medium">匿名投票（不記錄學生姓名）</label>
                </div>
            </div>

            <div class="settings-button-group mt-6 w-full">
                <button id="start-quick-poll-btn" class="btn bg-lime-500 hover:bg-lime-600">開始投票 🚀</button>
                <button id="cancel-quick-poll-settings-btn" class="btn btn-gray">取消 ↩️</button>
            </div>
        </div>
    </div>

    <!-- 快速投票統計模態框 -->
    <div id="quick-poll-stats-modal" class="magnified-image-modal hidden">
        <div id="quick-poll-stats-modal-content" class="magnified-image-modal-content" style="max-width: 900px; max-height: 90vh;">
            <button id="quick-poll-stats-modal-close-btn" class="magnified-image-modal-close">×</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800 text-center">投票統計結果</h4>
            <p id="quick-poll-stats-question" class="text-lg text-gray-700 mb-4 text-center font-medium"></p>

            <!-- 上方區塊：左右兩欄布局 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                <!-- 左欄：圖表類型切換和統計資訊 -->
                <div>
                    <!-- 圖表類型切換 -->
                    <div class="flex justify-center gap-4 mb-4">
                        <button id="chart-type-bar-btn" class="btn bg-blue-500 hover:bg-blue-600 !w-auto text-sm h-10 px-4">長條圖</button>
                        <button id="chart-type-pie-btn" class="btn btn-gray !w-auto text-sm h-10 px-4">圓餅圖</button>
                    </div>

                    <!-- 投票統計資訊 -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div>
                                <p class="text-gray-600 text-sm">總投票數</p>
                                <p id="poll-total-votes" class="text-3xl font-bold text-lime-600">0</p>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">在線學生數</p>
                                <p id="poll-online-students" class="text-3xl font-bold text-blue-600">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右欄：詳細數據表格 -->
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border px-4 py-2 text-left">選項</th>
                                <th class="border px-4 py-2 text-right">票數</th>
                                <th class="border px-4 py-2 text-right">百分比</th>
                            </tr>
                        </thead>
                        <tbody id="quick-poll-stats-table-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- D3.js 圖表容器 -->
            <div class="bg-white border rounded-lg p-4 overflow-x-auto" style="min-height: 500px;">
                <svg id="quick-poll-chart-svg" width="800" height="450"></svg>
            </div>

            <div class="flex justify-center gap-4 mt-6">
                <button id="download-poll-results-btn" class="btn btn-green !w-auto text-base h-11 px-6">
                    <i class="fas fa-download mr-2"></i>下載結果 (CSV)
                </button>
                <button id="end-quick-poll-btn" class="btn btn-red !w-auto text-base h-11 px-6">
                    <i class="fas fa-stop mr-2"></i>結束投票
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase 設定檔（請修改此檔案來使用您自己的 Firebase 專案） -->
    <script src="firebase-config.js"></script>

    <script type="module">
        // Import Firebase SDK functions.
        import { initializeApp, getApps, getApp, deleteApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; // Added signOut
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, getDoc, getDocs, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables ---
        // Max dimension (px) for user uploaded images to prevent excessively large files.
        const MAX_IMAGE_DIMENSION = 1024; 
        // JPEG compression quality (0.0 to 1.0).
        const JPEG_QUALITY = 0.8; 

        // Firebase configuration - will be initialized later
        let firebaseConfig = null;
        let app = null;
        let auth = null;
        let db = null;
        let isFirebaseConfigApplied = false; // Track if config has been applied

        // Use __app_id for the base Firestore path.
        const baseAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-classroom-app';
        let userId = null;
        let studentName = null;
        let currentRole = null; // 'teacher' or 'student'
        let classroomCode = null; // NEW: Stores the teacher-defined or student-entered classroom code.
        let currentInteractionMode = null; // To track the active mode for statistics.
        let allStudentResponses = []; // Global variable to store all student responses for charting and lottery.
        let activeStudentNames = []; // NEW: Global variable to store names of all currently active students.
        let lastSelectedStudentCard = null; // To track the previously selected card for the lottery feature.
        let isResponsePaused = false; // NEW: Global state for response pause.
        let lastSelectedModalStudent = null; // NEW: To track the previously selected student in the modal for lottery.

        let interactionModeUnsubscribe = null;
        let questionBanks = []; // Question Bank storage in memory (will be cleared when class ends)
        let sequencingQuestionBanks = []; // Sequencing Question Bank storage
        let matchingQuestionBanks = []; // Matching Question Bank storage
        let studentResponsesUnsubscribe = null;
        let classroomPresenceUnsubscribe = null; // Unsubscribe function for classroom presence listener.

        // Quick Poll variables
        let quickPollActive = false;
        let quickPollData = null; // Stores current poll configuration
        let quickPollVotesUnsubscribe = null; // Listener for vote updates
        let currentChartType = 'bar'; // 'bar' or 'pie'

        // Drawing specific variables.
        const canvas = document.getElementById('drawing-canvas'); // Main canvas for student display.
        const ctx = canvas.getContext('2d'); // 2D context of the main canvas.

        let backgroundCanvas = document.createElement('canvas'); // Canvas for teacher's background image.
        let backgroundCtx = backgroundCanvas.getContext('2d');

        let studentImageCanvas = document.createElement('canvas'); 
        let studentImageCtx = studentImageCanvas.getContext('2d');
        let studentUploadedImageDataURL = null; // Stores the scaled and compressed student uploaded image Data URL.

        let drawingCanvas = document.createElement('canvas'); // Canvas for student's drawing strokes.
        let drawingCtx = drawingCanvas.getContext('2d');

        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        
        let teacherUploadedBackgroundImageDataURL = null; // Stores the scaled and compressed background image Data URL from Firestore.

        // AI Settings Global Object
        let aiSettings = {
            aiSource: 'gemini-custom', // 'gemini-default' or 'gemini-custom'
            geminiApiKey: '', // Custom API key if 'gemini-custom' is selected
            selectedModel: 'gemini-2.5-flash' // Selected AI model
        };
        
        // MODIFIED: Combined Dispatch Settings Global Object
        let dispatchSettings = {
            type: 'url', // 'url' or 'html'
            url: '',
            isYoutube: false, // Only relevant if type is 'url'
            htmlContent: null // Only relevant if type is 'html'
        };

        // New: Recording specific variables
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob = null;
        let audioDataURL = null;
        let audioStream = null; // To store the MediaStream object

        // NEW: Custom Multiple Choice Questions (Teacher side)
        let customMultipleChoiceQuestions = []; // Stores parsed questions from teacher input

        // NEW: Reading Comprehension Data (Teacher side)
        let readingComprehensionData = {
            text: '',
            questions: [] // Array of {question, correctAnswer, options, level}
        };

        // NEW: Store student's current answers (not yet submitted) for reading comprehension
        let currentReadingAnswers = [];

        // NEW: Reading Comprehension Question Banks
        let readingQuestionBanks = [];

        // NEW: Sequencing and Matching Questions (Teacher side)
        let sequencingData = {
            question: '',
            correctOrder: [] // Array of items in correct order
        };
        let matchingData = {
            question: '',
            pairs: [] // Array of {left, right} objects
        };
        let currentMatchingSelection = {
            leftItem: null,
            rightItem: null
        };
        let currentMultipleChoiceQuestions = null; // Stores questions from Firestore for student/teacher monitor

        // NEW: Peer Review System Variables
        let peerReviewActive = false; // Whether peer review is currently active
        let peerReviewUnsubscribe = null; // Unsubscribe function for peer review votes listener
        let studentVotedWorks = new Set(); // Track which works this student has voted for
        let allPeerReviewVotes = {}; // Global object to store all votes data
        const MAX_VOTES_PER_STUDENT = 3; // Maximum votes per student per interaction
        
        // Canvas content preservation
        let savedCanvasState = null; // Save student's drawing when switching to peer review
        

        // --- DOM Elements Caching ---
        const views = {
            entry: document.getElementById('entry-view'),
            teacherClassroomCode: document.getElementById('teacher-classroom-code-view'), // NEW VIEW
            teacherMenu: document.getElementById('teacher-menu-view'),
            teacherMonitor: document.getElementById('teacher-monitor-view'),
            studentName: document.getElementById('student-name-view'),
            studentWaiting: document.getElementById('student-waiting-view'),
            studentInteraction: document.getElementById('student-interaction-view'),
            studentPeerReview: document.getElementById('student-peer-review-view'), // NEW VIEW
        };

        const interactionUIs = {
            true_false: document.getElementById('interaction-true-false'),
            multiple_choice: document.getElementById('interaction-multiple-choice'),
            text_input: document.getElementById('interaction-text-input'),
            word_cloud: document.getElementById('interaction-word-cloud'), // Word cloud UI
            sticky_note: document.getElementById('interaction-sticky-note'), // Sticky note wall UI
            focus_game: document.getElementById('interaction-focus-game'), // Focus game UI
            drawing: document.getElementById('interaction-drawing'),
            url_dispatch: document.getElementById('interaction-url-dispatch'), // Now handles both URL and HTML
            recording: document.getElementById('interaction-recording'), // New UI
            reading_comprehension: document.getElementById('interaction-reading-comprehension'), // Reading comprehension UI
            quick_answer: document.getElementById('interaction-quick-answer'), // Quick answer UI
            quick_poll: document.getElementById('interaction-quick-poll'), // Quick poll UI
            sequencing: document.getElementById('interaction-sequencing'), // Sequencing UI
            matching: document.getElementById('interaction-matching'), // Matching UI
        };

        // --- Core Logic Functions ---
        /**
         * Displays the specified view section.
         * @param {string} viewName - The name of the view to display (key in `views` object).
         */
        function showView(viewName) {
            const body = document.querySelector('body');
            body.classList.remove('initial-view-background');

            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewName]) {
                views[viewName].classList.remove('hidden');
                if (viewName === 'entry') {
                    body.classList.add('initial-view-background');
                }
            }
        }
        
        /**
         * Displays the UI for a specific interaction mode within the student interface.
         * @param {string} mode - The interaction mode (e.g., 'true_false', 'drawing', 'recording', 'url_dispatch').
         * @param {boolean} [isResumingFromPause=false] - True if this is part of resuming from a paused state.
         */
        function showInteractionUI(mode, isResumingFromPause = false) {
             Object.values(interactionUIs).forEach(ui => ui.classList.add('hidden'));
             // Clear URL dispatch content if switching to another mode
             if (mode !== 'url_dispatch' && interactionUIs.url_dispatch) {
                interactionUIs.url_dispatch.innerHTML = ''; // Clear content for URL/HTML dispatch
                interactionUIs.url_dispatch.style.cssText = ''; // Reset container styles
             }

             // Disable pull-to-refresh prevention when leaving reading comprehension mode
             if (mode !== 'reading_comprehension') {
                disablePullToRefreshPrevention();
             }

             if (interactionUIs[mode]) {
                interactionUIs[mode].classList.remove('hidden');
                resetStudentUIState(mode, isResumingFromPause); // Pass the flag

                // Special handling for quick answer mode
                if (mode === 'quick_answer') {
                    startQuickAnswer();
                    listenToQuickAnswerUpdates();
                }
             }
        }

        /**
         * Resets the student UI state, e.g., clears input fields or enables buttons.
         * @param {string} mode - The current interaction mode.
         * @param {boolean} [isResumingFromPause=false] - True if this reset is part of resuming from a paused state.
         */
        function resetStudentUIState(mode, isResumingFromPause = false) {
            const grayClass = 'bg-gray-400';
            const hoverClassMap = {
                '1': 'hover:bg-blue-600', '2': 'hover:bg-yellow-600',
                '3': 'hover:bg-green-600', '4': 'hover:bg-red-600'
            };
            
            // Ensure all interaction UIs are enabled by default before applying pause state
            document.querySelectorAll('#student-interaction-view button, #student-interaction-view textarea, #student-interaction-view input[type="file"], #student-interaction-view select, #student-interaction-view input[type="radio"]').forEach(el => {
                el.disabled = false;
                // Re-add original classes if they were removed by pause state
                if (el.classList.contains('btn-gray')) {
                    el.classList.remove('btn-gray');
                    el.classList.add('btn-primary'); // Assuming primary is default for many
                }
            });
            // Re-enable canvas interaction
            canvas.style.pointerEvents = 'auto';

            switch(mode) {
                case 'true_false':
                    interactionUIs[mode].querySelectorAll('.answer-btn').forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove(grayClass);
                        if (btn.dataset.answer === 'O') btn.classList.replace('bg-gray-400', 'bg-green-500');
                        if (btn.dataset.answer === 'X') btn.classList.replace('bg-gray-400', 'bg-red-500');
                    });
                    break;
                case 'multiple_choice':
                    // Reset default MC options
                    const defaultMcOptions = document.getElementById('default-mc-options');
                    defaultMcOptions.querySelectorAll('.answer-btn').forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove(grayClass);
                        if (btn.dataset.answer === '1') btn.classList.replace('bg-gray-400', 'bg-blue-500');
                        if (btn.dataset.answer === '2') btn.classList.replace('bg-gray-400', 'bg-yellow-500');
                        if (btn.dataset.answer === '3') btn.classList.replace('bg-gray-400', 'bg-green-500');
                        if (btn.dataset.answer === '4') btn.classList.replace('bg-gray-400', 'bg-red-500');
                        btn.classList.add(hoverClassMap[btn.dataset.answer]);
                    });
                    // Reset custom MC options (but preserve submission state)
                    document.getElementById('custom-mc-questions-container').innerHTML = '';
                    // NEW: 只有在不是從暫停狀態恢復時才重置按鈕，避免覆蓋已提交狀態
                    if (!isResumingFromPause) {
                        const submitBtn = document.getElementById('submit-custom-mc-btn');
                        submitBtn.disabled = false;
                        submitBtn.classList.replace('btn-gray', 'btn-primary');
                        submitBtn.textContent = '送出全部答案 ✉️';
                    }
                    break;
                case 'text_input':
                    document.getElementById('text-input-area').value = '';
                    const submitTextBtn = document.getElementById('submit-text-btn');
                    submitTextBtn.disabled = false;
                    submitTextBtn.classList.remove('btn-gray');
                    submitTextBtn.classList.add('btn-primary');
                    break;
                case 'word_cloud':
                    document.getElementById('word-cloud-input').value = '';
                    document.getElementById('word-cloud-char-count').textContent = '0';
                    const submitWordCloudBtn = document.getElementById('submit-word-cloud-btn');
                    submitWordCloudBtn.disabled = false;
                    submitWordCloudBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'btn-gray');
                    break;
                case 'sticky_note':
                    // Reset text input
                    document.getElementById('sticky-note-text').value = '';
                    document.getElementById('sticky-text-char-count').textContent = '0';
                    // Reset image input
                    stickyNoteImageData = null;
                    document.getElementById('sticky-image-preview').classList.add('hidden');
                    document.getElementById('sticky-image-input').value = '';
                    // Reset to text tab
                    document.getElementById('sticky-text-tab').classList.add('bg-amber-500', 'text-white');
                    document.getElementById('sticky-text-tab').classList.remove('bg-slate-200', 'text-slate-600');
                    document.getElementById('sticky-image-tab').classList.remove('bg-amber-500', 'text-white');
                    document.getElementById('sticky-image-tab').classList.add('bg-slate-200', 'text-slate-600');
                    document.getElementById('sticky-text-section').classList.remove('hidden');
                    document.getElementById('sticky-image-section').classList.add('hidden');
                    // Enable submit button
                    const submitStickyNoteBtn = document.getElementById('submit-sticky-note-btn');
                    submitStickyNoteBtn.disabled = false;
                    submitStickyNoteBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    break;
                case 'drawing':
                    // Only clear the drawing canvas if it's NOT resuming from a pause.
                    // If isResumingFromPause is true, it means we are re-enabling controls
                    // within the *same* drawing session after a pause, so preserve the drawing.
                    if (!isResumingFromPause) {
                         clearDrawingCanvas(); // Clears only the student's drawing layer.
                         studentUploadedImageDataURL = null; // Clear student uploaded image too
                         studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);
                    }
                    
                    const submitDrawingBtn = document.getElementById('submit-drawing-btn');
                    submitDrawingBtn.disabled = false;
                    submitDrawingBtn.classList.replace('btn-gray', 'btn-primary');
                    
                    // Reset drawing tools to default values.
                    const colorSelect = document.getElementById('color-select');
                    const sizeSelect = document.getElementById('size-select');
                    const penToolBtn = document.getElementById('pen-tool-btn');
                    const eraserBtn = document.getElementById('eraser-btn');

                    colorSelect.value = 'black';
                    sizeSelect.value = '2';
                    drawingCtx.strokeStyle = 'black'; 
                    drawingCtx.lineWidth = 2;
                    drawingCtx.globalCompositeOperation = 'source-over'; 
                    
                    penToolBtn.classList.add('border-blue-500');
                    eraserBtn.classList.remove('border-blue-500');

                    updateColorSwatch(colorSelect.value);
                    break;
                case 'url_dispatch': // This mode now handles both URL and HTML
                    // Content is dynamically generated, no specific reset needed here beyond clearing in showInteractionUI
                    break;
                case 'recording':
                    // Reset recording state
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                    }
                    if (audioStream) {
                        audioStream.getTracks().forEach(track => track.stop());
                    }
                    audioChunks = [];
                    audioBlob = null;
                    audioDataURL = null;
                    document.getElementById('audio-preview').classList.add('hidden');
                    document.getElementById('audio-preview').src = '';
                    document.getElementById('start-recording-btn').disabled = false;
                    document.getElementById('stop-recording-btn').disabled = true;
                    document.getElementById('play-recording-btn').disabled = true;
                    document.getElementById('reset-recording-btn').disabled = true;
                    document.getElementById('submit-recording-btn').disabled = true;
                    recordingStatusText.textContent = '準備錄音...';
                    recordingStatusIcon.classList.remove('fa-spin', 'text-red-500');
                    recordingStatusIcon.classList.add('text-gray-400');
                    break;
                case 'quick_answer':
                    // Reset quick answer state
                    document.getElementById('quick-answer-status-text').textContent = '等待搶答開始...';
                    document.getElementById('quick-answer-result').classList.add('hidden');
                    document.getElementById('quick-answer-locked').classList.add('hidden');
                    document.getElementById('quick-answer-button-container').innerHTML = '';
                    document.getElementById('quick-answer-button-container').classList.add('pointer-events-none');
                    break;
                case 'sequencing':
                    // Reset sequencing state
                    document.getElementById('sequencing-items-container').innerHTML = '';
                    const submitSequencingBtn = document.getElementById('submit-sequencing-btn');
                    submitSequencingBtn.disabled = false;
                    submitSequencingBtn.classList.remove('btn-gray');
                    submitSequencingBtn.classList.add('btn-primary');
                    break;
                case 'matching':
                    // Reset matching state
                    document.getElementById('matching-column-a').innerHTML = '';
                    document.getElementById('matching-column-b').innerHTML = '';
                    document.getElementById('matching-svg-canvas').innerHTML = '';
                    const submitMatchingBtn = document.getElementById('submit-matching-btn');
                    submitMatchingBtn.disabled = false;
                    submitMatchingBtn.classList.remove('btn-gray');
                    submitMatchingBtn.classList.add('btn-primary');
                    currentMatchingSelection.leftItem = null;
                    currentMatchingSelection.rightItem = null;
                    break;
                case 'focus_game':
                    // Focus game initialization is handled in listenToInteractionMode
                    // to ensure we use the correct numberCount from Firebase
                    break;
                case 'reading_comprehension':
                    // Only clear content if not resuming from pause
                    if (!isResumingFromPause) {
                        document.getElementById('reading-text-display').textContent = '';
                        document.getElementById('reading-questions-container').innerHTML = '';
                        // Clear local answers when switching to a new reading comprehension session
                        currentReadingAnswers = [];
                    }
                    const submitReadingBtn = document.getElementById('submit-reading-btn');
                    // Don't reset button state if resuming from pause (preserve submitted state)
                    if (!isResumingFromPause) {
                        submitReadingBtn.disabled = false;
                        submitReadingBtn.classList.remove('btn-gray');
                        submitReadingBtn.classList.add('btn-primary');
                    }
                    // Disable pull-to-refresh on iOS/iPadOS
                    enablePullToRefreshPrevention();
                    break;
                case 'quick_poll':
                    // Reset quick poll state
                    document.getElementById('quick-poll-options-container').innerHTML = '';
                    document.getElementById('quick-poll-options-container').classList.remove('hidden');
                    document.getElementById('quick-poll-voted-status').classList.add('hidden');
                    document.getElementById('quick-poll-question-display').textContent = '';
                    break;
            }
        }

        /**
         * Toggles the enabled/disabled state of student interaction elements.
         * @param {boolean} disable - True to disable, false to enable.
         */
        function toggleStudentInteractionElements(disable) {
            const studentInteractionView = document.getElementById('student-interaction-view');
            // Select all interactive elements within the student interaction view, excluding the pause overlay itself.
            const interactiveElements = studentInteractionView.querySelectorAll(
                'button, textarea, input[type="file"], select, input[type="radio"]' // Added input[type="radio"]
            );

            interactiveElements.forEach(el => {
                // Only disable if the element is not the pause overlay itself or its children
                if (!el.closest('#student-pause-overlay')) {
                    el.disabled = disable;
                    if (disable) {
                        // Add a class for visual feedback if needed, e.g., gray out
                        if (el.tagName === 'BUTTON' && !el.classList.contains('btn-gray')) {
                            el.classList.add('btn-gray');
                            el.classList.remove('btn-primary', 'btn-green', 'btn-orange', 'btn-purple', 'btn-teal', 'bg-indigo-600', 'hover:bg-indigo-700', 'bg-yellow-600', 'hover:bg-yellow-700'); // Remove original colors
                        }
                    } else {
                        // Re-enable and restore original styles
                        if (el.tagName === 'BUTTON' && el.classList.contains('btn-gray')) {
                            el.classList.remove('btn-gray');
                            // Restore based on common button types or specific IDs
                            if (el.id === 'submit-text-btn' || el.id === 'submit-drawing-btn' || el.id === 'submit-recording-btn' || el.id === 'submit-custom-mc-btn' || el.id === 'submit-reading-btn' || el.id === 'submit-sequencing-btn' || el.id === 'submit-matching-btn') {
                                el.classList.add('btn-primary');
                            } else if (el.classList.contains('answer-btn')) {
                                // For answer buttons, re-apply their specific colors
                                if (el.dataset.answer === 'O') el.classList.add('bg-green-500');
                                else if (el.dataset.answer === 'X') el.classList.add('bg-red-500');
                                else if (el.dataset.answer === '1') el.classList.add('bg-blue-500');
                                else if (el.dataset.answer === '2') el.classList.add('bg-yellow-500');
                                else if (el.dataset.answer === '3') el.classList.add('bg-green-500');
                                else if (el.dataset.answer === '4') el.classList.add('bg-red-500');
                            } else if (el.id === 'start-recording-btn') {
                                el.classList.add('btn-green');
                            } else if (el.id === 'stop-recording-btn') {
                                el.classList.add('btn-red');
                            } else if (el.id === 'play-recording-btn') {
                                el.classList.add('btn-primary');
                            } else if (el.id === 'reset-recording-btn') {
                                el.classList.add('btn-orange');
                            } else if (el.id === 'pen-tool-btn') {
                                el.classList.add('border-blue-500'); // Pen button border
                            }
                        }
                    }
                }
            });

            // Handle canvas interaction separately
            canvas.style.pointerEvents = disable ? 'none' : 'auto';

            // Handle recording specific buttons that might be disabled by default
            if (currentInteractionMode === 'recording' && !disable) {
                // Only enable start if not already recording
                if (mediaRecorder && mediaRecorder.state === 'inactive') {
                    document.getElementById('start-recording-btn').disabled = false;
                }
                // Other recording buttons remain disabled until recording starts/stops
            }
        }
        
        /**
         * Displays a custom message box.
         * @param {string} message - The message to display.
         * @param {'info' | 'success' | 'error'} type - The message type, influencing its color.
         */
        function showMessage(message, type = 'info') {
            const msgBox = document.getElementById('message-box');
            const msgContent = document.getElementById('message-content');
            msgContent.textContent = message;
            msgBox.className = 'fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform text-white';
            switch (type) {
                case 'success': msgBox.classList.add('bg-green-500'); break;
                case 'error': msgBox.classList.add('bg-red-500'); break;
                case 'info': msgBox.classList.add('bg-blue-500'); break;
                default: msgBox.classList.add('bg-blue-500'); break;
            }
            msgBox.classList.remove('hidden');
            setTimeout(() => {
                msgBox.classList.add('hidden');
            }, 3000); // Auto-hide after 3 seconds.
        }

        /**
         * Question Bank Management Functions (Classroom-specific)
         */
        function getQuestionBankKey() {
            return classroomCode ? `questionBanks_${classroomCode}` : 'questionBanks_default';
        }

        function loadQuestionBanksFromStorage() {
            if (!classroomCode) return;
            const key = getQuestionBankKey();
            const stored = localStorage.getItem(key);
            if (stored) {
                try {
                    questionBanks = JSON.parse(stored);
                } catch (e) {
                    console.error('載入題庫失敗:', e);
                    questionBanks = [];
                }
            } else {
                questionBanks = [];
            }
        }

        function saveQuestionBanksToStorage() {
            if (!classroomCode) return;
            const key = getQuestionBankKey();
            try {
                localStorage.setItem(key, JSON.stringify(questionBanks));
            } catch (e) {
                console.error('儲存題庫失敗:', e);
            }
        }

        function updateQuestionBankList() {
            loadQuestionBanksFromStorage(); // Load from storage first
            const list = document.getElementById('question-bank-list');
            if (questionBanks.length === 0) {
                list.innerHTML = '<div class="text-gray-500 text-sm italic text-center">目前沒有儲存的題庫</div>';
            } else {
                list.innerHTML = questionBanks.map((bank, index) => `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded border">
                        <span class="text-sm font-medium text-gray-700">${bank.name}</span>
                        <div class="flex gap-2">
                            <button onclick="loadQuestionBankToTextarea(${index})" class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded">載入</button>
                            <button onclick="deleteQuestionBank(${index})" class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded">刪除</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function loadQuestionBankFromFile() {
            const fileInput = document.getElementById('question-bank-file-input');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('請選擇一個txt檔案', 'error');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.txt')) {
                showMessage('只能上傳txt格式的檔案', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const fileName = file.name.replace('.txt', '');

                // Check if bank with same name exists
                const existingIndex = questionBanks.findIndex(bank => bank.name === fileName);
                if (existingIndex !== -1) {
                    if (confirm(`題庫「${fileName}」已存在，是否要覆蓋？`)) {
                        questionBanks[existingIndex] = { name: fileName, content: content };
                    } else {
                        return;
                    }
                } else {
                    questionBanks.push({ name: fileName, content: content });
                }

                updateQuestionBankList();
                showMessage(`題庫「${fileName}」載入成功`, 'success');
                fileInput.value = ''; // Clear file input
            };

            reader.onerror = function() {
                showMessage('讀取檔案時發生錯誤', 'error');
            };

            reader.readAsText(file, 'UTF-8');
        }

        function saveQuestionBankFromTextarea() {
            const nameInput = document.getElementById('question-bank-name-input');
            const textarea = document.getElementById('custom-mc-questions-textarea');
            const name = nameInput.value.trim();
            const content = textarea.value.trim();

            if (!name) {
                showMessage('請輸入題庫名稱', 'error');
                return;
            }

            if (!content) {
                showMessage('題目內容不能為空', 'error');
                return;
            }

            loadQuestionBanksFromStorage(); // Load latest from storage

            // Check if bank with same name exists
            const existingIndex = questionBanks.findIndex(bank => bank.name === name);
            if (existingIndex !== -1) {
                if (confirm(`題庫「${name}」已存在，是否要覆蓋？`)) {
                    questionBanks[existingIndex] = { name: name, content: content };
                } else {
                    return;
                }
            } else {
                questionBanks.push({ name: name, content: content });
            }

            saveQuestionBanksToStorage(); // Save to storage
            updateQuestionBankList();
            showMessage(`題庫「${name}」儲存成功`, 'success');
            nameInput.value = ''; // Clear name input
        }

        function loadQuestionBankToTextarea(index) {
            if (index >= 0 && index < questionBanks.length) {
                const textarea = document.getElementById('custom-mc-questions-textarea');
                textarea.value = questionBanks[index].content;
                showMessage(`題庫「${questionBanks[index].name}」已載入到輸入框`, 'success');
            }
        }

        function deleteQuestionBank(index) {
            loadQuestionBanksFromStorage(); // Load latest from storage
            if (index >= 0 && index < questionBanks.length) {
                const bankName = questionBanks[index].name;
                if (confirm(`確定要刪除題庫「${bankName}」嗎？`)) {
                    questionBanks.splice(index, 1);
                    saveQuestionBanksToStorage(); // Save to storage
                    updateQuestionBankList();
                    showMessage(`題庫「${bankName}」已刪除`, 'success');
                }
            }
        }

        // Make functions globally accessible for onclick handlers
        window.loadQuestionBankToTextarea = loadQuestionBankToTextarea;
        window.deleteQuestionBank = deleteQuestionBank;

        function clearAllQuestionBanks() {
            if (!classroomCode) {
                console.warn('無法清除題庫：教室代碼為空');
                return;
            }

            // Store current classroom code for logging
            const currentClassroom = classroomCode;

            // Clear question banks from localStorage for current classroom only
            const mcKey = `questionBanks_${currentClassroom}`;
            localStorage.removeItem(mcKey);
            console.log(`已刪除選擇題題庫: ${mcKey}`);

            // Clear sequencing banks
            const seqKey = `sequencingBanks_${currentClassroom}`;
            localStorage.removeItem(seqKey);
            console.log(`已刪除排序題題庫: ${seqKey}`);

            // Clear matching banks
            const matchKey = `matchingBanks_${currentClassroom}`;
            localStorage.removeItem(matchKey);
            console.log(`已刪除配對題題庫: ${matchKey}`);

            // Clear reading comprehension question banks
            const readingKey = `readingQuestionBanks_${currentClassroom}`;
            localStorage.removeItem(readingKey);
            console.log(`已刪除閱讀測驗題庫: ${readingKey}`);

            // Clear memory arrays (these will be reset when entering another classroom)
            questionBanks = [];
            sequencingQuestionBanks = [];
            matchingQuestionBanks = [];
            readingQuestionBanks = [];

            console.log(`✓ 已完全清除教室 ${currentClassroom} 的所有題庫，其他教室題庫不受影響`);
        }

        // ==================== Sequencing Question Bank Functions ====================

        function getSequencingBankKey() {
            return classroomCode ? `sequencingBanks_${classroomCode}` : 'sequencingBanks_default';
        }

        function loadSequencingBanksFromStorage() {
            if (!classroomCode) return;
            const key = getSequencingBankKey();
            const stored = localStorage.getItem(key);
            if (stored) {
                try {
                    sequencingQuestionBanks = JSON.parse(stored);
                } catch (e) {
                    console.error('載入排序題庫失敗:', e);
                    sequencingQuestionBanks = [];
                }
            } else {
                sequencingQuestionBanks = [];
            }
        }

        function saveSequencingBanksToStorage() {
            if (!classroomCode) return;
            const key = getSequencingBankKey();
            try {
                localStorage.setItem(key, JSON.stringify(sequencingQuestionBanks));
            } catch (e) {
                console.error('儲存排序題庫失敗:', e);
            }
        }

        function updateSequencingBankList() {
            loadSequencingBanksFromStorage(); // Load from storage first
            const list = document.getElementById('seq-bank-list');
            if (sequencingQuestionBanks.length === 0) {
                list.innerHTML = '<div class="text-gray-500 text-sm italic text-center">目前沒有儲存的題庫</div>';
            } else {
                list.innerHTML = sequencingQuestionBanks.map((bank, index) => `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded border">
                        <span class="text-sm font-medium text-gray-700">${bank.name}</span>
                        <div class="flex gap-2">
                            <button onclick="loadSequencingBankToTextarea(${index})" class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded">載入</button>
                            <button onclick="deleteSequencingBank(${index})" class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded">刪除</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function loadSequencingBankFromFile() {
            const fileInput = document.getElementById('seq-bank-file-input');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('請選擇一個txt檔案', 'error');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.txt')) {
                showMessage('只能上傳txt格式的檔案', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const fileName = file.name.replace('.txt', '');
                const lines = content.split('\n').map(line => line.trim()).filter(line => line);

                if (lines.length < 2) {
                    showMessage('題庫格式錯誤：至少需要2個排序項目', 'error');
                    return;
                }

                const question = '排序題';
                const items = lines.join('\n');

                loadSequencingBanksFromStorage(); // Load latest from storage
                const existingIndex = sequencingQuestionBanks.findIndex(bank => bank.name === fileName);
                if (existingIndex !== -1) {
                    if (confirm(`題庫「${fileName}」已存在，是否要覆蓋？`)) {
                        sequencingQuestionBanks[existingIndex] = { name: fileName, question: question, items: items };
                    } else {
                        return;
                    }
                } else {
                    sequencingQuestionBanks.push({ name: fileName, question: question, items: items });
                }

                saveSequencingBanksToStorage(); // Save to storage
                updateSequencingBankList();
                showMessage(`題庫「${fileName}」載入成功`, 'success');
                fileInput.value = '';
            };

            reader.onerror = function() {
                showMessage('讀取檔案時發生錯誤', 'error');
            };

            reader.readAsText(file, 'UTF-8');
        }

        function saveSequencingBank() {
            const nameInput = document.getElementById('seq-bank-name-input');
            const itemsTextarea = document.getElementById('sequencing-items-textarea');

            const name = nameInput.value.trim();
            const question = '排序題';
            const items = itemsTextarea.value.trim();

            if (!name) {
                showMessage('請輸入題庫名稱', 'error');
                return;
            }

            if (!items) {
                showMessage('排序項目不能為空', 'error');
                return;
            }

            loadSequencingBanksFromStorage(); // Load latest from storage
            const existingIndex = sequencingQuestionBanks.findIndex(bank => bank.name === name);
            if (existingIndex !== -1) {
                if (confirm(`題庫「${name}」已存在，是否要覆蓋？`)) {
                    sequencingQuestionBanks[existingIndex] = { name: name, question: question, items: items };
                } else {
                    return;
                }
            } else {
                sequencingQuestionBanks.push({ name: name, question: question, items: items });
            }

            saveSequencingBanksToStorage(); // Save to storage
            updateSequencingBankList();
            showMessage(`題庫「${name}」儲存成功`, 'success');
            nameInput.value = '';
        }

        function loadSequencingBankToTextarea(index) {
            if (index >= 0 && index < sequencingQuestionBanks.length) {
                const bank = sequencingQuestionBanks[index];
                document.getElementById('sequencing-items-textarea').value = bank.items;
                showMessage(`題庫「${bank.name}」已載入到輸入框`, 'success');
            }
        }

        function deleteSequencingBank(index) {
            loadSequencingBanksFromStorage(); // Load latest from storage
            if (index >= 0 && index < sequencingQuestionBanks.length) {
                const bankName = sequencingQuestionBanks[index].name;
                if (confirm(`確定要刪除題庫「${bankName}」嗎？`)) {
                    sequencingQuestionBanks.splice(index, 1);
                    saveSequencingBanksToStorage(); // Save to storage
                    updateSequencingBankList();
                    showMessage(`題庫「${bankName}」已刪除`, 'success');
                }
            }
        }

        // ==================== Matching Question Bank Functions ====================

        function getMatchingBankKey() {
            return classroomCode ? `matchingBanks_${classroomCode}` : 'matchingBanks_default';
        }

        function loadMatchingBanksFromStorage() {
            if (!classroomCode) return;
            const key = getMatchingBankKey();
            const stored = localStorage.getItem(key);
            if (stored) {
                try {
                    matchingQuestionBanks = JSON.parse(stored);
                } catch (e) {
                    console.error('載入配對題庫失敗:', e);
                    matchingQuestionBanks = [];
                }
            } else {
                matchingQuestionBanks = [];
            }
        }

        function saveMatchingBanksToStorage() {
            if (!classroomCode) return;
            const key = getMatchingBankKey();
            try {
                localStorage.setItem(key, JSON.stringify(matchingQuestionBanks));
            } catch (e) {
                console.error('儲存配對題庫失敗:', e);
            }
        }

        function updateMatchingBankList() {
            loadMatchingBanksFromStorage(); // Load from storage first
            const list = document.getElementById('match-bank-list');
            if (matchingQuestionBanks.length === 0) {
                list.innerHTML = '<div class="text-gray-500 text-sm italic text-center">目前沒有儲存的題庫</div>';
            } else {
                list.innerHTML = matchingQuestionBanks.map((bank, index) => `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded border">
                        <span class="text-sm font-medium text-gray-700">${bank.name}</span>
                        <div class="flex gap-2">
                            <button onclick="loadMatchingBankToTextarea(${index})" class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded">載入</button>
                            <button onclick="deleteMatchingBank(${index})" class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded">刪除</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function loadMatchingBankFromFile() {
            const fileInput = document.getElementById('match-bank-file-input');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('請選擇一個txt檔案', 'error');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.txt')) {
                showMessage('只能上傳txt格式的檔案', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const fileName = file.name.replace('.txt', '');
                const lines = content.split('\n').map(line => line.trim()).filter(line => line);

                if (lines.length < 2) {
                    showMessage('題庫格式錯誤：至少需要2組配對項目', 'error');
                    return;
                }

                const question = '配對題';
                const pairs = lines.join('\n');

                loadMatchingBanksFromStorage(); // Load latest from storage
                const existingIndex = matchingQuestionBanks.findIndex(bank => bank.name === fileName);
                if (existingIndex !== -1) {
                    if (confirm(`題庫「${fileName}」已存在，是否要覆蓋？`)) {
                        matchingQuestionBanks[existingIndex] = { name: fileName, question: question, pairs: pairs };
                    } else {
                        return;
                    }
                } else {
                    matchingQuestionBanks.push({ name: fileName, question: question, pairs: pairs });
                }

                saveMatchingBanksToStorage(); // Save to storage
                updateMatchingBankList();
                showMessage(`題庫「${fileName}」載入成功`, 'success');
                fileInput.value = '';
            };

            reader.onerror = function() {
                showMessage('讀取檔案時發生錯誤', 'error');
            };

            reader.readAsText(file, 'UTF-8');
        }

        function saveMatchingBank() {
            const nameInput = document.getElementById('match-bank-name-input');
            const pairsTextarea = document.getElementById('matching-pairs-textarea');

            const name = nameInput.value.trim();
            const question = '配對題';
            const pairs = pairsTextarea.value.trim();

            if (!name) {
                showMessage('請輸入題庫名稱', 'error');
                return;
            }

            if (!pairs) {
                showMessage('配對項目不能為空', 'error');
                return;
            }

            loadMatchingBanksFromStorage(); // Load latest from storage
            const existingIndex = matchingQuestionBanks.findIndex(bank => bank.name === name);
            if (existingIndex !== -1) {
                if (confirm(`題庫「${name}」已存在，是否要覆蓋？`)) {
                    matchingQuestionBanks[existingIndex] = { name: name, question: question, pairs: pairs };
                } else {
                    return;
                }
            } else {
                matchingQuestionBanks.push({ name: name, question: question, pairs: pairs });
            }

            saveMatchingBanksToStorage(); // Save to storage
            updateMatchingBankList();
            showMessage(`題庫「${name}」儲存成功`, 'success');
            nameInput.value = '';
        }

        function loadMatchingBankToTextarea(index) {
            if (index >= 0 && index < matchingQuestionBanks.length) {
                const bank = matchingQuestionBanks[index];
                document.getElementById('matching-pairs-textarea').value = bank.pairs;
                showMessage(`題庫「${bank.name}」已載入到輸入框`, 'success');
            }
        }

        function deleteMatchingBank(index) {
            loadMatchingBanksFromStorage(); // Load latest from storage
            if (index >= 0 && index < matchingQuestionBanks.length) {
                const bankName = matchingQuestionBanks[index].name;
                if (confirm(`確定要刪除題庫「${bankName}」嗎？`)) {
                    matchingQuestionBanks.splice(index, 1);
                    saveMatchingBanksToStorage(); // Save to storage
                    updateMatchingBankList();
                    showMessage(`題庫「${bankName}」已刪除`, 'success');
                }
            }
        }

        // Make functions globally accessible
        window.loadSequencingBankToTextarea = loadSequencingBankToTextarea;
        window.deleteSequencingBank = deleteSequencingBank;
        window.loadMatchingBankToTextarea = loadMatchingBankToTextarea;
        window.deleteMatchingBank = deleteMatchingBank;

        /**
         * Hides the custom message box.
         */
        function hideMessage() {
            document.getElementById('message-box').classList.add('hidden');
        }

        // --- Firebase Functions ---

        /**
         * (Teacher) Sets the current interaction mode and clears old student response data.
         * @param {string} mode - 'true_false', 'multiple_choice', 'text_input', 'drawing', 'url_dispatch', 'recording', or 'waiting'.
         * @param {object} [options={}] - Optional settings for the mode, e.g., custom questions.
         */
        async function setInteractionMode(mode, options = {}) {
            console.log(`[Teacher] Setting mode to: ${mode}`);
            currentInteractionMode = mode; 
            // Use classroomCode in the Firestore path
            const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
            const showStatisticsBtn = document.getElementById('show-statistics-btn');
            const downloadMediaBtn = document.getElementById('download-media-btn');
            const aiTextSummaryBtn = document.getElementById('ai-text-summary-btn');
            const showUnsubmittedStudentsBtn = document.getElementById('show-unsubmitted-students-btn'); // NEW
            const viewQuestionsBtn = document.getElementById('view-questions-btn'); // NEW
            const viewReadingQuestionsBtn = document.getElementById('view-reading-questions-btn'); // NEW
            const downloadResponsesBtn = document.getElementById('download-responses-btn'); // NEW

            // MODIFIED: Show statistics button for true_false, multiple_choice, and reading_comprehension
            showStatisticsBtn.classList.toggle('hidden', mode !== 'true_false' && mode !== 'multiple_choice' && mode !== 'reading_comprehension');

            // NEW: Show view questions button only for multiple_choice with custom questions
            const hasCustomQuestions = mode === 'multiple_choice' && options.customQuestions && options.customQuestions.length > 0;
            viewQuestionsBtn.classList.toggle('hidden', !hasCustomQuestions);

            // NEW: Show view reading questions button only for reading_comprehension
            viewReadingQuestionsBtn.classList.toggle('hidden', mode !== 'reading_comprehension');

            // NEW: Show peer review button only for text_input and drawing modes
            const startPeerReviewBtn = document.getElementById('start-peer-review-btn');
            startPeerReviewBtn.classList.toggle('hidden', mode !== 'text_input' && mode !== 'drawing');

            // NEW: Reset peer review button state when starting new interaction
            if (mode !== 'waiting') {
                peerReviewActive = false;
                startPeerReviewBtn.innerHTML = '<i class="fas fa-heart mr-2"></i> 開始互評 ❤️';
                document.getElementById('peer-review-stats-container').classList.add('hidden');

                // Reset peer review status in Firebase for new interaction
                const peerReviewRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'peerReview');
                setDoc(peerReviewRef, { active: false }).catch(error => {
                    console.error('Error resetting peer review status:', error);
                });

                // Clear student voting history for new interaction
                studentVotedWorks.clear();

                // Clear saved canvas state for new interaction
                savedCanvasState = null;
            }
            downloadMediaBtn.classList.toggle('hidden', mode !== 'drawing' && mode !== 'recording');
            aiTextSummaryBtn.classList.toggle('hidden', mode !== 'text_input');
            // NEW: Show unsubmitted students button for specific modes
            showUnsubmittedStudentsBtn.classList.toggle('hidden', mode === 'waiting' || mode === 'url_dispatch');
            // NEW: Show download responses button for text_input, multiple_choice with custom questions, and reading_comprehension
            const showDownloadBtn = mode === 'text_input' || (mode === 'multiple_choice' && hasCustomQuestions) || mode === 'reading_comprehension';
            downloadResponsesBtn.classList.toggle('hidden', !showDownloadBtn);


            // NEW: Hide pause button for URL/HTML dispatch modes
            const togglePauseBtn = document.getElementById('toggle-pause-btn');
            togglePauseBtn.classList.toggle('hidden', mode === 'url_dispatch');

            // WORD CLOUD: For word_cloud mode, hide all buttons except unsubmitted students button
            if (mode === 'word_cloud') {
                showStatisticsBtn.classList.add('hidden');
                viewQuestionsBtn.classList.add('hidden');
                viewReadingQuestionsBtn.classList.add('hidden');
                startPeerReviewBtn.classList.add('hidden');
                downloadMediaBtn.classList.add('hidden');
                aiTextSummaryBtn.classList.add('hidden');
                downloadResponsesBtn.classList.add('hidden');
                togglePauseBtn.classList.add('hidden');
                // Keep showUnsubmittedStudentsBtn visible
                showUnsubmittedStudentsBtn.classList.remove('hidden');
            }

            // STICKY NOTE: For sticky_note mode, hide all buttons except unsubmitted students button
            if (mode === 'sticky_note') {
                showStatisticsBtn.classList.add('hidden');
                viewQuestionsBtn.classList.add('hidden');
                viewReadingQuestionsBtn.classList.add('hidden');
                startPeerReviewBtn.classList.add('hidden');
                downloadMediaBtn.classList.add('hidden');
                aiTextSummaryBtn.classList.add('hidden');
                downloadResponsesBtn.classList.add('hidden');
                togglePauseBtn.classList.add('hidden');
                showUnsubmittedStudentsBtn.classList.remove('hidden');
            }


            try {
                // Clear previous student responses unless it's a waiting state.
                if (mode !== 'waiting') {
                    const studentsColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
                    const querySnapshot = await getDocs(studentsColRef);
                    const deletePromises = [];
                    querySnapshot.forEach((doc) => {
                        deletePromises.push(deleteDoc(doc.ref));
                    });
                    await Promise.all(deletePromises);
                    console.log("[Teacher] Cleared all previous student responses.");
                    lastSelectedStudentCard = null; // Clear highlight on monitor view
                }

                // Prepare data payload for Firestore.
                const payload = { 
                    active_mode: mode,
                    backgroundImage: teacherUploadedBackgroundImageDataURL || null,
                    teacherId: userId, // Store teacher ID
                    isPaused: isResponsePaused // Use current local pause state
                };

                // MODIFIED: Add combined dispatch settings if in that mode.
                if (mode === 'url_dispatch') {
                    payload.dispatchSettings = dispatchSettings; // Send the entire dispatchSettings object
                } else {
                    payload.dispatchSettings = null; // Clear dispatch settings if not in URL_DISPATCH mode
                }

                // NEW: Add custom multiple choice questions if in that mode.
                // If mode is multiple_choice and options.customQuestions is explicitly null, it means no custom questions.
                if (mode === 'multiple_choice' && options.hasOwnProperty('customQuestions')) {
                    payload.multiple_choice_questions = options.customQuestions;
                } else {
                    payload.multiple_choice_questions = null; // Clear if not multiple_choice mode or if customQuestions not provided
                }
                currentMultipleChoiceQuestions = payload.multiple_choice_questions; // Update global for teacher monitor

                // NEW: Add sequencing settings if in that mode
                if (mode === 'sequencing' && options.question && options.correctOrder) {
                    payload.sequencingSettings = {
                        question: options.question,
                        correctOrder: options.correctOrder
                    };
                } else {
                    payload.sequencingSettings = null;
                }

                // NEW: Add matching settings if in that mode
                if (mode === 'matching' && options.question && options.pairs) {
                    payload.matchingSettings = {
                        question: options.question,
                        pairs: options.pairs
                    };
                } else {
                    payload.matchingSettings = null;
                }

                // NEW: Add reading comprehension data if in that mode
                if (mode === 'reading_comprehension' && options.readingData) {
                    payload.readingComprehensionData = options.readingData;
                } else {
                    payload.readingComprehensionData = null;
                }

                // NEW: Add focus game settings if in that mode
                if (mode === 'focus_game' && options.numberCount) {
                    payload.focusGameSettings = {
                        numberCount: options.numberCount
                    };
                } else {
                    payload.focusGameSettings = null;
                }

                await setDoc(controlRef, payload, { merge: true });

                // Handle student responses listener based on mode
                if (studentResponsesUnsubscribe) {
                    studentResponsesUnsubscribe();
                    studentResponsesUnsubscribe = null;
                }

                if (mode === 'url_dispatch') { // Now handles both URL and HTML
                    // For URL/HTML dispatch, the monitor view shows online students, handled by presence listener.
                    // Clear existing responses display if any.
                    document.getElementById('student-responses-container').innerHTML = '<p class="text-gray-500 text-center col-span-full">正在等待學生作答...</p>';
                } else if (mode === 'waiting') {
                    // When going to 'waiting' mode, ensure the student responses container is cleared
                    // and shows the "waiting" message.
                    document.getElementById('student-responses-container').innerHTML = '<p class="text-gray-500 text-center col-span-full">正在等待學生作答...</p>';
                } else { // For other interaction modes (true_false, multiple_choice, text_input, drawing, recording, quick_answer)
                    listenToStudentSubmissions(mode); // Ensure this listener is active
                }

            } catch (error) {
                console.error("設定互動模式或清除學生資料失敗:", error);
                showMessage("操作失敗，請檢查網路連線或聯繫管理員。", "error");
            }
        }

        /**
         * (Student) Listens for changes in the teacher's interaction mode and switches the student interface accordingly.
         */
        function listenToInteractionMode() {
            // Use classroomCode in the Firestore path
            const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
            // Ensure only one interaction mode listener is active for the student
            if (interactionModeUnsubscribe) interactionModeUnsubscribe(); 

            interactionModeUnsubscribe = onSnapshot(controlRef, async (docSnap) => {
                const studentPauseOverlay = document.getElementById('student-pause-overlay');
                const interactionMultipleChoice = document.getElementById('interaction-multiple-choice'); // Get the MC container

                if (!docSnap.exists()) {
                    // Teacher has ended the class session (control document deleted)
                    console.log("[Student] Teacher has ended the class session.");
                    classroomCode = null; // Clear student's classroom code
                    studentName = null; // Clear student's name
                    document.getElementById('user-id-display').textContent = userId; // Reset user ID display
                    showMessage('老師已結束課程，請重新選擇角色。', 'info');
                    showView('entry'); // Go back to the initial entry screen
                    // Unsubscribe from student responses and presence if they were active
                    if (studentResponsesUnsubscribe) {
                        studentResponsesUnsubscribe();
                        studentResponsesUnsubscribe = null;
                    }
                    // IMPORTANT: Unsubscribe student's presence listener as well when class ends
                    if (classroomPresenceUnsubscribe) {
                        classroomPresenceUnsubscribe();
                        classroomPresenceUnsubscribe = null;
                    }
                    studentPauseOverlay.classList.add('hidden'); // Hide overlay if class ends
                    currentInteractionMode = null; // Reset global mode for student
                    isResponsePaused = false; // Reset global pause state for student
                    return; // Exit the function as the session is over
                }

                const data = docSnap.data();
                const newMode = data.active_mode || 'waiting';
                const newIsResponsePaused = data.isPaused || false;
                const newBackgroundImage = data.backgroundImage || null;
                const newMultipleChoiceQuestions = data.multiple_choice_questions || null;

                // Determine if the interaction mode itself has changed
                const modeChanged = (currentInteractionMode !== newMode);
                // Determine if the pause state has changed within the same mode
                const pauseStateChanged = (currentInteractionMode === newMode && isResponsePaused !== newIsResponsePaused);
                // Determine if we are resuming from a pause (mode is same, was paused, now not paused)
                const isResumingFromPause = (currentInteractionMode === newMode) && isResponsePaused && !newIsResponsePaused;


                // Update global states *before* acting on them
                currentInteractionMode = newMode;
                isResponsePaused = newIsResponsePaused;
                teacherUploadedBackgroundImageDataURL = newBackgroundImage; // Update teacher background image
                currentMultipleChoiceQuestions = newMultipleChoiceQuestions; // Update custom MC questions


                console.log(`[Student] Detected mode: ${currentInteractionMode}, Paused: ${isResponsePaused}, Mode Changed: ${modeChanged}, pauseStateChanged: ${pauseStateChanged}`);

                if (currentInteractionMode === 'waiting') {
                    showView('studentWaiting');
                    studentPauseOverlay.classList.add('hidden'); // Hide overlay in waiting view
                } else {
                    showView('studentInteraction');

                    // Call showInteractionUI if mode changed OR if this is the first time entering this mode
                    // We determine "first time" by checking if any interaction UI is currently visible
                    const anyUIVisible = Object.values(interactionUIs).some(ui => !ui.classList.contains('hidden'));

                    if (modeChanged || !anyUIVisible) {
                        showInteractionUI(currentInteractionMode, false); // Not resuming from pause if mode changed
                    }
                    // If mode hasn't changed and a UI is already visible, we don't need to call showInteractionUI
                    // This preserves the DOM state (including content) during pause/resume


                    console.log('[Student] Setting pause overlay, isResponsePaused:', isResponsePaused);
                    if (isResponsePaused) {
                        studentPauseOverlay.classList.remove('hidden');
                        toggleStudentInteractionElements(true); // Disable elements if paused
                    } else {
                        studentPauseOverlay.classList.add('hidden');
                        toggleStudentInteractionElements(false); // Enable elements if not paused
                    }

                    // Specific UI updates that need to happen on every snapshot change
                    if (currentInteractionMode === 'drawing') {
                        requestAnimationFrame(() => {
                            // BUG FIX: Only call setupCanvas (which resizes and clears the drawing canvas)
                            // when the mode truly changes to 'drawing'.
                            // On other updates (like pause/resume or background image change),
                            // we only need to reload images and redraw the combined canvas,
                            // preserving the student's existing drawing.
                            if (modeChanged) {
                                setupCanvas();
                            }
                            loadBackgroundImage(); // Reload background in case teacher changed it
                            loadStudentImage();    // Reload student-uploaded image
                            drawCombinedCanvas();  // Redraw all layers
                        });
                    } else if (currentInteractionMode === 'url_dispatch') { // This mode now handles both URL and HTML
                        const currentDispatchSettings = data.dispatchSettings; // Get the combined settings
                        if (currentDispatchSettings) {
                            if (currentDispatchSettings.type === 'url' && currentDispatchSettings.url) {
                                displayDispatchedUrl(currentDispatchSettings);
                            } else if (currentDispatchSettings.type === 'html' && currentDispatchSettings.htmlContent) {
                                displayDispatchedHtml(currentDispatchSettings.htmlContent);
                            }
                        }
                    } else if (currentInteractionMode === 'multiple_choice') { // NEW: Handle custom multiple choice questions
                        await renderMultipleChoiceQuestions(currentMultipleChoiceQuestions);
                        // Apply/remove enlarged-buttons class based on whether custom questions exist
                        if (!currentMultipleChoiceQuestions || currentMultipleChoiceQuestions.length === 0) {
                            interactionMultipleChoice.classList.add('enlarged-buttons');
                        } else {
                            interactionMultipleChoice.classList.remove('enlarged-buttons');
                        }
                    } else if (currentInteractionMode === 'sequencing') {
                        const sequencingSettings = data.sequencingSettings;
                        if (sequencingSettings && modeChanged) {
                            setupSequencingUI(sequencingSettings);
                        }
                    } else if (currentInteractionMode === 'matching') {
                        const matchingSettings = data.matchingSettings;
                        if (matchingSettings && modeChanged) {
                            setupMatchingUI(matchingSettings);
                        }
                    } else if (currentInteractionMode === 'reading_comprehension') {
                        const readingData = data.readingComprehensionData;
                        // Always display if we have data and (mode changed OR resuming from pause OR pause state changed)
                        if (readingData && (modeChanged || isResumingFromPause || pauseStateChanged)) {
                            console.log('[Student] Displaying reading comprehension, modeChanged:', modeChanged, 'isResumingFromPause:', isResumingFromPause, 'pauseStateChanged:', pauseStateChanged);
                            displayReadingComprehensionForStudent(readingData);
                            // Only reset submit button if mode changed (not when resuming from pause)
                            if (modeChanged) {
                                document.getElementById('submit-reading-btn').disabled = false;
                            }
                        }
                    } else if (currentInteractionMode === 'focus_game') {
                        const focusGameSettings = data.focusGameSettings;
                        if (focusGameSettings && modeChanged) {
                            initializeFocusGame(focusGameSettings.numberCount);
                        } else if (modeChanged) {
                            // Use default if no settings provided
                            initializeFocusGame(36);
                        }
                    } else if (currentInteractionMode === 'quick_poll') {
                        if (modeChanged) {
                            listenToQuickPollConfig();
                        }
                    }
                }
            }, (error) => {
                console.error("[Student] Error listening to interaction mode:", error);
                // This error might indicate a network issue or permission denied, not necessarily class end.
                // So, keep the student in waiting view or current view, and just show an error.
                showMessage("無法接收老師指令，請檢查網路連線。", "error");
            });
        }
        
        /**
         * (Student) Displays the dispatched URL or YouTube video.
         * @param {object} settings - The URL settings object from Firestore.
         */
        function displayDispatchedUrl(settings) {
            const container = interactionUIs.url_dispatch;
            container.innerHTML = ''; // Clear previous content

            if (settings.isYoutube) {
                const videoId = getYouTubeVideoId(settings.url);
                console.log('YouTube URL:', settings.url, 'Video ID:', videoId); // 調試信息
                if (videoId) {
                    const embedContainer = document.createElement('div');
                    embedContainer.className = 'youtube-embed-container';
                    
                    // 添加載入中的提示
                    embedContainer.innerHTML = `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center;">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i><br>
                        影片載入中...
                    </div>`;
                    
                    const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&showinfo=0&modestbranding=1`;
                    console.log('Embed URL:', embedUrl); // 調試信息
                    
                    // 創建iframe元素
                    const iframe = document.createElement('iframe');
                    iframe.src = embedUrl;
                    iframe.frameBorder = '0';
                    iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
                    iframe.allowFullscreen = true;
                    iframe.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;';
                    
                    // 載入完成後移除載入提示
                    iframe.onload = function() {
                        const loadingDiv = embedContainer.querySelector('div');
                        if (loadingDiv) loadingDiv.remove();
                    };
                    
                    // 錯誤處理
                    iframe.onerror = function() {
                        embedContainer.innerHTML = `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center;">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i><br>
                            影片載入失敗
                        </div>`;
                    };
                    
                    embedContainer.appendChild(iframe);
                    container.appendChild(embedContainer);
                } else {
                    console.error('無效的 YouTube 網址:', settings.url); // 調試信息
                    container.innerHTML = `<p class="text-red-500">無效的 YouTube 網址。</p>`;
                }
            } else {
                const card = document.createElement('a');
                card.className = 'url-card';
                card.href = settings.url;
                card.target = '_blank';
                card.rel = 'noopener noreferrer';
                card.innerHTML = `
                    <i class="fas fa-external-link-alt url-card-icon"></i>
                    <p class="url-card-text">老師分享了一個連結</p>
                    <p class="url-card-link">${settings.url}</p>
                `;
                container.appendChild(card);
            }
        }

        /**
         * NEW: (Student) Displays the dispatched HTML content in an iframe.
         * @param {string} htmlContent - The HTML content to display.
         */
        function displayDispatchedHtml(htmlContent) {
            const container = interactionUIs.url_dispatch; // Use the same container
            container.innerHTML = ''; // Clear previous content
            
            const iframe = document.createElement('iframe');
            iframe.id = 'html-content-iframe'; // Re-use the ID for consistency if needed, but it's internal to this function now
            iframe.sandbox = 'allow-scripts allow-same-origin allow-popups allow-forms';
            iframe.srcdoc = htmlContent;
            iframe.style.cssText = 'width: 100vw; height: 100vh; margin: 0; padding: 0; border: none; background-color: white; display: block;';
            container.appendChild(iframe);

            // Add status indicator
            const statusIndicator = document.createElement('div');
            statusIndicator.className = 'html-dispatch-indicator';
            statusIndicator.textContent = '教師派送html中...';
            container.appendChild(statusIndicator);

            // Apply the specific HTML dispatch container styles to the outer container
            container.style.cssText = 'position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; margin: 0; padding: 0; border: none; overflow: hidden; background-color: white; z-index: 1000;';
        }

        /**
         * Extracts YouTube video ID from various URL formats.
         * @param {string} url - The YouTube URL.
         * @returns {string|null} The video ID or null if not found.
         */
        function getYouTubeVideoId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }


        /**
         * (Student) Submits the answer to Firestore.
         * @param {string | object} answer - The student's answer.
         */
        async function submitAnswer(answer) {
            // NEW: Prevent submission if paused
            if (isResponsePaused) {
                showMessage('老師已暫停回覆，無法送出答案。', 'error');
                return;
            }

            if (!studentName || !userId || !classroomCode) {
                console.error("Student name, User ID, or Classroom Code not set. Cannot submit answer.");
                showMessage("學生姓名、用戶ID或教室代碼未設定，無法送出答案。", "error");
                return;
            }
            // Use classroomCode in the Firestore path
            const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
            try {
                 await setDoc(studentRef, { 
                    name: studentName,
                    answer: answer,
                    timestamp: new Date()
                }, { merge: true });
                console.log(`[Student] ${studentName} submitted answer:`, answer);
                showMessage('回答已送出！', 'success');
            } catch (error) {
                console.error("送出答案失敗:", error);
                showMessage("送出答案失敗，請檢查網路連線。", "error");
            }
        }
        
        /**
         * (Teacher) Listens for all student submissions and dynamically displays them.
         * @param {string} mode - The current interaction mode, used to determine the answer type.
         */
        function listenToStudentSubmissions(mode) {
             if (studentResponsesUnsubscribe) studentResponsesUnsubscribe();

             // Use classroomCode in the Firestore path
             const studentsColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
             const container = document.getElementById('student-responses-container');
             const wordCloudDisplay = document.getElementById('word-cloud-display');
             const stickyNoteWall = document.getElementById('sticky-note-wall');
             const focusGameResults = document.getElementById('focus-game-results');

             // Show/hide appropriate display based on mode
             if (mode === 'word_cloud') {
                 container.classList.add('hidden');
                 wordCloudDisplay.classList.remove('hidden');
                 stickyNoteWall.classList.add('hidden');
                 focusGameResults.classList.add('hidden');
                 // Clear word cloud SVG when starting fresh
                 updateWordCloud([]);
             } else if (mode === 'sticky_note') {
                 container.classList.add('hidden');
                 wordCloudDisplay.classList.add('hidden');
                 stickyNoteWall.classList.remove('hidden');
                 focusGameResults.classList.add('hidden');
                 // Clear sticky notes when starting fresh
                 clearStickyNotes();
                 // Trigger canvas initialization via custom event
                 setTimeout(() => {
                     const event = new CustomEvent('initStickyCanvas');
                     window.dispatchEvent(event);
                 }, 100);
             } else if (mode === 'focus_game') {
                 container.classList.add('hidden');
                 wordCloudDisplay.classList.add('hidden');
                 stickyNoteWall.classList.add('hidden');
                 focusGameResults.classList.remove('hidden');
                 // Clear focus game results when starting fresh
                 clearFocusGameResults();
             } else {
                 container.classList.remove('hidden');
                 wordCloudDisplay.classList.add('hidden');
                 stickyNoteWall.classList.add('hidden');
                 focusGameResults.classList.add('hidden');
             }

             studentResponsesUnsubscribe = onSnapshot(studentsColRef, (querySnapshot) => {
                container.innerHTML = ''; 
                lastSelectedStudentCard = null; 
                
                // REMOVED: document.getElementById('responded-student-count').textContent = querySnapshot.size; 

                if (querySnapshot.empty) {
                    if (mode !== 'url_dispatch') { 
                        container.innerHTML = '<p class="text-gray-500 text-center col-span-full">正在等待學生作答...</p>';
                    }
                    allStudentResponses = [];
                    clearStudentsByAnswerList();
                    return;
                }
                
                let responses = []; 
                querySnapshot.forEach((doc) => {
                    const student = doc.data();
                    responses.push(student);
                    const card = document.createElement('div');
                    card.className = 'student-response-item'; 

                    let answerContentHTML = ''; 
                    
                    if (student.answer === undefined || student.answer === null) {
                        answerContentHTML = `<p class="text-gray-400">尚未作答</p>`;
                    } else if (mode === 'drawing') {
                        if(String(student.answer).startsWith('data:image')){
                            answerContentHTML = `<img src="${student.answer}" alt="${student.name} 的繪圖" class="w-full h-auto rounded-md border max-h-32 object-contain cursor-pointer" data-full-image="${student.answer}"/>`;
                        } else {
                            answerContentHTML = `<p class="text-gray-500">繪圖未完成或格式錯誤</p>`;
                        }
                    } else if (mode === 'recording') { // New: Handle recording answers
                        if (String(student.answer).startsWith('data:audio')) {
                            answerContentHTML = `<audio controls src="${student.answer}" class="w-full"></audio>`;
                        } else {
                            answerContentHTML = `<p class="text-gray-500">錄音未完成或格式錯誤</p>`;
                        }
                    } else if (mode === 'text_input' || mode === 'word_cloud') {
                        answerContentHTML = `<p class="text-gray-700 whitespace-pre-wrap">${student.answer || '(空白)'}</p>`;
                    } else if (mode === 'multiple_choice' && Array.isArray(student.answer) && currentMultipleChoiceQuestions) {
                        // NEW: Handle custom multiple choice answers
                        answerContentHTML = `<div class="flex flex-col w-full">`;
                        student.answer.forEach((qAns, index) => {
                            const question = currentMultipleChoiceQuestions[qAns.qIndex];
                            if (question) {
                                const isCorrect = (String(qAns.ans) === String(question.correctAnswer));
                                answerContentHTML += `
                                    <div class="mc-question-answer">
                                        <i class="icon fas ${isCorrect ? 'fa-check-circle correct-icon' : 'fa-times-circle incorrect-icon'}"></i>
                                        <span class="question-text">Q${qAns.qIndex + 1}:</span>
                                        <span class="student-choice">${qAns.ans}</span>
                                    </div>
                                `;
                            }
                        });
                        answerContentHTML += `</div>`;
                    }
                    else if (mode === 'quick_answer') {
                        // Handle quick answer results
                        if (student.answer && student.answer.includes('搶答成功')) {
                            answerContentHTML = `<div class="text-center">
                                <i class="fas fa-trophy text-yellow-500 text-4xl mb-2"></i>
                                <p class="text-xl font-bold text-green-600">搶答成功！</p>
                                <p class="text-lg text-gray-600">第一名</p>
                            </div>`;
                        } else {
                            answerContentHTML = `<p class="text-gray-500">未搶答或搶答失敗</p>`;
                        }
                    }
                    else if (mode === 'sequencing') {
                        // Handle sequencing answers
                        try {
                            const studentOrder = JSON.parse(student.answer);
                            const correctOrder = sequencingData.correctOrder;
                            let isCorrect = true;

                            answerContentHTML = `<div class="flex flex-col w-full gap-1">`;
                            studentOrder.forEach((item, index) => {
                                const correct = correctOrder[index] === item;
                                if (!correct) isCorrect = false;
                                answerContentHTML += `
                                    <div class="flex items-center gap-2 text-sm">
                                        <i class="fas ${correct ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'}"></i>
                                        <span class="font-bold">${index + 1}.</span>
                                        <span>${item}</span>
                                    </div>
                                `;
                            });
                            answerContentHTML += `</div>`;
                        } catch (e) {
                            answerContentHTML = `<p class="text-gray-500">答案格式錯誤</p>`;
                        }
                    }
                    else if (mode === 'matching') {
                        // Handle matching answers
                        try {
                            const studentMatches = JSON.parse(student.answer);
                            const correctPairs = matchingData.pairs;
                            let correctCount = 0;

                            answerContentHTML = `<div class="flex flex-col w-full gap-1">`;
                            studentMatches.forEach(match => {
                                const correctPair = correctPairs.find(p => p.left === match.left);
                                const isCorrect = correctPair && correctPair.right === match.right;
                                if (isCorrect) correctCount++;

                                answerContentHTML += `
                                    <div class="flex items-center gap-2 text-xs">
                                        <i class="fas ${isCorrect ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'}"></i>
                                        <span>${match.left}</span>
                                        <i class="fas fa-arrow-right text-gray-400"></i>
                                        <span>${match.right}</span>
                                    </div>
                                `;
                            });
                            answerContentHTML += `<div class="text-xs text-gray-600 mt-1">正確: ${correctCount}/${studentMatches.length}</div></div>`;
                        } catch (e) {
                            answerContentHTML = `<p class="text-gray-500">答案格式錯誤</p>`;
                        }
                    }
                    else if (mode === 'reading_comprehension') {
                        // Handle reading comprehension answers
                        try {
                            const studentAnswers = JSON.parse(student.answer);
                            const questions = readingComprehensionData.questions;
                            let correctCount = 0;

                            answerContentHTML = `<div class="flex flex-col w-full" style="font-size: 10px; gap: 1px;">`;
                            studentAnswers.forEach((ans, index) => {
                                if (questions[index]) {
                                    const isCorrect = (ans === questions[index].correctAnswer);
                                    if (isCorrect) correctCount++;

                                    answerContentHTML += `
                                        <div class="flex items-center whitespace-nowrap" style="gap: 4px; line-height: 1.3;">
                                            <i class="fas ${isCorrect ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'}" style="font-size: 11px;"></i>
                                            <span class="font-bold" style="min-width: 22px;">Q${index + 1}</span>
                                            <span class="text-gray-700" style="min-width: 32px;">答:${ans || '未'}</span>
                                            ${!isCorrect && ans > 0 ? `<span class="text-gray-500" style="font-size: 9px;">(正確:${questions[index].correctAnswer})</span>` : ''}
                                        </div>
                                    `;
                                }
                            });
                            answerContentHTML += `<div class="font-bold mt-1 pt-1 border-t ${correctCount === questions.length ? 'text-green-600' : 'text-gray-700'}" style="font-size: 10px;">正確: ${correctCount}/${questions.length}</div></div>`;
                        } catch (e) {
                            answerContentHTML = `<p class="text-gray-500">答案格式錯誤</p>`;
                        }
                    }
                    else { // Default multiple choice (1-4)
                        answerContentHTML = `<p class="text-2xl font-bold text-blue-600">${student.answer}</p>`;
                    }
                    
                    card.innerHTML = `
                        <div class="name-box">${student.name}</div>
                        <div class="answer-box">
                            ${answerContentHTML}
                        </div>
                    `;
                    container.appendChild(card);

                    if (mode === 'drawing') {
                        const imgElement = card.querySelector('.answer-box img');
                        if (imgElement) {
                            imgElement.addEventListener('click', (e) => {
                                const fullImageUrl = e.target.dataset.fullImage;
                                showMagnifiedDrawing(fullImageUrl);
                            });
                        }
                    }
                });

                allStudentResponses = responses;

                // Special handling for word cloud mode
                if (mode === 'word_cloud') {
                    clearTimeout(wordCloudUpdateTimer);
                    wordCloudUpdateTimer = setTimeout(() => {
                        updateWordCloud(responses);
                    }, 300);
                }

                // Special handling for sticky note mode
                if (mode === 'sticky_note') {
                    updateStickyNotes(responses);
                }

                // Special handling for focus game mode
                if (mode === 'focus_game') {
                    updateFocusGameResults(responses);
                }

                // Special handling for quick answer mode
                if (mode === 'quick_answer') {
                    console.log('Teacher: Processing quick answer responses:', responses);
                    const quickAnswerWinners = responses.filter(student =>
                        student.answer && student.answer.includes('搶答成功')
                    );
                    console.log('Teacher: Quick answer winners found:', quickAnswerWinners);

                    if (quickAnswerWinners.length > 0) {
                        const winner = quickAnswerWinners[0]; // First one to answer
                        console.log('Teacher: Showing winner:', winner.name);
                        showQuickAnswerWinner(winner.name);
                    }
                }

                if (!statisticsModal.classList.contains('hidden')) {
                    drawChart(allStudentResponses, currentInteractionMode);
                }
             }, (error) => {
                 console.error("[Teacher] Error listening to student submissions:", error);
                 showMessage("無法監聽學生作答，請檢查連線。", "error");
             });
        }

        /**
         * (Teacher) Listens for student online presence and updates the active student count list.
         * This listener should be persistent as long as the teacher is in the classroom.
         */
        function listenToClassroomPresence() {
            // Only set up the listener if it's not already active
            if (classroomPresenceUnsubscribe) {
                console.log("Presence listener already active. Skipping re-subscription.");
                return;
            }

            if (!classroomCode) {
                console.warn("Classroom code not set, cannot listen to presence.");
                return;
            }

            const presenceColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'presence');
            const activeStudentCountSpan = document.getElementById('active-student-count');
            const modalStudentNamesDiv = document.getElementById('modal-student-names');
            const monitorContainer = document.getElementById('student-responses-container');

            classroomPresenceUnsubscribe = onSnapshot(presenceColRef, (querySnapshot) => {
                activeStudentNames = []; // Clear and re-populate
                querySnapshot.forEach(doc => {
                    activeStudentNames.push(doc.data().name);
                });
                
                activeStudentCountSpan.textContent = activeStudentNames.length;

                // Update the student list modal.
                modalStudentNamesDiv.innerHTML = ''; 
                if (lastSelectedModalStudent) { // Clear highlight in modal when list rebuilds
                    lastSelectedModalStudent.classList.remove('modal-selected-student-border');
                    lastSelectedModalStudent = null;
                }

                if (activeStudentNames.length === 0) {
                    modalStudentNamesDiv.innerHTML = '<p class="text-gray-500 text-sm col-span-full">沒有學生在線</p>';
                } else {
                    activeStudentNames.sort().forEach(name => {
                        const p = document.createElement('p');
                        p.textContent = name;
                        modalStudentNamesDiv.appendChild(p);
                    });
                }

                // Dynamically update the monitor view if in URL/HTML dispatch mode
                if (currentInteractionMode === 'url_dispatch') { 
                    monitorContainer.innerHTML = ''; // Clear previous content
                    if (activeStudentNames.length === 0) {
                        monitorContainer.innerHTML = '<p class="text-gray-500 text-center col-span-full">沒有學生在線</p>';
                    } else {
                        activeStudentNames.sort().forEach(name => {
                            const card = document.createElement('div');
                            card.className = 'student-response-item';
                            card.innerHTML = `<div class="name-box">${name}</div><div class="answer-box"><i class="fas fa-check-circle text-green-500 text-2xl"></i></div>`;
                            monitorContainer.appendChild(card);
                        });
                    }
                }
            }, (error) => {
                console.error("[Teacher] Error listening to classroom presence:", error);
                // If there's an error, maybe the listener broke, so clear it.
                classroomPresenceUnsubscribe = null;
                showMessage("無法監聽學生在線狀態，請檢查連線。", "error");
            });
        }

        /**
         * (Teacher) Manually refreshes the online student count and responded student count.
         */
        async function manualRefreshCounts() {
            if (!classroomCode) {
                console.warn("Classroom code not set, cannot manually refresh counts.");
                return;
            }
            // Use classroomCode in the Firestore path
            const presenceColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'presence');
            try {
                const presenceSnapshot = await getDocs(presenceColRef);
                activeStudentNames = []; // Clear and re-populate
                presenceSnapshot.forEach(doc => activeStudentNames.push(doc.data().name));
                document.getElementById('active-student-count').textContent = activeStudentNames.length;
            } catch (error) {
                console.error("Manual refresh: Failed to get online student count:", error);
            }

            // Use classroomCode in the Firestore path
            const responsesColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
            try {
                const responsesSnapshot = await getDocs(responsesColRef);
                // REMOVED: document.getElementById('responded-student-count').textContent = responsesSnapshot.size;
                
                const responsesData = [];
                responsesSnapshot.forEach(doc => responsesData.push(doc.data()));
                allStudentResponses = responsesData; 

                if (!statisticsModal.classList.contains('hidden')) {
                    drawChart(allStudentResponses, currentInteractionMode);
                }
                showMessage('統計數據已更新！', 'info');
            } catch (error) {
                console.error("Manual refresh: Failed to get responded student count:", error);
            }
        }


        // --- Magnified Drawing Modal Functions ---
        const magnifiedImageModal = document.getElementById('magnified-image-modal');
        const magnifiedImage = document.getElementById('magnified-image');
        const magnifiedImageModalCloseBtn = document.getElementById('magnified-image-modal-close-btn');

        function showMagnifiedDrawing(imageUrl) {
            magnifiedImage.src = imageUrl;
            magnifiedImageModal.classList.remove('hidden');
        }

        function hideMagnifiedDrawing() {
            magnifiedImageModal.classList.add('hidden');
            magnifiedImage.src = '';
        }

        // Make function globally accessible for onclick handlers
        window.showMagnifiedDrawing = showMagnifiedDrawing;

        // --- Student List Modal (Teacher Side) ---
        const studentListModal = document.getElementById('student-list-modal');
        const studentListModalCloseBtn = document.getElementById('student-list-modal-close-btn');

        function showStudentListModal() {
            studentListModal.classList.remove('hidden');
        }

        function hideStudentListModal() {
            studentListModal.classList.add('hidden');
            if (lastSelectedModalStudent) { // Clear highlight in modal when closing
                lastSelectedModalStudent.classList.remove('modal-selected-student-border');
                lastSelectedModalStudent = null;
            }
        }

        // --- NEW: Unsubmitted Students Modal Functions ---
        const unsubmittedStudentsModal = document.getElementById('unsubmitted-students-modal');
        const unsubmittedStudentsModalCloseBtn = document.getElementById('unsubmitted-students-modal-close-btn');
        const modalUnsubmittedStudentNamesDiv = document.getElementById('modal-unsubmitted-student-names');

        /**
         * Calculates the list of students who are active but have not submitted an answer.
         * @param {string[]} activeStudents - Array of names of all active students.
         * @param {Object[]} respondedStudents - Array of response objects from students.
         * @returns {string[]} Sorted array of names of unsubmitted students.
         */
        function getUnsubmittedStudents(activeStudents, respondedStudents) {
            const respondedNames = new Set(respondedStudents.map(s => s.name));
            return activeStudents.filter(name => !respondedNames.has(name)).sort();
        }

        /**
         * Displays the modal with the list of unsubmitted students.
         */
        function showUnsubmittedStudentsModal() {
            const unsubmittedNames = getUnsubmittedStudents(activeStudentNames, allStudentResponses);
            modalUnsubmittedStudentNamesDiv.innerHTML = '';
            if (unsubmittedNames.length === 0) {
                modalUnsubmittedStudentNamesDiv.innerHTML = '<p class="text-gray-500 text-sm col-span-full">所有學生皆已作答或無學生在線</p>';
            } else {
                unsubmittedNames.forEach(name => {
                    const p = document.createElement('p');
                    p.textContent = name;
                    p.className = 'bg-red-100 p-2 rounded-md text-center text-red-700 font-medium overflow-hidden text-ellipsis whitespace-nowrap';
                    modalUnsubmittedStudentNamesDiv.appendChild(p);
                });
            }
            unsubmittedStudentsModal.classList.remove('hidden');
        }

        /**
         * Hides the unsubmitted students modal.
         */
        function hideUnsubmittedStudentsModal() {
            unsubmittedStudentsModal.classList.add('hidden');
        }


        // --- Statistics Chart Modal (Teacher Side) ---
        const statisticsModal = document.getElementById('statistics-modal');
        const chartModalCloseBtn = document.getElementById('chart-modal-close-btn');
        const chartSvg = d3.select("#chart-svg");
        const studentsByAnswerListContainer = document.getElementById('students-by-answer-list-container');
        const studentsByAnswerListTitle = document.getElementById('students-by-answer-list-title');
        const studentsByAnswerNamesParagraph = document.getElementById('students-by-answer-names');


        function showStatisticsModal() {
            statisticsModal.classList.remove('hidden');
            drawChart(allStudentResponses, currentInteractionMode); 
        }

        function hideStatisticsModal() {
            statisticsModal.classList.add('hidden');
            chartSvg.selectAll("*").remove();
            clearStudentsByAnswerList();
        }

        function downloadStudentResponses() {
            if (!allStudentResponses || allStudentResponses.length === 0) {
                showMessage('目前沒有學生回應可以下載。', 'warning');
                return;
            }

            let csvData = [];
            let filename = '';
            
            if (currentInteractionMode === 'text_input') {
                // 文字題模式
                csvData.push('學生姓名,學生回應');
                
                allStudentResponses.forEach(student => {
                    const studentName = student.name || '未知學生';
                    let responseText = student.answer || '';
                    
                    // 清理回應文字中的換行符號和雙引號，避免影響CSV格式
                    responseText = responseText.replace(/[\r\n]/g, ' ').replace(/"/g, '""');
                    
                    // 如果內容包含逗號或雙引號，需要用雙引號包圍
                    if (responseText.includes(',') || responseText.includes('"') || responseText.includes('\n')) {
                        responseText = `"${responseText}"`;
                    }
                    
                    csvData.push(`${studentName},${responseText}`);
                });
                
                const now = new Date();
                const timestamp = now.getFullYear() + 
                                String(now.getMonth() + 1).padStart(2, '0') + 
                                String(now.getDate()).padStart(2, '0') + '_' +
                                String(now.getHours()).padStart(2, '0') + 
                                String(now.getMinutes()).padStart(2, '0') + 
                                String(now.getSeconds()).padStart(2, '0');
                filename = `學生回應_${timestamp}.csv`;
                
            } else if (currentInteractionMode === 'multiple_choice' && currentMultipleChoiceQuestions) {
                // 自訂選擇題模式
                
                // 第一部分：題目資訊
                csvData.push('=== 題目資訊 ===');
                csvData.push('題號,題目內容,選項A,選項B,選項C,選項D,正確答案');
                
                currentMultipleChoiceQuestions.forEach((question, index) => {
                    const questionText = `"${question.questionText.replace(/"/g, '""')}"`;
                    const optionA = `"${question.options[0].replace(/"/g, '""')}"`;
                    const optionB = `"${question.options[1].replace(/"/g, '""')}"`;
                    const optionC = `"${question.options[2].replace(/"/g, '""')}"`;
                    const optionD = `"${question.options[3].replace(/"/g, '""')}"`;
                    const correctAnswer = `選項${['A', 'B', 'C', 'D'][parseInt(question.correctAnswer) - 1]}`;
                    
                    csvData.push(`第${index + 1}題,${questionText},${optionA},${optionB},${optionC},${optionD},${correctAnswer}`);
                });
                
                // 空行分隔
                csvData.push('');
                
                // 第二部分：學生答題結果
                csvData.push('=== 學生答題結果 ===');
                
                // 建立表頭
                let header = '學生姓名';
                currentMultipleChoiceQuestions.forEach((_, index) => {
                    header += `,第${index + 1}題答案,第${index + 1}題結果`;
                });
                header += ',總分,總題數,正確率';
                csvData.push(header);
                
                // 建立每個學生的答題結果
                allStudentResponses.forEach(student => {
                    const studentName = student.name || '未知學生';
                    let row = studentName;
                    let correctCount = 0;
                    let totalQuestions = currentMultipleChoiceQuestions.length;
                    
                    if (Array.isArray(student.answer)) {
                        // 為每題加入答案和結果
                        currentMultipleChoiceQuestions.forEach((question, questionIndex) => {
                            const studentAnswer = student.answer.find(ans => ans.qIndex === questionIndex);
                            if (studentAnswer) {
                                const answerText = `選項${['A', 'B', 'C', 'D'][parseInt(studentAnswer.ans) - 1]}`;
                                const isCorrect = String(studentAnswer.ans) === String(question.correctAnswer);
                                const result = isCorrect ? '正確' : '錯誤';
                                if (isCorrect) correctCount++;
                                row += `,${answerText},${result}`;
                            } else {
                                row += ',未作答,錯誤';
                            }
                        });
                    } else {
                        // 如果學生沒有回答或格式不正確
                        currentMultipleChoiceQuestions.forEach(() => {
                            row += ',未作答,錯誤';
                        });
                    }
                    
                    // 加入統計資訊
                    const accuracy = totalQuestions > 0 ? ((correctCount / totalQuestions) * 100).toFixed(1) : '0.0';
                    row += `,${correctCount},${totalQuestions},${accuracy}%`;
                    
                    csvData.push(row);
                });
                
                const now = new Date();
                const timestamp = now.getFullYear() +
                                String(now.getMonth() + 1).padStart(2, '0') +
                                String(now.getDate()).padStart(2, '0') + '_' +
                                String(now.getHours()).padStart(2, '0') +
                                String(now.getMinutes()).padStart(2, '0') +
                                String(now.getSeconds()).padStart(2, '0');
                filename = `選擇題結果_${timestamp}.csv`;

            } else if (currentInteractionMode === 'reading_comprehension' && readingComprehensionData.questions) {
                // 閱讀測驗模式

                // 第一部分：文本內容
                csvData.push('=== 閱讀文本 ===');
                const readingText = `"${readingComprehensionData.text.replace(/"/g, '""')}"`;
                csvData.push(`文本內容,${readingText}`);
                csvData.push('');

                // 第二部分：題目資訊
                csvData.push('=== 題目資訊 ===');
                csvData.push('題號,PIRLS層次,題目內容,選項1,選項2,選項3,選項4,正確答案');

                readingComprehensionData.questions.forEach((question, index) => {
                    const levelNames = ['直接提取', '直接推論', '詮釋整合', '比較評估'];
                    const levelName = levelNames[question.level - 1] || '未分類';
                    const questionText = `"${question.question.replace(/"/g, '""')}"`;
                    const option1 = `"${question.options[0].replace(/"/g, '""')}"`;
                    const option2 = `"${question.options[1].replace(/"/g, '""')}"`;
                    const option3 = `"${question.options[2].replace(/"/g, '""')}"`;
                    const option4 = `"${question.options[3].replace(/"/g, '""')}"`;
                    const correctAnswer = `選項${question.correctAnswer}`;

                    csvData.push(`第${index + 1}題,${levelName},${questionText},${option1},${option2},${option3},${option4},${correctAnswer}`);
                });

                // 空行分隔
                csvData.push('');

                // 第三部分：學生答題結果
                csvData.push('=== 學生答題結果 ===');

                // 建立表頭
                let header = '學生姓名';
                readingComprehensionData.questions.forEach((_, index) => {
                    header += `,第${index + 1}題答案,第${index + 1}題結果`;
                });
                header += ',總分,總題數,正確率';
                csvData.push(header);

                // 建立每個學生的答題結果
                allStudentResponses.forEach(student => {
                    const studentName = student.name || '未知學生';
                    let row = studentName;
                    let correctCount = 0;
                    let totalQuestions = readingComprehensionData.questions.length;

                    try {
                        let studentAnswers = [];
                        if (typeof student.answer === 'string') {
                            studentAnswers = JSON.parse(student.answer);
                        } else if (Array.isArray(student.answer)) {
                            studentAnswers = student.answer;
                        }

                        // 為每題加入答案和結果
                        readingComprehensionData.questions.forEach((question, questionIndex) => {
                            const studentAnswer = studentAnswers[questionIndex];
                            if (studentAnswer && studentAnswer > 0) {
                                const answerText = `選項${studentAnswer}`;
                                const isCorrect = studentAnswer === question.correctAnswer;
                                const result = isCorrect ? '正確' : '錯誤';
                                if (isCorrect) correctCount++;
                                row += `,${answerText},${result}`;
                            } else {
                                row += ',未作答,錯誤';
                            }
                        });
                    } catch (e) {
                        // 如果解析失敗，全部標記為未作答
                        readingComprehensionData.questions.forEach(() => {
                            row += ',未作答,錯誤';
                        });
                    }

                    // 加入統計資訊
                    const accuracy = totalQuestions > 0 ? ((correctCount / totalQuestions) * 100).toFixed(1) : '0.0';
                    row += `,${correctCount},${totalQuestions},${accuracy}%`;

                    csvData.push(row);
                });

                const now2 = new Date();
                const timestamp2 = now2.getFullYear() +
                                String(now2.getMonth() + 1).padStart(2, '0') +
                                String(now2.getDate()).padStart(2, '0') + '_' +
                                String(now2.getHours()).padStart(2, '0') +
                                String(now2.getMinutes()).padStart(2, '0') +
                                String(now2.getSeconds()).padStart(2, '0');
                filename = `閱讀測驗結果_${timestamp2}.csv`;

            } else {
                showMessage('目前模式不支援下載功能。', 'warning');
                return;
            }

            // 建立CSV內容
            const csvContent = csvData.join('\n');

            // 建立下載連結，加上BOM確保正確顯示中文
            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showMessage(`已下載學生回應檔案: ${filename}`, 'success');
        }

        // NEW: View Questions Modal Functions
        function showViewQuestionsModal() {
            if (!currentMultipleChoiceQuestions || currentMultipleChoiceQuestions.length === 0) {
                showMessage('目前沒有自訂題目可以查看。', 'info');
                return;
            }
            
            const modal = document.getElementById('view-questions-modal');
            const container = document.getElementById('questions-display-container');
            
            // 清空容器
            container.innerHTML = '';
            
            // 生成題目顯示HTML
            currentMultipleChoiceQuestions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'bg-gray-50 p-4 rounded-lg border';
                questionDiv.innerHTML = `
                    <h5 class="font-bold text-lg mb-3">第 ${index + 1} 題</h5>
                    <p class="text-gray-800 mb-4">${question.questionText}</p>
                    <div class="space-y-2">
                        <p class="font-medium text-gray-700">選項：</p>
                        <div class="grid grid-cols-2 gap-2">
                            ${question.options.map((option, optIndex) => 
                                `<div class="p-2 bg-white rounded border text-sm">
                                    ${String.fromCharCode(65 + optIndex)}. ${option}
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">正確答案：</label>
                        <select class="correct-answer-select w-full p-2 border rounded" data-question-index="${index}">
                            ${question.options.map((option, optIndex) => {
                                const optionValue = String.fromCharCode(65 + optIndex);
                                const isSelected = question.correctAnswer === optionValue || question.correctAnswer === (optIndex + 1).toString();
                                return `<option value="${optionValue}" ${isSelected ? 'selected' : ''}>${optionValue}. ${option}</option>`;
                            }).join('')}
                        </select>
                    </div>
                `;
                container.appendChild(questionDiv);
            });
            
            modal.classList.remove('hidden');
        }

        function hideViewQuestionsModal() {
            document.getElementById('view-questions-modal').classList.add('hidden');
        }

        async function saveCorrectAnswers() {
            if (!currentMultipleChoiceQuestions || currentMultipleChoiceQuestions.length === 0) {
                showMessage('沒有題目可以儲存。', 'error');
                return;
            }
            
            try {
                // 更新currentMultipleChoiceQuestions中的正確答案
                const selects = document.querySelectorAll('.correct-answer-select');
                selects.forEach(select => {
                    const questionIndex = parseInt(select.getAttribute('data-question-index'));
                    let newCorrectAnswer = select.value;
                    
                    // NEW: 將字母格式轉換為數字格式以保持一致性
                    if (newCorrectAnswer === 'A') newCorrectAnswer = '1';
                    else if (newCorrectAnswer === 'B') newCorrectAnswer = '2';
                    else if (newCorrectAnswer === 'C') newCorrectAnswer = '3';
                    else if (newCorrectAnswer === 'D') newCorrectAnswer = '4';
                    
                    if (currentMultipleChoiceQuestions[questionIndex]) {
                        currentMultipleChoiceQuestions[questionIndex].correctAnswer = newCorrectAnswer;
                    }
                });
                
                // 更新Firestore中的題目資料
                const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                await updateDoc(controlRef, {
                    multiple_choice_questions: currentMultipleChoiceQuestions
                });
                
                // NEW: 等待一小段時間確保Firestore更新完成，然後觸發重新批改
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // NEW: 自動重新批改所有學生已提交的答案
                await regradeAllStudentAnswers();
                
                // NEW: 確保教師端UI使用最新的正確答案進行渲染
                // 由於重新批改會觸發Firebase監聽器，UI會自動重新渲染
                
                showMessage('正確答案已更新並重新批改所有作答！', 'success');
                hideViewQuestionsModal();
            } catch (error) {
                console.error('更新正確答案失敗:', error);
                showMessage('更新失敗，請稍後再試。', 'error');
            }
        }

        // NEW: 重新批改所有學生答案的函數
        async function regradeAllStudentAnswers() {
            if (!currentMultipleChoiceQuestions || currentMultipleChoiceQuestions.length === 0) {
                return;
            }

            try {
                const studentsColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
                const querySnapshot = await getDocs(studentsColRef);
                
                const batch = writeBatch(db);
                let regradeCount = 0;

                querySnapshot.forEach((docSnapshot) => {
                    const studentData = docSnapshot.data();
                    
                    // 只處理選擇題的答案（Array格式）
                    if (Array.isArray(studentData.answer)) {
                        // 更新學生答案時間戳以觸發UI重新渲染（答案內容保持不變）
                        const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', docSnapshot.id);
                        batch.update(studentRef, {
                            regraded: true,
                            regradeTimestamp: new Date(),
                            timestamp: new Date(), // 更新時間戳以觸發監聽器重新評判答案
                            forceUpdate: Math.random() // 添加隨機數強制觸發監聽器
                        });
                        regradeCount++;
                    }
                });

                if (regradeCount > 0) {
                    await batch.commit();
                    console.log(`重新批改了 ${regradeCount} 位學生的答案`);
                }
            } catch (error) {
                console.error('重新批改答案失敗:', error);
                throw error;
            }
        }

        function clearStudentsByAnswerList() {
            studentsByAnswerListContainer.classList.add('hidden');
            studentsByAnswerListTitle.textContent = '';
            studentsByAnswerNamesParagraph.textContent = ''; 
        }

        function displayStudentsForAnswer(answer, mode, questionIndex = null) {
            clearStudentsByAnswerList();
            studentsByAnswerListContainer.classList.remove('hidden');

            let filteredStudents;
            let titleText;

            if (mode === 'multiple_choice' && questionIndex !== null && currentMultipleChoiceQuestions) {
                // For custom multiple choice, filter by specific question and correctness
                const question = currentMultipleChoiceQuestions[questionIndex];
                if (!question) {
                    studentsByAnswerListTitle.textContent = `問題 ${questionIndex + 1} 不存在。`;
                    studentsByAnswerNamesParagraph.textContent = '';
                    return;
                }
                
                // 'answer' here is 'correct' or 'incorrect'
                if (answer === 'correct') {
                    filteredStudents = allStudentResponses.filter(s => 
                        Array.isArray(s.answer) && 
                        s.answer.some(q => q.qIndex === questionIndex && String(q.ans) === String(question.correctAnswer))
                    );
                    titleText = `問題 ${questionIndex + 1} 答對的學生：`;
                } else if (answer === 'incorrect') {
                     filteredStudents = allStudentResponses.filter(s => 
                        Array.isArray(s.answer) && 
                        s.answer.some(q => q.qIndex === questionIndex && String(q.ans) !== String(question.correctAnswer))
                    );
                    titleText = `問題 ${questionIndex + 1} 答錯的學生：`;
                } else { // Should not happen with current chart logic
                    filteredStudents = [];
                    titleText = `問題 ${questionIndex + 1} 的學生：`;
                }
            } else {
                // For default multiple choice or true/false
                filteredStudents = allStudentResponses.filter(s => s.answer === answer);
                titleText = `選擇「${answer}」的學生：`;
            }

            const studentNames = filteredStudents.map(s => s.name).sort(); 
            studentsByAnswerListTitle.textContent = studentNames.length > 0 ? `${titleText} ${studentNames.join(', ')}` : `${titleText} 沒有學生選擇此答案。`;
            studentsByAnswerNamesParagraph.textContent = ''; // Clear this as the title now contains names
        }

        // === Word Cloud Functions ===
        let wordCloudUpdateTimer = null;

        function updateWordCloud(responses) {
            // Count word frequency
            const wordFreq = {};
            responses.forEach(response => {
                const word = response.answer;
                if (word && word.trim()) {
                    wordFreq[word] = (wordFreq[word] || 0) + 1;
                }
            });

            // Convert to array for d3-cloud
            const words = Object.entries(wordFreq).map(([text, size]) => ({
                text,
                size: 20 + size * 15 // Base size 20, increase by 15 for each occurrence
            }));

            if (words.length === 0) {
                d3.select('#word-cloud-svg').selectAll('*').remove();
                d3.select('#word-cloud-svg')
                    .append('text')
                    .attr('x', '50%')
                    .attr('y', '50%')
                    .attr('text-anchor', 'middle')
                    .attr('dominant-baseline', 'middle')
                    .style('font-size', '24px')
                    .style('fill', '#94a3b8')
                    .text('等待學生輸入關鍵字...');
                return;
            }

            const svg = document.getElementById('word-cloud-svg');
            const width = svg.clientWidth || 800;
            const height = svg.clientHeight || 600;

            const layout = d3.layout.cloud()
                .size([width, height])
                .words(words)
                .padding(8)
                .rotate(() => (~~(Math.random() * 2) * 90))
                .font('Noto Sans TC, sans-serif')
                .fontSize(d => d.size)
                .on('end', draw);

            layout.start();

            function draw(words) {
                d3.select('#word-cloud-svg').selectAll('*').remove();

                d3.select('#word-cloud-svg')
                    .attr('width', width)
                    .attr('height', height)
                  .append('g')
                    .attr('transform', `translate(${width/2},${height/2})`)
                  .selectAll('text')
                    .data(words)
                  .enter().append('text')
                    .style('font-size', d => d.size + 'px')
                    .style('font-family', 'Noto Sans TC, sans-serif')
                    .style('font-weight', '700')
                    .style('fill', (d, i) => {
                        const colors = ['#ec4899', '#f43f5e', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ef4444', '#06b6d4'];
                        return colors[i % colors.length];
                    })
                    .attr('text-anchor', 'middle')
                    .attr('transform', d => `translate(${d.x},${d.y})rotate(${d.rotate})`)
                    .text(d => d.text)
                    .style('cursor', 'pointer')
                    .on('mouseover', function() {
                        d3.select(this).style('opacity', 0.7);
                    })
                    .on('mouseout', function() {
                        d3.select(this).style('opacity', 1);
                    });
            }
        }

        // === Sticky Note Functions ===
        const stickyNoteColors = ['#fef3c7', '#fed7aa', '#fecaca', '#ddd6fe', '#bfdbfe', '#a7f3d0', '#fce7f3', '#e0e7ff'];
        const stickyNotes = new Map(); // Track sticky notes by student name
        let stickyNoteScale = 1.0; // Default scale

        function updateZoomDisplay() {
            const zoomLevelEl = document.getElementById('sticky-zoom-level');
            if (zoomLevelEl) {
                zoomLevelEl.textContent = Math.round(stickyNoteScale * 100) + '%';
            }
        }

        function clearStickyNotes() {
            const container = document.getElementById('sticky-notes-container');
            container.innerHTML = '<div class="text-center py-10 text-slate-400 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2" id="sticky-note-placeholder"><i class="fas fa-note-sticky text-4xl mb-4"></i><p class="text-lg font-medium">等待學生送出便利貼...</p></div>';
            stickyNotes.clear();
            stickyNoteScale = 1.0;
            updateZoomDisplay();

            // Clear drawing canvas
            const canvas = document.getElementById('sticky-drawing-canvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        function updateStickyNotes(responses) {
            const container = document.getElementById('sticky-notes-container');
            const placeholder = document.getElementById('sticky-note-placeholder');

            if (responses.length === 0) {
                clearStickyNotes();
                return;
            }

            // Hide placeholder
            if (placeholder) {
                placeholder.remove();
            }

            // Update or create sticky notes
            responses.forEach((response, index) => {
                const existingNote = stickyNotes.get(response.name);

                if (!existingNote) {
                    // Create new sticky note
                    const note = createStickyNote(response, index);
                    container.appendChild(note);
                    stickyNotes.set(response.name, note);
                } else {
                    // Update existing note content
                    updateStickyNoteContent(existingNote, response);
                }
            });

            // Remove notes for students who deleted their responses
            const responseNames = new Set(responses.map(r => r.name));
            stickyNotes.forEach((note, name) => {
                if (!responseNames.has(name)) {
                    note.remove();
                    stickyNotes.delete(name);
                }
            });
        }

        function createStickyNote(response, index) {
            const note = document.createElement('div');
            note.className = 'sticky-note absolute cursor-move shadow-lg hover:shadow-xl transition-shadow duration-200 flex flex-col';
            note.style.width = '200px';
            note.style.height = '200px';
            note.style.backgroundColor = stickyNoteColors[index % stickyNoteColors.length];
            note.style.padding = '16px';
            note.style.borderRadius = '8px';
            note.style.border = '1px solid rgba(0,0,0,0.1)';
            note.style.transformOrigin = 'top left';
            note.style.transform = `scale(${stickyNoteScale})`;
            note.style.zIndex = '10'; // Below canvas layer

            // Random initial position within visible container
            const container = document.getElementById('sticky-notes-container');
            const containerRect = container.getBoundingClientRect();
            const noteSize = 200 * stickyNoteScale; // Account for current scale
            const maxX = Math.max(containerRect.width - noteSize - 20, 100); // Leave 20px margin
            const maxY = Math.max(containerRect.height - noteSize - 20, 100);
            const x = Math.random() * maxX;
            const y = Math.random() * maxY;
            note.style.left = x + 'px';
            note.style.top = y + 'px';

            // Add student name header
            const header = document.createElement('div');
            header.className = 'font-bold text-sm mb-2 pb-2 border-b border-slate-400 flex items-center gap-2 flex-shrink-0';
            header.innerHTML = `<i class="fas fa-user text-xs"></i>${response.name}`;
            note.appendChild(header);

            // Add content
            const content = document.createElement('div');
            content.className = 'sticky-note-content flex items-center justify-center flex-1 overflow-hidden';
            setStickyNoteContent(content, response);
            note.appendChild(content);

            // Make draggable
            makeDraggable(note);

            return note;
        }

        function updateStickyNoteContent(note, response) {
            const content = note.querySelector('.sticky-note-content');
            setStickyNoteContent(content, response);
        }

        function setStickyNoteContent(contentElement, response) {
            try {
                const data = JSON.parse(response.answer);

                if (data.type === 'text') {
                    const text = escapeHtml(data.content);
                    const charCount = data.content.length;

                    // Calculate font size based on character count
                    let fontSize;
                    if (charCount <= 5) {
                        fontSize = 48; // Very large for 1-5 characters
                    } else if (charCount <= 10) {
                        fontSize = 36; // Large for 6-10 characters
                    } else if (charCount <= 20) {
                        fontSize = 28; // Medium-large for 11-20 characters
                    } else if (charCount <= 30) {
                        fontSize = 22; // Medium for 21-30 characters
                    } else if (charCount <= 50) {
                        fontSize = 18; // Small-medium for 31-50 characters
                    } else {
                        fontSize = 14; // Small for 50+ characters
                    }

                    contentElement.innerHTML = `<div class="text-slate-800 break-words font-bold text-center w-full px-2" style="font-size: ${fontSize}px; line-height: 1.3; word-wrap: break-word; overflow-wrap: break-word;">${text}</div>`;
                } else if (data.type === 'image') {
                    contentElement.innerHTML = `<img src="${data.content}" class="w-full h-auto rounded border border-slate-300 object-contain max-h-32 cursor-pointer hover:opacity-80 transition-opacity" onclick="showMagnifiedDrawing(this.src)" title="點擊放大圖片">`;
                }
            } catch (e) {
                // Fallback for non-JSON answers
                const text = escapeHtml(response.answer);
                const charCount = response.answer.length;
                let fontSize;
                if (charCount <= 5) fontSize = 48;
                else if (charCount <= 10) fontSize = 36;
                else if (charCount <= 20) fontSize = 28;
                else if (charCount <= 30) fontSize = 22;
                else if (charCount <= 50) fontSize = 18;
                else fontSize = 14;
                contentElement.innerHTML = `<div class="text-slate-800 break-words font-bold text-center w-full px-2" style="font-size: ${fontSize}px; line-height: 1.3; word-wrap: break-word; overflow-wrap: break-word;">${text}</div>`;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

            element.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                element.style.zIndex = 999; // Keep below canvas (1000)
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;

                // Calculate new position
                let newTop = element.offsetTop - pos2;
                let newLeft = element.offsetLeft - pos1;

                // Get container bounds
                const container = document.getElementById('sticky-notes-container');
                const containerRect = container.getBoundingClientRect();
                const elementRect = element.getBoundingClientRect();

                // Constrain to container bounds
                newTop = Math.max(0, Math.min(newTop, containerRect.height - elementRect.height));
                newLeft = Math.max(0, Math.min(newLeft, containerRect.width - elementRect.width));

                element.style.top = newTop + 'px';
                element.style.left = newLeft + 'px';
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
                element.style.zIndex = 10; // Normal z-index, below canvas
            }
        }

        // === Focus Game Functions ===
        let focusGameState = {
            numbers: [],
            currentNumber: 1,
            startTime: null,
            isPlaying: false,
            timerInterval: null
        };

        function initializeFocusGame(numberCount = 36) {
            // Calculate grid size (e.g., 9->3, 16->4, 25->5, 36->6)
            const gridSize = Math.sqrt(numberCount);

            // Reset game state
            focusGameState = {
                numbers: shuffleArray([...Array(numberCount)].map((_, i) => i + 1)),
                currentNumber: 1,
                startTime: null,
                isPlaying: false,
                timerInterval: null,
                totalNumbers: numberCount
            };

            // Show instructions, hide timer and completion
            document.getElementById('focus-game-instructions').classList.remove('hidden');
            document.getElementById('focus-game-timer').classList.add('hidden');
            document.getElementById('focus-game-complete').classList.add('hidden');

            // Generate grid with dynamic columns
            const grid = document.getElementById('focus-game-grid');
            grid.classList.remove('hidden'); // Show the grid
            grid.innerHTML = '';
            // Set dynamic grid columns based on grid size
            grid.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;

            focusGameState.numbers.forEach((num, index) => {
                const cell = document.createElement('button');
                cell.className = 'focus-game-cell w-full aspect-square bg-gradient-to-br from-cyan-100 to-blue-100 hover:from-cyan-200 hover:to-blue-200 rounded-xl shadow-md border-2 border-cyan-300 text-3xl font-bold text-cyan-700 transition transform hover:scale-105 active:scale-95';
                cell.textContent = num;
                cell.dataset.number = num;
                cell.addEventListener('click', handleFocusGameClick);
                grid.appendChild(cell);
            });

            document.getElementById('focus-next-number').textContent = '1';
            document.getElementById('focus-timer-display').textContent = '0.00';
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function handleFocusGameClick(e) {
            const clickedNumber = parseInt(e.currentTarget.dataset.number);

            // Start timer on first click (number 1)
            if (!focusGameState.isPlaying && clickedNumber === 1) {
                focusGameState.isPlaying = true;
                focusGameState.startTime = Date.now();
                document.getElementById('focus-game-instructions').classList.add('hidden');
                document.getElementById('focus-game-timer').classList.remove('hidden');
                startFocusGameTimer();
            }

            // Check if clicked correct number
            if (clickedNumber === focusGameState.currentNumber) {
                // Correct click - hide the cell
                e.currentTarget.style.opacity = '0';
                e.currentTarget.style.pointerEvents = 'none';

                focusGameState.currentNumber++;
                document.getElementById('focus-next-number').textContent = focusGameState.currentNumber;

                // Check if game is complete
                if (focusGameState.currentNumber > focusGameState.totalNumbers) {
                    completeFocusGame();
                }
            } else if (focusGameState.isPlaying) {
                // Wrong click - visual feedback
                e.currentTarget.classList.add('shake');
                setTimeout(() => {
                    e.currentTarget.classList.remove('shake');
                }, 500);
            }
        }

        function startFocusGameTimer() {
            focusGameState.timerInterval = setInterval(() => {
                const elapsed = (Date.now() - focusGameState.startTime) / 1000;
                document.getElementById('focus-timer-display').textContent = elapsed.toFixed(2);
            }, 10);
        }

        function completeFocusGame() {
            // Stop timer
            clearInterval(focusGameState.timerInterval);
            const finalTime = ((Date.now() - focusGameState.startTime) / 1000).toFixed(2);

            // Hide timer and grid
            document.getElementById('focus-game-timer').classList.add('hidden');
            document.getElementById('focus-game-grid').classList.add('hidden');

            // Show completion message
            document.getElementById('focus-final-time').textContent = finalTime;
            document.getElementById('focus-encouragement').textContent = getFocusEncouragement(parseFloat(finalTime));
            document.getElementById('focus-game-complete').classList.remove('hidden');

            // Submit result to teacher
            submitAnswer(finalTime);
        }

        function getFocusEncouragement(time) {
            if (time <= 10) return '驚人！你的專注力超乎尋常，反應神速！🏆';
            if (time <= 15) return '太棒了！你的專注力非常優秀！⭐';
            if (time <= 20) return '很好！你的專注力很不錯！👍';
            if (time <= 30) return '不錯！繼續保持專注！💪';
            if (time <= 40) return '做得好！多練習會更進步！😊';
            return '完成了！記得常常練習提升專注力哦！📚';
        }

        function clearFocusGameResults() {
            const container = document.getElementById('focus-time-groups');
            container.innerHTML = `
                <div class="text-center py-20 text-slate-400">
                    <i class="fas fa-hourglass-start text-4xl mb-4"></i>
                    <p class="text-lg font-medium">等待學生完成遊戲...</p>
                </div>
            `;
        }

        function updateFocusGameResults(responses) {
            const container = document.getElementById('focus-time-groups');

            if (!responses || responses.length === 0) {
                clearFocusGameResults();
                return;
            }

            // Parse times and group students
            const students = responses.map(r => ({
                name: r.name,
                time: parseFloat(r.answer)
            })).filter(s => !isNaN(s.time));

            // Sort by time
            students.sort((a, b) => a.time - b.time);

            // Group students by time ranges
            const groups = [
                { label: '⚡ 閃電級 (1-10秒)', min: 0, max: 10, students: [], color: 'from-yellow-100 to-amber-100 border-yellow-300' },
                { label: '🏆 優秀級 (10-15秒)', min: 10, max: 15, students: [], color: 'from-green-100 to-emerald-100 border-green-300' },
                { label: '⭐ 良好級 (15-20秒)', min: 15, max: 20, students: [], color: 'from-blue-100 to-cyan-100 border-blue-300' },
                { label: '💪 加油級 (20-25秒)', min: 20, max: 25, students: [], color: 'from-purple-100 to-violet-100 border-purple-300' },
                { label: '📚 練習級 (25-30秒)', min: 25, max: 30, students: [], color: 'from-pink-100 to-rose-100 border-pink-300' },
                { label: '🌟 努力級 (30秒以上)', min: 30, max: Infinity, students: [], color: 'from-slate-100 to-gray-100 border-slate-300' }
            ];

            students.forEach(student => {
                const group = groups.find(g => student.time > g.min && student.time <= g.max);
                if (group) {
                    group.students.push(student);
                }
            });

            // Display groups
            container.innerHTML = groups
                .filter(g => g.students.length > 0)
                .map(group => `
                    <div class="bg-gradient-to-r ${group.color} border-2 rounded-xl p-4 shadow-md">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-lg font-bold text-slate-700">${group.label}</h4>
                            <span class="bg-white px-3 py-1 rounded-full text-sm font-bold text-slate-600">
                                ${group.students.length} 位學生
                            </span>
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                            ${group.students.map(s => `
                                <div class="bg-white p-2 rounded-lg shadow-sm border border-slate-200">
                                    <div class="font-bold text-slate-700 text-sm truncate">${s.name}</div>
                                    <div class="text-cyan-600 font-bold text-lg">${s.time.toFixed(2)}秒</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
        }

        function drawChart(responses, mode) { // Changed parameter name from 'data' to 'responses' to avoid conflict
            chartSvg.selectAll("*").remove();
            clearStudentsByAnswerList();

            let chartData = {}; // Renamed 'data' to 'chartData'
            const filteredResponses = responses.filter(r => {
                if (mode === 'true_false' && (r.answer === 'O' || r.answer === 'X')) return true;
                if (mode === 'multiple_choice') {
                    if (currentMultipleChoiceQuestions) { // Custom MC
                        return Array.isArray(r.answer);
                    } else { // Default MC
                        return (r.answer >= '1' && r.answer <= '4');
                    }
                }
                if (mode === 'reading_comprehension') {
                    // Check if answer is a valid JSON array
                    try {
                        const parsed = JSON.parse(r.answer);
                        return Array.isArray(parsed);
                    } catch (e) {
                        return false;
                    }
                }
                return false;
            });

            const totalValidResponses = filteredResponses.length;

            if (totalValidResponses === 0) {
                chartSvg.append("text")
                    .attr("x", chartSvg.attr("width") / 2)
                    .attr("y", chartSvg.attr("height") / 2)
                    .attr("text-anchor", "middle")
                    .style("font-size", "18px")
                    .style("fill", "#666")
                    .text("目前沒有作答資料。");
                return;
            }

            if (mode === 'true_false') {
                chartData = { 'O': 0, 'X': 0 }; // Use chartData
                filteredResponses.forEach(r => { chartData[r.answer]++; });
                drawPieChart(chartData, totalValidResponses); // Pass chartData
            } else if (mode === 'multiple_choice') {
                if (currentMultipleChoiceQuestions) { // Custom Multiple Choice Chart
                    drawCustomMultipleChoiceBarChart(filteredResponses, currentMultipleChoiceQuestions);
                } else { // Default Multiple Choice Chart
                    chartData = { '1': 0, '2': 0, '3': 0, '4': 0 }; // Use chartData
                    filteredResponses.forEach(r => { chartData[r.answer]++; });
                    drawBarChart(chartData, totalValidResponses); // Pass chartData
                }
            } else if (mode === 'reading_comprehension') {
                if (readingComprehensionData && readingComprehensionData.questions) {
                    drawReadingComprehensionChart(filteredResponses, readingComprehensionData.questions);
                }
            }
        }

        function drawPieChart(data, totalValidResponses) {
            const width = +chartSvg.attr("width");
            const height = +chartSvg.attr("height");
            const radius = Math.min(width, height) / 2 - 20;
            const g = chartSvg.append("g").attr("transform", `translate(${width / 2},${height / 2})`);
            const color = d3.scaleOrdinal().domain(Object.keys(data)).range(['#16a34a', '#dc2626']); // Green for O, Red for X
            const pie = d3.pie().value(d => d[1]).sort(null);
            const arc = d3.arc().innerRadius(0).outerRadius(radius);
            const arcs = g.selectAll(".arc").data(pie(Object.entries(data))).enter().append("g").attr("class", "arc");

            arcs.append("path")
                .attr("d", arc) 
                .attr("fill", d => color(d.data[0])) 
                .attr("stroke", "white").style("stroke-width", "2px")
                .on("click", (event, d) => displayStudentsForAnswer(d.data[0], 'true_false')); 

            arcs.append("text")
                .attr("transform", d => `translate(${arc.centroid(d)})`)
                .attr("dy", "0.35em")
                .text(d => {
                    const percentage = totalValidResponses > 0 ? ((d.data[1] / totalValidResponses) * 100).toFixed(1) : 0;
                    return `${d.data[0]}: ${d.data[1]} (${percentage}%)`;
                }) 
                .style("font-size", "14px").style("text-anchor", "middle").style("fill", "white");
        }

        function drawBarChart(data, totalValidResponses) {
            const width = +chartSvg.attr("width") - 60;
            const height = +chartSvg.attr("height") - 60;
            const margin = {top: 20, right: 20, bottom: 30, left: 40};
            const x = d3.scaleBand().range([0, width]).padding(0.1).domain(Object.keys(data));
            const y = d3.scaleLinear().range([height, 0]).domain([0, d3.max(Object.values(data)) || 1]); 
            const color = d3.scaleOrdinal().domain(Object.keys(data)).range(['#2563eb', '#ca8a04', '#16a34a', '#dc2626']);
            const g = chartSvg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));
            g.append("g").call(d3.axisLeft(y).ticks(Math.min(10, d3.max(Object.values(data)) || 1)).tickFormat(d3.format('d')));

            g.selectAll(".bar").data(Object.entries(data)).enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d[0]) + x.bandwidth() / 2) 
                .attr("y", d => y(d[1])) 
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d[1])) 
                .attr("fill", d => color(d[0]))
                .on("click", (event, d) => displayStudentsForAnswer(d[0], 'multiple_choice')); 
            
            g.selectAll(".bar-label").data(Object.entries(data)).enter().append("text")
                .attr("class", "bar-label")
                .attr("x", d => x(d[0]) + x.bandwidth() / 2) 
                .attr("y", d => y(d[1]) - 5) 
                .attr("text-anchor", "middle").style("font-size", "12px")
                .text(d => {
                    const percentage = totalValidResponses > 0 ? ((d[1] / totalValidResponses) * 100).toFixed(1) : 0;
                    return `${d[1]} (${percentage}%)`;
                }); 
        }

        /**
         * NEW: Draws a bar chart for custom multiple choice questions, showing correctness rate per question.
         * @param {Array} responses - All student responses.
         * @param {Array} questions - The custom multiple choice questions.
         */
        function drawCustomMultipleChoiceBarChart(responses, questions) {
            const width = +chartSvg.attr("width") - 60;
            const height = +chartSvg.attr("height") - 60;
            const margin = {top: 20, right: 20, bottom: 60, left: 40}; // Increased bottom margin for question labels
            
            const questionStats = questions.map((q, qIndex) => {
                let correctCount = 0;
                let answeredCount = 0; // Count students who attempted this question

                responses.forEach(studentResponse => {
                    if (Array.isArray(studentResponse.answer)) {
                        const studentQAnswer = studentResponse.answer.find(ans => ans.qIndex === qIndex);
                        if (studentQAnswer) {
                            answeredCount++;
                            if (String(studentQAnswer.ans) === String(q.correctAnswer)) {
                                correctCount++;
                            }
                        }
                    }
                });
                return {
                    questionIndex: qIndex,
                    questionText: `Q${qIndex + 1}`, // Display as Q1, Q2 etc.
                    correctCount: correctCount,
                    answeredCount: answeredCount,
                    correctRate: answeredCount > 0 ? (correctCount / answeredCount) * 100 : 0
                };
            });

            // Filter out questions with no attempts if desired, or show 0%
            const displayStats = questionStats.filter(s => s.answeredCount > 0);
            if (displayStats.length === 0) {
                chartSvg.append("text")
                    .attr("x", chartSvg.attr("width") / 2)
                    .attr("y", chartSvg.attr("height") / 2)
                    .attr("text-anchor", "middle")
                    .style("font-size", "18px")
                    .style("fill", "#666")
                    .text("目前沒有學生作答任何自訂選擇題。");
                return;
            }

            const x = d3.scaleBand()
                .range([0, width])
                .padding(0.2)
                .domain(displayStats.map(d => d.questionText));

            const y = d3.scaleLinear()
                .range([height, 0])
                .domain([0, 100]); // Percentage from 0 to 100

            const g = chartSvg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // X-axis
            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "rotate(-45)") // Rotate labels for readability
                .style("text-anchor", "end");

            // Y-axis
            g.append("g")
                .call(d3.axisLeft(y).ticks(10).tickFormat(d => `${d}%`));

            // Bars
            g.selectAll(".bar")
                .data(displayStats)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.questionText))
                .attr("y", d => y(d.correctRate))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.correctRate))
                .attr("fill", "#2563eb") // A nice blue color
                .on("click", (event, d) => displayStudentsForAnswer('correct', 'multiple_choice', d.questionIndex)); // Click to show correct students

            // Labels on bars
            g.selectAll(".bar-label")
                .data(displayStats)
                .enter().append("text")
                .attr("class", "bar-label")
                .attr("x", d => x(d.questionText) + x.bandwidth() / 2)
                .attr("y", d => y(d.correctRate) - 5)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .text(d => `${d.correctRate.toFixed(1)}%`);

            // Y-axis label
            g.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("答對率 (%)");
        }

        /**
         * Draw reading comprehension statistics chart with PIRLS level analysis
         */
        function drawReadingComprehensionChart(responses, questions) {
            const width = +chartSvg.attr("width") - 60;
            const height = +chartSvg.attr("height") - 60;
            const margin = {top: 20, right: 20, bottom: 80, left: 60};

            // Calculate statistics for each question
            const questionStats = questions.map((q, qIndex) => {
                let correctCount = 0;
                let answeredCount = 0;

                responses.forEach(studentResponse => {
                    try {
                        const studentAnswers = JSON.parse(studentResponse.answer);
                        if (Array.isArray(studentAnswers) && studentAnswers[qIndex] !== undefined) {
                            answeredCount++;
                            if (studentAnswers[qIndex] === q.correctAnswer) {
                                correctCount++;
                            }
                        }
                    } catch (e) {
                        // Invalid answer format
                    }
                });

                return {
                    questionIndex: qIndex,
                    questionText: `Q${qIndex + 1}`,
                    level: q.level,
                    correctCount: correctCount,
                    answeredCount: answeredCount,
                    correctRate: answeredCount > 0 ? (correctCount / answeredCount) * 100 : 0
                };
            });

            // Calculate PIRLS level statistics
            const levelStats = [1, 2, 3, 4].map(level => {
                const levelQuestions = questionStats.filter(q => q.level === level);
                if (levelQuestions.length === 0) return null;

                const totalCorrect = levelQuestions.reduce((sum, q) => sum + q.correctCount, 0);
                const totalAnswered = levelQuestions.reduce((sum, q) => sum + q.answeredCount, 0);

                return {
                    level: level,
                    correctRate: totalAnswered > 0 ? (totalCorrect / totalAnswered) * 100 : 0,
                    questionCount: levelQuestions.length
                };
            }).filter(s => s !== null);

            const displayStats = questionStats.filter(s => s.answeredCount > 0);
            if (displayStats.length === 0) {
                chartSvg.append("text")
                    .attr("x", chartSvg.attr("width") / 2)
                    .attr("y", chartSvg.attr("height") / 2)
                    .attr("text-anchor", "middle")
                    .style("font-size", "18px")
                    .style("fill", "#666")
                    .text("目前沒有學生作答閱讀測驗。");
                return;
            }

            const x = d3.scaleBand()
                .range([0, width])
                .padding(0.2)
                .domain(displayStats.map(d => d.questionText));

            const y = d3.scaleLinear()
                .range([height, 0])
                .domain([0, 100]);

            const g = chartSvg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // Define colors for each PIRLS level
            const levelColors = {
                1: '#3b82f6', // Blue - 直接提取
                2: '#8b5cf6', // Purple - 直接推論
                3: '#f59e0b', // Amber - 詮釋整合
                4: '#ef4444'  // Red - 比較評估
            };

            // X-axis
            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");

            // Y-axis
            g.append("g")
                .call(d3.axisLeft(y).ticks(10).tickFormat(d => `${d}%`));

            // Bars
            g.selectAll(".bar")
                .data(displayStats)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.questionText))
                .attr("y", d => y(d.correctRate))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.correctRate))
                .attr("fill", d => levelColors[d.level])
                .style("cursor", "pointer");

            // Labels on bars
            g.selectAll(".bar-label")
                .data(displayStats)
                .enter().append("text")
                .attr("class", "bar-label")
                .attr("x", d => x(d.questionText) + x.bandwidth() / 2)
                .attr("y", d => y(d.correctRate) - 5)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .text(d => `${d.correctRate.toFixed(1)}%`);

            // Y-axis label
            g.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("答對率 (%)");

            // PIRLS Level Legend and Statistics
            const legendY = height + 50;
            const levelIcons = ['📖', '💭', '🔗', '⚖️'];
            const levelTexts = ['直接提取', '直接推論', '詮釋整合', '比較評估'];

            levelStats.forEach((stat, i) => {
                const legendX = i * 140;

                // Color box
                g.append("rect")
                    .attr("x", legendX)
                    .attr("y", legendY)
                    .attr("width", 15)
                    .attr("height", 15)
                    .attr("fill", levelColors[stat.level]);

                // Text
                g.append("text")
                    .attr("x", legendX + 20)
                    .attr("y", legendY + 12)
                    .style("font-size", "11px")
                    .text(`${levelIcons[i]} L${stat.level}: ${stat.correctRate.toFixed(1)}%`);
            });
        }


        // --- Sequencing Question Logic ---
        function setupSequencingUI(data) {
            const questionText = document.getElementById('sequencing-question-text');
            const container = document.getElementById('sequencing-items-container');

            questionText.textContent = data.question || '請依照正確順序排列以下項目';
            container.innerHTML = '';

            // Shuffle items
            const shuffled = [...data.correctOrder].sort(() => Math.random() - 0.5);

            shuffled.forEach((text, index) => {
                const item = document.createElement('div');
                item.className = 'sequencing-item';
                item.draggable = true;
                item.dataset.text = text;
                item.innerHTML = `
                    <div class="sequencing-item-number">${index + 1}</div>
                    <div class="sequencing-item-text">${text}</div>
                `;

                // Drag events
                item.addEventListener('dragstart', (e) => {
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const dragging = document.querySelector('.sequencing-item.dragging');
                    if (dragging && dragging !== item) {
                        const rect = item.getBoundingClientRect();
                        const midY = rect.top + rect.height / 2;
                        if (e.clientY < midY) {
                            container.insertBefore(dragging, item);
                        } else {
                            container.insertBefore(dragging, item.nextSibling);
                        }
                    }
                });

                // Touch events for mobile
                let touchStartY = 0;
                item.addEventListener('touchstart', (e) => {
                    touchStartY = e.touches[0].clientY;
                    item.classList.add('dragging');
                });

                item.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const target = document.elementFromPoint(touch.clientX, touch.clientY);
                    if (target && target.classList.contains('sequencing-item') && target !== item) {
                        if (touch.clientY < touchStartY) {
                            container.insertBefore(item, target);
                        } else {
                            container.insertBefore(item, target.nextSibling);
                        }
                        touchStartY = touch.clientY;
                    }
                });

                item.addEventListener('touchend', () => {
                    item.classList.remove('dragging');
                });

                container.appendChild(item);
            });

            // Update numbers after any change
            updateSequencingNumbers();
        }

        function updateSequencingNumbers() {
            const items = document.querySelectorAll('.sequencing-item');
            items.forEach((item, index) => {
                const numberDiv = item.querySelector('.sequencing-item-number');
                if (numberDiv) numberDiv.textContent = index + 1;
            });
        }

        // --- Matching Question Logic ---
        function setupMatchingUI(data) {
            const questionText = document.getElementById('matching-question-text');
            const columnA = document.getElementById('matching-column-a');
            const columnB = document.getElementById('matching-column-b');
            const svg = document.getElementById('matching-svg-canvas');

            questionText.textContent = data.question || '請將左右兩側相關的項目配對';
            columnA.innerHTML = '';
            columnB.innerHTML = '';
            svg.innerHTML = '';

            // Shuffle items
            const leftItems = data.pairs.map(p => p.left).sort(() => Math.random() - 0.5);
            const rightItems = data.pairs.map(p => p.right).sort(() => Math.random() - 0.5);

            leftItems.forEach((text, index) => {
                const item = document.createElement('div');
                item.className = 'matching-item';
                item.dataset.side = 'left';
                item.dataset.text = text;
                item.dataset.index = index;
                item.textContent = text;
                item.addEventListener('click', () => handleMatchingClick(item));
                columnA.appendChild(item);
            });

            rightItems.forEach((text, index) => {
                const item = document.createElement('div');
                item.className = 'matching-item';
                item.dataset.side = 'right';
                item.dataset.text = text;
                item.dataset.index = index;
                item.textContent = text;
                item.addEventListener('click', () => handleMatchingClick(item));
                columnB.appendChild(item);
            });
        }

        function handleMatchingClick(item) {
            const side = item.dataset.side;

            if (item.classList.contains('matched')) {
                // Unmatch
                const matchedWith = item.dataset.matchedWith;
                delete item.dataset.matchedWith;
                item.classList.remove('matched');

                // Find and unmatch partner
                const partner = document.querySelector(`.matching-item[data-side="${side === 'left' ? 'right' : 'left'}"][data-text="${matchedWith}"]`);
                if (partner) {
                    delete partner.dataset.matchedWith;
                    partner.classList.remove('matched');
                }

                redrawMatchingLines();
                return;
            }

            if (side === 'left') {
                if (currentMatchingSelection.leftItem === item) {
                    currentMatchingSelection.leftItem.classList.remove('selected');
                    currentMatchingSelection.leftItem = null;
                } else {
                    if (currentMatchingSelection.leftItem) {
                        currentMatchingSelection.leftItem.classList.remove('selected');
                    }
                    currentMatchingSelection.leftItem = item;
                    item.classList.add('selected');
                }
            } else {
                if (currentMatchingSelection.rightItem === item) {
                    currentMatchingSelection.rightItem.classList.remove('selected');
                    currentMatchingSelection.rightItem = null;
                } else {
                    if (currentMatchingSelection.rightItem) {
                        currentMatchingSelection.rightItem.classList.remove('selected');
                    }
                    currentMatchingSelection.rightItem = item;
                    item.classList.add('selected');
                }
            }

            // If both sides selected, create match
            if (currentMatchingSelection.leftItem && currentMatchingSelection.rightItem) {
                const left = currentMatchingSelection.leftItem;
                const right = currentMatchingSelection.rightItem;

                left.classList.remove('selected');
                right.classList.remove('selected');
                left.classList.add('matched');
                right.classList.add('matched');

                left.dataset.matchedWith = right.dataset.text;
                right.dataset.matchedWith = left.dataset.text;

                currentMatchingSelection.leftItem = null;
                currentMatchingSelection.rightItem = null;

                redrawMatchingLines();
            }
        }

        function redrawMatchingLines() {
            const svg = document.getElementById('matching-svg-canvas');
            svg.innerHTML = '';

            const container = document.querySelector('.matching-container');
            const rect = container.getBoundingClientRect();
            svg.setAttribute('width', rect.width);
            svg.setAttribute('height', rect.height);

            document.querySelectorAll('.matching-item.matched[data-side="left"]').forEach(leftItem => {
                const rightText = leftItem.dataset.matchedWith;
                const rightItem = document.querySelector(`.matching-item[data-side="right"][data-text="${rightText}"]`);

                if (rightItem) {
                    const leftRect = leftItem.getBoundingClientRect();
                    const rightRect = rightItem.getBoundingClientRect();

                    const x1 = leftRect.right - rect.left;
                    const y1 = leftRect.top + leftRect.height / 2 - rect.top;
                    const x2 = rightRect.left - rect.left;
                    const y2 = rightRect.top + rightRect.height / 2 - rect.top;

                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const d = `M ${x1} ${y1} C ${(x1 + x2) / 2} ${y1}, ${(x1 + x2) / 2} ${y2}, ${x2} ${y2}`;
                    line.setAttribute('d', d);
                    line.setAttribute('class', 'matching-line');
                    svg.appendChild(line);
                }
            });
        }

        // --- Drawing Board Logic ---
        function setupCanvas() {
            const canvasElement = document.getElementById('drawing-canvas');
            if (!canvasElement.offsetParent) return; // Don't setup if not visible
            let renderedWidth = canvasElement.clientWidth;
            let renderedHeight = canvasElement.clientHeight;

            canvasElement.width = Math.min(MAX_IMAGE_DIMENSION * 2, Math.max(1, renderedWidth)); 
            canvasElement.height = Math.min(MAX_IMAGE_DIMENSION * 2, Math.max(1, renderedHeight));

            [backgroundCanvas, studentImageCanvas, drawingCanvas].forEach(c => {
                c.width = canvasElement.width;
                c.height = canvasElement.height;
            });

            drawingCtx.lineJoin = 'round';
            drawingCtx.lineCap = 'round';
            drawingCtx.strokeStyle = document.getElementById('color-select').value;
            drawingCtx.lineWidth = parseInt(document.getElementById('size-select').value);
            drawingCtx.globalCompositeOperation = 'source-over';

            // Only clear drawingCanvas if it's a new session, not just a resize within the same session.
            // This is handled by the `resetStudentUIState` function now.
            // For setupCanvas, it's about setting dimensions and initial drawing context properties.
            // The actual clearing should be conditional based on pause state.
            // However, for a fresh setup (e.g., first time entering drawing mode), it should be cleared.
            // The logic in resetStudentUIState is responsible for this.
            // So, here, we just ensure the canvases are ready.
            backgroundCtx.fillStyle = 'white';
            backgroundCtx.fillRect(0, 0, backgroundCanvas.width, backgroundCanvas.height);
            studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);
        }

        function loadBackgroundImage() {
            backgroundCtx.clearRect(0, 0, backgroundCanvas.width, backgroundCanvas.height);
            backgroundCtx.fillStyle = 'white';
            backgroundCtx.fillRect(0, 0, backgroundCanvas.width, backgroundCanvas.height);

            if (teacherUploadedBackgroundImageDataURL) {
                const tempImg = new Image();
                tempImg.onload = () => {
                    const canvasRatio = backgroundCanvas.width / backgroundCanvas.height;
                    const imgRatio = tempImg.width / tempImg.height;
                    let drawWidth, drawHeight, offsetX, offsetY;
                    if (imgRatio > canvasRatio) { 
                        drawHeight = backgroundCanvas.width / imgRatio;
                        drawWidth = backgroundCanvas.width;
                        offsetY = (backgroundCanvas.height - drawHeight) / 2;
                        offsetX = 0;
                    } else { 
                        drawWidth = backgroundCanvas.height * imgRatio;
                        drawHeight = backgroundCanvas.height;
                        offsetX = (backgroundCanvas.width - drawWidth) / 2;
                        offsetY = 0;
                    }
                    backgroundCtx.drawImage(tempImg, offsetX, offsetY, drawWidth, drawHeight);
                    drawCombinedCanvas();
                };
                tempImg.src = teacherUploadedBackgroundImageDataURL;
            } else {
                drawCombinedCanvas();
            }
        }

        function loadStudentImage() {
            studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);

            if (studentUploadedImageDataURL) {
                const tempImg = new Image();
                tempImg.onload = () => {
                    const canvasRatio = studentImageCanvas.width / studentImageCanvas.height;
                    const imgRatio = tempImg.width / tempImg.height;
                    let drawWidth, drawHeight, offsetX, offsetY;
                    if (imgRatio > canvasRatio) { 
                        drawHeight = studentImageCanvas.width / imgRatio;
                        drawWidth = studentImageCanvas.width;
                        offsetY = (studentImageCanvas.height - drawHeight) / 2;
                        offsetX = 0;
                    } else { 
                        drawWidth = studentImageCanvas.height * imgRatio;
                        drawHeight = studentImageCanvas.height;
                        offsetX = (studentImageCanvas.width - drawWidth) / 2;
                        offsetY = 0;
                    }
                    studentImageCtx.drawImage(tempImg, offsetX, offsetY, drawWidth, drawHeight);
                    drawCombinedCanvas();
                };
                tempImg.src = studentUploadedImageDataURL;
            } else {
                drawCombinedCanvas();
            }
        }

        function drawCombinedCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(backgroundCanvas, 0, 0);
            ctx.drawImage(studentImageCanvas, 0, 0);
            ctx.drawImage(drawingCanvas, 0, 0);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault(); 
            const { offsetX, offsetY } = getMousePos(e); 
            drawingCtx.beginPath();
            drawingCtx.moveTo(lastX, lastY);
            drawingCtx.lineTo(offsetX, offsetY);
            drawingCtx.stroke();
            [lastX, lastY] = [offsetX, offsetY];
            drawCombinedCanvas();
        }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect(); 
            let clientX = e.touches ? e.touches[0].clientX : e.clientX;
            let clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const rawOffsetX = clientX - rect.left;
            const rawOffsetY = clientY - rect.top;
            const scaleX = canvas.width / rect.width; 
            const scaleY = canvas.height / rect.height;
            return { offsetX: rawOffsetX * scaleX, offsetY: rawOffsetY * scaleY };
        }
        
        function startDrawing(e) {
            isDrawing = true;
            const { offsetX, offsetY } = getMousePos(e); 
            [lastX, lastY] = [offsetX, offsetY];
        }

        function stopDrawing() { isDrawing = false; }
        
        function clearDrawingCanvas() {
            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            drawCombinedCanvas();
        }

        function updateColorSwatch(color) {
            const swatch = document.getElementById('current-color-swatch');
            if (swatch) swatch.style.backgroundColor = color;
        }
        
        // --- AI Settings Modal Functions ---
        const aiSettingsModal = document.getElementById('ai-settings-modal');
        const aiSettingsModalCloseBtn = document.getElementById('ai-settings-modal-close-btn');
        const aiSourceSelect = document.getElementById('ai-source-select');
        const geminiApiKeyGroup = document.getElementById('gemini-api-key-group');
        const geminiApiKeyInput = document.getElementById('gemini-api-key-input');
        const saveAiSettingsBtn = document.getElementById('save-ai-settings-btn');

        const aiModelSelect = document.getElementById('ai-model-select');

        function showAISettingsModal() {
            aiSourceSelect.value = aiSettings.aiSource;
            geminiApiKeyInput.value = aiSettings.geminiApiKey;
            aiModelSelect.value = aiSettings.selectedModel;
            geminiApiKeyGroup.classList.toggle('hidden', aiSettings.aiSource !== 'gemini-custom');
            aiSettingsModal.classList.remove('hidden');
        }

        function hideAISettingsModal() {
            aiSettingsModal.classList.add('hidden');
        }

        /**
         * Show API error modal with detailed error message in Chinese
         */
        function showAPIErrorModal(error, response = null) {
            const errorMessageEl = document.getElementById('api-error-message');
            const errorSolutionsEl = document.getElementById('api-error-solutions');

            let errorMessage = '';
            let solutions = [];

            // Determine error type and provide Chinese explanation
            if (response && !response.ok) {
                const statusCode = response.status;

                if (statusCode === 400) {
                    errorMessage = 'API 請求格式錯誤或 API Key 無效';
                    solutions = [
                        '請檢查您的 API Key 是否正確',
                        '請確認 API Key 是否已啟用',
                        '請到右上角齒輪圖示重新設定 API Key'
                    ];
                } else if (statusCode === 401) {
                    errorMessage = 'API Key 驗證失敗，無法存取 API 服務';
                    solutions = [
                        '您的 API Key 可能無效或已過期',
                        '請到 Google AI Studio 確認 API Key 狀態',
                        '請到右上角齒輪圖示重新設定正確的 API Key'
                    ];
                } else if (statusCode === 403) {
                    errorMessage = 'API Key 沒有權限使用此服務';
                    solutions = [
                        '請確認 API Key 是否有 Gemini API 的使用權限',
                        '請檢查 API Key 是否已超過使用額度',
                        '請到 Google AI Studio 檢查專案設定'
                    ];
                } else if (statusCode === 429) {
                    errorMessage = 'API 請求次數超過限制';
                    solutions = [
                        '您已超過 API 的使用次數限制',
                        '請稍後再試，或升級您的 API 方案',
                        '如使用免費方案，請等待配額重置（通常為每分鐘重置）'
                    ];
                } else if (statusCode === 500 || statusCode === 503) {
                    errorMessage = 'API 服務暫時無法使用';
                    solutions = [
                        'Google API 伺服器目前發生問題',
                        '請稍後再試',
                        '如持續發生問題，請查看 Google API 服務狀態'
                    ];
                } else {
                    errorMessage = `API 請求失敗（錯誤代碼：${statusCode}）`;
                    solutions = [
                        '請檢查網路連線是否正常',
                        '請確認 API Key 設定是否正確',
                        '請稍後再試'
                    ];
                }
            } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                errorMessage = '無法連接到 API 服務';
                solutions = [
                    '請檢查您的網路連線是否正常',
                    '請確認防火牆或網路設定是否阻擋了 API 請求',
                    '請稍後再試'
                ];
            } else if (error.message.includes('API Key')) {
                errorMessage = 'API Key 設定有誤';
                solutions = [
                    '請到右上角齒輪圖示設定 API Key',
                    '請確認 API Key 格式正確（無多餘空格或字元）',
                    '請到 Google AI Studio 取得有效的 API Key'
                ];
            } else {
                errorMessage = error.message || 'AI 生成過程發生未知錯誤';
                solutions = [
                    '請檢查網路連線',
                    '請確認 API Key 設定正確',
                    '請稍後再試',
                    '如持續發生問題，請聯繫技術支援'
                ];
            }

            // Update modal content
            errorMessageEl.textContent = errorMessage;
            errorSolutionsEl.innerHTML = solutions.map(solution => `<li>${solution}</li>`).join('');

            // Show modal
            document.getElementById('api-error-modal').classList.remove('hidden');
        }

        function hideAPIErrorModal() {
            document.getElementById('api-error-modal').classList.add('hidden');
        }

        function saveAISettings() {
            aiSettings.aiSource = aiSourceSelect.value;
            aiSettings.geminiApiKey = geminiApiKeyInput.value.trim();
            aiSettings.selectedModel = aiModelSelect.value;
            localStorage.setItem('aiSettings', JSON.stringify(aiSettings));
            updateModelDisplays();
            showMessage('AI 設定已儲存！', 'success');
            hideAISettingsModal();
        }

        function loadAISettings() {
            const savedSettings = localStorage.getItem('aiSettings');
            if (savedSettings) {
                try {
                    const parsedSettings = JSON.parse(savedSettings);
                    if (parsedSettings.aiSource) aiSettings.aiSource = parsedSettings.aiSource;
                    // MODIFIED: If geminiApiKey is empty after loading, set default.
                    aiSettings.geminiApiKey = parsedSettings.geminiApiKey || '12345678';
                    aiSettings.selectedModel = parsedSettings.selectedModel || 'gemini-2.5-flash';
                } catch (e) {
                    console.error("Failed to parse AI settings from localStorage:", e);
                    // If parsing fails, set default API key
                    aiSettings.geminiApiKey = '12345678';
                    aiSettings.selectedModel = 'gemini-2.5-flash';
                }
            } else {
                // If no settings are saved at all, set default API key
                aiSettings.geminiApiKey = '12345678';
                aiSettings.selectedModel = 'gemini-2.5-flash';
            }
            updateModelDisplays();
        }

        function getApiUrl(apiKey) {
            const model = aiSettings.selectedModel || 'gemini-2.5-flash';
            return `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
        }

        function getCurrentModelName() {
            const modelMap = {
                'gemini-2.5-flash': 'Gemini 2.5 Flash',
                'gemma-3-27b-it': 'Gemma 3 27B IT'
            };
            return modelMap[aiSettings.selectedModel] || aiSettings.selectedModel;
        }

        function updateModelDisplays() {
            const modelName = getCurrentModelName();
            const displayText = `使用模型: ${modelName}`;

            const displays = [
                document.getElementById('ai-mc-model-name'),
                document.getElementById('ai-seq-model-name'),
                document.getElementById('ai-match-model-name')
            ];

            displays.forEach(display => {
                if (display) display.textContent = displayText;
            });
        }

        // --- New: URL/HTML Dispatch Settings Modal Functions (Combined) ---
        const urlDispatchModal = document.getElementById('url-dispatch-settings-modal');
        const urlDispatchModalCloseBtn = document.getElementById('url-dispatch-settings-modal-close-btn');
        
        const urlDispatchSection = document.getElementById('url-dispatch-section');
        const htmlDispatchSection = document.getElementById('html-dispatch-section');
        const dispatchTypeRadios = document.querySelectorAll('input[name="dispatchType"]');

        const urlInput = document.getElementById('dispatch-url-input');
        const isYoutubeCheckbox = document.getElementById('is-youtube-checkbox');
        
        const dispatchHtmlUploadInput = document.getElementById('dispatch-html-upload-input');
        const clearDispatchHtmlBtn = document.getElementById('clear-dispatch-html-btn');
        const dispatchHtmlStatus = document.getElementById('dispatch-html-status');

        function showUrlDispatchSettingsModal() {
            // Set radio button based on current dispatchSettings.type
            document.querySelector(`input[name="dispatchType"][value="${dispatchSettings.type}"]`).checked = true;
            
            // Show/hide sections based on type
            urlDispatchSection.classList.toggle('hidden', dispatchSettings.type === 'html');
            htmlDispatchSection.classList.toggle('hidden', dispatchSettings.type === 'url');

            // Populate URL fields
            urlInput.value = dispatchSettings.url;
            isYoutubeCheckbox.checked = dispatchSettings.isYoutube;

            // Update HTML status
            dispatchHtmlStatus.textContent = dispatchSettings.htmlContent ? '已上傳 HTML 檔案。' : '目前沒有 HTML 檔案。';

            urlDispatchModal.classList.remove('hidden');
        }

        function hideUrlDispatchSettingsModal() {
            urlDispatchModal.classList.add('hidden');
        }

        function saveDispatchSettings() { // Renamed from saveUrlDispatchSettings
            dispatchSettings.type = document.querySelector('input[name="dispatchType"]:checked').value;

            if (dispatchSettings.type === 'url') {
                dispatchSettings.url = urlInput.value.trim();
                dispatchSettings.isYoutube = isYoutubeCheckbox.checked;
                dispatchSettings.htmlContent = null; // Clear HTML content if switching to URL
            } else { // type === 'html'
                // htmlContent is updated via handleHtmlFile or clearDispatchHtml
                dispatchSettings.url = ''; // Clear URL if switching to HTML
                dispatchSettings.isYoutube = false; // Clear YouTube flag
            }
            
            localStorage.setItem('dispatchSettings', JSON.stringify(dispatchSettings));
            showMessage('派送設定已儲存！', 'success');
            hideUrlDispatchSettingsModal();
        }

        function clearDispatchSettings() { // Renamed from clearUrlDispatchSettings
            urlInput.value = '';
            isYoutubeCheckbox.checked = false;
            dispatchHtmlUploadInput.value = ''; // Clear file input
            dispatchHtmlStatus.textContent = '目前沒有 HTML 檔案。';

            dispatchSettings = { type: 'url', url: '', isYoutube: false, htmlContent: null }; // Reset global variable
            localStorage.removeItem('dispatchSettings'); // Clear from localStorage
            
            // Reset UI to default (URL selected)
            document.querySelector('input[name="dispatchType"][value="url"]').checked = true;
            urlDispatchSection.classList.remove('hidden');
            htmlDispatchSection.classList.add('hidden');
        }

        function loadDispatchSettings() { // Renamed from loadUrlDispatchSettings
            const savedSettings = localStorage.getItem('dispatchSettings');
            if (savedSettings) {
                try {
                    const parsedSettings = JSON.parse(savedSettings);
                    // Ensure all properties are set, even if null in saved data
                    dispatchSettings.type = parsedSettings.type || 'url';
                    dispatchSettings.url = parsedSettings.url || '';
                    dispatchSettings.isYoutube = parsedSettings.isYoutube || false;
                    dispatchSettings.htmlContent = parsedSettings.htmlContent || null;
                } catch (e) {
                    console.error("Failed to parse dispatch settings from localStorage:", e);
                    // Reset to default if parsing fails
                    dispatchSettings = { type: 'url', url: '', isYoutube: false, htmlContent: null };
                }
            }
        }

        /**
         * NEW: Handles HTML file upload within the combined dispatch settings modal.
         * @param {File} file - The HTML file to process.
         */
        function handleDispatchHtmlFile(file) {
            if (!file || !file.type.includes('html')) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                dispatchSettings.htmlContent = event.target.result; // Update global state
                dispatchHtmlStatus.textContent = `已上傳檔案: ${file.name}`;
                showMessage('HTML 檔案已上傳！', 'success');
            };
            reader.readAsText(file);
        }


        // --- New: Recording Functions (Student Side) ---
        const startRecordingBtn = document.getElementById('start-recording-btn');
        const stopRecordingBtn = document.getElementById('stop-recording-btn');
        const playRecordingBtn = document.getElementById('play-recording-btn');
        const resetRecordingBtn = document.getElementById('reset-recording-btn');
        const submitRecordingBtn = document.getElementById('submit-recording-btn');
        const audioPreview = document.getElementById('audio-preview');
        const recordingStatusText = document.getElementById('recording-status-text');
        const recordingStatusIcon = document.getElementById('recording-status-icon');

        /**
         * Starts the audio recording process.
         */
        async function startRecording() {
            try {
                // Request access to microphone
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Try to use audio/wav first for better iOS compatibility.
                // Fallback to audio/webm if wav is not supported.
                let mimeType = 'audio/webm';
                if (MediaRecorder.isTypeSupported('audio/wav')) {
                    mimeType = 'audio/wav';
                } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                    mimeType = 'audio/mp4'; // Another common format
                } else if (MediaRecorder.isTypeSupported('audio/ogg')) {
                    mimeType = 'audio/ogg';
                }

                mediaRecorder = new MediaRecorder(audioStream, { mimeType: mimeType });
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType }); // Use the actual mimeType recorded
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        audioDataURL = reader.result;
                        audioPreview.src = audioDataURL;
                        audioPreview.classList.remove('hidden');
                        playRecordingBtn.disabled = false;
                        resetRecordingBtn.disabled = false;
                        submitRecordingBtn.disabled = false;
                        recordingStatusText.textContent = '錄音完成，可試聽或送出';
                        recordingStatusIcon.classList.remove('fa-spin', 'text-red-500');
                        recordingStatusIcon.classList.add('text-green-500');
                    };
                    reader.readAsDataURL(audioBlob);

                    // Stop all tracks to release microphone
                    audioStream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                startRecordingBtn.disabled = true;
                stopRecordingBtn.disabled = false;
                playRecordingBtn.disabled = true;
                resetRecordingBtn.disabled = true;
                submitRecordingBtn.disabled = true;
                recordingStatusText.textContent = '正在錄音...';
                recordingStatusIcon.classList.remove('text-gray-400');
                recordingStatusIcon.classList.add('fa-spin', 'text-red-500');
                showMessage('開始錄音', 'info');
            } catch (err) {
                console.error('無法取得麥克風權限:', err);
                showMessage('無法取得麥克風權限，請檢查設定。', 'error');
                // Reset buttons if permission fails
                startRecordingBtn.disabled = false;
                stopRecordingBtn.disabled = true;
                playRecordingBtn.disabled = true;
                resetRecordingBtn.disabled = true;
                submitRecordingBtn.disabled = true;
                recordingStatusText.textContent = '錄音失敗';
                recordingStatusIcon.classList.remove('fa-spin', 'text-red-500');
                recordingStatusIcon.classList.add('text-gray-400');
            }
        }

        /**
         * Stops the audio recording.
         */
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                stopRecordingBtn.disabled = true;
            }
        }

        /**
         * Plays the recorded audio.
         */
        function playRecording() {
            if (audioPreview.src) {
                audioPreview.play();
                showMessage('正在播放錄音', 'info');
            } else {
                showMessage('沒有可播放的錄音', 'info');
            }
        }

        /**
         * Resets the recording state, allowing for a new recording.
         */
        function resetRecording() {
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
            }
            audioChunks = [];
            audioBlob = null;
            audioDataURL = null;
            audioPreview.src = '';
            audioPreview.classList.add('hidden');

            startRecordingBtn.disabled = false;
            stopRecordingBtn.disabled = true;
            playRecordingBtn.disabled = true;
            resetRecordingBtn.disabled = true;
            submitRecordingBtn.disabled = true;
            recordingStatusText.textContent = '準備錄音...';
            recordingStatusIcon.classList.remove('fa-spin', 'text-red-500', 'text-green-500');
            recordingStatusIcon.classList.add('text-gray-400');
            showMessage('錄音已重置', 'info');
        }

        // --- End Recording Functions ---

        /**
         * (Teacher) Ends the entire class session, clears all student data and presence for the current classroom code.
         */
        async function endClassSession() {
            markClassEnded(); // Mark that class has been properly ended
            clearAllQuestionBanks(); // Clear question banks from memory
            showMessage('正在結束課程並清空資料...', 'info');

            if (interactionModeUnsubscribe) interactionModeUnsubscribe();
            if (studentResponsesUnsubscribe) studentResponsesUnsubscribe();
            if (classroomPresenceUnsubscribe) { // Only unsubscribe presence here
                classroomPresenceUnsubscribe();
                classroomPresenceUnsubscribe = null;
            }
            interactionModeUnsubscribe = studentResponsesUnsubscribe = null; // Reset others

            try {
                // Delete the entire classroom subcollection for the current classroomCode
                if (classroomCode) {
                    const classroomRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
                    const responsesSnapshot = await getDocs(classroomRef);
                    for (const doc of responsesSnapshot.docs) {
                        await deleteDoc(doc.ref);
                    }

                    const presenceRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'presence');
                    const presenceSnapshot = await getDocs(presenceRef);
                    for (const doc of presenceSnapshot.docs) {
                        await deleteDoc(doc.ref);
                    }

                    const settingsDocRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                    await deleteDoc(settingsDocRef); // Delete the control document
                    
                    console.log(`[Teacher] Cleared all data for classroom: ${classroomCode}`);
                }

                // Remove classroom code from recent classrooms list
                removeRecentClassroom(classroomCode);

                classroomCode = null; // Clear the classroom code after ending session
                localStorage.removeItem('teacherClassroomCode'); // Clear from local storage

                studentName = null;
                currentRole = null;
                currentInteractionMode = null;
                allStudentResponses = [];
                activeStudentNames = []; // NEW: Clear active student names
                lastSelectedStudentCard = null;
                lastSelectedModalStudent = null; // NEW: Clear modal lottery highlight
                isResponsePaused = false; // NEW: Reset pause state
                currentMultipleChoiceQuestions = null; // NEW: Clear custom MC questions

                document.getElementById('student-responses-container').innerHTML = '<p class="text-gray-500 text-center col-span-full">正在等待學生作答...</p>';
                document.getElementById('active-student-count').textContent = '0';
                // REMOVED: document.getElementById('responded-student-count').textContent = '0';
                document.getElementById('teacher-image-status').textContent = '目前沒有背景圖片。可選擇檔案或直接貼上(Ctrl+V)。';
                document.getElementById('teacher-image-preview').src = '';
                document.getElementById('teacher-image-preview-container').classList.add('hidden');

                // Clear URL/HTML dispatch settings and teacher background image when ending interaction
                clearDispatchSettings(); // Use the combined clear function
                teacherUploadedBackgroundImageDataURL = null;
                document.getElementById('teacher-image-status').textContent = '目前沒有背景圖片。可選擇檔案或直接貼上(Ctrl+V)。';
                document.getElementById('teacher-image-preview').src = '';
                document.getElementById('teacher-image-preview-container').classList.add('hidden');
                isResponsePaused = false; // NEW: Reset pause state
                updateTeacherPauseButtonUI(); // NEW: Update pause button UI

                await signOut(auth); // Explicitly sign out the user
                
                // NEW: After signing out, explicitly sign in again to get a fresh authenticated state
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Re-authenticated after ending session.");

                showView('entry'); // Show the entry view
                showMessage('課程已結束，資料已清空。', 'success');

            } catch (error) {
                console.error("結束課程並清空資料失敗:", error);
                showMessage("結束課程失敗，請檢查網路連線或聯繫管理員。", "error");
            }
        }

        /**
         * (Teacher) Leave classroom without deleting data - just clear local state and return to entry view
         */
        async function leaveClassroom() {
            if (!confirm('確定要暫離教室嗎？教室資料會保留，您稍後可以重新進入。')) {
                return;
            }

            showMessage('正在離開教室...', 'info');

            // Unsubscribe from all listeners
            if (interactionModeUnsubscribe) interactionModeUnsubscribe();
            if (studentResponsesUnsubscribe) studentResponsesUnsubscribe();
            if (classroomPresenceUnsubscribe) {
                classroomPresenceUnsubscribe();
                classroomPresenceUnsubscribe = null;
            }
            interactionModeUnsubscribe = studentResponsesUnsubscribe = null;

            // Clear local state (but don't delete Firestore data)
            classroomCode = null;
            localStorage.removeItem('teacherClassroomCode'); // Clear from local storage

            studentName = null;
            currentRole = null;
            currentInteractionMode = null;
            allStudentResponses = [];
            activeStudentNames = [];
            lastSelectedStudentCard = null;
            lastSelectedModalStudent = null;
            isResponsePaused = false;
            currentMultipleChoiceQuestions = null;

            // Clear question bank arrays from memory
            questionBanks = [];
            sequencingQuestionBanks = [];
            matchingQuestionBanks = [];
            readingQuestionBanks = [];

            // Clear UI
            document.getElementById('student-responses-container').innerHTML = '<p class="text-gray-500 text-center col-span-full">正在等待學生作答...</p>';
            document.getElementById('active-student-count').textContent = '0';
            document.getElementById('teacher-image-status').textContent = '目前沒有背景圖片。可選擇檔案或直接貼上(Ctrl+V)。';
            document.getElementById('teacher-image-preview').src = '';
            document.getElementById('teacher-image-preview-container').classList.add('hidden');

            clearDispatchSettings();
            teacherUploadedBackgroundImageDataURL = null;
            updateTeacherPauseButtonUI();

            // Return to entry view
            showView('entry');
            showMessage('已離開教室，資料已保留。', 'success');

            console.log('[Teacher] Left classroom without deleting data');
        }

        // NEW: Pause/Resume Response Logic
        const togglePauseBtn = document.getElementById('toggle-pause-btn');
        const togglePauseBtnText = document.getElementById('toggle-pause-btn-text');

        /**
         * Toggles the pause state for student responses in Firestore.
         */
        async function toggleResponsePause() {
            if (!classroomCode) {
                showMessage('請先開啟一個教室！', 'error');
                return;
            }
            const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
            try {
                isResponsePaused = !isResponsePaused; // Toggle local state
                await setDoc(controlRef, { isPaused: isResponsePaused }, { merge: true });
                showMessage(`學生回覆已${isResponsePaused ? '暫停' : '恢復'}！`, 'info');
                updateTeacherPauseButtonUI();
            } catch (error) {
                console.error("切換暫停回覆狀態失敗:", error);
                showMessage("切換狀態失敗，請檢查網路連線。", "error");
                isResponsePaused = !isResponsePaused; // Revert local state on error
            }
        }

        /**
         * Updates the teacher's pause button UI based on the `isResponsePaused` state.
         */
        function updateTeacherPauseButtonUI() {
            if (isResponsePaused) {
                togglePauseBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                togglePauseBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                togglePauseBtnText.textContent = '恢復回覆';
                togglePauseBtn.querySelector('i').classList.replace('fa-pause', 'fa-play');
            } else {
                togglePauseBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                togglePauseBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
                togglePauseBtnText.textContent = '暫停回覆';
                togglePauseBtn.querySelector('i').classList.replace('fa-play', 'fa-pause');
            }
        }


        // --- Event Listeners ---
        
        /**
         * NEW: Processes an image file (from upload or paste), resizes it, and applies it.
         * @param {File} file - The image file to process.
         * @param {boolean} isTeacher - True if the image is for the teacher's background.
         */
        function handleImageFile(file, isTeacher) {
            if (!file || !file.type.startsWith('image/')) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    let { width, height } = img;

                    // Resize image if it's too large
                    if (width > MAX_IMAGE_DIMENSION || height > MAX_IMAGE_DIMENSION) {
                        if (width > height) {
                            height *= MAX_IMAGE_DIMENSION / width;
                            width = MAX_IMAGE_DIMENSION;
                        } else {
                            width *= MAX_IMAGE_DIMENSION / height;
                            height = MAX_IMAGE_DIMENSION;
                        }
                    }
                    tempCanvas.width = width;
                    tempCanvas.height = height;
                    tempCtx.drawImage(img, 0, 0, width, height);
                    const dataUrl = tempCanvas.toDataURL('image/jpeg', JPEG_QUALITY);

                    if (isTeacher) {
                        teacherUploadedBackgroundImageDataURL = dataUrl;
                        // For teacher image, we need to pass statusId, previewId, previewContainerId
                        // These are not directly available in handleImageFile without context.
                        // Let's assume these are passed as arguments or accessed globally.
                        // Re-evaluate how setupImageUpload calls this.
                        document.getElementById('teacher-image-status').textContent = '已上傳背景圖片。可選擇檔案或直接貼上(Ctrl+V)。';
                        document.getElementById('teacher-image-preview').src = dataUrl;
                        document.getElementById('teacher-image-preview-container').classList.remove('hidden');
                        showMessage('背景圖片已上傳！', 'success');
                    } else {
                        studentUploadedImageDataURL = dataUrl;
                        showMessage('圖片已上傳！', 'success');
                        loadStudentImage();
                    }
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        /**
         * MODIFIED: Sets up image upload functionality for both file input and pasting.
         */
        const setupImageUpload = (inputId, statusId, previewContainerId, previewId, clearBtnId, isTeacher) => {
            const input = document.getElementById(inputId);
            const clearBtn = document.getElementById(clearBtnId);
            
            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                e.target.value = ''; // Reset input to allow re-uploading the same file
                if (file) {
                    // Pass the IDs to handleImageFile for teacher-specific updates
                    if (isTeacher) {
                        handleImageFileForTeacher(file, statusId, previewContainerId, previewId);
                    } else {
                        handleImageFile(file, isTeacher);
                    }
                }
            });

            clearBtn.addEventListener('click', () => {
                if (isTeacher) {
                    teacherUploadedBackgroundImageDataURL = null;
                    document.getElementById(statusId).textContent = '目前沒有背景圖片。可選擇檔案或直接貼上(Ctrl+V)。';
                    document.getElementById(previewId).src = '';
                    document.getElementById(previewContainerId).classList.add('hidden');
                    showMessage('背景圖片已清除！', 'info');
                } else {
                    studentUploadedImageDataURL = null;
                    studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);
                    showMessage('圖片已清除！', 'info');
                    drawCombinedCanvas();
                }
            });
        };

        // NEW: Separate function for teacher image handling to pass specific DOM IDs
        function handleImageFileForTeacher(file, statusId, previewContainerId, previewId) {
            if (!file || !file.type.startsWith('image/')) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    let { width, height } = img;

                    // Resize image if it's too large
                    if (width > MAX_IMAGE_DIMENSION || height > MAX_IMAGE_DIMENSION) {
                        if (width > height) {
                            height *= MAX_IMAGE_DIMENSION / width;
                            width = MAX_IMAGE_DIMENSION;
                        } else {
                            width *= MAX_IMAGE_DIMENSION / height;
                            height = MAX_IMAGE_DIMENSION;
                        }
                    }
                    tempCanvas.width = width;
                    tempCanvas.height = height;
                    tempCtx.drawImage(img, 0, 0, width, height);
                    const dataUrl = tempCanvas.toDataURL('image/jpeg', JPEG_QUALITY);

                    teacherUploadedBackgroundImageDataURL = dataUrl;
                    document.getElementById(statusId).textContent = '已上傳背景圖片。可選擇檔案或直接貼上(Ctrl+V)。';
                    document.getElementById(previewId).src = dataUrl;
                    document.getElementById(previewContainerId).classList.remove('hidden');
                    showMessage('背景圖片已上傳！', 'success');
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }


        function setupEventListeners() {
            // Firebase settings modal
            document.getElementById('firebase-settings-btn').addEventListener('click', () => {
                const modal = document.getElementById('firebase-settings-modal');
                modal.classList.remove('hidden');

                // Load existing config if available
                const savedConfig = localStorage.getItem('firebaseConfig') || localStorage.getItem('firebaseConfigDraft') || '';
                document.getElementById('firebase-config-textarea').value = savedConfig;

                // Enable generate URL button if config is already applied
                if (isFirebaseConfigApplied && savedConfig) {
                    document.getElementById('generate-firebase-url-btn').disabled = false;
                } else {
                    document.getElementById('generate-firebase-url-btn').disabled = true;
                }

                // Hide QR code container and URL info when opening modal
                document.getElementById('firebase-qrcode-container').classList.add('hidden');
                document.getElementById('firebase-qrcode').innerHTML = '';
                document.getElementById('firebase-url-info').classList.add('hidden');
            });

            document.getElementById('firebase-settings-modal-close-btn').addEventListener('click', () => {
                document.getElementById('firebase-settings-modal').classList.add('hidden');
            });

            document.getElementById('apply-firebase-settings-btn').addEventListener('click', handleApplyFirebaseSettings);
            document.getElementById('generate-firebase-url-btn').addEventListener('click', handleGenerateFirebaseUrl);
            document.getElementById('download-qrcode-btn').addEventListener('click', downloadFirebaseQRCode);
            document.getElementById('clear-firebase-config-btn').addEventListener('click', handleClearFirebaseConfig);

            // Copy URL buttons
            document.getElementById('copy-short-url-btn').addEventListener('click', () => {
                const shortUrl = document.getElementById('firebase-short-url-display').value;
                navigator.clipboard.writeText(shortUrl).then(() => {
                    showFirebaseCopyMessage("短網址已複製！", false);
                }).catch(() => {
                    // Fallback for older browsers
                    const input = document.getElementById('firebase-short-url-display');
                    input.select();
                    document.execCommand('copy');
                    showFirebaseCopyMessage("短網址已複製！", false);
                });
            });

            document.getElementById('copy-original-url-btn').addEventListener('click', () => {
                const originalUrl = document.getElementById('firebase-original-url-display').value;
                navigator.clipboard.writeText(originalUrl).then(() => {
                    showFirebaseCopyMessage("原始網址已複製！", false);
                }).catch(() => {
                    // Fallback for older browsers
                    const input = document.getElementById('firebase-original-url-display');
                    input.select();
                    document.execCommand('copy');
                    showFirebaseCopyMessage("原始網址已複製！", false);
                });
            });

            // Entry screen.
            document.getElementById('teacher-entry-btn').addEventListener('click', () => {
                // Check if passwd=no parameter is present in URL
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('passwd') === 'no') {
                    loadRecentClassrooms(); // Load recent classrooms for teacher
                    showView('teacherClassroomCode');
                } else {
                    document.getElementById('teacher-password-modal').classList.remove('hidden');
                }
            });
            document.getElementById('student-entry-btn').addEventListener('click', () => {
                currentRole = 'student';
                showView('studentName');
            });

            // NEW: Teacher classroom code input.
            document.getElementById('teacher-classroom-code-back-btn').addEventListener('click', () => showView('entry'));
            document.getElementById('teacher-classroom-code-submit-btn').addEventListener('click', async () => {
                const code = document.getElementById('teacher-classroom-code-input').value.trim();
                if (code) {
                    classroomCode = code;
                    currentRole = 'teacher';
                    document.getElementById('end-class-button-text').textContent = `下課 教室代碼: ${classroomCode}`; // Update button text
                    document.getElementById('end-class-monitor-button-text').textContent = `下課 教室代碼: ${classroomCode}`; // Update button text for monitor view
                    localStorage.setItem('teacherClassroomCode', classroomCode); // Persist teacher's classroom code

                    // Save classroom code to recent classrooms
                    saveRecentClassroom(classroomCode);

                    // Set initial classroom state in Firestore, including isPaused: false
                    const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                    await setDoc(controlRef, { active_mode: 'waiting', teacherId: userId, backgroundImage: null, isPaused: false, multiple_choice_questions: null }, { merge: true });
                    isResponsePaused = false; // Initialize local state
                    updateTeacherPauseButtonUI(); // Update button UI
                    currentMultipleChoiceQuestions = null; // Ensure this is cleared on new class

                    // Load question banks for this classroom
                    loadQuestionBanksFromStorage();
                    loadSequencingBanksFromStorage();
                    loadMatchingBanksFromStorage();
                    loadReadingBanksFromStorage();

                    listenToClassroomPresence(); // Ensure presence listener is active
                    showView('teacherMenu');
                    document.getElementById('teacher-classroom-code-input').value = ''; // Clear input
                } else {
                     showMessage('請輸入教室代碼！', 'error');
                }
            });
            document.getElementById('teacher-classroom-code-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') document.getElementById('teacher-classroom-code-submit-btn').click();
            });

            // Recent classrooms select change event (Teacher)
            document.getElementById('teacher-recent-classrooms-select').addEventListener('change', (e) => {
                const selectedCode = e.target.value;
                if (selectedCode) {
                    document.getElementById('teacher-classroom-code-input').value = selectedCode;
                }
            });

            // Student name and classroom code submission.
            document.getElementById('submit-name-btn').addEventListener('click', async () => {
                const studentClassroomCode = document.getElementById('student-classroom-code-input').value.trim();
                const name = document.getElementById('student-name-input').value.trim();

                if (!studentClassroomCode) {
                    showMessage('請務必輸入教室代碼！', 'error');
                    return;
                }
                if (!name) {
                    showMessage('請務必輸入姓名！', 'error');
                    return;
                }

                classroomCode = studentClassroomCode; // Set global classroom code for student
                
                // Check if the classroom exists and is active
                const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                try {
                    const docSnap = await getDoc(controlRef);
                    if (docSnap.exists() && docSnap.data().teacherId) { // Check if control document exists and has a teacher ID
                        studentName = name;
                        document.getElementById('user-id-display').textContent = `${userId} (${studentName})`;
                        document.getElementById('student-welcome-msg').textContent = `你好，${studentName}！`;

                        listenToInteractionMode();
                        listenToPeerReviewStatus(); // NEW: Listen for peer review status
                        showView('studentWaiting');
                        // Set student presence using the specific classroomCode
                        const presenceRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'presence', userId);
                        await setDoc(presenceRef, { name: studentName, timestamp: new Date() }, { merge: true });
                    } else {
                        showMessage('教室代碼不存在或老師尚未開啟教室！', 'error');
                    }
                } catch (error) {
                    console.error("檢查教室代碼失敗:", error);
                    showMessage("進入教室失敗，請檢查網路連線或教室代碼。", "error");
                }
            });

            // Teacher mode selection.
            // MODIFIED: B button now opens a menu with Choice/Sequencing/Matching options
            document.getElementById('choice-sequencing-matching-menu-btn').addEventListener('click', () => {
                document.getElementById('choice-sequencing-matching-menu-modal').classList.remove('hidden');
            });

            // Close B menu modal
            document.getElementById('choice-sequencing-matching-menu-close-btn').addEventListener('click', () => {
                document.getElementById('choice-sequencing-matching-menu-modal').classList.add('hidden');
            });

            // Open Multiple Choice Settings from B menu
            document.getElementById('open-multiple-choice-settings-btn').addEventListener('click', () => {
                document.getElementById('choice-sequencing-matching-menu-modal').classList.add('hidden');

                // Update question bank list for current classroom
                updateQuestionBankList();

                // Initialize modal state based on current customMultipleChoiceQuestions
                const mcQuestionTypeNone = document.querySelector('input[name="mcQuestionType"][value="none"]');
                const mcQuestionTypeCustom = document.querySelector('input[name="mcQuestionType"][value="custom"]');
                const customMcQuestionsSection = document.getElementById('custom-mc-questions-section');
                const customMcQuestionsTextarea = document.getElementById('custom-mc-questions-textarea');
                const customMcQuestionsStatus = document.getElementById('custom-mc-questions-status');

                if (customMultipleChoiceQuestions && customMultipleChoiceQuestions.length > 0) {
                    mcQuestionTypeCustom.checked = true;
                    customMcQuestionsSection.classList.remove('hidden');
                    document.getElementById('question-bank-management-section').classList.remove('hidden');
                    customMcQuestionsTextarea.value = customMultipleChoiceQuestions.map(q => {
                        return `${q.question},${q.correctAnswer},${q.options.join(',')}`;
                    }).join('\n');
                } else {
                    mcQuestionTypeNone.checked = true;
                    customMcQuestionsSection.classList.add('hidden');
                    document.getElementById('question-bank-management-section').classList.add('hidden');
                    customMcQuestionsTextarea.value = '';
                }
                customMcQuestionsStatus.classList.add('hidden');
                document.getElementById('multiple-choice-settings-modal').classList.remove('hidden');
            });

            // Open Sequencing Settings from B menu
            document.getElementById('open-sequencing-settings-btn').addEventListener('click', () => {
                document.getElementById('choice-sequencing-matching-menu-modal').classList.add('hidden');

                // Update sequencing bank list for current classroom
                updateSequencingBankList();

                document.getElementById('sequencing-settings-modal').classList.remove('hidden');
            });

            // Open Matching Settings from B menu
            document.getElementById('open-matching-settings-btn').addEventListener('click', () => {
                document.getElementById('choice-sequencing-matching-menu-modal').classList.add('hidden');

                // Update matching bank list for current classroom
                updateMatchingBankList();

                document.getElementById('matching-settings-modal').classList.remove('hidden');
            });

            // Sequencing/Matching Menu Button - Keep for compatibility if needed elsewhere
            // Sequencing Settings Button (from menu)
            document.getElementById('sequencing-settings-btn')?.addEventListener('click', () => {
                document.getElementById('sequencing-matching-menu-modal').classList.add('hidden');
                document.getElementById('sequencing-settings-modal').classList.remove('hidden');
            });

            // Matching Settings Button (from menu)
            document.getElementById('matching-settings-btn')?.addEventListener('click', () => {
                document.getElementById('sequencing-matching-menu-modal').classList.add('hidden');
                document.getElementById('matching-settings-modal').classList.remove('hidden');
            });

            // 題型切換按鈕
            document.getElementById('switch-to-matching-btn').addEventListener('click', () => {
                document.getElementById('sequencing-settings-modal').classList.add('hidden');
                document.getElementById('matching-settings-modal').classList.remove('hidden');
            });

            document.getElementById('switch-to-sequencing-btn').addEventListener('click', () => {
                document.getElementById('matching-settings-modal').classList.add('hidden');
                document.getElementById('sequencing-settings-modal').classList.remove('hidden');
            });

            // REMOVED: Old multiple-choice-settings-btn listener (now handled by open-multiple-choice-settings-btn from B menu)

            // Other teacher mode selection buttons (unchanged, directly set mode)
            document.querySelectorAll('#teacher-menu-view button[data-mode]').forEach(button => {
                button.addEventListener('click', async () => {
                    const mode = button.dataset.mode;
                    // MODIFIED: Check dispatch settings for url_dispatch
                    if (mode === 'url_dispatch') {
                        if (dispatchSettings.type === 'url' && !dispatchSettings.url) {
                            showMessage('請先設定要派送的網址！', 'error');
                            showUrlDispatchSettingsModal();
                            return;
                        } else if (dispatchSettings.type === 'html' && !dispatchSettings.htmlContent) {
                            showMessage('請先上傳要派送的 HTML 檔案！', 'error');
                            showUrlDispatchSettingsModal();
                            return;
                        }
                    }
                    showView('teacherMonitor');
                    await setInteractionMode(mode); // Set mode and handle student responses listener
                });
            });

            // End interaction button.
            document.getElementById('end-interaction-btn').addEventListener('click', async () => {
                // NEW: Clear peer review data when ending interaction (not just stopping)
                try {
                    // Clear peer review settings
                    const peerReviewRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'peerReview');
                    await setDoc(peerReviewRef, { active: false });
                    
                    // Clear all votes - THIS IS THE KEY DIFFERENCE FROM STOPPING
                    const votesRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'peerReviewVotes');
                    const votesSnapshot = await getDocs(votesRef);
                    const deletePromises = votesSnapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deletePromises);
                    
                    peerReviewActive = false;
                    document.getElementById('peer-review-stats-container').classList.add('hidden');
                    
                    // Reset peer review button text
                    const startPeerReviewBtn = document.getElementById('start-peer-review-btn');
                    startPeerReviewBtn.innerHTML = '<i class="fas fa-heart mr-2"></i> 開始互評 ❤️';
                    
                    // Clear student voted works
                    allPeerReviewVotes = {};
                    studentVotedWorks.clear();
                    
                    // Clear saved canvas state
                    savedCanvasState = null;
                    
                    if (peerReviewUnsubscribe) {
                        peerReviewUnsubscribe();
                        peerReviewUnsubscribe = null;
                    }
                } catch (error) {
                    console.error('Error clearing peer review data:', error);
                }
                
                await setInteractionMode('waiting');
                lastSelectedStudentCard = null;

                // Disable pull-to-refresh prevention when ending interaction
                disablePullToRefreshPrevention();

                // Clear sequencing and matching input fields
                document.getElementById('sequencing-items-textarea').value = '';
                document.getElementById('matching-pairs-textarea').value = '';

                showView('teacherMenu');
                manualRefreshCounts(); // This will refresh the count display, but the listener is already active.
                // Clear URL/HTML settings and teacher background image when ending interaction
                clearDispatchSettings(); // Use the combined clear function
                teacherUploadedBackgroundImageDataURL = null;
                document.getElementById('teacher-image-status').textContent = '目前沒有背景圖片。可選擇檔案或直接貼上(Ctrl+V)。';
                document.getElementById('teacher-image-preview').src = '';
                document.getElementById('teacher-image-preview-container').classList.add('hidden');
                isResponsePaused = false; // NEW: Reset pause state
                updateTeacherPauseButtonUI(); // NEW: Update pause button UI
                customMultipleChoiceQuestions = []; // NEW: Clear custom MC questions on end interaction
            });
            
            // Student answer buttons for default multiple choice.
            document.querySelectorAll('#interaction-true-false .answer-btn, #default-mc-options .answer-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    // NEW: Check pause state before submitting
                    if (isResponsePaused) {
                        showMessage('老師已暫停回覆，無法送出答案。', 'error');
                        return;
                    }
                    const answer = e.currentTarget.dataset.answer;
                    await submitAnswer(answer);
                    e.currentTarget.closest('div').querySelectorAll('.answer-btn').forEach(b => {
                        b.disabled = true;
                        b.classList.add('btn-gray');
                    });
                    e.currentTarget.disabled = false;
                    e.currentTarget.classList.remove('btn-gray');
                });
            });

            // Text input submission.
            document.getElementById('submit-text-btn').addEventListener('click', async (e) => {
                // NEW: Check pause state before submitting
                if (isResponsePaused) {
                    showMessage('老師已暫停回覆，無法送出答案。', 'error');
                    return;
                }
                const text = document.getElementById('text-input-area').value;
                await submitAnswer(text);
                e.currentTarget.disabled = true;
                e.currentTarget.classList.replace('btn-primary', 'btn-gray');
            });

            // Word cloud input character count
            document.getElementById('word-cloud-input').addEventListener('input', (e) => {
                const charCount = e.target.value.length;
                document.getElementById('word-cloud-char-count').textContent = charCount;
            });

            // Word cloud submission
            document.getElementById('submit-word-cloud-btn').addEventListener('click', async (e) => {
                if (isResponsePaused) {
                    showMessage('老師已暫停回覆，無法送出答案。', 'error');
                    return;
                }
                const text = document.getElementById('word-cloud-input').value.trim();
                if (!text) {
                    showMessage('請輸入關鍵字', 'error');
                    return;
                }
                // Save button reference before async call
                const btn = e.currentTarget;
                await submitAnswer(text);
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                document.getElementById('word-cloud-input').value = '';
                document.getElementById('word-cloud-char-count').textContent = '0';
            });

            // === Sticky Note Event Listeners ===
            let stickyNoteImageData = null;

            // Tab switching
            document.getElementById('sticky-text-tab').addEventListener('click', () => {
                document.getElementById('sticky-text-tab').classList.add('bg-amber-500', 'text-white');
                document.getElementById('sticky-text-tab').classList.remove('bg-slate-200', 'text-slate-600');
                document.getElementById('sticky-image-tab').classList.remove('bg-amber-500', 'text-white');
                document.getElementById('sticky-image-tab').classList.add('bg-slate-200', 'text-slate-600');
                document.getElementById('sticky-text-section').classList.remove('hidden');
                document.getElementById('sticky-image-section').classList.add('hidden');
            });

            document.getElementById('sticky-image-tab').addEventListener('click', () => {
                document.getElementById('sticky-image-tab').classList.add('bg-amber-500', 'text-white');
                document.getElementById('sticky-image-tab').classList.remove('bg-slate-200', 'text-slate-600');
                document.getElementById('sticky-text-tab').classList.remove('bg-amber-500', 'text-white');
                document.getElementById('sticky-text-tab').classList.add('bg-slate-200', 'text-slate-600');
                document.getElementById('sticky-image-section').classList.remove('hidden');
                document.getElementById('sticky-text-section').classList.add('hidden');
            });

            // Text character count
            document.getElementById('sticky-note-text').addEventListener('input', (e) => {
                const charCount = e.target.value.length;
                document.getElementById('sticky-text-char-count').textContent = charCount;
            });

            // Image compression function
            function compressImage(file, maxWidth = 800, quality = 0.8) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;

                            // Calculate new dimensions
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }

                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);

                            // Convert to JPEG with compression
                            const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                            resolve(compressedDataUrl);
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            // Handle image selection
            document.getElementById('sticky-select-image-btn').addEventListener('click', () => {
                document.getElementById('sticky-image-input').click();
            });

            document.getElementById('sticky-capture-image-btn').addEventListener('click', () => {
                const input = document.getElementById('sticky-image-input');
                input.setAttribute('capture', 'environment');
                input.click();
            });

            document.getElementById('sticky-image-input').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressed = await compressImage(file);
                        stickyNoteImageData = compressed;
                        document.getElementById('sticky-preview-img').src = compressed;
                        document.getElementById('sticky-image-preview').classList.remove('hidden');
                    } catch (error) {
                        console.error('圖片處理失敗:', error);
                        showMessage('圖片處理失敗，請重試', 'error');
                    }
                }
            });

            // Sticky note submission
            document.getElementById('submit-sticky-note-btn').addEventListener('click', async (e) => {
                if (isResponsePaused) {
                    showMessage('老師已暫停回覆，無法送出答案。', 'error');
                    return;
                }

                const textTab = document.getElementById('sticky-text-tab');
                const isTextMode = textTab.classList.contains('bg-amber-500');

                let answerData = {};

                if (isTextMode) {
                    const text = document.getElementById('sticky-note-text').value.trim();
                    if (!text) {
                        showMessage('請輸入文字內容', 'error');
                        return;
                    }
                    answerData = { type: 'text', content: text };
                } else {
                    if (!stickyNoteImageData) {
                        showMessage('請選擇或拍攝圖片', 'error');
                        return;
                    }
                    answerData = { type: 'image', content: stickyNoteImageData };
                }

                const btn = e.currentTarget;
                await submitAnswer(JSON.stringify(answerData));
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');

                // Clear inputs
                document.getElementById('sticky-note-text').value = '';
                document.getElementById('sticky-text-char-count').textContent = '0';
                stickyNoteImageData = null;
                document.getElementById('sticky-image-preview').classList.add('hidden');
                document.getElementById('sticky-image-input').value = '';
            });

            // === Sticky Note Zoom Controls ===
            function applyStickyNoteScale() {
                stickyNotes.forEach(note => {
                    note.style.transform = `scale(${stickyNoteScale})`;
                });
                updateZoomDisplay();
            }

            document.getElementById('sticky-zoom-in').addEventListener('click', () => {
                stickyNoteScale = Math.min(stickyNoteScale + 0.1, 2.0);
                applyStickyNoteScale();
            });

            document.getElementById('sticky-zoom-out').addEventListener('click', () => {
                stickyNoteScale = Math.max(stickyNoteScale - 0.1, 0.3);
                applyStickyNoteScale();
            });

            document.getElementById('sticky-zoom-reset').addEventListener('click', () => {
                stickyNoteScale = 1.0;
                applyStickyNoteScale();
            });

            // === Sticky Note Wall Drawing Canvas ===
            // Sticky Note Wall Drawing Functions - Wrapped in IIFE to avoid global scope pollution
            (function() {
                const stickyCanvas = document.getElementById('sticky-drawing-canvas');
                const stickyCtx = stickyCanvas.getContext('2d');
                let stickyIsDrawing = false;
                let currentTool = 'pen';
                let penColor = '#000000';
                let penWidth = 4;
                let stickyLastX = 0;
                let stickyLastY = 0;
                let currentMode = 'mouse'; // 'mouse' or 'draw'

                // Initialize canvas size
                function initStickyCanvas() {
                    const container = document.getElementById('sticky-notes-container');
                    if (!container) return;

                    const rect = container.getBoundingClientRect();
                    if (rect.width > 0 && rect.height > 0) {
                        stickyCanvas.width = rect.width;
                        stickyCanvas.height = rect.height;
                        stickyCtx.lineCap = 'round';
                        stickyCtx.lineJoin = 'round';
                        console.log('Canvas initialized:', rect.width, 'x', rect.height);
                    } else {
                        console.warn('Container has no size, cannot initialize canvas');
                    }
                }

                // Update canvas size on window resize
                window.addEventListener('resize', () => {
                    const container = document.getElementById('sticky-notes-container');
                    if (container && stickyCanvas && stickyCanvas.width > 0 && stickyCanvas.height > 0) {
                        const rect = container.getBoundingClientRect();
                        if (rect.width > 0 && rect.height > 0) {
                            // Save current canvas content
                            const tempCanvas = document.createElement('canvas');
                            const tempCtx = tempCanvas.getContext('2d');
                            tempCanvas.width = stickyCanvas.width;
                            tempCanvas.height = stickyCanvas.height;
                            tempCtx.drawImage(stickyCanvas, 0, 0);

                            // Resize and restore
                            stickyCanvas.width = rect.width;
                            stickyCanvas.height = rect.height;
                            stickyCtx.lineCap = 'round';
                            stickyCtx.lineJoin = 'round';
                            stickyCtx.drawImage(tempCanvas, 0, 0);
                        }
                    }
                });

                // Mode switching
                function setMouseMode() {
                    currentMode = 'mouse';
                    stickyCanvas.style.pointerEvents = 'none';
                    document.getElementById('mouse-mode').classList.add('bg-blue-500', 'text-white');
                    document.getElementById('mouse-mode').classList.remove('bg-slate-200', 'text-slate-700');
                    document.getElementById('draw-mode').classList.remove('bg-blue-500', 'text-white');
                    document.getElementById('draw-mode').classList.add('bg-slate-200', 'text-slate-700');
                    document.getElementById('drawing-tools').classList.add('opacity-50');
                    document.getElementById('drawing-tools').style.pointerEvents = 'none';
                }

                function setDrawMode() {
                    currentMode = 'draw';
                    stickyCanvas.style.pointerEvents = 'auto';
                    document.getElementById('draw-mode').classList.add('bg-blue-500', 'text-white');
                    document.getElementById('draw-mode').classList.remove('bg-slate-200', 'text-slate-700');
                    document.getElementById('mouse-mode').classList.remove('bg-blue-500', 'text-white');
                    document.getElementById('mouse-mode').classList.add('bg-slate-200', 'text-slate-700');
                    document.getElementById('drawing-tools').classList.remove('opacity-50');
                    document.getElementById('drawing-tools').style.pointerEvents = 'auto';
                }

                document.getElementById('mouse-mode').addEventListener('click', setMouseMode);
                document.getElementById('draw-mode').addEventListener('click', setDrawMode);

                // Drawing functions with corrected coordinates
                function stickyStartDrawing(e) {
                    if (currentMode !== 'draw') return;
                    stickyIsDrawing = true;
                    const rect = stickyCanvas.getBoundingClientRect();
                    stickyLastX = e.clientX - rect.left;
                    stickyLastY = e.clientY - rect.top;
                }

                function stickyDraw(e) {
                    if (!stickyIsDrawing || currentMode !== 'draw') return;
                    const rect = stickyCanvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    stickyCtx.beginPath();
                    stickyCtx.moveTo(stickyLastX, stickyLastY);
                    stickyCtx.lineTo(x, y);

                    if (currentTool === 'pen') {
                        stickyCtx.strokeStyle = penColor;
                        stickyCtx.lineWidth = penWidth;
                        stickyCtx.globalCompositeOperation = 'source-over';
                    } else if (currentTool === 'eraser') {
                        stickyCtx.globalCompositeOperation = 'destination-out';
                        stickyCtx.lineWidth = 20;
                    }

                    stickyCtx.stroke();
                    stickyLastX = x;
                    stickyLastY = y;
                }

                function stickyStopDrawing() {
                    stickyIsDrawing = false;
                }

                // Canvas event listeners
                stickyCanvas.addEventListener('mousedown', stickyStartDrawing);
                stickyCanvas.addEventListener('mousemove', stickyDraw);
                stickyCanvas.addEventListener('mouseup', stickyStopDrawing);
                stickyCanvas.addEventListener('mouseout', stickyStopDrawing);

                // Tool selection
                document.getElementById('pen-tool').addEventListener('click', () => {
                    currentTool = 'pen';
                    setDrawMode(); // Auto switch to draw mode
                    document.getElementById('pen-tool').classList.add('bg-blue-500', 'text-white');
                    document.getElementById('pen-tool').classList.remove('bg-slate-200', 'text-slate-700');
                    document.getElementById('eraser-tool').classList.remove('bg-blue-500', 'text-white');
                    document.getElementById('eraser-tool').classList.add('bg-slate-200', 'text-slate-700');
                });

                document.getElementById('eraser-tool').addEventListener('click', () => {
                    currentTool = 'eraser';
                    setDrawMode(); // Auto switch to draw mode
                    document.getElementById('eraser-tool').classList.add('bg-blue-500', 'text-white');
                    document.getElementById('eraser-tool').classList.remove('bg-slate-200', 'text-slate-700');
                    document.getElementById('pen-tool').classList.remove('bg-blue-500', 'text-white');
                    document.getElementById('pen-tool').classList.add('bg-slate-200', 'text-slate-700');
                });

                // Color selection
                document.querySelectorAll('.pen-color').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        penColor = e.currentTarget.dataset.color;
                        document.querySelectorAll('.pen-color').forEach(b => {
                            b.classList.remove('border-2', 'border-slate-400');
                            b.classList.add('border', 'border-slate-300');
                        });
                        e.currentTarget.classList.add('border-2', 'border-slate-400');
                        e.currentTarget.classList.remove('border', 'border-slate-300');
                        currentTool = 'pen';
                        setDrawMode(); // Auto switch to draw mode
                        // Update pen tool button
                        document.getElementById('pen-tool').classList.add('bg-blue-500', 'text-white');
                        document.getElementById('pen-tool').classList.remove('bg-slate-200', 'text-slate-700');
                        document.getElementById('eraser-tool').classList.remove('bg-blue-500', 'text-white');
                        document.getElementById('eraser-tool').classList.add('bg-slate-200', 'text-slate-700');
                    });
                });

                // Width selection
                document.getElementById('pen-width').addEventListener('change', (e) => {
                    penWidth = parseInt(e.target.value);
                });

                // Clear canvas
                document.getElementById('clear-canvas').addEventListener('click', () => {
                    if (confirm('確定要清除所有畫記嗎？')) {
                        const canvas = document.getElementById('sticky-drawing-canvas');
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                    }
                });

                // Listen for canvas initialization event
                window.addEventListener('initStickyCanvas', () => {
                    initStickyCanvas();
                    setMouseMode();
                });
            })(); // End of Sticky Note Wall Drawing IIFE

            // Drawing submission.
            document.getElementById('submit-drawing-btn').addEventListener('click', async (e) => {
                // NEW: Check pause state before submitting
                if (isResponsePaused) {
                    showMessage('老師已暫停回覆，無法送出答案。', 'error');
                    return;
                }
                const dataUrl = canvas.toDataURL('image/jpeg', JPEG_QUALITY);
                await submitAnswer(dataUrl);
                e.currentTarget.disabled = true;
                e.currentTarget.classList.replace('btn-primary', 'btn-gray');
            });

            // Sequencing submission.
            document.getElementById('submit-sequencing-btn').addEventListener('click', async (e) => {
                if (isResponsePaused) {
                    showMessage('老師已暫停回覆，無法送出答案。', 'error');
                    return;
                }
                const container = document.getElementById('sequencing-items-container');
                const items = Array.from(container.children).map(item => item.dataset.text);
                await submitAnswer(JSON.stringify(items));
                e.currentTarget.disabled = true;
                e.currentTarget.classList.replace('btn-primary', 'btn-gray');
                showMessage('答案已送出！', 'success');
            });

            // Matching submission.
            document.getElementById('submit-matching-btn').addEventListener('click', async (e) => {
                if (isResponsePaused) {
                    showMessage('老師已暫停回覆，無法送出答案。', 'error');
                    return;
                }
                const matches = [];
                document.querySelectorAll('.matching-item.matched').forEach(item => {
                    if (item.dataset.side === 'left' && item.dataset.matchedWith) {
                        matches.push({
                            left: item.dataset.text,
                            right: item.dataset.matchedWith
                        });
                    }
                });

                if (matches.length === 0) {
                    showMessage('請至少完成一個配對！', 'error');
                    return;
                }

                await submitAnswer(JSON.stringify(matches));
                e.currentTarget.disabled = true;
                e.currentTarget.classList.replace('btn-primary', 'btn-gray');
                showMessage('答案已送出！', 'success');
            });

            // Drawing board events.
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseleave', stopDrawing);
            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);
            window.addEventListener('resize', () => {
                if (!views.studentInteraction.classList.contains('hidden') && !interactionUIs.drawing.classList.contains('hidden')) {
                    setupCanvas();
                    loadBackgroundImage();
                    loadStudentImage();
                }
            });

            // Drawing tool controls.
            const colorSelect = document.getElementById('color-select');
            const sizeSelect = document.getElementById('size-select');
            const penToolBtn = document.getElementById('pen-tool-btn');
            const eraserBtn = document.getElementById('eraser-btn');
            colorSelect.addEventListener('change', (e) => {
                drawingCtx.strokeStyle = e.target.value; 
                drawingCtx.globalCompositeOperation = 'source-over'; 
                updateColorSwatch(e.target.value); 
                penToolBtn.classList.add('border-blue-500'); 
                eraserBtn.classList.remove('border-blue-500');
            });
            sizeSelect.addEventListener('change', (e) => { drawingCtx.lineWidth = parseInt(e.target.value); });
            penToolBtn.addEventListener('click', () => {
                drawingCtx.globalCompositeOperation = 'source-over'; 
                drawingCtx.strokeStyle = colorSelect.value; 
                drawingCtx.lineWidth = parseInt(sizeSelect.value); 
                penToolBtn.classList.add('border-blue-500'); 
                eraserBtn.classList.remove('border-blue-500'); 
            });
            eraserBtn.addEventListener('click', () => {
                drawingCtx.globalCompositeOperation = 'destination-out';
                drawingCtx.lineWidth = 15;
                penToolBtn.classList.remove('border-blue-500'); 
                eraserBtn.classList.add('border-blue-500'); 
            });
            document.getElementById('clear-canvas-btn').addEventListener('click', clearDrawingCanvas);
            
            // Image upload handlers (teacher and student).
            setupImageUpload('teacher-image-upload-input', 'teacher-image-status', 'teacher-image-preview-container', 'teacher-image-preview', 'clear-teacher-background-btn', true);
            setupImageUpload('student-image-upload-input', null, null, null, 'clear-student-image-btn', false);

            // NEW: Paste event listener for teacher background image
            document.addEventListener('paste', e => {
                // Only allow pasting when the teacher menu is visible
                if (views.teacherMenu.classList.contains('hidden')) {
                    return;
                }
                
                // Don't interfere if the user is typing in an input field
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                const items = (e.clipboardData || window.clipboardData).items;
                for (const item of items) {
                    if (item.kind === 'file' && item.type.startsWith('image/')) {
                        const file = item.getAsFile();
                        if (file) {
                            // Call the specific teacher image handler
                            handleImageFileForTeacher(file, 'teacher-image-status', 'teacher-image-preview-container', 'teacher-image-preview');
                            e.preventDefault(); // Prevent the image from being pasted as a file object
                            return; // Exit after handling the first image
                        }
                    }
                }
            });

            // Modal close buttons.
            document.getElementById('student-status-area').addEventListener('click', showStudentListModal);
            studentListModalCloseBtn.addEventListener('click', hideStudentListModal);
            document.getElementById('show-statistics-btn').addEventListener('click', showStatisticsModal);
            
            // NEW: View Questions Button
            document.getElementById('view-questions-btn').addEventListener('click', showViewQuestionsModal);
            document.getElementById('view-questions-modal-close-btn').addEventListener('click', hideViewQuestionsModal);
            document.getElementById('cancel-questions-view-btn').addEventListener('click', hideViewQuestionsModal);
            document.getElementById('save-correct-answers-btn').addEventListener('click', saveCorrectAnswers);
            
            // NEW: Download Responses Button
            document.getElementById('download-responses-btn').addEventListener('click', downloadStudentResponses);
            
            // NEW: Start Peer Review Button
            document.getElementById('start-peer-review-btn').addEventListener('click', startPeerReview);
            
            // NEW: Exit Peer Review Button (Student)
            document.getElementById('exit-peer-review-btn').addEventListener('click', exitPeerReview);
            chartModalCloseBtn.addEventListener('click', hideStatisticsModal);
            magnifiedImageModalCloseBtn.addEventListener('click', hideMagnifiedDrawing);
            magnifiedImageModal.addEventListener('click', (e) => { if (e.target === magnifiedImageModal) hideMagnifiedDrawing(); });
            document.getElementById('close-message-btn').addEventListener('click', hideMessage);

            // NEW: Unsubmitted Students Modal Listeners
            document.getElementById('show-unsubmitted-students-btn').addEventListener('click', showUnsubmittedStudentsModal);
            unsubmittedStudentsModalCloseBtn.addEventListener('click', hideUnsubmittedStudentsModal);
            unsubmittedStudentsModal.addEventListener('click', (e) => { if (e.target === unsubmittedStudentsModal) hideUnsubmittedStudentsModal(); });


            // Teacher utility buttons.
            document.getElementById('refresh-student-count-btn').addEventListener('click', manualRefreshCounts);
            // Original lottery button in monitor view (now replaced by modal one)
            document.getElementById('draw-lottery-btn').addEventListener('click', () => {
                if (allStudentResponses.length === 0) return showMessage('目前沒有學生提交答案可供抽籤。', 'info');
                if (lastSelectedStudentCard) lastSelectedStudentCard.classList.remove('selected-student-border');
                const randomIndex = Math.floor(Math.random() * allStudentResponses.length);
                const selectedStudentName = allStudentResponses[randomIndex].name;
                const studentCards = document.querySelectorAll('#student-responses-container .student-response-item');
                const foundCard = Array.from(studentCards).find(card => card.querySelector('.name-box').textContent === selectedStudentName);
                if (foundCard) {
                    foundCard.classList.add('selected-student-border');
                    lastSelectedStudentCard = foundCard;
                    showMessage(`恭喜！抽中學生：${selectedStudentName}`, 'success');
                }
            });
            // NEW: Lottery button inside the student list modal
            document.getElementById('modal-draw-lottery-btn').addEventListener('click', () => {
                if (activeStudentNames.length === 0) {
                    return showMessage('目前沒有學生在線可供抽籤。', 'info');
                }

                // Remove highlight from previously selected student in the modal
                if (lastSelectedModalStudent) {
                    lastSelectedModalStudent.classList.remove('modal-selected-student-border');
                }

                // Randomly select a student from all active online students
                const randomIndex = Math.floor(Math.random() * activeStudentNames.length);
                const selectedStudentName = activeStudentNames[randomIndex];

                // Find the corresponding <p> element in the modal
                const studentNameElements = document.querySelectorAll('#modal-student-names p');
                const foundElement = Array.from(studentNameElements).find(p => p.textContent === selectedStudentName);

                if (foundElement) {
                    foundElement.classList.add('modal-selected-student-border');
                    lastSelectedModalStudent = foundElement; // Store the currently selected element
                    showMessage(`恭喜！抽中學生：${selectedStudentName}`, 'success');
                } else {
                    // This case should ideally not happen if activeStudentNames is correctly populated
                    // and the modal list is correctly rendered.
                    showMessage(`抽中學生：${selectedStudentName} (未在列表中找到)`, 'info');
                }
            });


            document.getElementById('download-media-btn').addEventListener('click', async (e) => { // Changed ID
                const btn = e.currentTarget;
                if (btn.disabled) return;
                
                let mediaResponses = [];
                let filenamePrefix = '';
                let fileExtension = '';

                if (currentInteractionMode === 'drawing') {
                    mediaResponses = allStudentResponses.filter(r => r.answer && r.answer.startsWith('data:image'));
                    filenamePrefix = '學生繪圖答案';
                    fileExtension = 'jpg';
                } else if (currentInteractionMode === 'recording') {
                    mediaResponses = allStudentResponses.filter(r => r.answer && r.answer.startsWith('data:audio'));
                    filenamePrefix = '學生錄音答案';
                    // Determine file extension based on the actual mimeType used for recording
                    const firstAudioResponse = mediaResponses.find(r => r.answer);
                    if (firstAudioResponse) {
                        const mime = firstAudioResponse.answer.split(',')[0].match(/:(.*?);/)?.[1];
                        if (mime) {
                            if (mime.includes('webm')) fileExtension = 'webm';
                            else if (mime.includes('mp4')) fileExtension = 'mp4';
                            else if (mime.includes('ogg')) fileExtension = 'ogg';
                            else if (mime.includes('wav')) fileExtension = 'wav';
                            else fileExtension = 'bin'; // Fallback for unknown
                        } else {
                            fileExtension = 'bin'; // Fallback if mime type not found in data URL
                        }
                    } else {
                        fileExtension = 'webm'; // Default if no audio responses
                    }
                } else {
                    return showMessage('目前模式不支援下載媒體。', 'info');
                }

                if (mediaResponses.length === 0) return showMessage(`目前沒有${filenamePrefix}可供下載。`, 'info');
                
                btn.disabled = true;
                showMessage(`正在打包${filenamePrefix}...`, 'info');
                const zip = new JSZip();
                const dataURLToBlob = (dataurl) => {
                    const [header, body] = dataurl.split(',');
                    const mime = header.match(/:(.*?);/)[1];
                    const bstr = atob(body);
                    let n = bstr.length;
                    const u8arr = new Uint8Array(n);
                    while(n--) u8arr[n] = bstr.charCodeAt(n);
                    return new Blob([u8arr], {type:mime});
                };
                
                mediaResponses.forEach(r => {
                    // Ensure unique filenames for students with same name but different recordings if needed
                    // For now, just use student name.
                    zip.file(`${r.name}.${fileExtension}`, dataURLToBlob(r.answer));
                });

                try {
                    const content = await zip.generateAsync({type:"blob"});
                    saveAs(content, `${filenamePrefix}_${new Date().toLocaleDateString('zh-TW')}.zip`);
                    showMessage(`已成功打包 ${mediaResponses.length} 個檔案並開始下載。`, 'success');
                } catch (error) {
                    console.error("打包媒體失敗:", error);
                    showMessage("打包媒體失敗，請檢查瀏覽器支援或檔案大小。", "error");
                } finally {
                    btn.disabled = false;
                }
            });
            
            // AI-related buttons and modals.
            document.getElementById('ai-text-summary-btn').addEventListener('click', async () => {
                const textResponses = allStudentResponses.filter(r => currentInteractionMode === 'text_input' && r.answer && r.answer.trim()).map(r => r.answer);
                if (textResponses.length === 0) return showMessage('目前沒有文字回答可供 AI 分析。', 'info');
                const aiSummaryModal = document.getElementById('ai-summary-modal');
                const aiLoadingSpinner = document.getElementById('ai-loading-spinner');
                const aiSummaryResultList = document.getElementById('ai-summary-result-list');
                aiSummaryModal.classList.remove('hidden');
                aiLoadingSpinner.classList.remove('hidden');
                aiSummaryResultList.innerHTML = '';
                const prompt = `請分析以下學生回答的文本內容，識別出語義上相似的詞語或短語，歸類為主要詞彙並統計總出現次數。列出最常出現的10個主要詞彙。請以繁體中文回應，排除常見助詞、連接詞、標點符號。

請使用以下JSON格式返回結果，只輸出JSON內容，不要有其他說明文字：
[{"word": "主要詞彙1", "count": 10}, {"word": "主要詞彙2", "count": 8}]

若無有意義詞彙，返回空陣列：[]

文本內容：
${textResponses.join('\n\n')}`;
                try {
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.3 }
                    };
                    const apiKey = (aiSettings.aiSource === 'gemini-custom' && aiSettings.geminiApiKey) ? aiSettings.geminiApiKey : "";
                    const response = await fetch(getApiUrl(apiKey), { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                    if (!response.ok) {
                        aiLoadingSpinner.classList.add('hidden');
                        showAPIErrorModal(new Error(`API request failed: ${response.status}`), response);
                        return;
                    }

                    const result = await response.json();
                    aiLoadingSpinner.classList.add('hidden');
                    let jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    // Extract JSON from response text (in case there's extra text)
                    if (jsonText) {
                        // Try to find JSON array in the text
                        const jsonMatch = jsonText.match(/\[[\s\S]*\]/);
                        if (jsonMatch) {
                            jsonText = jsonMatch[0];
                        }
                    }

                    const parsedResults = jsonText ? JSON.parse(jsonText) : [];
                    if (parsedResults.length > 0) {
                        parsedResults.sort((a, b) => b.count - a.count).forEach(item => {
                            const li = document.createElement('li');
                            li.textContent = `${item.word} (${item.count}次)`;
                            aiSummaryResultList.appendChild(li);
                        });
                    } else {
                        aiSummaryResultList.innerHTML = '<li>沒有找到常用詞彙。</li>';
                    }
                } catch (error) {
                    console.error("AI 文字分析失敗:", error);
                    aiLoadingSpinner.classList.add('hidden');
                    showAPIErrorModal(error);
                }
            });
            document.getElementById('ai-summary-modal-close-btn').addEventListener('click', () => document.getElementById('ai-summary-modal').classList.add('hidden'));
            document.getElementById('ai-settings-btn').addEventListener('click', showAISettingsModal);
            aiSettingsModalCloseBtn.addEventListener('click', hideAISettingsModal);
            saveAiSettingsBtn.addEventListener('click', saveAISettings);
            aiSourceSelect.addEventListener('change', (e) => geminiApiKeyGroup.classList.toggle('hidden', e.target.value !== 'gemini-custom'));

            // API Error Modal listeners
            document.getElementById('api-error-modal-close-btn').addEventListener('click', hideAPIErrorModal);
            document.getElementById('api-error-modal-ok-btn').addEventListener('click', hideAPIErrorModal);

            // New: URL/HTML Dispatch Settings Modal listeners.
            document.getElementById('url-dispatch-settings-btn').addEventListener('click', showUrlDispatchSettingsModal);
            urlDispatchModalCloseBtn.addEventListener('click', hideUrlDispatchSettingsModal);
            document.getElementById('save-dispatch-settings-btn').addEventListener('click', saveDispatchSettings); // Renamed
            document.getElementById('clear-dispatch-settings-btn').addEventListener('click', clearDispatchSettings); // Renamed

            // Sequencing Settings Modal listeners
            document.getElementById('sequencing-settings-modal-close-btn').addEventListener('click', () => {
                document.getElementById('sequencing-settings-modal').classList.add('hidden');
            });
            document.getElementById('cancel-sequencing-settings-btn').addEventListener('click', () => {
                document.getElementById('sequencing-settings-modal').classList.add('hidden');
            });
            document.getElementById('start-sequencing-interaction-btn').addEventListener('click', async () => {
                const question = '排序題';
                const itemsText = document.getElementById('sequencing-items-textarea').value.trim();

                if (!itemsText) {
                    showMessage('請輸入排序項目！', 'error');
                    return;
                }

                const items = itemsText.split('\n').map(item => item.trim()).filter(item => item);
                if (items.length < 2) {
                    showMessage('至少需要兩個排序項目！', 'error');
                    return;
                }

                sequencingData.question = question;
                sequencingData.correctOrder = items;

                document.getElementById('sequencing-settings-modal').classList.add('hidden');
                showView('teacherMonitor');
                await setInteractionMode('sequencing', {
                    question: question,
                    correctOrder: items
                });
            });

            // Matching Settings Modal listeners
            document.getElementById('matching-settings-modal-close-btn').addEventListener('click', () => {
                document.getElementById('matching-settings-modal').classList.add('hidden');
            });
            document.getElementById('cancel-matching-settings-btn').addEventListener('click', () => {
                document.getElementById('matching-settings-modal').classList.add('hidden');
            });
            document.getElementById('start-matching-interaction-btn').addEventListener('click', async () => {
                const question = '配對題';
                const pairsText = document.getElementById('matching-pairs-textarea').value.trim();

                if (!pairsText) {
                    showMessage('請輸入配對項目！', 'error');
                    return;
                }

                const lines = pairsText.split('\n').map(line => line.trim()).filter(line => line);
                const pairs = [];

                for (const line of lines) {
                    const parts = line.split(/[,\t]/).map(p => p.trim()).filter(p => p);
                    if (parts.length >= 2) {
                        pairs.push({ left: parts[0], right: parts[1] });
                    }
                }

                if (pairs.length < 2) {
                    showMessage('至少需要兩對配對項目！', 'error');
                    return;
                }

                matchingData.question = question;
                matchingData.pairs = pairs;

                document.getElementById('matching-settings-modal').classList.add('hidden');
                showView('teacherMonitor');
                await setInteractionMode('matching', {
                    question: question,
                    pairs: pairs
                });
            });

            // Focus Game Settings Modal listeners
            let selectedFocusGameNumber = 36; // Default number

            document.getElementById('focus-game-settings-btn').addEventListener('click', () => {
                document.getElementById('focus-game-settings-modal').classList.remove('hidden');
            });

            document.getElementById('focus-game-settings-modal-close-btn').addEventListener('click', () => {
                document.getElementById('focus-game-settings-modal').classList.add('hidden');
            });

            document.getElementById('cancel-focus-game-settings-btn').addEventListener('click', () => {
                document.getElementById('focus-game-settings-modal').classList.add('hidden');
            });

            // Handle number option selection
            document.querySelectorAll('.focus-game-number-option').forEach(button => {
                button.addEventListener('click', (e) => {
                    // Remove selected class from all buttons
                    document.querySelectorAll('.focus-game-number-option').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    // Add selected class to clicked button
                    e.currentTarget.classList.add('selected');
                    // Store the selected number
                    selectedFocusGameNumber = parseInt(e.currentTarget.dataset.number);
                });
            });

            // Start focus game interaction
            document.getElementById('start-focus-game-interaction-btn').addEventListener('click', async () => {
                document.getElementById('focus-game-settings-modal').classList.add('hidden');
                showView('teacherMonitor');
                await setInteractionMode('focus_game', {
                    numberCount: selectedFocusGameNumber
                });
            });

            // Quick Poll Settings Modal listeners
            document.getElementById('quick-poll-settings-btn').addEventListener('click', showQuickPollSettingsModal);
            document.getElementById('quick-poll-settings-modal-close-btn').addEventListener('click', hideQuickPollSettingsModal);
            document.getElementById('cancel-quick-poll-settings-btn').addEventListener('click', hideQuickPollSettingsModal);
            document.getElementById('start-quick-poll-btn').addEventListener('click', startQuickPoll);

            // Quick Poll Stats Modal listeners
            document.getElementById('quick-poll-stats-modal-close-btn').addEventListener('click', hideQuickPollStatsModal);
            document.getElementById('end-quick-poll-btn').addEventListener('click', endQuickPoll);
            document.getElementById('download-poll-results-btn').addEventListener('click', downloadPollResults);
            document.getElementById('chart-type-bar-btn').addEventListener('click', () => switchChartType('bar'));
            document.getElementById('chart-type-pie-btn').addEventListener('click', () => switchChartType('pie'));

            // Poll type radio button listeners
            document.querySelectorAll('input[name="pollType"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const customSection = document.getElementById('custom-poll-options-section');
                    customSection.classList.toggle('hidden', e.target.value !== 'custom');
                });
            });

            // NEW: Event listeners for dispatch type radio buttons
            dispatchTypeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const selectedType = e.target.value;
                    urlDispatchSection.classList.toggle('hidden', selectedType === 'html');
                    htmlDispatchSection.classList.toggle('hidden', selectedType === 'url');
                });
            });

            // NEW: HTML upload/clear listeners within the dispatch settings modal
            dispatchHtmlUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                e.target.value = ''; // Reset input
                if (file) {
                    handleDispatchHtmlFile(file);
                }
            });
            clearDispatchHtmlBtn.addEventListener('click', () => {
                dispatchSettings.htmlContent = null; // Clear content in global state
                dispatchHtmlUploadInput.value = ''; // Clear file input
                dispatchHtmlStatus.textContent = '目前沒有 HTML 檔案。';
                showMessage('HTML 檔案已清除！', 'info');
            });


            // New: Recording button event listeners
            startRecordingBtn.addEventListener('click', async () => {
                // NEW: Check pause state before starting recording
                if (isResponsePaused) {
                    showMessage('老師已暫停回覆，無法開始錄音。', 'error');
                    return;
                }
                startRecording();
            });
            stopRecordingBtn.addEventListener('click', stopRecording);
            playRecordingBtn.addEventListener('click', playRecording);
            resetRecordingBtn.addEventListener('click', resetRecording);
            submitRecordingBtn.addEventListener('click', async () => {
                // NEW: Check pause state before submitting recording
                if (isResponsePaused) {
                    showMessage('老師已暫停回覆，無法送出錄音。', 'error');
                    return;
                }
                if (audioDataURL) {
                    await submitAnswer(audioDataURL);
                    submitRecordingBtn.disabled = true;
                    submitRecordingBtn.classList.replace('btn-primary', 'btn-gray');
                } else {
                    showMessage('沒有錄音可送出', 'error');
                }
            });

            // NEW: Toggle Pause Button Event Listener
            togglePauseBtn.addEventListener('click', toggleResponsePause);


            // End Class Session Buttons.
            document.getElementById('end-class-session-menu-btn').addEventListener('click', endClassSession);
            document.getElementById('end-class-session-monitor-btn').addEventListener('click', endClassSession);

            // Leave Classroom Button (without deleting data)
            document.getElementById('leave-classroom-btn').addEventListener('click', leaveClassroom);

            // NEW: Multiple Choice Settings Modal Listeners
            const multipleChoiceSettingsModal = document.getElementById('multiple-choice-settings-modal');
            const multipleChoiceSettingsModalCloseBtn = document.getElementById('multiple-choice-settings-modal-close-btn');
            const mcQuestionTypeRadios = document.querySelectorAll('input[name="mcQuestionType"]');
            const customMcQuestionsSection = document.getElementById('custom-mc-questions-section');
            const customMcQuestionsTextarea = document.getElementById('custom-mc-questions-textarea');
            const customMcQuestionsStatus = document.getElementById('custom-mc-questions-status');
            const startMcInteractionBtn = document.getElementById('start-mc-interaction-btn');
            const cancelMcSettingsBtn = document.getElementById('cancel-mc-settings-btn');
            
            // AI Question Generation elements
            const aiGenerateMcBtn = document.getElementById('ai-generate-mc-btn');
            const aiMcTopicTextarea = document.getElementById('ai-mc-topic-textarea');
            const aiMcCountInput = document.getElementById('ai-mc-count-input');
            const aiMcLoadingSpinner = document.getElementById('ai-mc-loading-spinner');
            const aiMcBtnText = document.getElementById('ai-mc-btn-text');
            const aiMcBtnIcon = document.getElementById('ai-mc-btn-icon');

            // Question Bank Management elements
            const questionBankFileInput = document.getElementById('question-bank-file-input');
            const loadQuestionBankBtn = document.getElementById('load-question-bank-btn');
            const questionBankNameInput = document.getElementById('question-bank-name-input');
            const saveQuestionBankBtn = document.getElementById('save-question-bank-btn');
            const questionBankList = document.getElementById('question-bank-list');


            multipleChoiceSettingsModalCloseBtn.addEventListener('click', () => multipleChoiceSettingsModal.classList.add('hidden'));
            cancelMcSettingsBtn.addEventListener('click', () => multipleChoiceSettingsModal.classList.add('hidden'));

            // Question Bank Management Event Listeners
            loadQuestionBankBtn.addEventListener('click', loadQuestionBankFromFile);
            saveQuestionBankBtn.addEventListener('click', saveQuestionBankFromTextarea);

            // Teacher Password Modal Event Listeners
            const teacherPasswordModal = document.getElementById('teacher-password-modal');
            const teacherPasswordModalCloseBtn = document.getElementById('teacher-password-modal-close-btn');
            const teacherPasswordInput = document.getElementById('teacher-password-input');
            const teacherPasswordSubmitBtn = document.getElementById('teacher-password-submit-btn');
            const teacherPasswordCancelBtn = document.getElementById('teacher-password-cancel-btn');

            teacherPasswordModalCloseBtn.addEventListener('click', () => {
                teacherPasswordModal.classList.add('hidden');
                teacherPasswordInput.value = '';
            });
            teacherPasswordCancelBtn.addEventListener('click', () => {
                teacherPasswordModal.classList.add('hidden');
                teacherPasswordInput.value = '';
            });
            teacherPasswordSubmitBtn.addEventListener('click', () => {
                const password = teacherPasswordInput.value.trim();
                if (password === 'tpet') {
                    teacherPasswordModal.classList.add('hidden');
                    teacherPasswordInput.value = '';
                    loadRecentClassrooms(); // Load recent classrooms for teacher
                    showView('teacherClassroomCode');
                } else {
                    showMessage('密碼錯誤！', 'error');
                    teacherPasswordInput.value = '';
                    teacherPasswordInput.focus();
                }
            });
            teacherPasswordInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    teacherPasswordSubmitBtn.click();
                }
            });

            mcQuestionTypeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const isCustomMode = e.target.value === 'custom';
                    customMcQuestionsSection.classList.toggle('hidden', !isCustomMode);
                    document.getElementById('question-bank-management-section').classList.toggle('hidden', !isCustomMode);
                    customMcQuestionsStatus.classList.add('hidden'); // Hide status when changing radio
                });
            });

            startMcInteractionBtn.addEventListener('click', async () => {
                const selectedType = document.querySelector('input[name="mcQuestionType"]:checked').value;
                let questionsToDispatch = null;

                if (selectedType === 'custom') {
                    const parsedQuestions = parseCustomQuestions(customMcQuestionsTextarea.value);
                    if (!parsedQuestions) {
                        customMcQuestionsStatus.classList.remove('hidden');
                        return; // Stop if parsing failed
                    }
                    questionsToDispatch = parsedQuestions;
                    customMultipleChoiceQuestions = parsedQuestions; // Update global for teacher UI
                } else {
                    customMultipleChoiceQuestions = []; // Clear global if switching to none
                }
                
                customMcQuestionsStatus.classList.add('hidden'); // Hide status on successful dispatch
                multipleChoiceSettingsModal.classList.add('hidden');
                showView('teacherMonitor');
                await setInteractionMode('multiple_choice', { customQuestions: questionsToDispatch });
            });

            // AI Question Generation Button Listener
            aiGenerateMcBtn.addEventListener('click', async () => {
                const topic = aiMcTopicTextarea.value.trim();
                const count = parseInt(aiMcCountInput.value);

                if (!topic) {
                    showMessage('請輸入出題主題或要求！', 'error');
                    return;
                }
                if (!count || count < 1 || count > 10) {
                    showMessage('出題數量必須介於 1 到 10 之間！', 'error');
                    return;
                }
                
                // Show loading state
                aiGenerateMcBtn.disabled = true;
                aiMcBtnText.textContent = 'AI 思考中...';
                aiMcBtnIcon.classList.remove('fa-magic');
                aiMcBtnIcon.classList.add('fa-spinner', 'fa-spin');
                aiMcLoadingSpinner.classList.remove('hidden');

                const prompt = `請根據以下要求，生成 ${count} 題選擇題。
                要求：${topic}
                請嚴格遵守以下格式，每題一行，並用逗號分隔每個欄位：
                題目,正確答案(1-4),選項1,選項2,選項3,選項4
                請勿包含題號、任何多餘的說明文字或程式碼區塊標記。`;

                let apiResponse = null;
                try {
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.7 } // Adjust temperature for creativity
                    };
                    const apiKey = aiSettings.geminiApiKey;
                    apiResponse = await fetch(getApiUrl(apiKey), { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                    if (!apiResponse.ok) {
                        throw new Error(`AI API request failed with status ${apiResponse.status}`);
                    }

                    const result = await apiResponse.json();
                    const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (generatedText) {
                        // Append to existing content, adding a newline if needed
                        const existingText = customMcQuestionsTextarea.value.trim();
                        customMcQuestionsTextarea.value = existingText ? `${existingText}\n${generatedText.trim()}` : generatedText.trim();
                        showMessage('AI 題目已成功生成並填入左方！', 'success');
                    } else {
                        throw new Error('AI 未返回有效內容。');
                    }

                } catch (error) {
                    console.error("AI 題目生成失敗:", error);
                    showAPIErrorModal(error, apiResponse);
                } finally {
                    // Hide loading state
                    aiGenerateMcBtn.disabled = false;
                    aiMcBtnText.textContent = 'AI 開始出題';
                    aiMcBtnIcon.classList.add('fa-magic');
                    aiMcBtnIcon.classList.remove('fa-spinner', 'fa-spin');
                    aiMcLoadingSpinner.classList.add('hidden');
                }
            });

            // AI Sequencing Question Generation Button Listener
            const aiGenerateSeqBtn = document.getElementById('ai-generate-seq-btn');
            const aiSeqTopicTextarea = document.getElementById('ai-seq-topic-textarea');
            const aiSeqCountInput = document.getElementById('ai-seq-count-input');
            const aiSeqBtnText = document.getElementById('ai-seq-btn-text');
            const aiSeqBtnIcon = document.getElementById('ai-seq-btn-icon');
            const aiSeqLoadingSpinner = document.getElementById('ai-seq-loading-spinner');

            aiGenerateSeqBtn.addEventListener('click', async () => {
                const topic = aiSeqTopicTextarea.value.trim();
                const count = parseInt(aiSeqCountInput.value);

                if (!topic) {
                    showMessage('請輸入出題主題或要求！', 'error');
                    return;
                }
                if (!count || count < 3 || count > 10) {
                    showMessage('項目數量必須介於 3 到 10 之間！', 'error');
                    return;
                }

                // Show loading state
                aiGenerateSeqBtn.disabled = true;
                aiSeqBtnText.textContent = 'AI 思考中...';
                aiSeqBtnIcon.classList.remove('fa-magic');
                aiSeqBtnIcon.classList.add('fa-spinner', 'fa-spin');
                aiSeqLoadingSpinner.classList.remove('hidden');

                const prompt = `請根據以下主題，生成 ${count} 個排序項目。
主題：${topic}
請按正確順序列出，每個項目一行，不要有題號或任何標記。
只需提供項目內容，不要包含說明文字或程式碼區塊標記。`;

                let apiResponse = null;
                try {
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.7 }
                    };
                    const apiKey = aiSettings.geminiApiKey;
                    apiResponse = await fetch(getApiUrl(apiKey), { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                    if (!apiResponse.ok) {
                        throw new Error(`AI API request failed with status ${apiResponse.status}`);
                    }

                    const result = await apiResponse.json();
                    const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (generatedText) {
                        const sequencingItemsTextarea = document.getElementById('sequencing-items-textarea');
                        sequencingItemsTextarea.value = generatedText.trim();
                        showMessage('AI 排序題已成功生成並填入！', 'success');
                    } else {
                        throw new Error('AI 未返回有效內容。');
                    }

                } catch (error) {
                    console.error("AI 排序題生成失敗:", error);
                    showAPIErrorModal(error, apiResponse);
                } finally {
                    // Hide loading state
                    aiGenerateSeqBtn.disabled = false;
                    aiSeqBtnText.textContent = 'AI 開始出題';
                    aiSeqBtnIcon.classList.add('fa-magic');
                    aiSeqBtnIcon.classList.remove('fa-spinner', 'fa-spin');
                    aiSeqLoadingSpinner.classList.add('hidden');
                }
            });

            // AI Matching Question Generation Button Listener
            const aiGenerateMatchBtn = document.getElementById('ai-generate-match-btn');
            const aiMatchTopicTextarea = document.getElementById('ai-match-topic-textarea');
            const aiMatchCountInput = document.getElementById('ai-match-count-input');
            const aiMatchBtnText = document.getElementById('ai-match-btn-text');
            const aiMatchBtnIcon = document.getElementById('ai-match-btn-icon');
            const aiMatchLoadingSpinner = document.getElementById('ai-match-loading-spinner');

            aiGenerateMatchBtn.addEventListener('click', async () => {
                const topic = aiMatchTopicTextarea.value.trim();
                const count = parseInt(aiMatchCountInput.value);

                if (!topic) {
                    showMessage('請輸入出題主題或要求！', 'error');
                    return;
                }
                if (!count || count < 3 || count > 10) {
                    showMessage('配對數量必須介於 3 到 10 之間！', 'error');
                    return;
                }

                // Show loading state
                aiGenerateMatchBtn.disabled = true;
                aiMatchBtnText.textContent = 'AI 思考中...';
                aiMatchBtnIcon.classList.remove('fa-magic');
                aiMatchBtnIcon.classList.add('fa-spinner', 'fa-spin');
                aiMatchLoadingSpinner.classList.remove('hidden');

                const prompt = `請根據以下主題，生成 ${count} 組配對題。
主題：${topic}
每行格式：左側項目,右側項目
不要有題號、說明文字或程式碼區塊標記。
直接提供配對內容，每行一組。`;

                let apiResponse = null;
                try {
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.7 }
                    };
                    const apiKey = aiSettings.geminiApiKey;
                    apiResponse = await fetch(getApiUrl(apiKey), { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                    if (!apiResponse.ok) {
                        throw new Error(`AI API request failed with status ${apiResponse.status}`);
                    }

                    const result = await apiResponse.json();
                    const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (generatedText) {
                        const matchingPairsTextarea = document.getElementById('matching-pairs-textarea');
                        matchingPairsTextarea.value = generatedText.trim();
                        showMessage('AI 配對題已成功生成並填入！', 'success');
                    } else {
                        throw new Error('AI 未返回有效內容。');
                    }

                } catch (error) {
                    console.error("AI 配對題生成失敗:", error);
                    showAPIErrorModal(error, apiResponse);
                } finally {
                    // Hide loading state
                    aiGenerateMatchBtn.disabled = false;
                    aiMatchBtnText.textContent = 'AI 開始出題';
                    aiMatchBtnIcon.classList.add('fa-magic');
                    aiMatchBtnIcon.classList.remove('fa-spinner', 'fa-spin');
                    aiMatchLoadingSpinner.classList.add('hidden');
                }
            });

            // Sequencing Question Bank Management Listeners
            document.getElementById('load-seq-bank-btn').addEventListener('click', loadSequencingBankFromFile);
            document.getElementById('save-seq-bank-btn').addEventListener('click', saveSequencingBank);

            // Matching Question Bank Management Listeners
            document.getElementById('load-match-bank-btn').addEventListener('click', loadMatchingBankFromFile);
            document.getElementById('save-match-bank-btn').addEventListener('click', saveMatchingBank);

            // Reading Comprehension Listeners
            document.getElementById('reading-comprehension-settings-btn')?.addEventListener('click', showReadingComprehensionModal);
            document.getElementById('reading-comprehension-settings-modal-close-btn')?.addEventListener('click', hideReadingComprehensionModal);
            document.getElementById('cancel-reading-settings-btn')?.addEventListener('click', hideReadingComprehensionModal);
            document.getElementById('start-reading-interaction-btn')?.addEventListener('click', startReadingComprehension);
            document.getElementById('submit-reading-btn')?.addEventListener('click', submitReadingAnswer);
            document.getElementById('ai-generate-reading-btn')?.addEventListener('click', generatePIRLSQuestions);
            document.getElementById('load-reading-files-btn')?.addEventListener('click', loadReadingFiles);
            document.getElementById('save-reading-question-bank-btn')?.addEventListener('click', saveReadingQuestionBank);
            document.getElementById('download-reading-zip-btn')?.addEventListener('click', downloadReadingZip);

            // View Reading Questions Modal Listeners
            document.getElementById('view-reading-questions-btn')?.addEventListener('click', showViewReadingQuestionsModal);
            document.getElementById('view-reading-questions-modal-close-btn')?.addEventListener('click', hideViewReadingQuestionsModal);
            document.getElementById('close-reading-questions-view-btn')?.addEventListener('click', hideViewReadingQuestionsModal);


            // NEW: Student side custom multiple choice submission
            document.getElementById('submit-custom-mc-btn').addEventListener('click', async (e) => {
                // NEW: Check pause state before submitting
                if (isResponsePaused) {
                    showMessage('老師已暫停回覆，無法送出答案。', 'error');
                    return;
                }

                // NEW: 檢查是否已經提交過答案
                const hasSubmitted = await checkIfStudentSubmitted();
                if (hasSubmitted) {
                    showMessage('您已經提交過答案，無法重複提交。', 'error');
                    return;
                }

                const studentAnswers = [];
                const questionContainers = document.querySelectorAll('#custom-mc-questions-container .mc-question-item');
                let allAnswered = true;

                questionContainers.forEach((qContainer, index) => {
                    const selectedOption = qContainer.querySelector(`input[name="question-${index}"]:checked`);
                    if (selectedOption) {
                        studentAnswers.push({ qIndex: index, ans: selectedOption.value });
                    } else {
                        allAnswered = false;
                    }
                });

                if (!allAnswered) {
                    showMessage('請回答所有題目！', 'error');
                    return;
                }

                await submitAnswer(studentAnswers);
                
                // NEW: 更新UI顯示已提交狀態
                e.currentTarget.disabled = true;
                e.currentTarget.classList.replace('btn-primary', 'btn-gray');
                e.currentTarget.textContent = '已提交答案 ✓';
                
                // Disable all radio buttons after submission
                document.querySelectorAll('#custom-mc-questions-container input[type="radio"]').forEach(radio => {
                    radio.disabled = true;
                });
            });
        }

        /**
         * NEW: Parses custom multiple choice questions from a textarea string.
         * Expected format per line: Question,CorrectAnswer(1-4/A-D),Option1,Option2,Option3,Option4
         * @param {string} rawText - The raw string from the textarea.
         * @returns {Array|null} An array of question objects, or null if parsing fails.
         */
        function parseCustomQuestions(rawText) {
            const lines = rawText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            const questions = [];

            for (const line of lines) {
                // Try splitting by comma first, then by tab if comma yields too few parts
                let parts = line.split(',');
                if (parts.length < 6) {
                    parts = line.split('\t');
                }

                if (parts.length !== 6) {
                    console.error("Invalid line format:", line);
                    return null; // Invalid format
                }

                const questionText = parts[0].trim();
                let correctAnswer = parts[1].trim().toUpperCase();
                const options = parts.slice(2, 6).map(opt => opt.trim());

                // Normalize correct answer to 1, 2, 3, 4
                if (correctAnswer === 'A') correctAnswer = '1';
                else if (correctAnswer === 'B') correctAnswer = '2';
                else if (correctAnswer === 'C') correctAnswer = '3';
                else if (correctAnswer === 'D') correctAnswer = '4';

                if (!['1', '2', '3', '4'].includes(correctAnswer)) {
                    console.error("Invalid correct answer format:", correctAnswer);
                    return null; // Invalid correct answer
                }

                if (questionText === '' || options.some(opt => opt === '')) {
                    console.error("Empty question or option:", line);
                    return null; // Empty question or option
                }

                questions.push({
                    questionText: questionText,
                    correctAnswer: correctAnswer,
                    options: options
                });
            }

            if (questions.length === 0) {
                return null; // No valid questions parsed
            }

            return questions;
        }

        /**
         * NEW: Renders custom multiple choice questions on the student side.
         * @param {Array} questions - An array of question objects.
         */
        async function renderMultipleChoiceQuestions(questions) {
            const defaultMcOptions = document.getElementById('default-mc-options');
            const customMcQuestionsContainer = document.getElementById('custom-mc-questions-container');
            const submitCustomMcBtn = document.getElementById('submit-custom-mc-btn');
            const interactionMultipleChoice = document.getElementById('interaction-multiple-choice');

            if (questions && questions.length > 0) {
                defaultMcOptions.classList.add('hidden');
                customMcQuestionsContainer.classList.remove('hidden');
                submitCustomMcBtn.classList.remove('hidden');
                customMcQuestionsContainer.innerHTML = ''; // Clear previous questions
                interactionMultipleChoice.classList.remove('enlarged-buttons'); // Remove enlarged class for custom questions

                // NEW: 檢查學生是否已經提交過答案
                const hasSubmitted = await checkIfStudentSubmitted();
                
                questions.forEach((q, qIndex) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'mc-question-item bg-white p-4 rounded-lg shadow-md';
                    questionDiv.innerHTML = `
                        <p class="font-bold text-lg mb-3 text-gray-800">Q${qIndex + 1}. ${q.questionText}</p>
                        <div class="space-y-2">
                            ${q.options.map((option, optIndex) => `
                                <label class="flex items-center p-2 border border-gray-200 rounded-md cursor-pointer hover:bg-gray-50 transition-colors">
                                    <input type="radio" name="question-${qIndex}" value="${optIndex + 1}" class="form-radio text-blue-600 h-5 w-5" ${hasSubmitted ? 'disabled' : ''}>
                                    <span class="ml-3 text-gray-700">${option}</span>
                                </label>
                            `).join('')}
                        </div>
                    `;
                    customMcQuestionsContainer.appendChild(questionDiv);
                });

                // NEW: 如果已提交，更新按鈕狀態
                if (hasSubmitted) {
                    submitCustomMcBtn.disabled = true;
                    submitCustomMcBtn.classList.replace('btn-primary', 'btn-gray');
                    submitCustomMcBtn.textContent = '已提交答案 ✓';
                    
                    // 顯示已提交的答案
                    await displaySubmittedAnswers();
                }
            } else {
                defaultMcOptions.classList.remove('hidden');
                customMcQuestionsContainer.classList.add('hidden');
                submitCustomMcBtn.classList.add('hidden');
                interactionMultipleChoice.classList.add('enlarged-buttons'); // Add enlarged class for no custom questions
            }
        }

        // NEW: 檢查學生是否已經提交過答案
        async function checkIfStudentSubmitted() {
            if (!studentName || !classroomCode) return false;
            
            try {
                const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
                const docSnap = await getDoc(studentRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // 檢查是否有陣列格式的答案（自訂選擇題）
                    return Array.isArray(data.answer) && data.answer.length > 0;
                }
                return false;
            } catch (error) {
                console.error('檢查提交狀態失敗:', error);
                return false;
            }
        }

        // NEW: 顯示學生已提交的答案
        async function displaySubmittedAnswers() {
            if (!studentName || !classroomCode) return;
            
            try {
                const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
                const docSnap = await getDoc(studentRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (Array.isArray(data.answer)) {
                        // 標記已選擇的答案
                        data.answer.forEach(qAns => {
                            const radio = document.querySelector(`input[name="question-${qAns.qIndex}"][value="${qAns.ans}"]`);
                            if (radio) {
                                radio.checked = true;
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('載入已提交答案失敗:', error);
            }
        }


        // --- Canvas State Management Functions ---
        
        /**
         * Saves the current canvas state when switching to peer review.
         */
        function saveCanvasState() {
            if (canvas && currentInteractionMode === 'drawing') {
                try {
                    savedCanvasState = {
                        mainCanvas: canvas.toDataURL(),
                        drawingCanvas: drawingCanvas.toDataURL(),
                        studentImageCanvas: studentImageCanvas.toDataURL(),
                        canvasWidth: canvas.width,
                        canvasHeight: canvas.height
                    };
                    console.log('Canvas state saved');
                } catch (error) {
                    console.error('Error saving canvas state:', error);
                }
            }
        }
        
        /**
         * Restores the canvas state when returning from peer review.
         */
        function restoreCanvasState() {
            if (savedCanvasState && canvas && currentInteractionMode === 'drawing') {
                try {
                    // Ensure canvas setup is complete
                    if (canvas.width === 0 || canvas.height === 0) {
                        setupCanvas();
                    }
                    
                    // Restore canvas dimensions
                    canvas.width = savedCanvasState.canvasWidth;
                    canvas.height = savedCanvasState.canvasHeight;
                    drawingCanvas.width = savedCanvasState.canvasWidth;
                    drawingCanvas.height = savedCanvasState.canvasHeight;
                    studentImageCanvas.width = savedCanvasState.canvasWidth;
                    studentImageCanvas.height = savedCanvasState.canvasHeight;
                    
                    let imagesLoaded = 0;
                    const totalImages = 2; // drawing and student image
                    
                    function checkAllImagesLoaded() {
                        imagesLoaded++;
                        if (imagesLoaded === totalImages) {
                            // All images loaded, recompose the final canvas
                            redrawCanvas();
                            console.log('Canvas state restored');
                        }
                    }
                    
                    // Restore drawing canvas content
                    if (savedCanvasState.drawingCanvas && savedCanvasState.drawingCanvas !== 'data:,') {
                        const drawingImg = new Image();
                        drawingImg.onload = function() {
                            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                            drawingCtx.drawImage(drawingImg, 0, 0);
                            checkAllImagesLoaded();
                        };
                        drawingImg.onerror = function() {
                            console.warn('Failed to load drawing canvas');
                            checkAllImagesLoaded();
                        };
                        drawingImg.src = savedCanvasState.drawingCanvas;
                    } else {
                        drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                        checkAllImagesLoaded();
                    }
                    
                    // Restore student image canvas content
                    if (savedCanvasState.studentImageCanvas && savedCanvasState.studentImageCanvas !== 'data:,') {
                        const studentImg = new Image();
                        studentImg.onload = function() {
                            studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);
                            studentImageCtx.drawImage(studentImg, 0, 0);
                            checkAllImagesLoaded();
                        };
                        studentImg.onerror = function() {
                            console.warn('Failed to load student image canvas');
                            checkAllImagesLoaded();
                        };
                        studentImg.src = savedCanvasState.studentImageCanvas;
                    } else {
                        studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);
                        checkAllImagesLoaded();
                    }
                    
                } catch (error) {
                    console.error('Error restoring canvas state:', error);
                    // Fallback: just redraw what we can
                    redrawCanvas();
                }
            }
        }
        
        /**
         * Redraws the main canvas by compositing all layers.
         */
        function redrawCanvas() {
            if (!canvas || !ctx) return;
            
            // Clear main canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw background (teacher's background image)
            if (teacherUploadedBackgroundImageDataURL && backgroundCanvas) {
                try {
                    ctx.drawImage(backgroundCanvas, 0, 0);
                } catch (error) {
                    console.warn('Error drawing background canvas:', error);
                }
            }
            
            // Draw student's uploaded image
            if (studentUploadedImageDataURL && studentImageCanvas) {
                try {
                    ctx.drawImage(studentImageCanvas, 0, 0);
                } catch (error) {
                    console.warn('Error drawing student image canvas:', error);
                }
            }
            
            // Draw student's drawing strokes
            if (drawingCanvas) {
                try {
                    ctx.drawImage(drawingCanvas, 0, 0);
                } catch (error) {
                    console.warn('Error drawing drawing canvas:', error);
                }
            }
        }

        // --- Peer Review Functions ---
        
        /**
         * Toggles the peer review process for the current interaction.
         * Only works for text_input and drawing modes.
         */
        async function startPeerReview() {
            if (!currentInteractionMode || (!['text_input', 'drawing'].includes(currentInteractionMode))) {
                showMessage('互評功能只支援文字題和繪圖題！', 'error');
                return;
            }
            
            const startPeerReviewBtn = document.getElementById('start-peer-review-btn');
            
            if (peerReviewActive) {
                // Stop peer review
                try {
                    const peerReviewRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'peerReview');
                    await setDoc(peerReviewRef, { active: false });
                    
                    peerReviewActive = false;
                    showMessage('互評已停止！學生回到原互動模式。', 'info');
                    
                    // Hide voting statistics container
                    document.getElementById('peer-review-stats-container').classList.add('hidden');
                    
                    // Update button text
                    startPeerReviewBtn.innerHTML = '<i class="fas fa-heart mr-2"></i> 開始互評 ❤️';
                    
                } catch (error) {
                    console.error('Error stopping peer review:', error);
                    showMessage('停止互評時發生錯誤，請稍後再試。', 'error');
                }
            } else {
                // Start peer review
                if (allStudentResponses.length === 0) {
                    showMessage('目前沒有學生作答，無法開始互評！', 'error');
                    return;
                }
                
                try {
                    // Set peer review status in Firebase
                    const peerReviewRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'peerReview');
                    await setDoc(peerReviewRef, {
                        active: true,
                        mode: currentInteractionMode,
                        works: allStudentResponses,
                        timestamp: Date.now()
                    });
                    
                    peerReviewActive = true;
                    showMessage('互評已開始！學生可以開始觀摩投票。', 'success');
                    
                    // Show voting statistics container
                    document.getElementById('peer-review-stats-container').classList.remove('hidden');
                    
                    // Start listening for votes
                    listenToPeerReviewVotes();
                    
                    // Update button text
                    startPeerReviewBtn.innerHTML = '<i class="fas fa-stop mr-2"></i> 停止互評 ⏹️';
                    
                } catch (error) {
                    console.error('Error starting peer review:', error);
                    showMessage('開始互評時發生錯誤，請稍後再試。', 'error');
                }
            }
        }
        
        /**
         * Exits peer review mode for students and returns to original interaction mode.
         */
        function exitPeerReview() {
            if (currentInteractionMode && currentInteractionMode !== 'waiting') {
                // Return to the original interaction mode
                showView('studentInteraction');
                showInteractionUI(currentInteractionMode);
                
                // Restore canvas state if returning to drawing mode
                if (currentInteractionMode === 'drawing') {
                    // Use a small delay to ensure canvas is ready
                    setTimeout(() => {
                        restoreCanvasState();
                    }, 100);
                }
            } else {
                // Return to waiting if no active interaction
                showView('studentWaiting');
            }
        }
        
        /**
         * Listens for peer review status changes and updates student UI accordingly.
         */
        function listenToPeerReviewStatus() {
            if (!classroomCode) return;
            
            const peerReviewRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'peerReview');
            onSnapshot(peerReviewRef, (doc) => {
                if (doc.exists() && doc.data().active) {
                    const data = doc.data();
                    if (currentRole === 'student') {
                        // Save canvas state before switching to peer review (if in drawing mode)
                        if (currentInteractionMode === 'drawing') {
                            saveCanvasState();
                        }
                        
                        // Switch student to peer review view
                        showView('studentPeerReview');
                        displayPeerReviewWorks(data.works, data.mode);
                        
                        // Restore student's voting history from Firebase
                        restoreStudentVotingHistory().then(() => {
                            listenToPeerReviewVotes();
                        });
                    }
                } else {
                    // Peer review ended, return to original interaction mode
                    if (currentRole === 'student' && !views.studentPeerReview.classList.contains('hidden')) {
                        if (currentInteractionMode && currentInteractionMode !== 'waiting') {
                            // Return to the original interaction mode
                            showView('studentInteraction');
                            showInteractionUI(currentInteractionMode);
                            
                            // Restore canvas state if returning to drawing mode
                            if (currentInteractionMode === 'drawing') {
                                // Use a small delay to ensure canvas is ready
                                setTimeout(() => {
                                    restoreCanvasState();
                                }, 100);
                            }
                        } else {
                            // Return to waiting if no active interaction
                            showView('studentWaiting');
                        }
                    }
                }
            });
        }
        
        /**
         * Displays peer review works for students to vote on.
         */
        function displayPeerReviewWorks(works, mode) {
            const worksGrid = document.getElementById('peer-review-works-grid');
            worksGrid.innerHTML = '';
            
            works.forEach((work, index) => {
                // Create a more stable unique identifier using timestamp and student name
                const workId = `${work.name}-${work.timestamp || index}`;
                
                const workDiv = document.createElement('div');
                workDiv.className = 'peer-review-work-item';
                workDiv.dataset.workId = workId;
                
                let contentHtml = '';
                if (mode === 'drawing') {
                    contentHtml = `<img src="${work.answer}" alt="學生作品">`;
                } else {
                    contentHtml = `<p>${work.answer}</p>`;
                }
                
                workDiv.innerHTML = `
                    <div class="work-author">${work.name}</div>
                    <div class="work-content">${contentHtml}</div>
                    <div class="vote-section">
                        <button class="vote-btn" data-work-id="${workId}" data-tooltip="點擊投票/取消投票">
                            <i class="fas fa-heart"></i>
                        </button>
                        <span class="vote-count zero">0</span>
                    </div>
                `;
                
                worksGrid.appendChild(workDiv);
            });
            
            // Add vote button listeners and update vote display
            document.querySelectorAll('.vote-btn').forEach(btn => {
                btn.addEventListener('click', handleVote);
                
                // Check if student has already voted for this work
                const workId = btn.dataset.workId;
                if (studentVotedWorks.has(workId)) {
                    btn.classList.add('voted');
                }
            });
            
            // Update vote counts if available
            if (Object.keys(allPeerReviewVotes).length > 0) {
                updateStudentVoteUI(allPeerReviewVotes);
            }
            
            // Update student's vote count display
            updateVoteCountDisplay();
        }
        
        /**
         * Handles voting on a work (toggle vote/unvote).
         */
        async function handleVote(e) {
            const workId = e.currentTarget.dataset.workId;
            const voteBtn = e.currentTarget;
            const voteCountSpan = voteBtn.nextElementSibling;
            
            try {
                if (studentVotedWorks.has(workId)) {
                    // Remove vote (unvote)
                    const voteRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'peerReviewVotes', `${studentName}-${workId}`);
                    await deleteDoc(voteRef);
                    
                    // Remove from local tracking
                    studentVotedWorks.delete(workId);
                    voteBtn.classList.remove('voted');
                    updateVoteCountDisplay();
                    showMessage('已取消投票！', 'info');
                    
                } else {
                    // Add vote
                    if (studentVotedWorks.size >= MAX_VOTES_PER_STUDENT) {
                        showMessage(`最多只能投票 ${MAX_VOTES_PER_STUDENT} 個作品！請先取消其他投票。`, 'warning');
                        return;
                    }
                    
                    const voteRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'peerReviewVotes', `${studentName}-${workId}`);
                    await setDoc(voteRef, {
                        voterName: studentName,
                        workId: workId,
                        timestamp: Date.now()
                    });
                    
                    // Mark as voted locally
                    studentVotedWorks.add(workId);
                    voteBtn.classList.add('voted');
                    updateVoteCountDisplay();
                    showMessage('投票成功！', 'success');
                }
                
            } catch (error) {
                console.error('Error handling vote:', error);
                showMessage('操作失敗，請稍後再試。', 'error');
            }
        }
        
        /**
         * Listens for peer review votes and updates UI.
         */
        function listenToPeerReviewVotes() {
            if (!classroomCode) return;
            
            const votesRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'peerReviewVotes');
            
            if (peerReviewUnsubscribe) {
                peerReviewUnsubscribe();
            }
            
            peerReviewUnsubscribe = onSnapshot(votesRef, (snapshot) => {
                const votes = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (!votes[data.workId]) {
                        votes[data.workId] = 0;
                    }
                    votes[data.workId]++;
                });
                
                allPeerReviewVotes = votes;
                
                // Update student UI
                if (currentRole === 'student' && !views.studentPeerReview.classList.contains('hidden')) {
                    updateStudentVoteUI(votes);
                    updateVoteCountDisplay();
                }
                
                // Update teacher UI
                if (currentRole === 'teacher' && !document.getElementById('peer-review-stats-container').classList.contains('hidden')) {
                    updateTeacherVoteStats(votes);
                }
            });
        }
        
        /**
         * Updates the vote counts in student UI.
         */
        function updateStudentVoteUI(votes) {
            document.querySelectorAll('.vote-count').forEach(span => {
                const workId = span.previousElementSibling.dataset.workId;
                const count = votes[workId] || 0;
                span.textContent = count;
                span.classList.toggle('zero', count === 0);
            });
        }
        
        /**
         * Updates the student's current vote count display.
         */
        function updateVoteCountDisplay() {
            const voteCountElement = document.getElementById('current-vote-count');
            if (voteCountElement) {
                voteCountElement.textContent = studentVotedWorks.size;
                
                // Change color based on vote count
                const container = voteCountElement.parentElement;
                container.className = 'inline-block px-4 py-2 rounded-full text-sm font-medium';
                
                if (studentVotedWorks.size === 0) {
                    container.classList.add('bg-gray-100', 'text-gray-600');
                } else if (studentVotedWorks.size < MAX_VOTES_PER_STUDENT) {
                    container.classList.add('bg-blue-100', 'text-blue-800');
                } else {
                    container.classList.add('bg-green-100', 'text-green-800');
                }
            }
        }
        
        /**
         * Restores student's voting history from Firebase.
         */
        async function restoreStudentVotingHistory() {
            if (!classroomCode || !studentName) return;
            
            try {
                const votesRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'peerReviewVotes');
                const votesSnapshot = await getDocs(votesRef);
                
                // Clear existing voting history
                studentVotedWorks.clear();
                
                // Find votes made by this student
                votesSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.voterName === studentName) {
                        studentVotedWorks.add(data.workId);
                    }
                });
                
                console.log('Restored student voting history:', Array.from(studentVotedWorks));
                
                // Update vote count display after restoration
                updateVoteCountDisplay();
            } catch (error) {
                console.error('Error restoring student voting history:', error);
            }
        }

        /**
         * Updates the teacher's vote statistics display.
         */
        function updateTeacherVoteStats(votes) {
            const statsGrid = document.getElementById('peer-review-stats-grid');
            statsGrid.innerHTML = '';
            
            // Sort works by vote count (descending)
            const sortedWorks = allStudentResponses.map(work => {
                const workId = `${work.name}-${work.timestamp || allStudentResponses.indexOf(work)}`;
                return {
                    ...work,
                    workId: workId,
                    votes: votes[workId] || 0
                };
            }).sort((a, b) => b.votes - a.votes);
            
            sortedWorks.forEach((work, index) => {
                const statsDiv = document.createElement('div');
                statsDiv.className = 'vote-stats-item';
                
                let contentHtml = '';
                if (currentInteractionMode === 'drawing') {
                    contentHtml = `<img src="${work.answer}" alt="學生作品">`;
                } else {
                    contentHtml = `<p>${work.answer}</p>`;
                }
                
                statsDiv.innerHTML = `
                    <div class="stats-author">${work.name}</div>
                    <div class="stats-content">${contentHtml}</div>
                    <div class="stats-votes">
                        <i class="fas fa-heart vote-icon"></i>
                        <span class="vote-count ${work.votes === 0 ? 'zero' : ''}">${work.votes}</span>
                    </div>
                `;
                
                statsGrid.appendChild(statsDiv);
            });
        }

        // --- Firebase Configuration Functions ---
        /**
         * Parse and apply Firebase configuration string
         */
        async function applyFirebaseConfig(rawConfigString, suppressMessage = false) {
            try {
                // Step 1: Clean up the input string
                let cleanedConfigString = rawConfigString.trim();

                // Step 2: Remove trailing comma if exists
                cleanedConfigString = cleanedConfigString.replace(/,\s*$/, "");

                // Step 3: Replace newlines with spaces (preserve existing commas)
                cleanedConfigString = cleanedConfigString.replace(/\s*\n\s*/g, ' ');

                // Step 4: Clean up multiple spaces
                cleanedConfigString = cleanedConfigString.replace(/\s+/g, ' ');

                // Step 5: Add quotes around property names
                // Only match property names at the start or after a comma
                // Pattern: (start of string or comma+spaces) + word + spaces + colon
                cleanedConfigString = cleanedConfigString.replace(/(^|,\s*)(\w+)\s*:/g, '$1"$2":');

                // Step 6: Build valid JSON string
                const jsonString = `{${cleanedConfigString}}`;

                console.log('Parsed JSON string:', jsonString); // For debugging

                firebaseConfig = JSON.parse(jsonString);

                if (!firebaseConfig.apiKey || !firebaseConfig.projectId || !firebaseConfig.authDomain) {
                    throw new Error("設定檔中缺少必要欄位 (apiKey, projectId, authDomain)");
                }

                // Initialize Firebase with the new config
                await initializeFirebase();

                if (!suppressMessage) {
                    showFirebaseCopyMessage("設定已成功套用！", false);
                }

                return true;
            } catch (error) {
                console.error("Firebase 設定檔處理失敗:", error);
                if (!suppressMessage) {
                    showFirebaseCopyMessage(`設定套用失敗: ${error.message}\n請檢查格式是否正確。`, true);
                }
                return false;
            }
        }

        /**
         * Initialize Firebase with the current configuration
         */
        async function initializeFirebase() {
            try {
                if (getApps().length > 0) {
                    const existingApp = getApp();
                    console.log("Existing Firebase app found. Deleting it to re-initialize...");
                    await deleteApp(existingApp);
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase 初始化成功");

                // Update Firebase Project ID display on main screen
                updateFirebaseProjectIdDisplay();
            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
                throw error;
            }
        }

        /**
         * Update Firebase Project ID display on the main screen
         */
        function updateFirebaseProjectIdDisplay() {
            const projectIdDisplay = document.getElementById('firebase-project-id-display');
            const projectIdWrapper = document.getElementById('firebase-project-id-display-wrapper');

            if (firebaseConfig && firebaseConfig.projectId && firebaseConfig.projectId !== 'demo') {
                if (projectIdDisplay) {
                    projectIdDisplay.textContent = firebaseConfig.projectId;
                }
                if (projectIdWrapper) {
                    projectIdWrapper.classList.remove('hidden');
                }
                console.log('Firebase Project ID 顯示已更新:', firebaseConfig.projectId);
            } else {
                // Hide if no valid projectId
                if (projectIdWrapper) {
                    projectIdWrapper.classList.add('hidden');
                }
            }
        }

        /**
         * Setup Firebase configuration from various sources
         * 優先順序：URL 參數 > localStorage > firebase-config.js > 原始碼硬編碼
         */
        async function setupFirebaseConfig() {
            const urlParams = new URLSearchParams(window.location.search);
            const configParam = urlParams.get('config');
            let rawConfigString = localStorage.getItem('firebaseConfig');
            let configSource = "localStorage";

            // Priority 1: Check URL parameter (優先使用 URL 參數)
            if (configParam) {
                try {
                    rawConfigString = atob(configParam);
                    configSource = "URL";
                } catch (e) {
                    console.error("URL config base64 解碼失敗:", e);
                    document.body.innerHTML = `<div class="text-center p-8 text-red-600"><h1 class="text-2xl font-bold">設定檔錯誤</h1><p>Firebase 設定檔錯誤，請點擊右上角 'Firebase 設定' 按鈕重新設定。</p></div>`;
                    return false;
                }
            }

            // Priority 2: Check external firebase-config.js
            if (!rawConfigString && typeof __firebase_config !== 'undefined') {
                try {
                    firebaseConfig = JSON.parse(__firebase_config);
                    await initializeFirebase();
                    isFirebaseConfigApplied = true;
                    console.log("已從外部 firebase-config.js 自動載入並套用 Firebase 設定。");
                    return true;
                } catch (error) {
                    console.error("外部 firebase-config.js 解析失敗:", error);
                }
            }

            // Apply config if found
            if (rawConfigString) {
                try {
                    const applySuccess = await applyFirebaseConfig(rawConfigString, true);
                    if (applySuccess) {
                        isFirebaseConfigApplied = true;
                        console.log(`已從 ${configSource} 自動載入並套用 Firebase 設定。`);

                        // If from URL, save to localStorage
                        if (configSource === "URL") {
                            localStorage.setItem('firebaseConfig', rawConfigString);
                            console.log("已將 URL 設定儲存至 localStorage");
                        }
                        return true;
                    }
                } catch (error) {
                    console.error("套用 Firebase 設定失敗:", error);
                }
            }

            // ============================================================================
            // 【Firebase 設定區】- 備用設定（優先權最低）
            // ============================================================================
            // 使用方式：將下方六行 "demo" 直接取代為您的 Firebase 設定值
            //
            // 1. 前往 Firebase Console > 專案設定 > 一般設定
            // 2. 在「您的應用程式」區塊找到 firebaseConfig
            // 3. 複製對應的值，取代下方的 "demo"
            //
            // 優先順序：localStorage > URL 參數 > firebase-config.js > 此設定
            // 如果上述來源都沒有設定，才會使用這裡的值
            // ============================================================================
            firebaseConfig = {
                apiKey: "AIzaSyBsFXGMfIn10eJTlNrRYE2es7eOoylt7yw",
  authDomain: "ckesclass06.firebaseapp.com",
  projectId: "ckesclass06",
  storageBucket: "ckesclass06.firebasestorage.app",
  messagingSenderId: "633812819202",
  appId: "1:633812819202:web:47cb568a53e2c4165ab61b"
            };
            // ============================================================================

            // Check if this is a valid config (not demo or starts with demo)
            if (firebaseConfig.apiKey !== "demo" && !firebaseConfig.apiKey.startsWith("demo")) {
                try {
                    await initializeFirebase();
                    isFirebaseConfigApplied = true;
                    console.log("已從原始碼中的備用設定自動載入並套用 Firebase 設定。");
                    return true;
                } catch (error) {
                    console.error("原始碼中的 Firebase 設定初始化失敗:", error);
                }
            }

            // No valid config found - return 'demo' to skip Firebase initialization
            console.warn("未找到 Firebase 設定，請使用右上角按鈕進行設定");
            // Don't initialize Firebase with demo config, just return 'demo'
            return 'demo';
        }

        /**
         * Show copy message in the Firebase settings modal
         */
        function showFirebaseCopyMessage(message, isError = false) {
            const msgElement = document.getElementById('firebase-copy-success-msg');
            msgElement.textContent = message;
            msgElement.classList.remove('hidden');

            if (isError) {
                msgElement.classList.remove('text-green-500');
                msgElement.classList.add('text-red-500');
            } else {
                msgElement.classList.remove('text-red-500');
                msgElement.classList.add('text-green-500');
            }

            setTimeout(() => {
                msgElement.classList.add('hidden');
            }, 4000);
        }

        /**
         * Handle apply settings button click
         */
        async function handleApplyFirebaseSettings() {
            const configContent = document.getElementById('firebase-config-textarea').value.trim();
            if (!configContent) {
                showFirebaseCopyMessage("請先貼上設定內容", true);
                return;
            }

            localStorage.setItem('firebaseConfigDraft', configContent);

            const applySuccess = await applyFirebaseConfig(configContent);

            if (applySuccess) {
                isFirebaseConfigApplied = true;
                document.getElementById('generate-firebase-url-btn').disabled = false;
                localStorage.setItem('firebaseConfig', configContent);

                // Close modal and reload to apply new config
                document.getElementById('firebase-settings-modal').classList.add('hidden');
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else {
                isFirebaseConfigApplied = false;
                document.getElementById('generate-firebase-url-btn').disabled = true;
                localStorage.removeItem('firebaseConfig');
            }
        }

        /**
         * Generate short URL using a free URL shortener service
         */
        async function generateShortUrl(longUrl) {
            try {
                // Try is.gd first (free, no API key needed)
                const response = await fetch(`https://is.gd/create.php?format=json&url=${encodeURIComponent(longUrl)}`);
                const data = await response.json();

                if (data.shorturl) {
                    console.log('短網址生成成功:', data.shorturl);
                    return data.shorturl;
                } else if (data.errormessage) {
                    console.warn('is.gd 錯誤:', data.errormessage);
                    // Fallback to TinyURL
                    return await generateShortUrlTinyURL(longUrl);
                }
            } catch (error) {
                console.warn('is.gd 失敗，嘗試 TinyURL:', error);
                // Fallback to TinyURL
                return await generateShortUrlTinyURL(longUrl);
            }

            // If all fails, return original URL
            return longUrl;
        }

        /**
         * Fallback: Generate short URL using TinyURL
         */
        async function generateShortUrlTinyURL(longUrl) {
            try {
                const response = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(longUrl)}`);
                const shortUrl = await response.text();

                if (shortUrl && shortUrl.startsWith('http')) {
                    console.log('TinyURL 短網址生成成功:', shortUrl);
                    return shortUrl;
                }
            } catch (error) {
                console.error('TinyURL 也失敗:', error);
            }

            // Return original URL if all shorteners fail
            console.warn('所有短網址服務都失敗，使用原始網址');
            return longUrl;
        }

        /**
         * Handle generate URL button click
         */
        let currentGeneratedUrl = ''; // Store current URL for QR code download
        let currentShortUrl = ''; // Store short URL

        async function handleGenerateFirebaseUrl() {
            const configContent = document.getElementById('firebase-config-textarea').value.trim();

            if (!configContent || !isFirebaseConfigApplied) {
                showFirebaseCopyMessage("請先成功套用設定", true);
                return;
            }

            try {
                // Show loading message
                showFirebaseCopyMessage("正在生成短網址，請稍候...", false);

                const base64Config = btoa(configContent);
                const newUrl = `${window.location.origin}${window.location.pathname}?config=${base64Config}&hideFirebaseBtn=true`;
                currentGeneratedUrl = newUrl; // Store original URL

                // Generate short URL
                const shortUrl = await generateShortUrl(newUrl);
                currentShortUrl = shortUrl; // Store short URL

                // Copy short URL to clipboard
                const tempInput = document.createElement('textarea');
                tempInput.value = shortUrl;
                tempInput.style.position = 'absolute';
                tempInput.style.left = '-9999px';
                document.body.appendChild(tempInput);
                tempInput.select();
                tempInput.setSelectionRange(0, 99999);

                let success = false;
                try {
                    success = document.execCommand('copy');
                } catch (err) {
                    console.error('無法自動複製:', err);
                }

                document.body.removeChild(tempInput);

                if (success) {
                    showFirebaseCopyMessage("短網址已複製到剪貼簿！", false);
                } else {
                    showFirebaseCopyMessage("複製網址失敗，請手動複製。", true);
                }

                // Display URLs in UI
                document.getElementById('firebase-short-url-display').value = shortUrl;
                document.getElementById('firebase-original-url-display').value = newUrl;
                document.getElementById('firebase-url-info').classList.remove('hidden');

                // Generate QR Code using short URL
                generateFirebaseQRCode(shortUrl);

            } catch (error) {
                console.error("生成網址失敗:", error);
                showFirebaseCopyMessage("生成網址失敗。", true);
            }
        }

        /**
         * Generate QR Code for the Firebase URL
         */
        function generateFirebaseQRCode(url) {
            const qrcodeContainer = document.getElementById('firebase-qrcode');
            const qrcodeContainerWrapper = document.getElementById('firebase-qrcode-container');

            // Clear previous QR code
            qrcodeContainer.innerHTML = '';

            // Generate new QR code
            try {
                new QRCode(qrcodeContainer, {
                    text: url,
                    width: 256,
                    height: 256,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

                // Show QR code container
                qrcodeContainerWrapper.classList.remove('hidden');

                console.log('QR Code 已生成');
            } catch (error) {
                console.error('生成 QR Code 失敗:', error);
                showFirebaseCopyMessage("生成 QR Code 失敗", true);
            }
        }

        /**
         * Download QR Code as image
         */
        function downloadFirebaseQRCode() {
            const qrcodeContainer = document.getElementById('firebase-qrcode');
            const canvas = qrcodeContainer.querySelector('canvas');

            if (!canvas) {
                showFirebaseCopyMessage("請先生成 QR Code", true);
                return;
            }

            try {
                // Convert canvas to blob and download
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'firebase-qrcode.png';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    showFirebaseCopyMessage("QR Code 已下載", false);
                });
            } catch (error) {
                console.error('下載 QR Code 失敗:', error);
                showFirebaseCopyMessage("下載 QR Code 失敗", true);
            }
        }

        /**
         * Handle clear Firebase configuration button click
         */
        function handleClearFirebaseConfig() {
            if (confirm('確定要清除本地儲存的 Firebase 設定嗎？清除後需要重新整理頁面才會生效。')) {
                // Clear all Firebase-related data from localStorage
                localStorage.removeItem('firebaseConfig');
                localStorage.removeItem('firebaseConfigDraft');

                // Clear the textarea
                document.getElementById('firebase-config-textarea').value = '';

                // Show success message
                showFirebaseCopyMessage("本地設定值已清除，請重新整理頁面", false);

                // Disable generate URL button
                document.getElementById('generate-firebase-url-btn').disabled = true;

                // Hide URL info and QR code if visible
                document.getElementById('firebase-url-info').classList.add('hidden');
                document.getElementById('firebase-qrcode-container').classList.add('hidden');

                // Hide Firebase Project ID display on main screen
                const projectIdWrapper = document.getElementById('firebase-project-id-display-wrapper');
                if (projectIdWrapper) {
                    projectIdWrapper.classList.add('hidden');
                }

                console.log("Firebase 本地設定已清除");
            }
        }

        /**
         * Load recent classrooms from localStorage and populate teacher select dropdown
         */
        function loadRecentClassrooms() {
            const recentClassroomsStr = localStorage.getItem('recentClassrooms');
            if (!recentClassroomsStr) {
                return;
            }

            try {
                const recentClassrooms = JSON.parse(recentClassroomsStr);
                if (!Array.isArray(recentClassrooms) || recentClassrooms.length === 0) {
                    return;
                }

                // Get teacher elements
                const container = document.getElementById('teacher-recent-classrooms-container');
                const select = document.getElementById('teacher-recent-classrooms-select');

                if (!container || !select) {
                    return;
                }

                // Clear existing options except the first one
                select.innerHTML = '<option value="">-- 選擇教室代碼 --</option>';

                // Add classroom codes as options
                recentClassrooms.forEach(code => {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = code;
                    select.appendChild(option);
                });

                container.classList.remove('hidden');
            } catch (error) {
                console.error('載入最近教室代碼失敗:', error);
            }
        }

        /**
         * Save classroom code to recent classrooms in localStorage
         * @param {string} code - Classroom code to save
         */
        function saveRecentClassroom(code) {
            if (!code) return;

            try {
                const recentClassroomsStr = localStorage.getItem('recentClassrooms');
                let recentClassrooms = [];

                if (recentClassroomsStr) {
                    recentClassrooms = JSON.parse(recentClassroomsStr);
                }

                // Remove if already exists (to move to front)
                recentClassrooms = recentClassrooms.filter(c => c !== code);

                // Add to front
                recentClassrooms.unshift(code);

                // Keep only last 5
                recentClassrooms = recentClassrooms.slice(0, 5);

                localStorage.setItem('recentClassrooms', JSON.stringify(recentClassrooms));
            } catch (error) {
                console.error('保存最近教室代碼失敗:', error);
            }
        }

        /**
         * Remove classroom code from recent classrooms in localStorage
         * @param {string} code - Classroom code to remove
         */
        function removeRecentClassroom(code) {
            if (!code) return;

            try {
                const recentClassroomsStr = localStorage.getItem('recentClassrooms');
                if (!recentClassroomsStr) {
                    return;
                }

                let recentClassrooms = JSON.parse(recentClassroomsStr);

                // Remove the code from the list
                recentClassrooms = recentClassrooms.filter(c => c !== code);

                // Save back to localStorage
                if (recentClassrooms.length > 0) {
                    localStorage.setItem('recentClassrooms', JSON.stringify(recentClassrooms));
                } else {
                    // If list is empty, remove the key entirely
                    localStorage.removeItem('recentClassrooms');
                }

                console.log(`已從最近教室列表中刪除: ${code}`);
            } catch (error) {
                console.error('刪除最近教室代碼失敗:', error);
            }
        }

        // --- Initialization Function ---
        async function initialize() {
            // Check if hideFirebaseBtn parameter is present in URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('hideFirebaseBtn') === 'true') {
                const firebaseBtn = document.getElementById('firebase-settings-btn');
                if (firebaseBtn) {
                    firebaseBtn.style.display = 'none';
                    console.log('Firebase 設定按鈕已隱藏（因 URL 參數 hideFirebaseBtn=true）');
                }
            }

            // Setup Firebase configuration first
            const configResult = await setupFirebaseConfig();
            if (!configResult) {
                console.error("Firebase 設定失敗");
                return;
            }

            // Check if using demo config (no real Firebase setup)
            if (configResult === 'demo') {
                console.warn("未設定 Firebase，請點擊右上角「Firebase 設定」按鈕進行設定");
                // Show entry view without Firebase initialization
                showView('entry');

                // Show warning message on the page
                const entryView = document.getElementById('entry-view');
                if (entryView && !document.getElementById('firebase-warning-banner')) {
                    const warningBanner = document.createElement('div');
                    warningBanner.id = 'firebase-warning-banner';
                    warningBanner.className = 'fixed top-16 left-0 right-0 bg-yellow-100 border-b-2 border-yellow-400 p-3 text-center z-10';
                    warningBanner.innerHTML = `
                        <p class="text-yellow-800 font-semibold">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            尚未設定 Firebase，請點擊右上角「Firebase 設定」按鈕進行設定
                        </p>
                    `;
                    document.body.insertBefore(warningBanner, document.body.firstChild);
                }
                return; // Stop initialization here
            }

            loadAISettings();
            loadDispatchSettings(); // Load saved combined dispatch settings

            onAuthStateChanged(auth, async user => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = userId;
                    console.log("Authenticated User ID:", userId);
                    // setupEventListeners(); // Moved this call outside onAuthStateChanged

                    // Check if teacher has a persisted classroom code
                    const savedTeacherClassroomCode = localStorage.getItem('teacherClassroomCode');
                    if (savedTeacherClassroomCode) {
                        classroomCode = savedTeacherClassroomCode;
                        currentRole = 'teacher';
                        document.getElementById('end-class-button-text').textContent = `下課 教室代碼: ${classroomCode}`; // Update button text
                        document.getElementById('end-class-monitor-button-text').textContent = `下課 教室代碼: ${classroomCode}`; // Update button text for monitor view
                        
                        // NEW: Fetch initial pause state and dispatch settings for teacher
                        const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                        const docSnap = await getDoc(controlRef);
                        if (docSnap.exists()) {
                            isResponsePaused = docSnap.data().isPaused || false;
                            // MODIFIED: Load dispatchSettings from Firestore
                            const fetchedDispatchSettings = docSnap.data().dispatchSettings;
                            if (fetchedDispatchSettings) {
                                dispatchSettings.type = fetchedDispatchSettings.type || 'url';
                                dispatchSettings.url = fetchedDispatchSettings.url || '';
                                dispatchSettings.isYoutube = fetchedDispatchSettings.isYoutube || false;
                                dispatchSettings.htmlContent = fetchedDispatchSettings.htmlContent || null;
                            }
                            // NEW: Load custom multiple choice questions from Firestore
                            currentMultipleChoiceQuestions = docSnap.data().multiple_choice_questions || null;
                            customMultipleChoiceQuestions = currentMultipleChoiceQuestions || []; // Sync for teacher UI
                        } else {
                            isResponsePaused = false; // Default to not paused if control doc doesn't exist
                            // dispatchSettings remains at its default or loaded localStorage value
                            currentMultipleChoiceQuestions = null;
                            customMultipleChoiceQuestions = [];
                        }
                        updateTeacherPauseButtonUI(); // Update button UI based on fetched state

                        // Load question banks for this classroom
                        loadQuestionBanksFromStorage();
                        loadSequencingBanksFromStorage();
                        loadMatchingBanksFromStorage();
                        loadReadingBanksFromStorage();

                        listenToClassroomPresence(); // Ensure presence listener is established here and remains active
                        showView('teacherMenu');
                    } else {
                        showView('entry');
                    }
                } else {
                    console.error("Authentication failed, user is null.");
                    // If user is null (e.g., after signOut), ensure we are on the entry view.
                    showView('entry'); 
                }
            });

            document.getElementById('app-id-display').textContent = baseAppId; // Display the base app ID
            
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                console.error("Firebase Authentication failed:", error);
                document.body.innerHTML = `<div class="text-center p-8 text-red-600"><h1 class="text-2xl font-bold">驗證失敗</h1><p>無法連接至互動服務，請檢查 Firebase 設定或網路連線。</p><p class=\"text-sm mt-2\">${error.message}</p></div>`;
            }
        }

        // Add beforeunload handler to warn user about closing window
        let hasEndedClass = false;
        
        // Track when user clicks the end class button
        function markClassEnded() {
            hasEndedClass = true;
        }
        
        // Set up window close warning
        window.onbeforeunload = function() {
            if (!hasEndedClass) {
                return '請先按下紅色下課鍵，再關閉視窗，本提示請先按取消';
            }
        };

        // --- Quick Answer Functions ---
        let quickAnswerActive = false;
        let quickAnswerWinner = null;
        let quickAnswerWinnerDisplayed = false;

        function startQuickAnswer() {
            quickAnswerActive = true;
            quickAnswerWinner = null;
            quickAnswerWinnerDisplayed = false;

            // Update status text
            document.getElementById('quick-answer-status-text').textContent = '搶答開始！快點擊按鈕！';

            // Generate random position for the button
            const container = document.getElementById('quick-answer-button-container');
            container.innerHTML = '';
            container.classList.remove('pointer-events-none');

            // Create the quick answer button
            const button = document.createElement('button');
            button.className = 'quick-answer-btn';
            button.textContent = '快點我';

            // Calculate random position (ensure button is fully visible)
            const containerRect = container.getBoundingClientRect();
            const buttonSize = 200; // 200px width and height
            const maxLeft = containerRect.width - buttonSize;
            const maxTop = containerRect.height - buttonSize;

            const randomLeft = Math.random() * Math.max(0, maxLeft);
            const randomTop = Math.random() * Math.max(0, maxTop);

            button.style.left = randomLeft + 'px';
            button.style.top = randomTop + 'px';

            // Add click handler
            button.addEventListener('click', handleQuickAnswerClick);

            container.appendChild(button);
        }

        async function handleQuickAnswerClick() {
            if (!quickAnswerActive || quickAnswerWinner) return;

            try {
                // Submit the quick answer to Firebase
                const response = `搶答成功：${studentName}`;
                console.log('Submitting quick answer:', response);
                await submitAnswer(response);
                console.log('Quick answer submitted successfully');

                // Show success message
                document.getElementById('quick-answer-result').classList.remove('hidden');
                document.getElementById('quick-answer-status-text').textContent = '你搶答成功了！';

                // Lock the button
                lockQuickAnswerButton();

            } catch (error) {
                console.error('Failed to submit quick answer:', error);
                showMessage('搶答提交失敗！', 'error');
            }
        }

        function lockQuickAnswerButton() {
            const button = document.querySelector('.quick-answer-btn');
            if (button) {
                button.classList.add('locked');
                button.disabled = true;
                button.removeEventListener('click', handleQuickAnswerClick);
            }

            // Show locked message for other students
            document.getElementById('quick-answer-locked').classList.remove('hidden');
            document.getElementById('quick-answer-result').classList.add('hidden');
        }

        // Listen for quick answer winner updates
        function listenToQuickAnswerUpdates() {
            if (currentRole !== 'student' || currentInteractionMode !== 'quick_answer') return;

            const responsesRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
            onSnapshot(responsesRef, (snapshot) => {
                if (snapshot.empty) return;

                const responses = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.answer && data.answer.includes('搶答成功')) {
                        responses.push(data);
                    }
                });

                // If someone already answered and it's not this student, lock the button
                if (responses.length > 0 && !quickAnswerWinner) {
                    const winner = responses[0];
                    if (winner.name !== studentName) {
                        quickAnswerWinner = winner.name;
                        lockQuickAnswerButton();
                        document.getElementById('quick-answer-status-text').textContent = `${winner.name} 搶答成功！`;
                    }
                }
            });
        }

        function showQuickAnswerWinner(winnerName) {
            console.log('showQuickAnswerWinner called with:', winnerName);
            if (quickAnswerWinnerDisplayed) {
                console.log('Winner already displayed, skipping');
                return; // Prevent showing multiple times
            }
            quickAnswerWinnerDisplayed = true;
            console.log('Displaying winner overlay');

            // Create a big overlay notification for the teacher
            const overlay = document.createElement('div');
            overlay.id = 'quick-answer-winner-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                animation: fadeIn 0.5s ease-in-out;
            `;

            overlay.innerHTML = `
                <div style="text-align: center; color: white; font-size: 3rem; font-weight: bold;">
                    <i class="fas fa-trophy" style="color: #ffd700; font-size: 6rem; margin-bottom: 20px;"></i>
                    <h1 style="margin: 20px 0; color: #4ade80;">搶答成功！</h1>
                    <h2 style="margin: 20px 0; color: #60a5fa; font-size: 4rem;">${winnerName}</h2>
                    <p style="font-size: 1.5rem; color: #d1d5db;">點擊任意位置關閉</p>
                </div>
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; transform: scale(0.8); }
                        to { opacity: 1; transform: scale(1); }
                    }
                </style>
            `;

            // Add click handler to close the overlay
            overlay.addEventListener('click', () => {
                overlay.remove();
                quickAnswerWinnerDisplayed = false; // Reset for next round
            });

            document.body.appendChild(overlay);

            // Auto close after 5 seconds
            setTimeout(() => {
                if (overlay.parentElement) {
                    overlay.remove();
                    quickAnswerWinnerDisplayed = false;
                }
            }, 5000);
        }

        // --- Quick Poll Functions ---

        /**
         * Shows the quick poll settings modal
         */
        function showQuickPollSettingsModal() {
            document.getElementById('quick-poll-settings-modal').classList.remove('hidden');
            // Reset form
            document.querySelector('input[name="pollType"][value="emoji"]').checked = true;
            document.getElementById('custom-poll-options-section').classList.add('hidden');
            document.getElementById('custom-poll-options-input').value = '';
            document.getElementById('quick-poll-anonymous-checkbox').checked = true;
        }

        /**
         * Hides the quick poll settings modal
         */
        function hideQuickPollSettingsModal() {
            document.getElementById('quick-poll-settings-modal').classList.add('hidden');
        }

        /**
         * Gets poll options based on selected type
         */
        function getPollOptions(pollType, customOptions = '') {
            switch(pollType) {
                case 'emoji':
                    return ['😊', '😐', '😕'];
                case 'simple':
                    return ['同意', '不同意', '不確定'];
                case 'rating5':
                    return ['1', '2', '3', '4', '5'];
                case 'rating10':
                    return ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'];
                case 'custom':
                    return customOptions.split('\n').filter(opt => opt.trim() !== '').map(opt => opt.trim());
                default:
                    return [];
            }
        }

        /**
         * Starts a quick poll
         */
        async function startQuickPoll() {
            const question = '快速投票';
            const pollType = document.querySelector('input[name="pollType"]:checked').value;
            const anonymous = document.getElementById('quick-poll-anonymous-checkbox').checked;
            const customOptions = document.getElementById('custom-poll-options-input').value;

            // Validation
            const options = getPollOptions(pollType, customOptions);
            if (options.length === 0) {
                showMessage('請設定有效的投票選項！', 'error');
                return;
            }

            try {
                // Initialize vote counts
                const voteCounts = {};
                options.forEach(opt => voteCounts[opt] = 0);

                // Save poll configuration to Firebase
                quickPollData = {
                    question,
                    pollType,
                    options,
                    anonymous,
                    voteCounts,
                    active: true,
                    timestamp: Date.now()
                };

                const pollRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'quickPoll', 'config');
                await setDoc(pollRef, quickPollData);

                // Clear previous votes
                const votesRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'quickPollVotes');
                const votesSnapshot = await getDocs(votesRef);
                const deletePromises = votesSnapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);

                // Set interaction mode to quick_poll
                await setInteractionMode('quick_poll');

                quickPollActive = true;
                hideQuickPollSettingsModal();

                // Show stats modal for teacher
                showQuickPollStatsModal();

                // Start listening to votes
                listenToQuickPollVotes();

                showMessage('快速投票已開始！', 'success');
            } catch (error) {
                console.error('Error starting quick poll:', error);
                showMessage('啟動快速投票時發生錯誤，請稍後再試。', 'error');
            }
        }

        /**
         * Shows the quick poll statistics modal
         */
        function showQuickPollStatsModal() {
            const modal = document.getElementById('quick-poll-stats-modal');
            modal.classList.remove('hidden');

            // Display question
            document.getElementById('quick-poll-stats-question').textContent = quickPollData.question;

            // Display online student count
            document.getElementById('poll-online-students').textContent = activeStudentNames.length;

            // Initialize chart
            currentChartType = 'bar';
            updateChartButtonStyles();
            updateQuickPollChart();
        }

        /**
         * Hides the quick poll statistics modal
         */
        function hideQuickPollStatsModal() {
            document.getElementById('quick-poll-stats-modal').classList.add('hidden');
        }

        /**
         * Ends the current quick poll
         */
        async function endQuickPoll() {
            try {
                // Set poll as inactive
                const pollRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'quickPoll', 'config');
                await setDoc(pollRef, { active: false }, { merge: true });

                // Stop interaction
                await setInteractionMode('waiting');

                quickPollActive = false;
                hideQuickPollStatsModal();

                // Unsubscribe from votes listener
                if (quickPollVotesUnsubscribe) {
                    quickPollVotesUnsubscribe();
                    quickPollVotesUnsubscribe = null;
                }

                showMessage('快速投票已結束！', 'info');
            } catch (error) {
                console.error('Error ending quick poll:', error);
                showMessage('結束投票時發生錯誤，請稍後再試。', 'error');
            }
        }

        /**
         * Listens for vote updates
         */
        function listenToQuickPollVotes() {
            if (!classroomCode || !quickPollData) return;

            const votesRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'quickPollVotes');

            if (quickPollVotesUnsubscribe) {
                quickPollVotesUnsubscribe();
            }

            quickPollVotesUnsubscribe = onSnapshot(votesRef, (snapshot) => {
                // Aggregate votes
                const voteCounts = {};
                quickPollData.options.forEach(opt => voteCounts[opt] = 0);

                snapshot.forEach(doc => {
                    const voteData = doc.data();
                    if (voteData.option && voteCounts.hasOwnProperty(voteData.option)) {
                        voteCounts[voteData.option]++;
                    }
                });

                // Update quickPollData
                quickPollData.voteCounts = voteCounts;

                // Update UI if teacher is viewing stats
                if (currentRole === 'teacher' && !document.getElementById('quick-poll-stats-modal').classList.contains('hidden')) {
                    updateQuickPollChart();
                    updateQuickPollTable();
                }
            });
        }

        /**
         * Updates the quick poll chart
         */
        function updateQuickPollChart() {
            if (!quickPollData) return;

            const svg = d3.select("#quick-poll-chart-svg");
            svg.selectAll("*").remove(); // Clear previous chart

            const data = quickPollData.options.map(opt => ({
                label: opt,
                value: quickPollData.voteCounts[opt] || 0
            }));

            const totalVotes = data.reduce((sum, d) => sum + d.value, 0);
            document.getElementById('poll-total-votes').textContent = totalVotes;

            if (currentChartType === 'bar') {
                drawQuickPollBarChart(svg, data);
            } else {
                drawQuickPollPieChart(svg, data);
            }
        }

        /**
         * Draws a bar chart for quick poll
         */
        function drawQuickPollBarChart(svg, data) {
            const width = 800;
            const height = 450;
            const margin = {top: 20, right: 20, bottom: 60, left: 60};
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // X scale
            const x = d3.scaleBand()
                .range([0, chartWidth])
                .padding(0.2)
                .domain(data.map(d => d.label));

            // Y scale
            const maxValue = d3.max(data, d => d.value) || 1;
            const y = d3.scaleLinear()
                .range([chartHeight, 0])
                .domain([0, maxValue]);

            // Color scale
            const color = d3.scaleOrdinal()
                .domain(data.map(d => d.label))
                .range(['#84cc16', '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7']);

            // X axis
            g.append("g")
                .attr("transform", `translate(0,${chartHeight})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .style("font-size", "14px")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");

            // Y axis
            g.append("g")
                .call(d3.axisLeft(y).ticks(5))
                .selectAll("text")
                .style("font-size", "14px");

            // Bars
            g.selectAll(".bar")
                .data(data)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.label))
                .attr("y", d => y(d.value))
                .attr("width", x.bandwidth())
                .attr("height", d => chartHeight - y(d.value))
                .attr("fill", d => color(d.label))
                .attr("rx", 4);

            // Value labels on top of bars
            g.selectAll(".label")
                .data(data)
                .enter()
                .append("text")
                .attr("class", "label")
                .attr("x", d => x(d.label) + x.bandwidth() / 2)
                .attr("y", d => y(d.value) - 5)
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .style("font-weight", "bold")
                .style("fill", "#374151")
                .text(d => d.value);
        }

        /**
         * Draws a pie chart for quick poll
         */
        function drawQuickPollPieChart(svg, data) {
            const width = 800;
            const height = 450;
            const radius = Math.min(width, height) / 2 - 40;

            const g = svg.append("g").attr("transform", `translate(${width / 2},${height / 2})`);

            // Color scale
            const color = d3.scaleOrdinal()
                .domain(data.map(d => d.label))
                .range(['#84cc16', '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7']);

            const pie = d3.pie().value(d => d.value).sort(null);
            const arc = d3.arc().innerRadius(0).outerRadius(radius);
            const labelArc = d3.arc().innerRadius(radius * 0.6).outerRadius(radius * 0.6);

            const arcs = g.selectAll(".arc")
                .data(pie(data))
                .enter()
                .append("g")
                .attr("class", "arc");

            arcs.append("path")
                .attr("d", arc)
                .attr("fill", d => color(d.data.label))
                .attr("stroke", "white")
                .attr("stroke-width", 2);

            // Labels
            arcs.append("text")
                .attr("transform", d => `translate(${labelArc.centroid(d)})`)
                .attr("text-anchor", "middle")
                .style("font-size", "14px")
                .style("font-weight", "bold")
                .style("fill", "white")
                .each(function(d) {
                    const text = d3.select(this);
                    text.append("tspan")
                        .attr("x", 0)
                        .attr("dy", "-0.2em")
                        .text(d.data.label);
                    text.append("tspan")
                        .attr("x", 0)
                        .attr("dy", "1.2em")
                        .text(d.data.value);
                });
        }

        /**
         * Updates the quick poll data table
         */
        function updateQuickPollTable() {
            if (!quickPollData) return;

            const tbody = document.getElementById('quick-poll-stats-table-body');
            tbody.innerHTML = '';

            const totalVotes = Object.values(quickPollData.voteCounts).reduce((sum, val) => sum + val, 0);

            quickPollData.options.forEach(opt => {
                const count = quickPollData.voteCounts[opt] || 0;
                const percentage = totalVotes > 0 ? ((count / totalVotes) * 100).toFixed(1) : '0.0';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border px-4 py-2">${opt}</td>
                    <td class="border px-4 py-2 text-right font-bold">${count}</td>
                    <td class="border px-4 py-2 text-right">${percentage}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        /**
         * Switches between chart types
         */
        function switchChartType(type) {
            currentChartType = type;
            updateChartButtonStyles();
            updateQuickPollChart();
        }

        /**
         * Updates chart type button styles
         */
        function updateChartButtonStyles() {
            const barBtn = document.getElementById('chart-type-bar-btn');
            const pieBtn = document.getElementById('chart-type-pie-btn');

            if (currentChartType === 'bar') {
                barBtn.classList.remove('btn-gray');
                barBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                pieBtn.classList.add('btn-gray');
                pieBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            } else {
                pieBtn.classList.remove('btn-gray');
                pieBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                barBtn.classList.add('btn-gray');
                barBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            }
        }

        /**
         * Downloads poll results as CSV
         */
        async function downloadPollResults() {
            if (!quickPollData) return;

            const totalVotes = Object.values(quickPollData.voteCounts).reduce((sum, val) => sum + val, 0);

            let csv = '\uFEFF'; // BOM for Excel UTF-8 support
            csv += `快速投票結果\n`;
            csv += `問題,${quickPollData.question}\n`;
            csv += `總投票數,${totalVotes}\n`;
            csv += `投票模式,${quickPollData.anonymous ? '匿名' : '記名'}\n`;
            csv += `\n`;

            // Summary table
            csv += `選項統計\n`;
            csv += `選項,票數,百分比\n`;
            quickPollData.options.forEach(opt => {
                const count = quickPollData.voteCounts[opt] || 0;
                const percentage = totalVotes > 0 ? ((count / totalVotes) * 100).toFixed(1) : '0.0';
                csv += `${opt},${count},${percentage}%\n`;
            });

            // Detailed votes if not anonymous
            if (!quickPollData.anonymous) {
                csv += `\n詳細投票記錄\n`;
                csv += `學生姓名,選項,投票時間\n`;

                try {
                    const votesRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'quickPollVotes');
                    const votesSnapshot = await getDocs(votesRef);

                    votesSnapshot.forEach(doc => {
                        const voteData = doc.data();
                        const studentName = voteData.studentName || '未知';
                        const option = voteData.option || '';
                        const timestamp = voteData.timestamp ? new Date(voteData.timestamp).toLocaleString('zh-TW') : '';
                        csv += `${studentName},${option},${timestamp}\n`;
                    });
                } catch (error) {
                    console.error('Error fetching vote details:', error);
                }
            }

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `快速投票結果_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();

            showMessage('投票結果已下載！', 'success');
        }

        /**
         * Student submits a vote
         */
        async function submitQuickPollVote(option) {
            if (!classroomCode || !studentName) return;

            const pollKey = `quickPoll_${classroomCode}_${quickPollData.timestamp}`;

            // Check if already voted (using localStorage)
            if (localStorage.getItem(pollKey)) {
                showMessage('您已經投過票了！', 'info');
                return;
            }

            try {
                // Generate unique vote ID (anonymous or with student name based on settings)
                const voteId = quickPollData.anonymous
                    ? `anonymous_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                    : `${studentName}_${Date.now()}`;

                const voteRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'quickPollVotes', voteId);
                const voteData = {
                    option,
                    timestamp: Date.now()
                };

                // Add student name if not anonymous
                if (!quickPollData.anonymous) {
                    voteData.studentName = studentName;
                }

                await setDoc(voteRef, voteData);

                // Mark as voted in localStorage
                localStorage.setItem(pollKey, 'true');

                // Hide options, show success message
                document.getElementById('quick-poll-options-container').classList.add('hidden');
                document.getElementById('quick-poll-voted-status').classList.remove('hidden');

                showMessage('投票成功！感謝您的參與', 'success');
            } catch (error) {
                console.error('Error submitting vote:', error);
                showMessage('投票失敗，請稍後再試。', 'error');
            }
        }

        /**
         * Displays quick poll for students
         */
        function displayQuickPollForStudent(pollData) {
            if (!pollData || !pollData.active) return;

            quickPollData = pollData;

            // Use timestamp to create unique key for each poll session
            const pollKey = `quickPoll_${classroomCode}_${pollData.timestamp}`;
            const hasVoted = localStorage.getItem(pollKey);

            // Display question
            document.getElementById('quick-poll-question-display').textContent = pollData.question;

            const optionsContainer = document.getElementById('quick-poll-options-container');
            optionsContainer.innerHTML = '';

            if (hasVoted) {
                // Already voted - show success message
                optionsContainer.classList.add('hidden');
                document.getElementById('quick-poll-voted-status').classList.remove('hidden');
            } else {
                // Not voted yet - show options
                optionsContainer.classList.remove('hidden');
                document.getElementById('quick-poll-voted-status').classList.add('hidden');

                // Create buttons based on poll type
                if (pollData.pollType === 'emoji') {
                    optionsContainer.className = 'flex justify-center gap-6';
                    pollData.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'text-8xl hover:scale-110 transition-transform duration-200 p-4 rounded-lg hover:bg-gray-100';
                        btn.textContent = opt;
                        btn.addEventListener('click', () => submitQuickPollVote(opt));
                        optionsContainer.appendChild(btn);
                    });
                } else if (pollData.pollType === 'rating5' || pollData.pollType === 'rating10') {
                    optionsContainer.className = 'flex justify-center gap-3 flex-wrap';
                    pollData.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'btn bg-lime-500 hover:bg-lime-600 !w-20 !h-20 text-4xl font-bold';
                        btn.textContent = opt;
                        btn.addEventListener('click', () => submitQuickPollVote(opt));
                        optionsContainer.appendChild(btn);
                    });
                } else {
                    optionsContainer.className = 'space-y-3';
                    pollData.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'btn bg-lime-500 hover:bg-lime-600 w-full h-16 text-2xl';
                        btn.textContent = opt;
                        btn.addEventListener('click', () => submitQuickPollVote(opt));
                        optionsContainer.appendChild(btn);
                    });
                }
            }
        }

        /**
         * Listens for quick poll configuration changes (for students)
         */
        function listenToQuickPollConfig() {
            if (!classroomCode) return;

            const pollRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'quickPoll', 'config');
            onSnapshot(pollRef, (doc) => {
                if (doc.exists()) {
                    const pollData = doc.data();
                    if (pollData.active && currentRole === 'student' && currentInteractionMode === 'quick_poll') {
                        displayQuickPollForStudent(pollData);
                    }
                }
            });
        }

        // === Reading Comprehension Functions ===

        /**
         * Show reading comprehension settings modal
         */
        function showReadingComprehensionModal() {
            // Update reading bank list for current classroom
            updateReadingBankList();

            document.getElementById('reading-comprehension-settings-modal').classList.remove('hidden');
            // Populate with existing data if any
            document.getElementById('reading-text-textarea').value = readingComprehensionData.text || '';
            if (readingComprehensionData.questions && readingComprehensionData.questions.length > 0) {
                document.getElementById('reading-questions-textarea').value = readingComprehensionData.questions.map(q => {
                    return `${q.question},${q.correctAnswer},${q.options.join(',')},${q.level}`;
                }).join('\n');
            } else {
                document.getElementById('reading-questions-textarea').value = '';
            }
        }

        /**
         * Hide reading comprehension settings modal
         */
        function hideReadingComprehensionModal() {
            document.getElementById('reading-comprehension-settings-modal').classList.add('hidden');
        }

        /**
         * Parse reading comprehension questions
         * Supports both comma and tab delimiters
         */
        function parseReadingQuestions(text) {
            const lines = text.trim().split('\n').filter(line => line.trim().length > 0);
            const questions = [];

            for (const line of lines) {
                // Try to detect delimiter: if line contains tab, use tab; otherwise use comma
                const delimiter = line.includes('\t') ? '\t' : ',';
                const parts = line.split(delimiter).map(p => p.trim());

                if (parts.length < 6) {
                    return null; // Invalid format - need at least question, answer, and 4 options
                }

                const question = parts[0];
                let correctAnswer = parts[1];
                const options = [parts[2], parts[3], parts[4], parts[5]];
                // Level is optional, default to 1 if not provided
                const level = parts[6] ? parseInt(parts[6]) : 1;

                // Convert A-D to 1-4
                if (correctAnswer.match(/^[A-Da-d]$/)) {
                    correctAnswer = correctAnswer.toUpperCase().charCodeAt(0) - 64; // A=1, B=2, C=3, D=4
                } else {
                    correctAnswer = parseInt(correctAnswer);
                }

                if (!question || isNaN(correctAnswer) || correctAnswer < 1 || correctAnswer > 4 ||
                    options.length !== 4 || isNaN(level) || level < 1 || level > 4) {
                    return null; // Invalid format
                }

                questions.push({ question, correctAnswer, options, level });
            }

            return questions.length > 0 ? questions : null;
        }

        /**
         * Start reading comprehension interaction
         */
        async function startReadingComprehension() {
            const readingText = document.getElementById('reading-text-textarea').value.trim();
            const questionsText = document.getElementById('reading-questions-textarea').value.trim();

            if (!readingText || !questionsText) {
                showMessage('請輸入閱讀文本和題目！', 'error');
                return;
            }

            const questions = parseReadingQuestions(questionsText);
            if (!questions) {
                document.getElementById('reading-questions-status').classList.remove('hidden');
                return;
            }

            readingComprehensionData = { text: readingText, questions: questions };
            document.getElementById('reading-questions-status').classList.add('hidden');
            hideReadingComprehensionModal();

            // Set mode and dispatch to Firebase
            const mode = 'reading_comprehension';
            await setInteractionMode(mode, { readingData: readingComprehensionData });
            showView('teacherMonitor');
        }

        /**
         * Display reading comprehension for student
         */
        async function displayReadingComprehensionForStudent(readingData) {
            console.log('[displayReadingComprehensionForStudent] Called with data:', readingData);
            const textDisplay = document.getElementById('reading-text-display');
            const questionsContainer = document.getElementById('reading-questions-container');

            if (!textDisplay || !questionsContainer) {
                console.error('[displayReadingComprehensionForStudent] Elements not found!');
                return;
            }

            // Store reading data for student to use when submitting
            if (currentRole === 'student') {
                readingComprehensionData = readingData;
            }

            // Process text for highlighting - wrap in spans
            textDisplay.innerHTML = '';
            const text = readingData.text;
            // Split text by sentences (keep whitespace structure)
            const lines = text.split('\n');
            lines.forEach((line, lineIndex) => {
                if (line.trim()) {
                    const lineSpan = document.createElement('span');
                    lineSpan.textContent = line;
                    lineSpan.dataset.lineIndex = lineIndex;
                    textDisplay.appendChild(lineSpan);
                }
                if (lineIndex < lines.length - 1) {
                    textDisplay.appendChild(document.createTextNode('\n'));
                }
            });

            questionsContainer.innerHTML = '';
            console.log('[displayReadingComprehensionForStudent] Set text:', readingData.text);

            // Initialize highlighter after text is displayed
            initializeHighlighter();

            // Determine which answers to restore
            let answersToRestore = [];

            // Priority 1: Use current local answers (not yet submitted)
            if (currentReadingAnswers.length > 0) {
                answersToRestore = currentReadingAnswers;
                console.log('[displayReadingComprehensionForStudent] Restoring local answers:', answersToRestore);
            }
            // Priority 2: Check if student has already submitted answers to Firebase
            else if (currentRole === 'student' && studentName && classroomCode) {
                try {
                    const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
                    const docSnap = await getDoc(studentRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        // Check if answer is a JSON string or array
                        if (typeof data.answer === 'string') {
                            try {
                                answersToRestore = JSON.parse(data.answer);
                            } catch (e) {
                                answersToRestore = [];
                            }
                        } else if (Array.isArray(data.answer)) {
                            answersToRestore = data.answer;
                        }
                        console.log('[displayReadingComprehensionForStudent] Restoring submitted answers:', answersToRestore);
                    }
                } catch (error) {
                    console.error('Error fetching previous answers:', error);
                }
            }

            // Initialize currentReadingAnswers if empty
            if (currentReadingAnswers.length === 0) {
                currentReadingAnswers = new Array(readingData.questions.length).fill(0);
            }

            readingData.questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-card';

                // Get answer for this question (if exists)
                const selectedAnswer = answersToRestore[index] || 0;

                // Difficulty badge
                const levelBadge = q.level ? `<span class="inline-block px-2 py-1 text-xs font-semibold rounded-full ${
                    q.level === '直接理解' ? 'bg-green-100 text-green-800' :
                    q.level === '推論理解' ? 'bg-yellow-100 text-yellow-800' :
                    q.level === '詮釋整合' ? 'bg-orange-100 text-orange-800' :
                    'bg-purple-100 text-purple-800'
                }">${q.level}</span>` : '';

                questionDiv.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <p class="font-bold text-lg text-gray-800 flex-1">
                            <span class="inline-block w-8 h-8 bg-green-500 text-white rounded-full text-center leading-8 mr-2">${index + 1}</span>
                            ${q.question}
                        </p>
                        ${levelBadge}
                    </div>
                    <div class="space-y-2 ml-10">
                        ${q.options.map((opt, i) => {
                            const isChecked = selectedAnswer === (i + 1) ? 'checked' : '';
                            const optionLabels = ['A', 'B', 'C', 'D'];
                            return `
                            <label class="flex items-center p-3 hover:bg-green-50 rounded-lg cursor-pointer transition-all duration-200 border-2 ${isChecked ? 'border-green-400 bg-green-50' : 'border-transparent'}">
                                <input type="radio" name="reading_q${index}" value="${i + 1}" class="mr-3 w-4 h-4 text-green-600" ${isChecked} data-question-index="${index}">
                                <span class="font-medium text-gray-700"><span class="font-bold text-green-600">${optionLabels[i]}.</span> ${opt}</span>
                            </label>
                        `}).join('')}
                    </div>
                `;
                questionsContainer.appendChild(questionDiv);
            });

            // Add event listeners to track answer changes
            const radioInputs = questionsContainer.querySelectorAll('input[type="radio"]');
            radioInputs.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const questionIndex = parseInt(e.target.dataset.questionIndex);
                    const selectedValue = parseInt(e.target.value);
                    currentReadingAnswers[questionIndex] = selectedValue;
                    console.log('[Reading] Answer updated:', questionIndex, '=', selectedValue);

                    // Update visual styles for selected option
                    const allLabels = questionsContainer.querySelectorAll(`input[name="reading_q${questionIndex}"]`).forEach(input => {
                        const label = input.closest('label');
                        if (input.checked) {
                            label.classList.add('border-green-400', 'bg-green-50');
                            label.classList.remove('border-transparent');
                        } else {
                            label.classList.remove('border-green-400', 'bg-green-50');
                            label.classList.add('border-transparent');
                        }
                    });
                });
            });
        }

        /**
         * Prevent pull-to-refresh on iOS/iPadOS devices
         */
        let pullToRefreshHandler = null;
        let touchStartY = 0;

        function enablePullToRefreshPrevention() {
            // Remove existing handlers if any
            if (pullToRefreshHandler) {
                document.removeEventListener('touchstart', pullToRefreshHandler.start);
                document.removeEventListener('touchmove', pullToRefreshHandler.move, { passive: false });
            }

            // Track touch start position
            const handleTouchStart = function(e) {
                touchStartY = e.touches[0].clientY;
            };

            // Prevent pull-to-refresh only when pulling down from non-scrollable area
            const handleTouchMove = function(e) {
                const readingContainer = document.getElementById('interaction-reading-comprehension');
                if (!readingContainer || readingContainer.classList.contains('hidden')) {
                    return;
                }

                const touchY = e.touches[0].clientY;
                const touchDelta = touchY - touchStartY;

                // Get the target element that was touched
                const target = e.target;

                // Find if the target is inside a scrollable container
                let scrollableParent = null;
                let element = target;

                while (element && element !== readingContainer) {
                    const overflowY = window.getComputedStyle(element).overflowY;
                    if (overflowY === 'auto' || overflowY === 'scroll') {
                        scrollableParent = element;
                        break;
                    }
                    element = element.parentElement;
                }

                // If inside a scrollable container
                if (scrollableParent) {
                    const isAtTop = scrollableParent.scrollTop === 0;
                    const isPullingDown = touchDelta > 0;

                    // Only prevent if at the top AND pulling down
                    if (isAtTop && isPullingDown) {
                        e.preventDefault();
                    }
                } else {
                    // Not in a scrollable container, prevent pull-to-refresh
                    if (touchDelta > 0) {
                        e.preventDefault();
                    }
                }
            };

            pullToRefreshHandler = {
                start: handleTouchStart,
                move: handleTouchMove
            };

            // Add event listeners
            document.addEventListener('touchstart', pullToRefreshHandler.start, { passive: true });
            document.addEventListener('touchmove', pullToRefreshHandler.move, { passive: false });
            console.log('[Pull-to-Refresh] Prevention enabled');
        }

        function disablePullToRefreshPrevention() {
            if (pullToRefreshHandler) {
                document.removeEventListener('touchstart', pullToRefreshHandler.start);
                document.removeEventListener('touchmove', pullToRefreshHandler.move, { passive: false });
                pullToRefreshHandler = null;
                console.log('[Pull-to-Refresh] Prevention disabled');
            }
        }

        /**
         * Initialize highlighter functionality for reading text - Drawing mode
         */
        let currentHighlighterColor = null;
        let isEraserMode = false;
        let highlightLines = []; // Store all highlight lines {color, points: [{x, y, lineY}]}
        let highlightCanvas = null;
        let highlightCtx = null;
        let isHighlighting = false;
        let currentHighlightPath = [];
        let textLines = []; // Store text line positions

        function initializeHighlighter() {
            console.log('[Highlighter] Initializing drawing mode...');
            const textDisplay = document.getElementById('reading-text-display');
            highlightCanvas = document.getElementById('reading-highlight-canvas');

            if (!textDisplay || !highlightCanvas) {
                console.error('[Highlighter] Text display or canvas not found');
                return;
            }

            highlightCtx = highlightCanvas.getContext('2d');

            // Reset state
            currentHighlighterColor = null;
            isEraserMode = false;
            highlightLines = [];
            textLines = [];

            // Setup canvas size
            resizeCanvas();

            // Setup highlighter buttons
            const highlighterBtns = document.querySelectorAll('.highlighter-btn');
            const eraserBtn = document.getElementById('reading-eraser-btn');
            const mouseBtn = document.getElementById('reading-mouse-btn');

            console.log('[Highlighter] Found buttons:', highlighterBtns.length, 'highlighters, eraser:', !!eraserBtn, 'mouse:', !!mouseBtn);

            // Remove previous active states
            highlighterBtns.forEach(btn => btn.classList.remove('active'));
            if (eraserBtn) eraserBtn.classList.remove('active');
            if (mouseBtn) mouseBtn.classList.remove('active');

            // Remove old event listeners by cloning buttons
            highlighterBtns.forEach((btn, index) => {
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
            });

            if (eraserBtn) {
                const newEraserBtn = eraserBtn.cloneNode(true);
                eraserBtn.parentNode.replaceChild(newEraserBtn, eraserBtn);
            }

            if (mouseBtn) {
                const newMouseBtn = mouseBtn.cloneNode(true);
                mouseBtn.parentNode.replaceChild(newMouseBtn, mouseBtn);
            }

            // Re-query buttons after cloning
            const newHighlighterBtns = document.querySelectorAll('.highlighter-btn');
            const newEraserBtn = document.getElementById('reading-eraser-btn');
            const newMouseBtn = document.getElementById('reading-mouse-btn');

            // Highlighter button click handlers
            newHighlighterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const color = btn.dataset.color;
                    console.log('[Highlighter] Color button clicked:', color);

                    currentHighlighterColor = color;
                    isEraserMode = false;

                    // Update button states
                    newHighlighterBtns.forEach(b => b.classList.remove('active'));
                    if (newEraserBtn) newEraserBtn.classList.remove('active');
                    if (newMouseBtn) newMouseBtn.classList.remove('active');
                    btn.classList.add('active');

                    console.log('[Highlighter] Color activated:', color);

                    // Apply highlight to selected text if any
                    applyHighlightToSelection(color);
                });
            });

            // Eraser button click handler
            if (newEraserBtn) {
                newEraserBtn.addEventListener('click', () => {
                    console.log('[Highlighter] Eraser button clicked');
                    isEraserMode = true;
                    currentHighlighterColor = null;

                    // Update button states
                    newHighlighterBtns.forEach(b => b.classList.remove('active'));
                    if (newMouseBtn) newMouseBtn.classList.remove('active');
                    newEraserBtn.classList.add('active');

                    console.log('[Highlighter] Eraser mode activated');
                    textDisplay.classList.add('eraser-mode');
                });
            }

            // Mouse button click handler
            if (newMouseBtn) {
                newMouseBtn.addEventListener('click', () => {
                    console.log('[Highlighter] Mouse button clicked');
                    isEraserMode = false;
                    currentHighlighterColor = null;

                    // Update button states
                    newHighlighterBtns.forEach(b => b.classList.remove('active'));
                    if (newEraserBtn) newEraserBtn.classList.remove('active');
                    newMouseBtn.classList.add('active');

                    console.log('[Highlighter] Mouse mode activated');
                    textDisplay.classList.remove('eraser-mode');
                });
            }

            // Detect text lines
            detectTextLines();

            // Setup text selection and highlight events
            setupTextHighlightEvents();

            console.log('[Highlighter] Initialization complete with text selection mode');
        }

        /**
         * Resize canvas to match text display size
         */
        function resizeCanvas() {
            const textDisplay = document.getElementById('reading-text-display');
            if (!highlightCanvas || !textDisplay) return;

            const rect = textDisplay.getBoundingClientRect();
            highlightCanvas.width = rect.width;
            highlightCanvas.height = rect.height;
            highlightCanvas.style.width = rect.width + 'px';
            highlightCanvas.style.height = rect.height + 'px';

            console.log('[Highlighter] Canvas resized to:', highlightCanvas.width, 'x', highlightCanvas.height);

            // Redraw all highlights after resize
            drawHighlights();
        }

        /**
         * Detect text line positions
         */
        function detectTextLines() {
            const textDisplay = document.getElementById('reading-text-display');
            if (!textDisplay) return;

            textLines = [];
            const range = document.createRange();
            const textContent = textDisplay.textContent;

            if (!textContent) return;

            // Get all text nodes
            const walker = document.createTreeWalker(
                textDisplay,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );

            const textNodes = [];
            while (walker.nextNode()) {
                if (walker.currentNode.textContent.trim()) {
                    textNodes.push(walker.currentNode);
                }
            }

            // Get line rectangles
            const lineMap = new Map();
            textNodes.forEach(node => {
                range.selectNodeContents(node);
                const rects = range.getClientRects();
                Array.from(rects).forEach(rect => {
                    const y = Math.round(rect.top);
                    if (!lineMap.has(y)) {
                        lineMap.set(y, {
                            top: rect.top,
                            bottom: rect.bottom,
                            left: Math.min(rect.left, lineMap.get(y)?.left || Infinity),
                            right: Math.max(rect.right, lineMap.get(y)?.right || 0),
                            height: rect.height
                        });
                    } else {
                        const line = lineMap.get(y);
                        line.left = Math.min(line.left, rect.left);
                        line.right = Math.max(line.right, rect.right);
                    }
                });
            });

            const textDisplayRect = textDisplay.getBoundingClientRect();
            lineMap.forEach((line, y) => {
                textLines.push({
                    y: line.top + line.height / 2 - textDisplayRect.top,
                    top: line.top - textDisplayRect.top,
                    bottom: line.bottom - textDisplayRect.top,
                    left: line.left - textDisplayRect.left,
                    right: line.right - textDisplayRect.left,
                    height: line.height
                });
            });

            textLines.sort((a, b) => a.y - b.y);
            console.log('[Highlighter] Detected', textLines.length, 'text lines');
        }

        /**
         * Apply highlight to selected text
         */
        function applyHighlightToSelection(color) {
            const selection = window.getSelection();
            if (!selection || selection.isCollapsed) {
                console.log('[Highlighter] No text selected');
                return;
            }

            const range = selection.getRangeAt(0);
            const textDisplay = document.getElementById('reading-text-display');

            // Check if selection is within the text display
            if (!textDisplay.contains(range.commonAncestorContainer)) {
                console.log('[Highlighter] Selection is not in text display');
                return;
            }

            try {
                // Create a span to wrap the selected text
                const span = document.createElement('span');
                span.className = `highlight ${color}`;
                span.setAttribute('data-highlight-color', color);

                // Wrap the selected content
                range.surroundContents(span);

                console.log('[Highlighter] Applied', color, 'highlight to selected text');

                // Clear the selection
                selection.removeAllRanges();
            } catch (error) {
                // If surroundContents fails (e.g., partial element selection),
                // use a more robust method
                console.log('[Highlighter] Using alternative highlight method');

                const fragment = range.extractContents();
                const span = document.createElement('span');
                span.className = `highlight ${color}`;
                span.setAttribute('data-highlight-color', color);
                span.appendChild(fragment);
                range.insertNode(span);

                // Clear the selection
                selection.removeAllRanges();
            }
        }

        /**
         * Setup text selection and highlight events
         */
        function setupTextHighlightEvents() {
            const textDisplay = document.getElementById('reading-text-display');
            if (!textDisplay) return;

            // Listen for mouseup to apply highlight when text is selected
            textDisplay.addEventListener('mouseup', () => {
                if (currentHighlighterColor && !isEraserMode) {
                    setTimeout(() => {
                        applyHighlightToSelection(currentHighlighterColor);
                    }, 10);
                }
            });

            // Listen for click on highlights in eraser mode
            textDisplay.addEventListener('click', (e) => {
                if (isEraserMode && e.target.classList.contains('highlight')) {
                    console.log('[Highlighter] Removing highlight');
                    const highlight = e.target;
                    const parent = highlight.parentNode;

                    // Replace the highlight span with its text content
                    while (highlight.firstChild) {
                        parent.insertBefore(highlight.firstChild, highlight);
                    }
                    parent.removeChild(highlight);

                    // Normalize the parent to merge adjacent text nodes
                    parent.normalize();
                }
            });

            console.log('[Highlighter] Text selection events setup complete');
        }

        /**
         * Setup drawing events for mouse and touch
         */
        function setupDrawingEvents() {
            if (!highlightCanvas) return;

            // Mouse events
            highlightCanvas.addEventListener('mousedown', handleDrawStart);
            highlightCanvas.addEventListener('mousemove', handleDrawMove);
            highlightCanvas.addEventListener('mouseup', handleDrawEnd);
            highlightCanvas.addEventListener('mouseleave', handleDrawEnd);

            // Touch events
            highlightCanvas.addEventListener('touchstart', handleDrawStart);
            highlightCanvas.addEventListener('touchmove', handleDrawMove);
            highlightCanvas.addEventListener('touchend', handleDrawEnd);
            highlightCanvas.addEventListener('touchcancel', handleDrawEnd);
        }

        /**
         * Get coordinates from mouse or touch event
         */
        function getEventCoords(e) {
            const rect = highlightCanvas.getBoundingClientRect();
            let clientX, clientY;

            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        /**
         * Find nearest text line for a given y coordinate
         */
        function findNearestLine(y) {
            if (textLines.length === 0) return null;

            let nearest = textLines[0];
            let minDist = Math.abs(y - textLines[0].y);

            for (let i = 1; i < textLines.length; i++) {
                const dist = Math.abs(y - textLines[i].y);
                if (dist < minDist) {
                    minDist = dist;
                    nearest = textLines[i];
                }
            }

            return nearest;
        }

        /**
         * Start drawing
         */
        function handleDrawStart(e) {
            e.preventDefault();

            if (isEraserMode) {
                handleEraseClick(e);
                return;
            }

            if (!currentHighlighterColor) return;

            isHighlighting = true;
            currentHighlightPath = [];

            const coords = getEventCoords(e);
            currentHighlightPath.push(coords);

            console.log('[Highlighter] Drawing started at:', coords);
        }

        /**
         * Drawing move
         */
        function handleDrawMove(e) {
            if (!isHighlighting || !currentHighlighterColor) return;

            e.preventDefault();

            const coords = getEventCoords(e);
            currentHighlightPath.push(coords);

            // Draw preview
            drawPreview();
        }

        /**
         * End drawing
         */
        function handleDrawEnd(e) {
            if (!isHighlighting) return;

            e.preventDefault();
            isHighlighting = false;

            if (currentHighlightPath.length < 2) {
                currentHighlightPath = [];
                return;
            }

            // Process path to align to text lines
            const alignedPath = alignPathToLines(currentHighlightPath);

            if (alignedPath.length > 0) {
                highlightLines.push({
                    color: currentHighlighterColor,
                    points: alignedPath,
                    id: Date.now() + Math.random()
                });
            }

            currentHighlightPath = [];
            drawHighlights();

            console.log('[Highlighter] Drawing complete, total lines:', highlightLines.length);
        }

        /**
         * Draw preview while drawing
         */
        function drawPreview() {
            if (!highlightCtx || currentHighlightPath.length < 2) return;

            drawHighlights(); // Redraw existing highlights

            // Draw current path preview
            const colorMap = {
                yellow: 'rgba(254, 240, 138, 0.6)',
                green: 'rgba(134, 239, 172, 0.6)',
                pink: 'rgba(253, 164, 175, 0.6)',
                blue: 'rgba(147, 197, 253, 0.6)'
            };

            highlightCtx.strokeStyle = colorMap[currentHighlighterColor] || 'rgba(254, 240, 138, 0.6)';
            highlightCtx.lineWidth = 20;
            highlightCtx.lineCap = 'round';
            highlightCtx.lineJoin = 'round';

            highlightCtx.beginPath();
            highlightCtx.moveTo(currentHighlightPath[0].x, currentHighlightPath[0].y);
            for (let i = 1; i < currentHighlightPath.length; i++) {
                highlightCtx.lineTo(currentHighlightPath[i].x, currentHighlightPath[i].y);
            }
            highlightCtx.stroke();
        }

        /**
         * Align path to text lines
         */
        function alignPathToLines(path) {
            if (path.length === 0 || textLines.length === 0) return [];

            const aligned = [];
            const lineHeight = 20; // Height of highlight line

            // Group path points by nearest line
            const lineGroups = new Map();

            path.forEach(point => {
                const nearestLine = findNearestLine(point.y);
                if (nearestLine) {
                    const lineKey = nearestLine.y;
                    if (!lineGroups.has(lineKey)) {
                        lineGroups.set(lineKey, {
                            line: nearestLine,
                            points: []
                        });
                    }
                    lineGroups.get(lineKey).points.push(point);
                }
            });

            // Create aligned segments for each line
            lineGroups.forEach((group, lineKey) => {
                if (group.points.length > 0) {
                    const minX = Math.min(...group.points.map(p => p.x));
                    const maxX = Math.max(...group.points.map(p => p.x));
                    const y = group.line.y;

                    aligned.push({
                        x1: minX,
                        x2: maxX,
                        y: y,
                        lineY: group.line.y
                    });
                }
            });

            return aligned;
        }

        /**
         * Draw all highlights on canvas
         */
        function drawHighlights() {
            if (!highlightCtx || !highlightCanvas) return;

            // Clear canvas
            highlightCtx.clearRect(0, 0, highlightCanvas.width, highlightCanvas.height);

            const colorMap = {
                yellow: 'rgba(254, 240, 138, 0.6)',
                green: 'rgba(134, 239, 172, 0.6)',
                pink: 'rgba(253, 164, 175, 0.6)',
                blue: 'rgba(147, 197, 253, 0.6)'
            };

            const lineHeight = 20;

            // Draw all highlight lines
            highlightLines.forEach(line => {
                highlightCtx.strokeStyle = colorMap[line.color] || 'rgba(254, 240, 138, 0.6)';
                highlightCtx.lineWidth = lineHeight;
                highlightCtx.lineCap = 'round';

                line.points.forEach(segment => {
                    highlightCtx.beginPath();
                    highlightCtx.moveTo(segment.x1, segment.y);
                    highlightCtx.lineTo(segment.x2, segment.y);
                    highlightCtx.stroke();
                });
            });
        }

        /**
         * Handle eraser click
         */
        function handleEraseClick(e) {
            if (!isEraserMode) return;

            const coords = getEventCoords(e);
            console.log('[Highlighter] Erase click at:', coords);

            // Find which highlight line was clicked
            const clickRadius = 15;
            let foundIndex = -1;

            for (let i = highlightLines.length - 1; i >= 0; i--) {
                const line = highlightLines[i];
                for (const segment of line.points) {
                    // Check if click is within the segment bounds
                    if (coords.x >= segment.x1 - clickRadius &&
                        coords.x <= segment.x2 + clickRadius &&
                        Math.abs(coords.y - segment.y) <= clickRadius) {
                        foundIndex = i;
                        break;
                    }
                }
                if (foundIndex >= 0) break;
            }

            if (foundIndex >= 0) {
                highlightLines.splice(foundIndex, 1);
                drawHighlights();
                console.log('[Highlighter] Highlight line removed, remaining:', highlightLines.length);
            }
        }

        /**
         * Submit reading comprehension answer
         */
        async function submitReadingAnswer() {
            const questionsContainer = document.getElementById('reading-questions-container');
            const answers = [];

            // Collect all answers
            for (let i = 0; i < readingComprehensionData.questions.length; i++) {
                const selected = document.querySelector(`input[name="reading_q${i}"]:checked`);
                if (selected) {
                    answers.push(parseInt(selected.value));
                } else {
                    answers.push(0); // No answer
                }
            }

            if (answers.filter(a => a > 0).length === 0) {
                showMessage('請至少回答一題！', 'error');
                return;
            }

            await submitAnswer(JSON.stringify(answers));
            showMessage('答案已提交！', 'success');
            document.getElementById('submit-reading-btn').disabled = true;

            // Clear local answers after successful submission
            currentReadingAnswers = [];
        }

        /**
         * AI generate PIRLS reading questions
         */
        async function generatePIRLSQuestions() {
            const aiTopicTextarea = document.getElementById('ai-reading-topic-textarea');
            const readingTextTextarea = document.getElementById('reading-text-textarea');
            const questionsTextarea = document.getElementById('reading-questions-textarea');
            const aiBtn = document.getElementById('ai-generate-reading-btn');
            const aiIcon = document.getElementById('ai-reading-btn-icon');
            const aiText = document.getElementById('ai-reading-btn-text');
            const aiSpinner = document.getElementById('ai-reading-loading-spinner');

            const topic = aiTopicTextarea.value.trim();
            const existingText = readingTextTextarea.value.trim();

            if (!topic) {
                showMessage('請輸入出題要求！', 'error');
                return;
            }

            // Show loading
            aiBtn.disabled = true;
            aiText.textContent = '生成中...';
            aiIcon.classList.remove('fa-magic');
            aiIcon.classList.add('fa-spinner', 'fa-spin');
            aiSpinner.classList.remove('hidden');

            try {
                const prompt = existingText
                    ? `根據以下文本，依照 PIRLS 閱讀理解的 4 個層次生成 10 題選擇題：
層次1（直接提取資訊）：3題
層次2（直接推論）：3題
層次3（詮釋整合資訊）：2題
層次4（比較評估內容）：2題

文本：
${existingText}

要求：${topic}

請按照以下格式輸出，每行一題：
題目,正確答案(1-4),選項1,選項2,選項3,選項4,層次(1-4)

範例：
主角的名字是什麼?,2,小明,小華,小美,小強,1`
                    : `請根據以下主題生成一篇適合的閱讀文本，並依照 PIRLS 閱讀理解的 4 個層次生成 10 題選擇題：
層次1（直接提取資訊）：3題
層次2（直接推論）：3題
層次3（詮釋整合資訊）：2題
層次4（比較評估內容）：2題

主題：${topic}

請先輸出文本，然後輸出「---題目---」，再按照以下格式輸出題目，每行一題：
題目,正確答案(1-4),選項1,選項2,選項3,選項4,層次(1-4)`;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.7 }
                };

                const apiKey = aiSettings.geminiApiKey;
                const response = await fetch(getApiUrl(apiKey), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`AI API request failed with status ${response.status}`);
                }

                const result = await response.json();
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim();

                if (generatedText) {
                    if (!existingText) {
                        // Parse text and questions
                        const parts = generatedText.split('---題目---');
                        if (parts.length === 2) {
                            readingTextTextarea.value = parts[0].trim();
                            questionsTextarea.value = parts[1].trim();
                        } else {
                            questionsTextarea.value = generatedText;
                        }
                    } else {
                        questionsTextarea.value = generatedText;
                    }
                    showMessage('AI 閱讀測驗已成功生成！', 'success');
                } else {
                    throw new Error('AI 未返回有效內容。');
                }

            } catch (error) {
                console.error("AI 閱讀測驗生成失敗:", error);
                showMessage('AI 生成失敗，請檢查 API Key 或網路連線。', 'error');
            } finally {
                aiBtn.disabled = false;
                aiText.textContent = 'AI 開始出題';
                aiIcon.classList.add('fa-magic');
                aiIcon.classList.remove('fa-spinner', 'fa-spin');
                aiSpinner.classList.add('hidden');
            }
        }

        /**
         * Show reading comprehension questions modal for teacher
         */
        function showViewReadingQuestionsModal() {
            if (!readingComprehensionData || !readingComprehensionData.questions || readingComprehensionData.questions.length === 0) {
                showMessage('目前沒有閱讀測驗題目可以查看。', 'info');
                return;
            }

            const modal = document.getElementById('view-reading-questions-modal');
            const textDisplay = document.getElementById('view-reading-text-display');
            const questionsDisplay = document.getElementById('view-reading-questions-display');

            // Display text
            textDisplay.textContent = readingComprehensionData.text || '(無文本)';

            // Display questions
            questionsDisplay.innerHTML = '';
            readingComprehensionData.questions.forEach((q, index) => {
                const levelIcon = ['📖', '💭', '🔗', '⚖️'][q.level - 1];
                const levelText = ['直接提取', '直接推論', '詮釋整合', '比較評估'][q.level - 1];

                const questionDiv = document.createElement('div');
                questionDiv.className = 'bg-white p-4 rounded-lg border';
                questionDiv.innerHTML = `
                    <div class="flex items-center gap-2 mb-2">
                        <span class="font-bold text-lg">第 ${index + 1} 題</span>
                        <span class="text-sm bg-blue-100 text-blue-700 px-2 py-1 rounded">${levelIcon} 層次${q.level}: ${levelText}</span>
                    </div>
                    <p class="font-medium text-gray-800 mb-3">${q.question}</p>
                    <div class="space-y-1 ml-4">
                        ${q.options.map((opt, i) => `
                            <div class="flex items-center gap-2">
                                <span class="font-bold ${i + 1 === q.correctAnswer ? 'text-green-600' : 'text-gray-600'}">${i + 1}.</span>
                                <span class="${i + 1 === q.correctAnswer ? 'text-green-600 font-bold' : 'text-gray-700'}">${opt}</span>
                                ${i + 1 === q.correctAnswer ? '<i class="fas fa-check-circle text-green-600 ml-2"></i>' : ''}
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-2 text-sm text-gray-600">
                        <span class="font-bold">正確答案：</span><span class="text-green-600 font-bold">${q.correctAnswer}</span>
                    </div>
                `;
                questionsDisplay.appendChild(questionDiv);
            });

            modal.classList.remove('hidden');
        }

        /**
         * Hide reading comprehension questions modal
         */
        function hideViewReadingQuestionsModal() {
            document.getElementById('view-reading-questions-modal').classList.add('hidden');
        }

        // === Reading Comprehension Question Bank Functions ===

        /**
         * Get classroom-specific reading bank key
         */
        function getReadingBankKey() {
            return classroomCode ? `readingQuestionBanks_${classroomCode}` : 'readingQuestionBanks_default';
        }

        /**
         * Load reading question banks from localStorage for current classroom
         */
        function loadReadingBanksFromStorage() {
            if (!classroomCode) return;
            const key = getReadingBankKey();
            const stored = localStorage.getItem(key);
            if (stored) {
                try {
                    readingQuestionBanks = JSON.parse(stored);
                } catch (e) {
                    console.error('載入閱讀測驗題庫失敗:', e);
                    readingQuestionBanks = [];
                }
            } else {
                readingQuestionBanks = [];
            }
        }

        /**
         * Save reading question banks to localStorage for current classroom
         */
        function saveReadingBanksToStorage() {
            if (!classroomCode) return;
            const key = getReadingBankKey();
            try {
                localStorage.setItem(key, JSON.stringify(readingQuestionBanks));
            } catch (e) {
                console.error('儲存閱讀測驗題庫失敗:', e);
            }
        }

        /**
         * Load text and questions from separate files
         */
        async function loadReadingFiles() {
            const textFileInput = document.getElementById('reading-text-file-input');
            const questionsFileInput = document.getElementById('reading-questions-file-input');
            const textTextarea = document.getElementById('reading-text-textarea');
            const questionsTextarea = document.getElementById('reading-questions-textarea');

            const textFile = textFileInput.files[0];
            const questionsFile = questionsFileInput.files[0];

            if (!textFile && !questionsFile) {
                showMessage('請至少選擇一個檔案！', 'error');
                return;
            }

            try {
                if (textFile) {
                    const textContent = await textFile.text();
                    textTextarea.value = textContent.trim();
                }

                if (questionsFile) {
                    const questionsContent = await questionsFile.text();
                    questionsTextarea.value = questionsContent.trim();
                }

                showMessage('檔案載入成功！', 'success');

                // Clear file inputs
                textFileInput.value = '';
                questionsFileInput.value = '';
            } catch (error) {
                console.error('讀取檔案失敗:', error);
                showMessage('讀取檔案失敗！', 'error');
            }
        }

        /**
         * Save reading question bank to localStorage
         */
        function saveReadingQuestionBank() {
            const nameInput = document.getElementById('reading-question-bank-name-input');
            const bankName = nameInput.value.trim();
            const textContent = document.getElementById('reading-text-textarea').value.trim();
            const questionsContent = document.getElementById('reading-questions-textarea').value.trim();

            if (!bankName) {
                showMessage('請輸入題庫名稱！', 'error');
                return;
            }

            if (!textContent || !questionsContent) {
                showMessage('請先輸入文本和題目！', 'error');
                return;
            }

            // Check if questions are valid
            const questions = parseReadingQuestions(questionsContent);
            if (!questions) {
                showMessage('題目格式錯誤，請檢查！', 'error');
                return;
            }

            // Load from storage first to get current banks for this classroom
            loadReadingBanksFromStorage();

            const bank = {
                name: bankName,
                text: textContent,
                questions: questionsContent,
                timestamp: new Date().toISOString()
            };

            // Check if bank name already exists
            const existingIndex = readingQuestionBanks.findIndex(b => b.name === bankName);
            if (existingIndex >= 0) {
                if (!confirm(`題庫「${bankName}」已存在，是否覆蓋？`)) {
                    return;
                }
                readingQuestionBanks[existingIndex] = bank;
            } else {
                readingQuestionBanks.push(bank);
            }

            saveReadingBanksToStorage();
            updateReadingBankList();
            showMessage(`題庫「${bankName}」已儲存！`, 'success');
            nameInput.value = '';
        }

        /**
         * Download reading text and questions as a ZIP file
         */
        async function downloadReadingZip() {
            const textContent = document.getElementById('reading-text-textarea').value.trim();
            const questionsContent = document.getElementById('reading-questions-textarea').value.trim();

            if (!textContent && !questionsContent) {
                showMessage('請先輸入文本或題目！', 'error');
                return;
            }

            try {
                // Create a new JSZip instance
                const zip = new JSZip();

                // Add text file if content exists
                if (textContent) {
                    zip.file('文本.txt', textContent);
                }

                // Add questions file if content exists
                if (questionsContent) {
                    zip.file('題目.txt', questionsContent);
                }

                // Generate the zip file
                const content = await zip.generateAsync({ type: 'blob' });

                // Create filename with timestamp
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const filename = `閱讀測驗_${timestamp}.zip`;

                // Download the file using FileSaver.js
                saveAs(content, filename);

                showMessage('檔案下載成功！', 'success');
            } catch (error) {
                console.error('Download error:', error);
                showMessage('下載失敗，請重試！', 'error');
            }
        }

        /**
         * Update reading question bank list display
         */
        function updateReadingBankList() {
            loadReadingBanksFromStorage(); // Load from storage first
            const listContainer = document.getElementById('reading-question-bank-list');

            if (readingQuestionBanks.length === 0) {
                listContainer.innerHTML = '<div class="text-gray-500 text-sm italic text-center">目前沒有儲存的題庫</div>';
                return;
            }

            listContainer.innerHTML = readingQuestionBanks.map((bank, index) => `
                <div class="flex items-center justify-between p-2 bg-white border rounded hover:bg-gray-50">
                    <button onclick="loadReadingBankToTextarea(${index})" class="text-left flex-1 text-sm text-blue-600 hover:underline">
                        ${bank.name}
                    </button>
                    <button onclick="deleteReadingBank(${index})" class="text-red-500 hover:text-red-700 ml-2">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                </div>
            `).join('');
        }

        /**
         * Load reading bank to textarea
         */
        function loadReadingBankToTextarea(index) {
            if (index >= 0 && index < readingQuestionBanks.length) {
                const bank = readingQuestionBanks[index];
                document.getElementById('reading-text-textarea').value = bank.text;
                document.getElementById('reading-questions-textarea').value = bank.questions;
                showMessage(`題庫「${bank.name}」已載入`, 'success');
            }
        }

        /**
         * Delete reading bank
         */
        function deleteReadingBank(index) {
            loadReadingBanksFromStorage(); // Load from storage first
            if (index >= 0 && index < readingQuestionBanks.length) {
                const bankName = readingQuestionBanks[index].name;
                if (confirm(`確定要刪除題庫「${bankName}」嗎？`)) {
                    readingQuestionBanks.splice(index, 1);
                    saveReadingBanksToStorage();
                    updateReadingBankList();
                    showMessage(`題庫「${bankName}」已刪除`, 'success');
                }
            }
        }

        // Make functions globally accessible
        window.loadReadingBankToTextarea = loadReadingBankToTextarea;
        window.deleteReadingBank = deleteReadingBank;

        // Note: Reading question banks are loaded when teacher enters classroom
        // (see loadReadingBanksFromStorage() call in teacher setup)

        // --- Start Application ---
        initialize();
        setupEventListeners(); // Call setupEventListeners only once here.

    </script>
</body>
</html>